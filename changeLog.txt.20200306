v 0.0.1
9th, Jan 2015
1. nstore.controller.php::processCartReview()

아래 부분 주석 처리; 진열하지 않는다고 팔리지도 않게 하는 건 동의할 수 없는 정책
// 체크2) 진열상태 체크 
//if($item_info->display == 'N') return new Object(-1, sprintf(Context::getLang('msg_not_displayed_item'), $item_info->item_name));

27th, Jan 2015
1. nstore.admin.controller.php::procNstoreAdminCSVDownloadByOrder()에서
주문내역 CSV 다운로드 기능 개선 - 주소 배열에서 우편번호 컬럼 분리
주문내역 CSV 다운로드 기능 개선 - 주소 배열에서 , 문자가 있으면 컬럼이 분리되는 현상 개선

함수 시작에 아래의 코드 추가
$sAddressFieldKey = '주소';

아래의 코드를 
if(count($data))
{
	$list_keys = array_keys($data);
	$first_order = $data[$list_keys[0]];
	$extra_vars = unserialize($first_order->extra_vars);
	foreach( $extra_vars as $key=>$val )
	{
		echo ','.$key;
	}
}

아래의 코드로 변경
if(count($data))
{
	$list_keys = array_keys($data);
	$first_order = $data[$list_keys[0]];
	$extra_vars = unserialize($first_order->extra_vars);
	foreach( $extra_vars as $key=>$val )
	{
		if( strpos( $key, $sAddressFieldKey ) !== false )
		{
			// postcodify는 주소정보를 도로명주소, 상세주소, 참고항목, 우편번호 로 구성함
			// 이 중에서 우편번호만 분리함.
			echo ','.$key.',우편번호';
		}
		else
			echo ','.$key;
	}
}

아래의 코드를
if($extra_vars)
{
	foreach($extra_vars as $key=>$val)
	{
		if( is_array( $val ) )
			echo ',"'.implode(' ', $val).'"';
		else
			echo ','.$val; 
	}
}

아래의 코드로 변경
if($extra_vars)
{
	foreach($extra_vars as $key=>$val)
	{
		if( is_array( $val ) )
		{
			if( strpos( $key, $sAddressFieldKey ) !== false )
			{
				// postcodify는 주소정보를 도로명주소, 상세주소, 참고항목, 우편번호 로 구성함
				// 이 중에서 우편번호만 분리함.
				$postcode = array_pop( $val );
				echo ',"'.implode(' ', $val).'"'.','.$postcode;
			}
			else
				echo ',"'.implode(' ', $val).'"';
		}
		else
			echo ','.$val; 
	}
}

v 0.0.2
17th, Feb 2015
1. nstore.controller.php::sendAlarmMail() 추가; 거래 완료되면 고객과 관리자에게 메일 알람
2. nstore.controller.php::insertOrder()에서 거래 등록 완료되면 고객과 관리자에게 메일 알람

v 0.0.3
18th, Feb 2015
1. nstore.controller.php::processCartReview()에서
비회원 결제 정보 입력 부분을
$args->purchaser_name = Context::getLang('guest');
$args->purchaser_cellphone = Context::get('purchaser_cellphone');
$args->purchaser_telnum = Context::get('purchaser_telnum');
$args->purchaser_email = Context::get('purchaser_email');

아래와 같이 ncart.controller.php::triggerProcessReview에서 받은 $args를 참조하도록 변경
$args->purchaser_name = $args->purchaser_name ? $args->purchaser_name : Context::getLang('guest');
$args->purchaser_cellphone = $args->purchaser_cellphone ? $args->purchaser_cellphone : Context::get('purchaser_cellphone');
$args->purchaser_telnum = $args->purchaser_telnum ? $args->purchaser_telnum : Context::get('purchaser_telnum');
$args->purchaser_email = $args->purchaser_email ? $args->purchaser_email : Context::get('purchaser_email');

2. nstore.controller.php::processCartReview()에서
수령인 결제 정보 입력 부분을
$args->recipient_name = Context::get('recipient_name');
$args->recipient_cellphone = Context::get('recipient_cellphone');
$args->recipient_telnum = Context::get('recipient_telnum');
$args->recipient_postcode = Context::get('postcode');
$args->recipient_address = array(Context::get('address1'), Context::get('address2'));

아래와 같이 ncart.controller.php::triggerProcessReview에서 받은 $args를 참조하도록 변경
$args->recipient_name = $args->recipient_name ? $args->recipient_name : Context::get('recipient_name');
$args->recipient_cellphone = $args->recipient_cellphone ? $args->recipient_cellphone : Context::get('recipient_cellphone');
$args->recipient_telnum = $args->recipient_telnum ? $args->recipient_telnum : Context::get('recipient_telnum');
$args->recipient_postcode = $args->receipient_postcode ? $args->receipient_postcode : Context::get('receipient_postcode');
$args->recipient_address = $args->receipient_address ? $args->receipient_address : Context::get('receipient_address');

3. nstore.controller.php::insertOrder()에서
수령인 전화번호 필드를 변경없이 기록하는 기존 코드에서
$args->recipient_cellphone = $in_args->recipient_cellphone;
$args->recipient_telnum = $in_args->recipient_telnum;

아래와 같이 자료 형식이 배열이면 - 로 대치하여 연결하는 코드 추가
if (is_array($args->recipient_cellphone)) $args->recipient_cellphone = implode('-',$in_args->recipient_cellphone);
if (is_array($args->recipient_telnum)) $args->recipient_telnum = implode('-',$in_args->recipient_telnum);

v 0.0.4
19th, Feb 2015
tbl_nstore_order:payment_method가 공란이 되는 현상 발생함
nstore.controller.php::insertOrder() 이후의 프로세스에서 공란으로 변경되는 것으로 추정함; nstore.controller.php::insertOrder() 이후에는 어떤 루틴에서도 변경 금지
1. nstore.controller.php::processCartPayment()에서 
$args->payment_method = $obj->payment_method; 비활성화
2. nstore.controller.php::updateOrderStatus()에서
$args->payment_method = $in_args->payment_method; 비활성화
3. ./queries/updateOrderStatus.xml에서 <column name="payment_method" var="payment_method" />를 제거

3. tbl_nstore_order에서 http_user_agent, is_mobile_access 필드 추가

4. nstore.controller.php::insertOrder()에서 결제자 접속 환경 정보 기록 루틴 추가
// 접속 환경 기록
$args->http_user_agent = trim( $_SERVER['HTTP_USER_AGENT'] );
$args->is_mobile_access = $_COOKIE['mobile'] == 'false' ? 'N' : 'Y';

5. CSV 주문 데이터 컬럼 편집 기능 추가
./conf/module.xml에 추가
<action name="dispNstoreAdminDataFormat" type="view" />
<action name="procNstoreAdminDataFormat" type="controller" />

./nstore.admin.view.php::dispNstoreAdminDataFormat()
./tpl/dataformat.html 추가
./tpl/_header.html에 [데이터 포맷 설정] 메뉴 추가
./lang/lang.xml에 data_format_setting 추가

./nstore.admin.model.php::getDataFormatConfig()
./nstore.admin.model.php::getDefaultListConfig()

v 0.0.5
20th, Feb 2015 
1. ./nstore.admin.controller.php::procNstoreAdminCSVDownloadByOrder()를 CSV 다운로드가 동적으로 구성되도록 수정
ncart 모듈에서 생성한 사용자 정의 확장 변수는 자동 출력
./lang/lang.xml에 order_csv_header 제거

2. ./nstore.admin.controller.php::procNstoreAdminUpdateDataFormat()추가

v 0.0.6
21st, Feb 2015
1. ./nstore.controller.php::procNstoreAdminUpdateDataFormat()추가
ncart 모듈의 사용자 정의 확장 변수 처리를 명확하게 하기 위해 아래의 코드를 
if( $args->delivdest_info )
	$args->extra_vars = serialize( $args->delivdest_info );
아래와 같이 변경
if( $args->extra_order_form_info )
	$args->extra_vars = serialize( $args->extra_order_form_info );

v 0.0.7
22nd, Feb 2015
1. ./nstore.controller.php::updateOrderStatus()에 PG 모듈이나 무통장입금 모듈에서 결제자가 입력한 송금자명 입력 루틴 추가
$args->remitter_name = $in_args->remitter_name; 추가

2. ./nstore.controller.php::processCartPayment()에 epay 모듈의 정보 호출 루틴 추가
if( $order_status )
{
	$oEpayModel = &getModel('epay');
	$payment_info = $oEpayModel->getTransactionByOrderSrl( $obj->order_srl );
	$args->remitter_name = $payment_info->vact_inputname;

3. ./schemas/nstore_order.xml에  <column name="remitter_name" type="varchar" size="10" /> 추가
4. ./queries/updateOrderStatus.xml에  <column name="remitter_name" var="remitter_name" /> 추가
5. ./nstore.admin.model.php::getDataFormatConfig()에 'remitter_name' 추가
6. ./nstore.admin.model.php::getDefaultDataFormConfig()에 'remitter_name' 추가

v 0.0.8
1st, Mar 2015
배송 송장 번호 일괄 등록 기능
1. ./excel PHPExcel_1.8.0 library 등록 

2. ./tpl/_header.html에 [배송번호 일괄등록] 탭 추가
<li class="x_active"|cond="$act=='dispNstoreAdminRegisterShppingSerial'"><a href="{getUrl('','module',$module,'act','dispNstoreAdminRegisterShppingSerial')}">{$lang->register_shipping_serial}</a></li>

3. ./lang/lang.xml에 추가
register_shipping_serial
register_invoice_info_file
about_register_invoice_info_file
register_invoice_info_file_type

4. ./conf/module.xml에 추가
<action name="dispNstoreAdminRegisterShppingSerial" type="view" />
<action name="procNstoreAdminRegisterShippingSerial" type="controller" />

5. ./nstore.admin.view.php::dispNstoreAdminRegisterShppingSerial() 추가
6. ./tpl/register_shpping_serial.php 추가

주문 목록 화면에서 검색 기능 활성화
1. ./nstore.admin.view.php::dispNstoreAdminOrderManagement() 에서
$memberIdentifiers = array( 'user_id'=>'user_id', 'user_name'=>'user_name', 'nick_name'=>'nick_name', 'purchaser_name'=>'purchaser_name' );를
$memberIdentifiers = array( 'user_id'=>'user_id' );로 변경

아래의 코드 비활성화
if( $search_key == 'nick_name' && $search_value == '비회원' )
{
	$search_key = 'member_srl';
	$search_value = 0;
}
위의 코드 비활성화

2. ./tpl/ordermanagement.html에서
헤더에 <th scope="col">{$lang->purchaser_name}</th> 추가
table body에 <td>{$order->purchaser_name}</td> 추가

<option value="purchaser_name" selected="selected"|cond="$search_key==''">{$lang->purchaser_name}</option> 추가
<option loop="$usedIdentifiers=>$key,$val" value="{$key}" selected="selected"|cond=="$search_key==$key">{Context::getLang($key)}</option>를
<option loop="$usedIdentifiers=>$key,$val" value="{$key}" selected="selected"|cond="$search_key==$key">{Context::getLang($key)}</option>로 변경

3. ./queries/getOrderListByStatus.xml 에서
<column name="member.nick_name" alias="nick_name" /> 제거
<column name="member.user_name" alias="user_name" /> 제거
<condition operation="equal" column="member.nick_name" var="nick_name" pipe="or" /> 제거
<condition operation="equal" column="member.user_name" var="user_name" pipe="or" /> 제거
<condition operation="equal" column="member.email_id" var="email_id" pipe="or" /> 제거
<condition operation="equal" column="member.email_address" var="email_address" pipe="or" /> 제거

<condition operation="equal" column="order.purchaser_name" var="purchaser_name" pipe="or" /> 추가
<condition operation="equal" column="member.user_id" var="user_id" pipe="or" /> 추가
<condition operation="equal" column="order.purchaser_email" var="email_address" pipe="or" /> 추가

관리자에서 결제 취소하면 PG사 결제 취소
1. ./schemas/nstore_order.xml에서
<column name="pg_tid" type="varchar" size="50" /> 추가

2. ./nstore.controller.php::processCartPayment()에서
epay 모듈에서 얻은 pg_tid를 updateOrderStatus로 전달하기 위해 아래의 코드 추가
$args->pg_tid = $obj->pg_tid;

3. ./nstore.controller.php::updateOrderStatus()에서
$args->pg_tid = $in_args->pg_tid; 추가

4. ./queries/updateOrderStatusNstore.xml 에서
<column name="pg_tid" var="pg_tid" /> 추가

v 0.0.9
2nd, Mar 2015
관리자에서 PG사 카드결제 취소 기능 추가하려다 정책 미정으로 중단
1. ./nstore.controller.php::procNstoreAdminCancelSettlement() 추가
2. ./schemas/nstore_order.xml에 <column name="pg_tid_canceldate" type="date" notnull="notnull" /> 추가
3. ./tpl/ordermanagement.html에 아래 코드 추가
<block cond="( $status=='A' || $status=='B' || $status=='D' ) && $order->payment_method=='CC' && $order->canceldate==''">
	<DIV><A HREF='' onClick="javascript:cancelSettlement( '{$order->order_srl}' ); return false;">결제취소</A></DIV>
</block>
javascript::cancelSettlement()추가

4. ./conf/module.xml에 <action name="procNstoreAdminCancelSettlement" type="controller" /> 추가

v 0.1.0
7th, Mar 2015
1. ./tpl/register_shipping_serial.html에서 아래의 코드 추가
운송장 번호 일괄 등록 화면에서 처리 결과 메세지 출력 DIV 추가
<div cond="$XE_VALIDATOR_MESSAGE" class="message {$XE_VALIDATOR_MESSAGE_TYPE}">
	<p>{$XE_VALIDATOR_MESSAGE}</p>
</div>

2. ./nstore.admin.view.php::dispNstoreAdminRegisterShppingSerial()에 아래의 코드 추가
업로드 엑셀 파일에 [택배사] 필드가 존재하면 엑셀의 택배사 정의를 따르고, 없으면  [기본설정]탭의 [기본 배송회사] 설정으로 일괄처리
엑셀에 입력된 주문번호 유효성 검사
$oNstoreModel = &getModel('nstore');

if( count( $order_info ) == 0 )
	return new Object( -1, sprintf( '%d 행의 주문번호 [%s]은 유효하지 않습니다.', $nRow, $oRowData[0][$nOrderSrlIdx] ) );

v 0.1.1
29th, Mar 2015
1. ./nstore.admin.view.php::init()에서 cympusadmin 종속성 제거위해 아래의 코드 삭제
// module이 cympusadmin일때 관리자 레이아웃으로
if(Context::get('module')=='cympusadmin')
{
    $classfile = _XE_PATH_.'modules/cympusadmin/cympusadmin.class.php';
    if(file_exists($classfile))
    {
	    require_once($classfile);
	    cympusadmin::init();
    }
}

v 0.1.2
1st, Aug 2015
1. nproduct 모듈 이름을 svitem으로 변경에 대응하여 ./nstore.class.php에서 nproduct require 를 svitem require로 변경
require_once(_XE_PATH_.'modules/svitem/svitem.item.php');

./nstore.class.php::installTriggers()에서 아래를
if (!$oModuleModel->getTrigger('nproduct.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before'))
	$oModuleController->insertTrigger('nproduct.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before');
아래와 같이 변경
if (!$oModuleModel->getTrigger('svitem.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before'))
	$oModuleController->insertTrigger('svitem.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before');

./nstore.class.php::checkUpdate()에서 아래를
if(!$oModuleModel->getTrigger('nstore.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before')) return true;
아래와 같이 변경
if(!$oModuleModel->getTrigger('svitem.getProcModules', 'nstore', 'model', 'triggerGetProcModules', 'before')) return true;

./nstore.class.php::getNstoreModules()에서 아래를
$oNproductModel =  &getModel('nproduct');
$args->module = 'nproduct';
아래와 같이 변경
$oSvitemModel =  &getModel('svitem');
$args->module = 'svitem';

./nstore.model.php::getNproductExtraVars()을  ./nstore.model.php::getSvitemExtraVars()

./nstore.view.php::dispNstoreNonOrderList()에서 
$item = new nproductItem($val, $config->currency, $config->as_sign, $config->decimals);을
$item = new svitemItem($val, $config->currency, $config->as_sign, $config->decimals);

./nstore.view.php::dispNstoreOrderList()에서
$item = new nproductItem($val, $config->currency, $config->as_sign, $config->decimals); 을
$item = new svitemItem($val, $config->currency, $config->as_sign, $config->decimals);

./nstore.controller.php::updateSalesCount()에서
$oNproductController = &getController('nproduct');
$oNproductController->updateSalesCount( $item_srl, $quantity ); 를
$oSvitemController = &getController('svitem');
$oSvitemController->updateSalesCount( $item_srl, $quantity );로 변경

./nstore.controller.php::updateStock()에서
$oNproductModel = &getModel( 'nproduct' );
$oNproductController = &getController( 'nproduct' );를
$oSvitemModel = &getModel( 'svitem' );
$oSvitemController = &getController( 'svitem' );로 변경

2. 모듈 이름을 svorder로 변경

v 0.1.3
15th, Aug 2015
1. svcurrency 모듈 제거하고 svitem 모듈에서 환율 설정 조회
./svorder.model.php::getModuleConfig()에 아래의 코드 추가
if( getClass('svitem') )
{
	$oSvitemModel = &getModel('svitem');
	$currency = $oSvitemModel->getCurrencyInfo();
	//$currency = $oSvcurrencyModel->getModuleConfig();
}
else
	return new Object(-1,'msg_svitem_uninstalled');

$config->currency = $currency->currency;
$config->as_sign = $currency->as_sign;
$config->decimals = $currency->decimals;

v 0.1.4
3rd, Oct 2015
1. ./svorder.admin.view.php::init()에서 아래의 코드를 추가
if(Context::get('module')=='svshopmaster')
{
	$this->setLayoutPath('');
	$this->setLayoutFile('common_layout');
}
svshopmaster 레이아웃에서 http://singletest.zc.bz/index.php?module=svshopmaster&act=dispNproductAdminItemList&module_srl=ㅌㅌㅌ 를 호출할 때
$this->module_info->layout_srl에 정보가 있으면 모듈 디자인 설정을 실행하기 때문에 레이아웃을 강제 변경

2. ./svorder.model.php::getSvorderList()추가
svcart의 ordercomplete.html에서 연결시킬 svorder 모듈 정보를 제공하기 위한 메소드
./queries/getSvorderList.xml 추가

v 0.1.5
4th, Oct 2015
1. 결제 정보 입력 화면에서 배송비 선불/착불 선택에 대응
./svorder.controller.php::processCartReview()에서 아래의 코드 추가
if( is_null( $args->delivfee_inadvance ) )
{
	if( $config->shipping_fee_payment_type == 'prepaid' )
		$args->delivfee_inadvance = 'Y';
	if( $config->shipping_fee_payment_type == 'postpaid' )
		$args->delivfee_inadvance = 'N';
}

./tpl/ordersheet.html에 아래의 코드 추가
$order_info->delivery_fee = ( $order_info->delivfee_inadvance == 'N' ) ? 0 : $order_info->delivery_fee;


v 0.1.6
15th, Oct 2015
1. 주문관리->주문별 CSV다운로드에서 구매 옵션 사항이 출력되도록 수정함
./svorder.admin.model::getDataFormatConfig()에서 $aBuff에 
option_price, option_title 항목 추가
./lang/lang.xml에서 option_price, option_title 항목 추가
./queries/getOrderListByStatus.xml에 아래의 항목 추가
<tables>
	<table name="svorder_cart" alias="cart" type="left join">
		<conditions>
			<condition operation="equal" column="cart.cart_srl" default="order.cartnos" />
		</conditions>
	</table>
</tables>
<columns>
	<column name="cart.cart_srl" alias="option_srl" />
	<column name="cart.option_price" alias="option_price" />
	<column name="cart.option_title" alias="option_title" />
</columns>

v 0.1.7
17th, Oct 2015
1. 배송번호 일괄등록 템플릿 파일에 '송장번호'도 인식함
./svorder.admin.controller::procSvorderAdminRegisterShippingSerial()에서
if( $sVal == '운송장번호' )를
if( $sVal == '운송장번호' || $sVal == '송장번호' )로 변경

v 0.1.8
18th, Oct 2015
1. 발주요청서 다운로드 기능 개선: 주문관리->주문별 CSV 다운로드에서 장바구니 구매 내역이 항목별로 표시되도록 수정
v 0.1.6 수정 사항 roll back
./queries/getCartItems.xml 추가
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에서 order record의 cartnos 값 갯수에 따라 order_cart 테이블의 정보 읽어옴
2. dashboard 상품판매, 상품매출 표시 논리 변경
./svorder.admin.model.php::getTodaySalesInfo() 생성 <-svshopmaster모듈의 svshopmaster.admin.view.php::getSvshopStatus()에서 호출
./queries/getTotalSalesInfo.xml 추가
./svorder.admin.model.php::getTotalSalesInfo() 생성 <-svshopmaster모듈의 svshopmaster.admin.view.php::getSvshopStatus()에서 호출

v 0.1.9
25th, Nov 2015
1. 결제창 입력 후 할인 쿠폰 적용 기능
./svorder.controller.php::processCartReview()에서 insertOrder 호출 전
$args->total_discount_amount = $cart->total_discount_amount;를 아래와 같이 변경
$args->total_discount_amount = $args->cart->total_discount_amount;

v 0.2.0
28th, Nov 2015
1. 프로모션 관련 정보 항목 추가
./schemas/svorder_order.xml에서
<column name="promotion_info" type="text" /> 추가하여 promotion_info 변수를 serialize하여 저장
./queries/insertOrder.xml에서
<column name="promotion_info" var="promotion_info" /> 추가

2. svorder_order 레코드에 쿠폰 프로모션 정보 있으면 쿠폰 사용 내역 표시
./svorder.controller.php::processCartPayment()에서 아래의 코드 추가

// promotion 정보가 있으면 설정
$oPromotionInfo = new stdClass();
if( strlen( $output->data->promotion_info ) > 0 )
	$oPromotionInfo = unserialize( $output->data->promotion_info );

// promotion 정보가 있으면 쿠폰에 사용내역 표시
if( $oPromotionInfo->coupon_srl > 0 )
{
	$oSvPromotionController = &getController('svpromotion');
	$oSvPromotionController->procSvprmotionMarkUsedCoupon( $oPromotionInfo->coupon_srl );
}

v 0.2.1
1st, Dec 2015
1. GET 방식 주문별 CSV 다운로드가 xe core v 1.8.12 이상에서 호환되지 않는 문제 해결
./tpl/ordermanagement.html 에서 아래의 코드 추가
<!--- hidden form to download CSV begin ----->
<form action="./" method="post" id='frmCsvDownloadByOrder' name="frmCsvDownloadByOrder">
<input type='hidden' name='module' id='module' value='svshopmaster'/>
<input type='hidden' name='act' id='act' value='procSvorderAdminCSVDownloadByOrder'/>
</form>
<script type="text/javascript">
function downloadCsv()
{
	document.frmCsvDownloadByOrder.submit();
}
</script>
<!--- hidden form to download CSV end ----->

2. [주문별 CSV 다운로드]의 데이터포맷 설정을 주문관리 화면에 종속시킴
./conf/module.xml에서 아래의 코드 추가
<action name="getSvorderAdminModifyDataFormat" type="model" />

./svorder.model.php::getSvorderAdminModifyDataFormat() 추가
./tpl/js/ordermanagement.js에 $('a.modalAnchor.modifyDataFormat').bind('before-open.mw', function 추가
./tpl/form_dataformat.html 생성
./tpl/_header.html에서 데이터 포맷 설정 항목 제거
./svorder.admin.view.php::dispSvorderAdminDataFormat()제거

3. [배송번호 일괄등록]을 주문관리 화면에 종속시킴
./conf/module.xml에서 아래의 코드 추가
<action name="getSvorderAdminModifyDataFormat" type="model" />

./svorder.model.php::getSvorderAdminModifyDataFormat() 추가
./tpl/js/ordermanagement.js에 $('a.modalAnchor.registerShippingSerial').bind('before-open.mw', function(event){ 추가
./tpl/form_register_shipping_serial.html 생성
./tpl/_header.html에서 [배송번호 일괄등록] 항목 제거
./svorder.admin.view.php::dispSvorderAdminRegisterShppingSerial()제거

4. [거래원장 다운로드] 메뉴 생성
./lang.xml에 아래의 코드 추가
<item name="order_rawdata_download">
	<value xml:lang="ko"><![CDATA[거래원장 다운로드]]></value>
</item>

./conf/module.xml에서 아래의 코드 추가
<action name="dispSvorderAdminOrderRawDataDownload" type="view" />

./tpl/download_order_raw.html 생성
./queries/getOrderListAll.xml 생성

./svorder.controller.php::procSvorderAdminCSVDownloadByOrderAll() 생성

5. 거래원장 CSV 다운로드에서 이메일 주소의 .을 ,로 잘못 입력한 경우 발견하여 CSV 에러 방지위해 아래의 코드 추가
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서
else if( $key == 'purchaser_email' )
	echo '"'.$output->data[0]->purchaser_email.'"';

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에서 아래의 코드 추가
else if( $key == 'purchaser_email' )
	echo '"'.$output->data[0]->purchaser_email.'"';

./svorder.admin.model.php::getDataFormatConfig()의 배열에 'order_status' 추가
./svorder.admin.model.php::getDefaultDataFormConfig()의 배열에 'order_status' 추가

v 0.2.2
3rd, Dec 2015
1. [배송번호 일괄등록] 기능에서 송장번호 필드명을 기본설정에서 지정하도록 변경
./svorder.admin.view.php::dispSvorderAdminConfig() 불필요한 코드 정리
./tpl/config.html에 [기본 송장번호 컬럼명] 항목 추가
./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서 
moduleconfig->default_shipping_serial_column_name 호출
유효하지 않은 주문번호 발견하면 이전 행에서 유사성 점검하여 자식으로 파생된 주문 번호인지 확인 후 에러 반환

송장번호에서 -를 제거하기 위해 아래의 코드를 
$aShippingSrl[] = $oRowData[0][$nShippingSrlIdx];
아래의 코드로 변환
$aShippingSrl[] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );

v 0.2.3
5th, Dec 2015
1. [배송번호 일괄등록] 기능에서 한 주문에 복수 송장번호 있을 경우 기록
./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서
추가 배송번호를 발견할 경우 포함시킬 수 있도록 아래의 배열에 인덱스 번호 부여
$aCarrierId[$nRow]
$aOrderSrl[$nRow]
$aShippingSrl[$nRow]
추가 배송번호를 저장할 배열 생성하고 인덱스 부여
$aExtraShippingSrl[$nPrevRow]
컨텍스트 변수 추가
Context::set( 'extra_invoice_no', $aExtraShippingSrl );

./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서
아래의 코드 추가
$extra_invoice_nos = Context::get( 'extra_invoice_no' );

./schemas/svorder_order.xml에서 아래의 코드 추가
<column name="extra_invoice_no" type="varchar" size="255" />

./svorder.controller.php::updateOrderStatus()에서 아래의 코드 추가
$args->extra_invoice_no = $in_args->extra_invoice_no;

./queries/updateOrderStatusSvorder.xml에 아래의 코드 추가
<column name="extra_invoice_no" var="extra_invoice_no" />


./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 아래의 코드 추가
$extra_invoice_nos = Context::get( 'extra_invoice_no' );

if( $extra_invoice_nos[$key] !== NULL )
	$args->extra_invoice_no = $extra_invoice_nos[$key];

v 0.2.4
6th, Dec 2015
1. [주문관리] 기능에서 한 주문에 복수 송장번호 입력 기능
./lang/lang.xml에 아래의 코드 추가
<item name="input_invoice_no">
	<value xml:lang="ko"><![CDATA[복수운송장번호 ,구분]]></value>
	<value xml:lang="en"><![CDATA[Invoice no.]]></value>
</item>

./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 주문관리 화면에서 수기로 ,구분된 복수 송장 입력하는 루틴 추가
./tpl/ordermanagement.html에서 placeholder="{$lang->invoice_no}"를 placeholder="{$lang->input_invoice_no}" 로 변경

v 0.2.5
13th, Dec 2015
1. 결제창 호출 시 svpromotion에 가격 정보 의뢰
./svorder.controller.php::processCartReview()에서 아래의 코드를
$output = $oSvitemModel->discountItem($item_info, $group_list);
아래와 같이 변경
$output = $oSvpromotionModel->getItemPriceOrder($item_info, $group_list);

./tpl/register_shipping_serial.html 제거해야 함
./tpl/dataformat.html 제거해야 함

결제정보 입력 후 할인쿠폰과 배송비 관계 정리해야 함 -> 할인쿠폰은 제품구매가격에만 적용
./svorder.controller.php::insertOrder()에 utm_params 입력해야 함

v 0.2.6
20th, Dec 2015
1. bundling 주문 구성 정보 입력
./schemas/svorder_cart.xml에서 아래의 코드 추가
<column name="bundling_order_info" type="varchar" size="250" />

./svorder.controller.php::processCartReview()에서 아래의 코드를 추가
$cartitem_args->bundling_order_info = $val->bundling_order_info;

./queries/insertCartItem.xml에 아래의 코드 추가
<column name="bundling_order_info" var="bundling_order_info" default="" />

v 0.2.7
22nd, Dec 2015
1. bundling 주문 구성 정보 표시
./queries/getOrderItems.xml에 아래의 코드 추가
<column name="cart.bundling_order_info" alias="bundling_order_info" />

./svorder.model.php::getOrderInfo()에서 아래의 코드 추가
$oSvitemModel = &getModel('svitem');
foreach( $item_list as $key=>$val )
{
	$aBundlingInfo = Array();
	$item = new svitemItem( $val, $config->currency, $config->as_sign, $config->decimals );
	
	$oBundlingInfo = unserialize( $item->bundling_order_info );

	$nBundlingIdx = 0;
	foreach( $oBundlingInfo as $key2 => $val2 )
	{
		$oItemInfo = $oSvitemModel->getItemInfo( $val2->bundle_item_srl );
		$aBundlingInfo[$nBundlingIdx]->bundling_item_name = $oItemInfo->item_name;
		$aBundlingInfo[$nBundlingIdx++]->bundle_quantity = $val2->bundle_quantity;
	}

	$item->bundling_infos = $aBundlingInfo;
}

./tpl/ordersheet.html에 아래의 코드 추가
<block loop="$val->bundling_infos=>$bundlekey,$bundleval">
	{$bundleval->bundling_item_name}
	({$bundleval->bundle_quantity})개
</block>

./tpl/ordersheet.html에서 인쇄화면 출력 기능 비활성화

2. bundling_order_info 저장 공간 확장
./schemas/svorder_cart.xml 에서 아래의 코드를
<column name="bundling_order_info" type="varchar" size="250" />
아래와 같이 변경
<column name="bundling_order_info" type="text" />

v 0.2.8
30th, Dec 2015
1. 실행코드 최적화
./svorder.view.php::dispSvorderOrderDetail()에서 아래의 코드 비활성화
$oFileModel = &getModel('file');
$logged_info = Context::get('logged_info');

./svorder.view.php::dispSvorderOrderList()에서 아래의 코드 비활성화
$oFileModel = &getModel('file');

2. 거래원장 다운로드에서 bundling_info를 decode
./queries/getCartItems.xml에 아래의 코드 추가
<column name="cart.bundling_order_info" alias="bundling_order_info" />

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드 추가
// decode and print bundling_info
if( strlen( $output->data->bundling_order_info ) > 0 )
{
	$oBundlingInfo = unserialize( $output->data->bundling_order_info );
	foreach( $oBundlingInfo as $key => $val )
	{
		$oItemInfo = $oSvitemModel->getItemInfo( $val->bundle_item_srl );
		$nIdx = 0;
		foreach( $oDataConfig as $key1 => $val1 )
		{
			if( $key1 == 'title' )
				echo '"'.$oItemInfo->item_name.'"';
			else if( $key1 == 'item_count' )
				echo $val->bundle_quantity;
			else
				echo '""';

			if( $nFieldCnt > $nIdx )
				echo ',';
			$nIdx++;
		}
		// extra_vars의 컬럼 값 설정, 어떤 값이 CSV로 출력될지 모르기 때문에 무조건 ""로 wrapping
		$extra_vars = unserialize( $rec->extra_vars );
		if( $extra_vars )
		{
			foreach( $extra_vars as $key1 => $val1 )
			{
				if( $i == 0 )
					echo ',"'.$val1.'"'; 
				else
					echo '""';
			}
		}
		echo "\r\n";
	}
}

v 0.2.9
4th, Jan 2016
1. 주문별 CSV 다운로드에서 bundling_info를 decode
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
// decode and print bundling_info
if( strlen( $output->data->bundling_order_info ) > 0 )
{
	$oBundlingInfo = unserialize( $output->data->bundling_order_info );
	foreach( $oBundlingInfo as $key => $val )
	{
		$oItemInfo = $oSvitemModel->getItemInfo( $val->bundle_item_srl );
		$nIdx = 0;
		foreach( $oDataConfig as $key1 => $val1 )
		{
			if( $key1 == 'title' )
				echo '"'.$oItemInfo->item_name.'"';
			else if( $key1 == 'item_count' )
				echo $val->bundle_quantity;
			else
				echo '""';

			if( $nFieldCnt > $nIdx )
				echo ',';
			$nIdx++;
		}
		// extra_vars의 컬럼 값 설정, 어떤 값이 CSV로 출력될지 모르기 때문에 무조건 ""로 wrapping
		$extra_vars = unserialize( $rec->extra_vars );
		if( $extra_vars )
		{
			foreach( $extra_vars as $key1 => $val1 )
			{
				if( $i == 0 )
					echo ',"'.$val1.'"'; 
				else
					echo '""';
			}
		}
		echo "\r\n";
	}
}

v 0.3.0
22nd, Feb 2016
1. 주문별 CSV 다운로드에서 bundling_info를 decode
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드 블록 추가
if( Context::get( 'search_key' ) )
{
	$search_key = Context::get( 'search_key' );
	$search_value = Context::get( 'search_value' );
	if( $search_key == 'nick_name' && $search_value == '비회원' )
	{
		$search_key = 'member_srl';
		$search_value = 0;
	}
	$args->{$search_key} = $search_value;
}

v 0.3.1
23rd, Feb 2016
1. conditional_promotion=>FBLIKE 할인 수용하도록 논리 변경
./svorder.controller.php::processCartReview()에 아래의 코드 추가
if( $val->conditional_promotion == 'fblike' )
{
	$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info);
	if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
		$output->discounted_price = $output->discounted_price - $oConditionalPromotion->fb_like_additional_discount_amount;
}
$cartitem_args->conditional_promotion = $val->conditional_promotion;

2. ./schemas/svorder_cart.xml에 아래의 코드 추가
<column name="conditional_promotion" type="varchar" size="50" />

v 0.3.2
29th, Feb 2016
./svorder.admin.view.php::dispSvorderAdminPurchaserInfo()에서 아래의 코드 수정
$output = executeQueryArray('Svorder.getOrderList', $args);를
$output = executeQueryArray('svorder.getOrderList', $args);로 변경

v 0.3.3
3rd, Mar 2016
1. 신용카드 결제취소 기능 추가
./svorder.admin.controller.php::procSvorderAdminCancelSettlement() 기능 활성화
./queries/getOrderByOrderSrl.xml 추가
./queries/updatePgTrIdCancelLogByOrderSrl.xml 추가
./tpl/ordermanagement.html에서 결제취소 링크 제거
./tpl/js/ordermanagement.js에서 결제취소 함수 제거
./tpl/orderdetail.html에 결제취소 링크 추가
./tpl/config.html에 GA tracking ID 입력란 추가
./svorder.admin.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
$config = $oSvorderModel->getModuleConfig();
Context::set('config', $config);

2. 송장번호에 -가 포함되어 있으면 제거
./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo() 에 아래의 코드 추가
$invoice_nos = str_replace( '-', '', $invoice_nos );

v 0.3.4
14th, Mar 2016
1. conditional_promotion=>FBLIKE 할인과 item 기본 할인 동시에 수용하도록 논리 변경
./svorder.controller.php::processCartReview()에서 아래의 코드를
if( $val->conditional_promotion == 'fblike' )
{
	$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info);
	if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
		$output->discounted_price = $output->discounted_price - $oConditionalPromotion->fb_like_additional_discount_amount;
}
아래와 같이 변경
if( $val->conditional_promotion == 'fblike' )
{
	$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info);
	if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
		$output->discounted_price = $val->price - $oConditionalPromotion->fb_like_additional_discount_amount;
}

v 0.3.5
27th, Mar 2016
1. 구매에 적용된 할인 체계 정리
./schemas/svorder_cart.xml에서 아래의 코드를
<column name="discount_info" type="varchar" size="250" />
<column name="conditional_promotion" type="varchar" size="50" />
아래와 같이 변경
<column name="discount_info" type="text"/>
<column name="conditional_promotion" type="text"/>

./schemas/svorder_order.xml에서 아래의 코드를
<column name="promotion_info" type="text" />
아래와 같이 변경
<column name="checkout_promotion_info" type="text" />

./queries/insertOrder.xml에서 아래의 코드를
<column name="promotion_info" var="promotion_info" />
아래의 코드로 변경
<column name="checkout_promotion_info" var="promotion_info" />

./svorder.controller.php::processCartReview()에서 아래의 코드를
if( $val->conditional_promotion == 'fblike' )
{
	$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info);
	if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
		$output->discounted_price = $val->price - $oConditionalPromotion->fb_like_additional_discount_amount;
}
아래와 같이 변경
$oConditionalPromotion = unserialize( $val->conditional_promotion );
if( $oConditionalPromotion->version == '1.0' )
{
	if( $oConditionalPromotion->promotion[0]->type == 'fblike' )
	{
		if( $oConditionalPromotion->promotion[0]->resultant_disc_amnt > 0 )
			$output->discounted_price = $val->price - $oConditionalPromotion->promotion[0]->resultant_disc_amnt;
	}
}
else // 20160601 이후에 코드 블록 제거
{
	if( $val->conditional_promotion == 'fblike' )
	{
		$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info);
		if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
			$output->discounted_price = $val->price - $oConditionalPromotion->fb_like_additional_discount_amount;
	}
}

v 0.3.6
29th, Mar 2016
1. cart 정보 갱신하기 전에 discount_info의 내용을 svpromotion 모듈에서 가져옴
./svorder.controller.php::insertOrder()에 아래의 코드 블록 추가
$oSvpromotionModel = &getModel('svpromotion');
$output = $oSvpromotionModel->getItemPriceDetail( $val );
if( !$output->toBool() )
	return $output;
$oDiscountInfo->version = '1.0';
$oDiscountInfo->promotion[0]->type = 'item_policy';
$oDiscountInfo->promotion[0]->unit_disc_amnt = $output->discount_amount;
$oDiscountInfo->promotion[0]->title = $output->discount_info;
if( $oDiscountInfo->promotion[0]->unit_disc_amnt > 0 )
{
	$args->discount_info = serialize( $oDiscountInfo );
}

./svorder.admin.model.php::getOrderInfo()에 아래의 코드를 추가
$oCheckoutPromotionInfo = unserialize( $order_info->checkout_promotion_info );
$nCheckoutPromoIdx = 0;
foreach( $oCheckoutPromotionInfo->promotion as $ccpromokey => $ccpromoval )
{
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->title = $ccpromoval->title;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx++]->total_disc_amnt = $ccpromoval->total_disc_amnt;
}

$order_info->checkout_promotion_info = $aCheckoutPromotionInfo;
$oDiscountInfo = unserialize( $item->discount_info );
$nPromotionIdx = 0;
foreach( $oDiscountInfo->promotion as $key2 => $val2 )
{
	$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
	$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->unit_disc_amnt;
}
$item->discount_info = $aDiscountInfo;
$oConditionalDiscountInfo = unserialize( $item->conditional_promotion );
foreach( $oConditionalDiscountInfo->promotion as $key2 => $val2 )
{
	$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
	$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->resultant_disc_amnt;
}

./tpl/ordersheet.html에 아래의 코드를
{$val->discount_info}
아래와 같이 변경
<block loop="$val->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>

./queries/getOrderItems.xml에 아래의 코드 추가
<column name="cart.conditional_promotion" alias="conditional_promotion" />

./svorder.controller.php::processCartReview()에 아래의 코드를
$args->total_discounted_price = $cart->total_discounted_price;
아래와 같이 변경
$args->total_discounted_price = $args->cart->total_price;

./skins/Trendshop/orderdetail.html에서 아래의 코드를
{$val->discount_info}
아래와 같이 변경
<block loop="$val->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>

v 0.3.7
2nd, Apr 2016
1. svpromotion의 메소드 변경에 따라서 호출 변경
./svorder.controller.php::processCartReview()에서 아래의 코드를
if( $oConditionalPromotion->fb_like_additional_discount_amount > 0 )
	$output->discounted_price = $val->price - $oConditionalPromotion->fb_like_additional_discount_amount;
아래와 같이 변경
if( $oConditionalPromotion->conditional_additional_discount_amount > 0 )
	$output->discounted_price = $val->price - $oConditionalPromotion->conditional_additional_discount_amount;

./tpl/orderdetail.html에서 아래의 코드를
{$item->discount_info}
아래와 같이 변경
<block loop="$item->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>

./svorder.controller.php::processCartReview()에서 아래의 코드를
if( $oConditionalPromotion->promotion[0]->type == 'fblike' )
아래와 같이 변경
if( $oConditionalPromotion->promotion[0]->type == 'fblike' || $oConditionalPromotion->promotion[0]->type == 'fbshare' )

v 0.3.8
16th, May 2016
1. svitemModel의 재고 확인 메소드 활용
./svorder.controller.php::updateStock()에서 아래의 코드를
$base_stock = $oSvitemModel->getItemExtraVarValue( $val->item_srl, 'stock' );
아래와 같이 변경
$base_stock = $oSvitemModel->getItemStock( $val->item_srl );

2. svitemController의 재고 변경 메소드 활용
./svorder.controller.php::updateStock()에서 아래의 코드를
$output = $oSvitemController->updateExtraVars($val->item_srl, 'stock', $stock);
아래와 같이 변경
$output = $oSvitemController->setItemStock($val->item_srl, $stock);

v 0.3.9
18th, May 2016
1. 외부 서버에 주문정보 통보 기능 추가
./ecaso.class.php 추가

./svorder.controller.php::_transmitOrderInfo 추가

./svorder.controller.php::insertOrder()에 아래의 코드 추가
$oSvorderModel = &getModel('svorder');
$config = $oSvorderModel->getModuleConfig();
if( $config->external_server != '' )
{
	$sExtOrderSrl = $this->_transmitOrderInfo( $oSvorderModel, $config->external_server, $order_srl );
//var_Dump($sExtOrderSrl );
	// for order table
	$args->order_srl = $order_srl;
	$args->thirdparty_order_id = $sExtOrderSrl;
	$output = executeQuery( 'svorder.updateExtOrderSrlSvorder', $args );
	if( !$output->toBool() )
		return $output;
	unset($args);
}

./tpl/config.html에 아래의 코드 추가
<div class="x_control-group">
	<label class="x_control-label" for="external_server">{$lang->transmit_to_external_server}</label>
	<div class="x_controls">
		<select name="external_server" id="external_server">
			<option value='' selected="selected"|cond="$config->external_server==''">{$lang->no_transmit}</option>
			<option value='ecaso' selected="selected"|cond="$config->external_server=='ecaso'">ecaso</option>
		</select>
		<a href="#external_server_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="external_server_help" class="x_help-block" hidden>{$lang->about_external_server}</p>
	</div>
</div>

./svorder.controller.php::processCartPayment()에 아래의 코드 비활성, 무의미한 연산으로 추정
$orders_info = $oSvorderModel->getOrderInfo( $order_srl );
$item_srls = array();
$count_list = count( $orders_info->item_list );
for($i = 0; $count_list != $i; $i++)
{
	foreach( $orders_info->item_list[$i] as $k => $v )
	{
		if( $k == 'item_srl' ) 
			$item_srls[] = $v;
	}
}

./conf/module.xml에 아래의 코드 추가
<action name="procSvorderExtSetInvoiceByOrder" type="controller" method="GET|POST"/>

./svorder.controller.php::procSvorderExtSetInvoiceByOrder() 추가

v 0.4.0
20th, May 2016
1. 송장번호 입력하면 배송중 상태로 강제 변경
./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에 아래의 코드 추가
$args->order_status = 4; // 송장번호가 입력되면 배송중 상태로 변경

아래의 코드를 
if( !$args->express_id && !$args->invoice_no )
	continue;
아래의 같이 변경
if( !$args->express_id || strlen( $args->invoice_no )==0)
	continue;

아래의 코드 주석 처리
$carts = Context::get( 'cart' );
if( !is_array( $carts ) ) 
	$carts = array();

2. 주문정보에 utm_params가 있으면 입렵
./svorder.controller.php::insertOrder()에 아래의 코드 추가
if( isset( $_SESSION['HTTP_INIT_SOURCE'] ) && strlen( $_SESSION['HTTP_INIT_SOURCE'] ) > 0 )
	$args->utm_source = $_SESSION['HTTP_INIT_SOURCE'];
if( isset( $_SESSION['HTTP_INIT_MEDIUM'] ) && strlen( $_SESSION['HTTP_INIT_MEDIUM'] ) > 0 )
	$args->utm_medium = $_SESSION['HTTP_INIT_MEDIUM'];
if( isset( $_SESSION['HTTP_INIT_CAMPAIGN'] ) && strlen( $_SESSION['HTTP_INIT_CAMPAIGN'] ) > 0 )
	$args->utm_campaign = $_SESSION['HTTP_INIT_CAMPAIGN'];
if( isset( $_SESSION['HTTP_INIT_KEYWORD'] ) && strlen( $_SESSION['HTTP_INIT_KEYWORD'] ) > 0 )
	$args->utm_term = $_SESSION['HTTP_INIT_KEYWORD'];

./schemas/svorder_order.xml에 아래의 코드 추가
<column name="utm_source" type="varchar" size="30" />
<column name="utm_medium" type="varchar" size="15" />
<column name="utm_campaign" type="varchar" size="90" />
<column name="utm_term" type="varchar" size="25" />

./tpl/insertOrder.xml에 아래의 코드 추가
<column name="utm_source" var="utm_source" />
<column name="utm_medium" var="utm_medium" />
<column name="utm_campaign" var="utm_campaign" />
<column name="utm_term" var="utm_term" />

v 0.4.1
23th, May 2016
1. 관리자의 주문서출력 명령이 svorder_cart 테이블의 품목 아이템이 손상되어도 표시되도록 변경
./tpl/ordersheet.html에 아래의 코드 추가
<block cond="$order_info->item_list">
	<tbody>
		{@$total_quantity=0}
		<tr loop="$order_info->item_list=>$key,$val">
			{@$total_quantity+=$val->quantity}
			<td>{$key+1}</td>
			<td>
				<div><span cond="$val->taxfree=='Y'"> * </span>{$val->item_name}</div>
				<div>
				<block loop="$val->bundling_infos=>$bundlekey,$bundleval">
					{$bundleval->bundling_item_name}
					({$bundleval->bundle_quantity}개)<BR>
				</block>
				</div>

				
				<div cond="$val->option_srl">{$val->option_title} ({$val->printPrice($val->option_price)}원)</div>
			</td>
			<td>{$val->quantity}</td>
			<td>{$val->formatMoney($val->price * $val->quantity)}</td>
			<td>{$val->formatMoney($val->discount_amount)}<br />
				<block loop="$val->discount_info=>$promotionkey,$promotionval">
				{$promotionval->title}<BR>
				</block>
			</td>
			<td>{$val->formatMoney($val->discounted_price)}</td>
		</tr>
		<tr>
			<td></td>
			<td>합계</td>
			<td>{number_format($total_quantity)}</td>
			<td>{$val->formatMoney($order_info->sum_price)}</td>
			<td>{$val->formatMoney($order_info->total_discount_amount)}
				<block loop="$order_info->checkout_promotion_info=>$checkoupromotionkey,$checkoutpromotionval">
				<BR>{$checkoutpromotionval->title}<BR>
				</block>
			</td>
			<td>{$val->formatMoney($order_info->total_discounted_price)}</td>
		</tr>
	</tbody>
</block>
<block cond="!$order_info->item_list">
	<tbody>
		<tr>
			<td>장바구니 테이블 에러입니다.</td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</tbody>
</block>

v 0.4.2
24th, May 2016
1. 이카소 주문 정보 전송 클래스에 배송비 정보 추가
./ecaso.class.php에 아래의 코드 추가
'delivery_amount' => $oArgs->delivery_fee,

v 0.4.3
25th, May 2016
1. 이카소 주문 정보 전송 방식 변경
./svorder.controller.php::processCartPayment()에서 아래의 코드 제거
$oSvorderModel = &getModel('svorder');
$config = $oSvorderModel->getModuleConfig();
if( $config->external_server != '' )
{
	//$sExtOrderSrl = $this->_transmitOrderInfo( $oSvorderModel, $config->external_server, $order_srl );
	// for order table
	$args->order_srl = $order_srl;
	$args->thirdparty_order_id = 'transmitted';//$sExtOrderSrl;
	$output = executeQuery( 'svorder.updateExtOrderSrlSvorder', $args );
	if( !$output->toBool() )
		return $output;
	
	unset($args);
}

./svorder.controller.php::_transmitOrderInfo( $nOrderSrl ) 제거

./svorder.controller.php::transmitOrderInfo( $nOrderSrl ) 추가, svcart.view.php::dispSvcartOrderComplete()에서 호출

v 0.4.4
26th, May 2016
1. 이카소 주문 정보 전송 클래스 이름 변경
./ecaso.class.php를 ./ecaso_order.class.php 로 변경
class name을 ecaso에서 ecasoOrder로 변경

./svorder.controller.php::transmitOrderInfo()에서 이에 대응하여 아래와 같이 코드 변경
require_once(_XE_PATH_.'modules/svorder/ecaso_order.class.php');
$oExtServer = new ecasoOrder( $oOrdersInfo );

./svorder.controller.php::procSvorderExtSetInvoiceByOrder()을 다중 송장 처리 방식으로 변경

v 0.4.5
30th, May 2016
1. 이카소 주문 취소 정보 전송 기능 추가
./svorder.controller.php::transmitOrderInfo()를 transmitOrderInfoExt로 이름 변경
./ecaso_order.class.php::ecasoOrder()에 전송 타입 변수 추가

v 0.4.6
3rd, Jun 2016
1. 관리자 주문 취소 UI를 [주문관리] 화면으로 단일화
./tpl/ordermanagement.html에서 선택한 주문을 영역에서 [취소] 옵션 제거
./tpl/orderdetail.html에서 PG주문취소만 처리하던 방식에서 모든 주문 취소 처리로 변경
./svorder.controller.php::transmitCancelInfoExt() 추가
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()를 아래의 논리로 변경
신용카드 결제 주문일경우 PG 취소 후
주문상태 변경 후
외부 서버에 통지

2. 외부서버 연동 상태면 외부 서버 주문번호 표시
./tpl/ordermanagement.html에서 아래의 코드 추가
<div cond="$config->external_server!=''">{$config->external_server} 주문번호<BR>({$order->thirdparty_order_id})</div>

3. 취소 요청 상태 생성
./svorder.class.php::$order_status에 아래의 코드 추가
'E'=>'on_cancelling'

./tpl/ordermanagement_header.html에 아래의 코드 추가
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','E')}" class="active"|cond="$status=='E'">{$lang->on_cancelling}</a> <i>|</i>

./oonf/module.xml에 아래의 코드 추가
<action name="procSvorderExtConfirmCancelByOrder" type="controller" method="GET|POST"/>

./svorder.controller.php::procSvorderExtConfirmCancelByOrder() 추가
./schemas/getOrderInfoBySvThirdPartyOrderSrl.xml에서 아래의 코드를 
<column name="order_srl" />
아래와 같이 변경
<column name="order_status" />

4. 외부 서버에서 배송 완료 확정 받는 기능 추가
./oonf/module.xml에 아래의 코드 추가
<action name="procSvorderExtCloseDeliveryByOrder" type="controller" method="GET|POST"/>
./svorder.controller.php::procSvorderExtCloseDeliveryByOrder() 추가

5. 엑셀 다운로드 받을 때 아래의 메시지가 마지막 라인에 출력되지 않도록 함
Fatal error: spl_autoload(): Class UpdateExpression could not be loaded in /home/singleview57/www/files/cache/queries/session.updateSession.1.8.15.mysqli.cache.php on line 35

./svorder.admin.controller.php::procSvorderAdminOrderExcelDownload()에서 아래의 코드를
exit();
아래와 같이 변경
Context::setResponseMethod('JSON'); // display class 작동 정지

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에서 아래의 코드를
exit();
아래와 같이 변경
Context::setResponseMethod('JSON'); // display class 작동 정지

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드를
exit();
아래와 같이 변경
Context::setResponseMethod('JSON'); // display class 작동 정지

v 0.4.7
9th, Jun 2016
1. 외부 서버 연동 상태이면 관리자 화면에서 주문 상태 변경 기능 비활성화
여러 부서가 관리자 화면을 통제한 결과, 주문 배송 정보 무결성이 손상되는 사고 발생 
예) CS업체가 결제취소한 주문에 MD회사가 송장번호 부여
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드 추가
&& $output->data->order_status != 'C'
./tpl/ordermanagement.html에서 주문상태 변경 관련 DIV에 아래의 코드 추가
<div class="x_control-group" cond="$config->external_server==''">

v 0.4.8
13th, Jun 2016
1. 신용카드 결제 후 배송완료 상태에서 환불 요청 처리
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
if( $output->data->order_status != '2' && $output->data->order_status != 'A' && $output->data->order_status != 'B' && $output->data->order_status != 'C' && $output->data->order_status != 'D' )
	return new Object( -1, 'msg_cancel_not_available_order_status' );
아래와 같이 변경
if( $output->data->order_status != '2' && $output->data->order_status != '5' && 
	$output->data->order_status != '6' && 
	$output->data->order_status != 'A' && $output->data->order_status != 'B' && 
	$output->data->order_status != 'C' && $output->data->order_status != 'D' )
	return new Object( -1, 'msg_1cancel_not_available_order_status' );

2. 배송전 상태에서만 신용카드 결제 취소 시도
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
if( $output->data->payment_method == 'CC' )
아래와 같이 변경
if( $output->data->payment_method == 'CC' && ( $output->data->order_status == '2' || $output->data->order_status == '3' ) )

3. 주문취소 요청 시 외부주문번호 변수 할당 변경
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
$oOrdersCancelInfo->thirdparty_order_id = $output->data->thirdparty_order_id;
아래와 같이 변경
$oOrdersCancelInfo->thirdparty_order_id = $sThirdPartyOrderId;

4. 주문관리 화면에서 배송 상태에 따라 취소라벨 변경
{@
if( $order_info->order_status == 2 )
	$sCancelLabel = '결제취소';
else
	$sCancelLabel = '주문취소요청';
}

5. 일반 외부서버 통신 controller 메소드 추가
./svorder.admin.controller.php::procSvorderExtCommand() 추가

6. ecaso_order.class.php를 ecaso_query.class.php로 변경
./svorder.controller.php::transmitOrderInfoExt()에서 관련 호출 코드 변경
./svorder.controller.php::transmitCancelInfoExt()에서 관련 호출 코드 변경

7. ./ecaso_listen.class.php 생성하고 아래의 메소드를 wrapping
./svorder.controller.php::procSvorderExtSetInvoiceByOrder()
./svorder.controller.php::procSvorderExtConfirmCancelByOrder()
./svorder.controller.php::procSvorderExtCloseDeliveryByOrder()

v 0.4.9
7th, Jul 2016
1. 무조건 증정 프로모션 처리 루틴 추가
./svorder.controller.php::processCartReview()에서 아래의 코드를
if( $oConditionalPromotion->promotion[0]->type == 'fblike' || $oConditionalPromotion->promotion[0]->type == 'fbshare' )
{
	if( $oConditionalPromotion->promotion[0]->resultant_disc_amnt > 0 )
		$output->discounted_price = $val->price - $oConditionalPromotion->promotion[0]->resultant_disc_amnt;
}
아래와 같이 변경
foreach( $oConditionalPromotion->promotion as $promotion_key=>$promotion_val)
{
	if( $promotion_val->type == 'fblike' || $promotion_val->type == 'fbshare' )
	{
		if( $promotion_val->resultant_disc_amnt > 0 )
			$output->discounted_price = $val->price - $promotion_val->resultant_disc_amnt;
	}
}

./queries/getCartItems.xml에 아래의 코드 추가
<column name="cart.conditional_promotion" alias="conditional_promotion" />

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder에 아래의 코드 추가
if( strlen( $output->data->conditional_promotion ) > 0 )
{
	$oConditionalPromotionInfo = unserialize( $output->data->conditional_promotion );
	foreach( $oConditionalPromotionInfo->promotion as $key2 => $val2 )
	{
		if( $val2->type == 'giveaway' )
		{
			$oItemInfo = $oSvitemModel->getItemInfo( $val2->giveaway_item_srl );
			$nIdx = 0;
			foreach( $oDataConfig as $key1 => $val1 )
			{
				if( $key1 == 'title' )
					echo '"'.$oItemInfo->item_name.'"';
				else if( $key1 == 'item_count' )
					echo $val2->resultant_giveaway_qty;
				else
					echo '""';

				if( $nFieldCnt > $nIdx )
					echo ',';
				$nIdx++;
			}
			// extra_vars의 컬럼 값 설정, 어떤 값이 CSV로 출력될지 모르기 때문에 무조건 ""로 wrapping
			$extra_vars = unserialize( $rec->extra_vars );
			if( $extra_vars )
			{
				foreach( $extra_vars as $key1 => $val1 )
				{
					if( $i == 0 )
						echo ',"'.$val1.'"'; 
					else
						echo '""';
				}
			}
			echo "\r\n";
		}
	}
}

./svorder.admin.controller.php::transmitOrderInfoExt 아래의 코드 추가
$nItemCnt = count( $oOrdersInfo->item_list );
$aGiveawayItem = array();
foreach($oOrdersInfo->item_list as $key=>$val)
{
	if( strlen( $val->conditional_promotion ) > 0 )
	{
		$oConditionalPromotion = unserialize( $val->conditional_promotion );
		if( $oConditionalPromotion->version == '1.0' )
		{
			foreach( $oConditionalPromotion->promotion as $key1=>$val1)
			{
				if( $val1->type == 'giveaway' )
				{
					$oItemInfo = $oSvitemModel->getItemInfo($val1->giveaway_item_srl);
					$aGiveawayItem[++$nItemCnt]->item_code = $oItemInfo->item_code;
					$aGiveawayItem[$nItemCnt]->price = 0;
					$aGiveawayItem[$nItemCnt]->quantity = $val1->resultant_giveaway_qty;
				}
			}
		}
	}
}
if( count( $aGiveawayItem ) > 0 )
	$oOrdersInfo->giveaway_item_list = $aGiveawayItem;

2. 외부 서버 통신 코드 블록 구버전 제거
./svorder.controller.php::procSvorderExtCloseDeliveryByOrder 제거
./svorder.controller.php::procSvorderExtConfirmCancelByOrder 제거
./svorder.controller.php::procSvorderExtSetInvoiceByOrder 제거

./conf/module.xml에서 아래의 코드 제거
<action name="procSvorderExtSetInvoiceByOrder" type="controller" method="GET|POST"/>
<action name="procSvorderExtConfirmCancelByOrder" type="controller" method="GET|POST"/>
<action name="procSvorderExtCloseDeliveryByOrder" type="controller" method="GET|POST"/>

3. 알림 메일 발송 기능 개선
./svorder.controller.php::sendAlarmMail() 개선
./svorder.controller.php::_encode2047() 추가

v 0.5.0
12th, Jul 2016
1. 외부 서버 전송할 때 본품과 증정품 배열의 인덱스를 통일시킴
./svorder.controller.php::transmitOrderInfoExt()에서 아래의 코드를 제거
$nItemCnt = count( $oOrdersInfo->item_list );

./svorder.controller.php::transmitOrderInfoExt()에서 아래의 코드를
$aGiveawayItem[++$nItemCnt]->item_code = $oItemInfo->item_code;
$aGiveawayItem[$nItemCnt]->price = 0;
$aGiveawayItem[$nItemCnt]->quantity = $val1->resultant_giveaway_qty;
아래와 같이 변경
$aGiveawayItem[$key]->item_code = $oItemInfo->item_code;
$aGiveawayItem[$key]->price = 0;
$aGiveawayItem[$key]->quantity = $val1->resultant_giveaway_qty;

v 0.5.1
13th, Jul 2016
1. svitem의 모듈이 생성될 때 기본 생성되는 추가등록품에서 "무료배송" 제거
./svorder.model.php::getSvitemExtraVars()에서 아래의 코드를 제거
$extra_var->column_type = "checkbox";
$extra_var->column_name = "item_delivery_free";
$extra_var->column_title = Context::getLang('cmd_delivery_fee');
$extra_var->default_value = Context::getLang('freebie');
$extra_var->required = "N";
if($extra_values["svorder_extra_1"]) $extra_var->value = $extra_values["svorder_extra_1"];
$extra_var->description = Context::getLang('about_item_delivery_fee');
$extra_vars[] = $extra_var;
unset($extra_var);

v 0.5.2
25th, Jul 2016
1. 주문관리->주문관리 화면에서 checkout_promotion_info 출력 루틴 추가
./tpl/orderdetail.html에 아래의 코드 추가
<table class="x_table">
	<thead>
		<tr>
			<th>{$lang->item_price}</th>
			<th>{$lang->discount}</th>
			<th>{$lang->amount}</th>
		</tr>
	</thead>
	<tbody>
		<tr loop="$order_info->item_list=>$key,$val">
			<td>{$val->formatMoney($order_info->sum_price)}</td>
			<td>{$val->formatMoney($order_info->total_discount_amount)}
				<block loop="$order_info->checkout_promotion_info=>$checkoupromotionkey,$checkoutpromotionval">
				<BR>{$checkoutpromotionval->title}<BR>
				</block>
			</td>
			<td>{$val->formatMoney($order_info->total_discounted_price)}</td>
		</tr>
	</tbody>
</table>

v 0.5.3
8th, Aug 2016
1. svitem의 모듈이 생성될 때 기본 생성되는 추가등록품에서 "재고" 제거
./svorder.model.php::getSvitemExtraVars()에서 아래의 코드를 제거
$extra_var->column_type = "text";
$extra_var->column_name = "stock";
$extra_var->column_title = Context::getLang('cmd_stock');
if($extra_values["svorder_extra_2"]) $extra_var->value = $extra_values["svorder_extra_2"];
$extra_var->description = Context::getLang('about_stock');
$extra_var->required = "N";
$extra_vars[] = $extra_var;

v 0.5.4
13th, Aug 2016
./svorder.model.php::getSvitemExtraVars() 제거

v 0.5.5
5th, Feb 2017
1. checkCSRF() patch 관련 안내 추가

v 0.5.6
15th, Feb 2017
./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
$oNmileageController = &getController( 'nmileage' );
$oNmileageController->plusMileage( $order_info->member_srl, $order_info->mileage, $order_info->title, $order_srl );
$args->mileage_save = 'Y';
아래와 같이 변경
$oSvmileageController = &getController( 'svreserves' );
$oSvmileageController->plusMileage( $order_info->member_srl, $order_info->mileage, $order_info->title, $order_srl );
$args->mileage_save = 'Y';

v 0.5.7
8th, Mar 2017
1. LGUPLUS escrow 결제 표시 기능 추가
./svorder.controller.php::updateOrderStatus()에서 아래의 코드를 추가
if( isset( $in_args->use_escrow ) && $in_args->use_escrow == 'Y' )
	$args->use_escrow = 'Y';

./svorder.controller.php::processCartPayment()에서 아래의 코드를 추가
$args->use_escrow = $obj->use_escrow;

./queries/updateOrderStatusSvorder.xml에 아래의 코드를 추가
<column name="use_escrow" var="use_escrow" />

./schemas/svorder_order.xml에 아래의 코드를 추가
<column name="use_escrow" type="char" size="1" default="N" />

./tpl/ordermanagement.html에 아래의 코드를 추가
<block cond="$order->use_escrow=='Y'"><div><font color='red'>에스크로결제</font></div></block>

v 0.5.8
15th, Mar 2017
1. 프로모션 구버전 데이터 호환 코드 블록 제거
./svorder.controller.php::processCartReview()에서 아래의 코드를 비활성화
else
{
	if( $val->conditional_promotion == 'fblike' )
	{
		$oConditionalPromotion = $oSvpromotionModel->getItemConditionalPromotionDetail($item_info, 'fblike' );
		if( $oConditionalPromotion->conditional_additional_discount_amount > 0 )
			$output->discounted_price = $val->price - $oConditionalPromotion->conditional_additional_discount_amount;
	}
}

2. 개별 쿠폰 사용 횟수 표시 기능 오류 수정
./svorder.controller.php::processCartPayment()에서 아래의 코드를
$oPromotionInfo = new stdClass();
if( strlen( $output->data->promotion_info ) > 0 )
	$oPromotionInfo = unserialize( $output->data->promotion_info );

아래와 같이 변경
$oCheckoutPromotionInfo = null;
if( strlen( $output->data->checkout_promotion_info ) > 0 )
	$oCheckoutPromotionInfo = unserialize( $output->data->checkout_promotion_info );

./svorder.controller.php::processCartPayment()에서 아래의 코드를
if( $oPromotionInfo->coupon_srl > 0 )
{
	$oSvPromotionController = &getController('svpromotion');
	$oSvPromotionController->procSvprmotionMarkUsedCoupon( $oPromotionInfo->coupon_srl );
}
아래와 같이 변경
$nCouponSrl = (int)$oCheckoutPromotionInfo->promotion[0]->coupon_srl;
if( $nCouponSrl > 0 )
{
	$oSvPromotionController = &getController('svpromotion');
	$oSvPromotionController->procSvprmotionMarkUsedCoupon( $nCouponSrl );
}

v 0.5.9
18th, Mar 2017
1. 존재하지 않는 주문번호의 상세정보를 조회하면 거부
./svorder.view.php::dispSvorderOrderDetail()에 아래의 코드 추가
if( !$order_info )
	return new Object(-1,'msg_invalid_order_srl');

2. 불필요한 코드 블럭 제거
./svorder.view.php::init()에 아래의 코드 제거
$logged_info = Context::get('logged_info');
if( $logged_info )
	Context::set('login_chk','Y');
else if( !$logged_info )
	Context::set('login_chk','N');

./svorder.view.php::dispSvorderNonOrderList()에 아래의 코드 제거
$logged_info = Context::get('logged_info');

./svorder.admin.controller.php::procSvorderAdminTransmitTransaction() 비활성화

./svorder.admin.controller.php::installTriggers()를 제거하고 코드블록을 moduleInstall()로 이동

./svorder.class.php::checkUpdate()에서 아래의 코드 비활성화
$oSvitemModel =  &getModel('svitem');

./svorder.class.php::moduleUpdate() 제거

v 0.6.0
20th, Mar 2017
1. PG 사와 통신 오류 가능성이 있는 주문 복구 기능 추가
./svorder.admin.view.php::dispSvorderAdminRecoverTransaction() 추가
./tpl/order_recover.html 추가

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에 아래의 코드 추가
if( $args->order_status == 2 ) // 외부 서버 전송 상태일 때, PG 통신 실패한 경우, 외부서버에 수기 전송을 위해
{
	$oModuleModel = &getModel('module');
	foreach( $output->data as $key=>$val ) 
	{
		if( is_null( $val->thirdparty_order_id ) )
		{
			$oRst = $oModuleModel->getModuleInfoByModuleSrl($val->module_srl);
			if( $oRst->module == 'svcart' )
				$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', '','act','dispSvcartOrderComplete','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."'>".$config->external_server."주문번호받기</a>";
			else
				$output->data[$key]->thirdparty_order_id = '연결된 장바구니 모듈 에러';
		}
	}
}

v 0.6.1
27th, Mar 2017
1. 주문상태가 변경될 때에만 주문관련 SMS 통지 기능 실행하도록 추가
./svorder.controller.php::updateOrderStatus()에 아래의 코드 추가
$output = executeQuery( 'svorder.getOrderInfo', $args );
if( !$output->toBool() )
	return $output;

if( $nOriginalOrderStatus != $in_args->order_status )
{
	$oSvcrm = getClass('svcrm');
	if( !is_null( $oSvcrm ) )
	{
		$args->country_code = 82;//$country_code;
		$args->recipient_no = '01031755222';
		$args->sender_no = '0805001479';//$config->sender_no;
		$args->content = 'osrl:'.$args->order_srl.' ostat:'.$in_args->order_status;
		$oSmsController = &getController('textmessage');
		if($oSmsController)
		{
			
			switch( $in_args->order_status )
			{
				case 1: //입금대기
					break;
				case 2: //입금완료
					break;
				case 4: //배송중
					break;
				case 5: //배송완료
					break;
			}
			$output = $controller->sendMessage($args);
		}
	}
}

v 0.6.2
30th, Mar 2017
1. 주문상태가 안내 SMS 통지 기능을 SVCRM으로 이전
./svorder.controller.php::updateOrderStatus()에 아래의 코드를
./svcrm.controller.php::notifyOrderStatusUpdate()로 이동

v 0.6.3
5th, Apr 2017
1. 관리자 거래원장 다운로드할 때 카트보관,입금대기 상태를 제외하고 모든 거래가 다운되도록 변경
./queries/getOrderListAll.xml에서 아래의 코드를 비활성화
<condition operation="less" column="order_status" var="order_status_max" pipe="and">

v 0.6.4
11th, Apr 2017
1. 통신 오류 PG 거래를 복구시킨 후 외부서버 주문번호 획득 링크를 새창 열기로 전환
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', '','act','dispSvcartOrderComplete','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."'>".$config->external_server."주문번호받기</a>";
아래와 같이 변경
$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', '','act','dispSvcartOrderComplete','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."' target='_new'>".$config->external_server."주문번호받기</a>";

v 0.6.5
13th, Apr 2017
1. 사용하지 않는 코드 비활성화
./svorder.controller.php::processCartPayment()에 아래의 코드를 비활성화
$oSvorderModel = &getModel('svorder');
$oModuleModel = &getModel('module');
$logged_info = Context::get('logged_info');

v 0.6.6
22nd, Apr 2017
1. svcrm 모듈의 주문취소 완료 상태 전송 판단 코드 변경
주문상태 0과 주문상태 A가 같은 값으로 인식됨
./svorder.controller.php::updateOrderStatus()에서 아래의 코드를 
if( $nOriginalOrderStatus != $in_args->order_status )
아래와 같이 변경
if( $nOriginalOrderStatus !== $in_args->order_status )

v 0.6.7
16th, May 2017
1. 게시판의 회원 정보 팝업 메뉴 수정
./svorder.controller.php::triggerMemberMenu()에 아래의 코드를 비활성화
$url = getUrl('','module','svorder','act','dispSvorderAdminPurchaserInfo','member_srl',Context::get('target_srl'));
$oMemberController = &getController('member');
$oMemberController->addMemberPopupMenu($url, Context::getLang('cmd_purchaser_info'), '', 'popup');

if(Context::get('cympusadmin_menu')) 
	$url = getUrl('','module','cympusadmin','act','dispSvorderAdminOrderManagement','search_key','member_srl','search_value',Context::get('target_srl'));
else

아래의 코드를
$oMemberController->addMemberPopupMenu($url, '주문관리');
아래와 같이 변경
$oMemberController->addMemberPopupMenu($url, Context::getLang('cmd_order_management'), '', 'popup');

./svorder.admin.view.php::dispSvorderAdminPurchaserInfo() 비활성화
./queries/getOrderList.xml를 getAdminOrderList.xml로 변경
./svorder.admin.model.php::getOrdersByMemberSrl() 추가

v 0.6.8
20th, May 2017
1. svorder에서 주문서 화면 처리
./svorder.view.php::dispSvorderOrderForm() 추가
./svorder.view.php::dispSvorderOrderComplete() 추가

2. svorder와 svpg 연결
./svorder.admin.view.php::dispSvorderAdminInsertModInst()에 아래의 코드 추가
$oSvpgModel = &getModel('svpg');
$oSvPgModules = $oSvpgModel->getSvpgList();
Context::set('svpg_modules', $oSvPgModules);

3. 주문서 전처리 메소드 추가
./svorder.controller.php::processCartReview() 체거
./svorder.controller.php::precheckOrder() 추가
./svorder.controller.php::_insertCartItem() 추가
./svorder.controller.php::_insertOrder() 추가
./svorder.controller.php::_getCheckoutPromtion() 추가
./svorder.controller.php::_getExtraFields() 추가

4. 주문서 후처리 메소드 추가
./svorder.controller.php::processCartPayment() 체거
./svorder.controller.php::completePgProcess() 추가

v 0.6.9
22nd, May 2017
1. 무의미한 trigger 제거
./svorder.class.php::moduleInstall()에서 아래 코드 제거
// svitem 상품등록, 수정 할 때 처리모듈 목록 취합
if (!$oModuleModel->getTrigger('svitem.getProcModules', 'svorder', 'model', 'triggerGetProcModules', 'before')) 
	$oModuleController->insertTrigger('svitem.getProcModules', 'svorder', 'model', 'triggerGetProcModules', 'before');

./svorder.class.php::checkUpdate()에서 아래 코드 제거
if(!$oModuleModel->getTrigger('svitem.getProcModules', 'svorder', 'model', 'triggerGetProcModules', 'before')) return true;

./svorder.model.php::triggerGetProcModules() 제거

v 0.7.0
23rd, May 2017
1. 외부 물류 서버에 거래 통지 기능 일원화
./svorder.view.php::dispSvorderOrderComplete()에서 아래 코드 제거
$oSvorderController = &getController('svorder');
$oSvorderController->transmitOrderInfoExt( $nOrderSrl );
$oSvorderController->sendAlarmMail( $nOrderSrl );

./svorder.view.php::transmitOrderInfoExt()에서 아래 코드를
if( $oOrdersInfo->order_status != '2' )
	return new Object();
아래와 같이 변경
if( $nOrderState != '2' )
	return new Object();

./queries/getOrderItemsForPg.xml 추가
./svorder.model.php::getOrderInfoForPayment() 추가
./svorder.model.php::_constructItemInfoByOrder() 추가
./svorder.model.php::getOrderInfo() 에서 아래의 코드를 
$oSvitemModel = &getModel('svitem');
$config = $this->getModuleConfig();
foreach( $aItemList as $key=>$val )
{
	$aBundlingInfo = Array();
	$item = new svitemItem( $val, $config->currency, $config->as_sign, $config->decimals );
	$oBundlingInfo = unserialize( $item->bundling_order_info );

	$nBundlingIdx = 0;
	foreach( $oBundlingInfo as $key2 => $val2 )
	{
		$oItemInfo = $oSvitemModel->getItemInfo( $val2->bundle_item_srl );
		$aBundlingInfo[$nBundlingIdx]->bundling_item_name = $oItemInfo->item_name;
		$aBundlingInfo[$nBundlingIdx++]->bundle_quantity = $val2->bundle_quantity;
	}
	$item->bundling_infos = $aBundlingInfo;
	
	$aDiscountInfo = Array();
	$oDiscountInfo = unserialize( $item->discount_info );
	$nPromotionIdx = 0;
	foreach( $oDiscountInfo->promotion as $key2 => $val2 )
	{
		$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
		$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->unit_disc_amnt;
	}
	$oConditionalDiscountInfo = unserialize( $item->conditional_promotion );
	foreach( $oConditionalDiscountInfo->promotion as $key2 => $val2 )
	{
		$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
		$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->resultant_disc_amnt;
	}
	$item->discount_info = $aDiscountInfo;
	$aItemList[$key] = $item;
}
아래와 같이 변경
$this->_constructItemInfoByOrder( $item_list);

2. svitem 관련 기능 제거
./svorder.controller.php::updateStock() 제거
./svorder.controller.php::completePgProcess()에서 아래의 코드 제거
$output = $this->updateStock($obj->order_srl, $order_status);

v 0.7.1
27th, May 2017
1. 주문 레코드에서 사용한 쿠폰 일련번호 항목 추가
./svorder.model.php::getOrderInfo()에서 아래의 코드 추가
$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->coupon_srl = $ccpromoval->coupon_srl;

v 0.7.2
28th, May 2017
1. 결제 완료 페이지에 사용 쿠폰 정보 추가
./svorder.view.php::dispSvorderOrderComplete()에서 아래의 코드 제거
$oCheckoutPromotionInfo = unserialize( $oOrderInfo->checkout_promotion_info );
$nCheckoutPromoIdx = 0;
foreach( $oCheckoutPromotionInfo->promotion as $ccpromokey => $ccpromoval )
{
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->title = $ccpromoval->title;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx++]->total_disc_amnt = $ccpromoval->total_disc_amnt;
}
$oOrderInfo->checkout_promotion_info = $aCheckoutPromotionInfo;

2. 주문상태 변경 관련 메소드 추가
./svorder.admin.controller.php::procSvorderAdminUpdateStatus()에서 아래의 코드를
$output = $oSvorderController->updateStock( $order_srl, $order_status );
아래와 같이 변경
$output = $this->_updateStock( $order_srl, $order_status );

./svorder.admin.controller.php::_updateStock() 추가

3. svpromotion으로 적립금 기록 이동
./schemas/svorder_order.xml에서 아래의 코드 제거
<column name="mileage" type="number" size="11" default="0" notnull="notnull" />
<column name="mileage_save" type="char" size="1" default="N" notnull="notnull" />
<column name="use_mileage" type="number" size="11" default="0" notnull="notnull" />

./schemas/svorder_order.xml에서 아래의 코드 추가
<column name="reserves_spent" type="char" size="1" default="N" notnull="notnull" />
<column name="reserves_take" type="char" size="1" default="N" notnull="notnull" />

./queries/insertOrder.xml에서 아래의 코드 제거
<column name="mileage" var="mileage" />
<column name="use_mileage" var="use_mileage" />

./queries/insertOrder.xml에서 아래의 코드 추가
<column name="reserves_spent" var="reserves_spent" />
<column name="reserves_take" var="use_mileage" />

./queries/updateOrderStatusSvorder.xml에서 아래의 코드 제거
<column name="mileage_save" var="mileage_save" />

./svorder.controller.php::_insertOrder()에서 아래의 코드를
// reserve information
if( $oInArgs->use_mileage )
	$oInArgs->cart->total_price -= (int)$oInArgs->use_mileage;
// calculate reserve
$oInArgs->mileage = 0;
$oConfig = $oSvcartModel->getModuleConfig();
if( $oConfig->mileage_percent )
	$oInArgs->mileage = round($oInArgs->cart->total_price * ((float)$oConfig->mileage_percent/100));
$oOrderArgs->mileage = $oInArgs->input_mileage;
$oOrderArgs->use_mileage = $oInArgs->use_mileage;

아래와 같이 변경
$oOrderArgs->reserves_consume_srl = $oInArgs->reserves_consume_srl;

./svorder.controller.php::_validateReservesClaimed() 추가
./svorder.controller.php::_consumeReserves() 추가

./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
$oSvreservesModel = &getModel('svreserves');
$oMileageConfig = $oSvreservesModel->getModuleConfig();
Context::set('use_mileage', $oMileageConfig->use_flag);
아래와 같이 변경
$oSvpromotionModel = &getModel('svpromotion');
$oSvpromotionConfig = $oSvpromotionModel->getModuleConfig();
$aReservesInfo = array();
if( $oSvpromotionConfig->allow_reserves_consumption == 'Y' )
{
	$aReservesInfo['use_reserves'] = $oSvpromotionConfig->allow_reserves_consumption;
	$nRemainingReserves = $oSvpromotionModel->getRemainigReservesByMemberSrl($logged_info->member_srl);
	$aReservesInfo['minimum_reserves_available'] = $oSvpromotionConfig->minimum_reserves_available;
	$aReservesInfo['my_reserves'] = $nRemainingReserves;
}
Context::set('reserves_info', $aReservesInfo);

./svorder.model.php::getSvorderReservesValidation() 추가
./svorder.model.php::validationReservesClaimed() 추가
./svorder.model.php::_validateReservesClaimed() 추가
./tpl/skin.js/orderitems.js::validateReserves() 추가

./svorder.controller.php::completePgProcess()에서 아래의 코드를
if($oOrder->reserves_consume_srl) // updateorderstatus의 거래완료시 적립금 지급 코드 명심
{
	$oSvreserveController = &getController('svreserves');
	$output = $oSvreserveController->minusMileage($oOrder->member_srl, $oOrder->use_mileage, $oOrder->title, $oOrder->order_srl);
	if(!$output->toBool()) 
		return $output;
}
$nCouponSrl = (int)$oOrder->checkout_promotion_info[0]->coupon_srl;
if( $nCouponSrl > 0 )
{
	$oSvPromotionController = &getController('svpromotion');
	$oSvPromotionController->procSvprmotionMarkUsedCoupon( $nCouponSrl );
}

아래와 같이 변경
$oSvPromotionController = &getController('svpromotion');
if($oOrder->reserves_consume_srl) // updateorderstatus의 거래완료시 적립금 지급 코드 명심
	$oSvPromotionController->activateReservesLog( $oOrder->reserves_consume_srl );
$nCouponSrl = (int)$oOrder->checkout_promotion_info[0]->coupon_srl;
if( $nCouponSrl > 0 )
	$oSvPromotionController->procSvprmotionMarkUsedCoupon( $nCouponSrl );

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
if( $order_info->reserves_consume_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLog( $order_info->reserves_consume_srl  );
	if( $output->get('mode') == '-' )
		$order_info->consumed_reserves_amount = $output->get('amount');
}
./tpl/ordersheet.html 변경

./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
if( $order_info->member_srl && $order_info->mileage && $order_info->mileage_save=='N' )
{
	$oSvmileageController = &getController( 'svreserves' );
	$oSvmileageController->plusMileage( $order_info->member_srl, $order_info->mileage, $order_info->title, $order_srl );
	$args->mileage_save = 'Y';
}
아래와 같이 변경
if( $order_info->member_srl )
{
	$oSvpromotionController = &getController( 'svpromotion' );
	$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price, $order_info->member_srl );
	$nReservesSrl = (int)$output->get('reserves_srl');
	if( $nReservesSrl )
		$args->reserves_receive_srl = $nReservesSrl;
}

./queries/updateOrderStatusSvorder.xml에 아래의 코드 추가
<column name="reserves_receive_srl" var="reserves_receive_srl" />

4. 미사용 필드 제거
./schemas/svorder_order.xml에서 아래의 코드 제거
<column name="purchaser_telnum" type="varchar" size="80" notnull="notnull" />

v 0.7.3
6th, Jun 2017
1. 사용자 주문관리 화면 UI 정리
./tpl/skin.js/script.js에 아래의 코드 추가
jQuery(function($){
	var option = {
		changeMonth: true,
		changeYear: true,
		gotoCurrent: false,
		yearRange:'-100:+10',
		dateFormat:'yy-mm-dd',
		onSelect:function() {
			$(this).prev('input[type="hidden"]').val(this.value.replace(/-/g,""))}
		};
	$.extend(option,$.datepicker.regional['{$lang_type}']);
	$(".inputDate").datepicker(option);
	$(".dateRemover").click(function() {
		$(this).parent().prevAll('input').val('');
		return false;
	});
	//$('.escrow').escrow();

	$('#receipt').click(function() {
		var order_srl = $(this).attr('data-order-srl');
		var $_parent = $(this).parent();
		exec_xml(
			'svpg',
			'getSvpgReceipt',
			{order_srl:order_srl},
			function(ret){
				var tpl = ret.tpl.replace(/<enter>/g, '\n');
				$_parent.html(tpl);
			},
			['error','message','tpl']
		);

	});
});

function _addDays(myDate, days) 
{
	return new Date(myDate.getTime() + days*24*60*60*1000);
}

function _addMonth(currDate, month) 
{
	var currDay   = currDate.getDate();
	var currMonth = currDate.getMonth();
	var currYear  = currDate.getFullYear();
	var ModMonth = currMonth + month;
	if (ModMonth > 12) 
	{
		ModMonth = ModMonth - 12;
		currYear = currYear + 1;
	}
	if (ModMonth < 0) 
	{
		ModMonth = 12 + (ModMonth);
		currYear = currYear - 1;
	}
	return new Date(currYear, ModMonth, currDay);
}

2. 사용자 주문 취소 기능 추가
./svorder.controller.php::procSvorderCancelSettlement() 추가

3. 미사용코드 비활성화
./svorder.view.php::dispSvorderOrderDetail()에서 아래의 코드 비활성화
Context::set( 'soldout_process', $this->soldout_process );

./svorder.class.php::svorder()에서 아래의 코드 비활성화
var $soldout_process = array(
	'P' => '포인트로 환불','C' => '현금으로 환불','H' => '전화요망','R' => '대체상품으로 배송'
);

./svorder.class.php::getSvorderModules() 비활성화

v 0.7.4
11th, Jun 2017
1. svitem_item tbl::category_id 제거 대응
./queries/getCartItems.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />
./queries/getNonOrderItems.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />
./queries/getOrderedItemsByOrderSrl.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />
./queries/getOrderItems.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />
./queries/getOrderItemsByStatus.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />
./queries/getOrderItemsForPg.xml에서 아래의 코드 제거
<column name="items.category_id" alias="category_id" />

2. svitem_item tbl::node_route 제거 대응
./queries/getNonOrderItems.xml에서 아래의 코드 제거
<column name="items.node_route" alias="node_route" />
./queries/getOrderItems.xml에서 아래의 코드 제거
<column name="items.node_route" alias="node_route" />
./queries/getOrderItemsByStatus.xml에서 아래의 코드 제거
<column name="items.node_route" alias="node_route" />
./queries/getOrderItemsForPg.xml에서 아래의 코드 제거
<column name="items.node_route" alias="node_route" />

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
if( $oRst->module == 'svcart' )
아래와 같이 변경
if( $oRst->module == 'svorder' )

./svorder.model.php::getOrderTitle()에서 아래의 코드를 제거
if($val->module != 'svorder') 
	continue;

3. checkout promotion 점검 변경
./svorder.controller.php::_getCheckoutPromtion()에서 아래의 코드를 
$sCouponSerial = $oInArgs->coupon_number;
if( strlen( trim( $sCouponSerial ) ) > 0 )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getCheckoutPrice( $oInArgs );
	if( !$output->toBool() )
		return $output;
	$nDiscAmnt = $output->get('total_discount_amount');
	if( $nDiscAmnt > 0 )
	{
		$oInArgs->cart->total_discount_amount = $nDiscAmnt;
		$oCheckoutPromotionInfo = new stdClass();
		$oCheckoutPromotionInfo->version = '1.0';
		$oCheckoutPromotionInfo->promotion[0]->type = 'coupon';
		$oCheckoutPromotionInfo->promotion[0]->coupon_srl = $output->get('coupon_srl');
		$oCheckoutPromotionInfo->promotion[0]->total_disc_amnt = $nDiscAmnt;
		$oCheckoutPromotionInfo->promotion[0]->title = $output->get('promotion_info');
		$oInArgs->cart->promotion_info = $oCheckoutPromotionInfo;
	}
}
아래와 같이 변경
$oSvpromotionModel = &getModel('svpromotion');
$output = $oSvpromotionModel->getCheckoutPrice( $oInArgs );
if( !$output->toBool() )
	return $output;
$nDiscAmnt = (int)$output->get('total_discount_amount');
if( $nDiscAmnt > 0 )
{
	$oInArgs->cart->total_discount_amount = $nDiscAmnt;
	$oInArgs->cart->promotion_info = $oCheckoutPromotionInfo;
}

4. 미사용 코드 삭제
./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드 제거
Context::set( 'shipping_fee_payment_type', $oSvcartConfig->shipping_fee_payment_type );
Context::set( 'freedeliv_amount', $oSvcartConfig->freedeliv_amount );

5. 주문정보 입력 화면에서 사이트 수량 할인 표시
./svorder.view.php::dispSvorderOrderForm()에 아래의 코드 추가
$oSvpromotionModel = &getModel('svpromotion');
$oTempArgs->cart = $oCart;
$oCheckoutPromotion = $oSvpromotionModel->getCheckoutPrice( $oTempArgs );
if( !$oCheckoutPromotion->toBool() )
	return $oCheckoutPromotion;
$nTotalDiscountAmnt = (int)$oCheckoutPromotion->get('total_discount_amount');
if( $nTotalDiscountAmnt )
{
	$oCart->total_discount_amount = $nTotalDiscountAmnt;
	$oCart->total_price = $oCart->sum_price - $oCart->total_discount_amount + $oCart->delivery_fee;
	$oPromotionInfo = $oCheckoutPromotion->get('promotion_info');
	Context::set( 'promotion_title', $oPromotionInfo->promotion[0]->title );
}
$nRecommendedQtyRange = (int)$oCheckoutPromotion->get('recommeded_qty_range');
if( $nRecommendedQtyRange )
{
	$fBulkDiscountRecommendedRate = (float)$oCheckoutPromotion->get('recommeded_discount_rate');
	$aBulkDiscountRecommendedItemList = $oCheckoutPromotion->get('recommeded_item_list');
	$nRemainingQty = (int)$oCheckoutPromotion->get('remaining_qty');
	Context::set( 'recommended_bulk_discount_rate', $fBulkDiscountRecommendedRate*100 );
	Context::set( 'recommended_bulk_item_list', $aBulkDiscountRecommendedItemList );
	Context::set( 'recommended_remaining_qty', $nRemainingQty );
}

6. 할인 쿠폰 검증 방식 변경
./svorder.view.php::getSvorderCouponValidation()에서 아래의 코드를
$sCouponSerial = Context::get('coupon_number');
$sCartNos = trim( Context::get('cartnos') );
$aCartNos = explode( ',', $sCartNos );

$aQuantityByItem = Array();
$nOriginalPayAmnt = 0;
$nAlreadyDiscountedPayAmnt = 0;
$oSvcartModel = &getModel('svcart');
foreach( $aCartNos as $key => $val )
{
	$aSingleCartInfo = $oSvcartModel->getCartItem( $val );
	// 이미 적용된 할인 혜택을 계산
	$nOriginalPayAmnt += $aSingleCartInfo->price * $aSingleCartInfo->quantity;
	$nAlreadyDiscountedPayAmnt += ($aSingleCartInfo->price - $aSingleCartInfo->discount_amount)*$aSingleCartInfo->quantity;
	if( $aSingleCartInfo !== NULL )
		$aDiscountPolicyTable[$aSingleCartInfo->item_srl] += $aSingleCartInfo->quantity;
}

$oSvpromotionModel = &getModel('svpromotion');
$output = $oSvpromotionModel->getCouponInfoBySerialNumber( $sCouponSerial, $nOriginalPayAmnt, $nAlreadyDiscountedPayAmnt );
if (!$output->toBool())
	return $output;

$this->add('disctype', $output->data->descount_type);
$this->add('discpolicy', $output->data->discpolicy);
$this->add('promotion_title', $output->data->promotion_title);

아래와 같이 변경
$sCouponSerial = Context::get('coupon_number');
$sCartNos = trim( Context::get('cartnos') );
$nOriginalPayAmnt = 0;
$nAlreadyDiscountedPayAmnt = 0;
$oSvcartModel = &getModel('svcart');
$oCart = $oSvcartModel->getCartInfo( $sCartNos );
if(!count($oCart->item_list))
	return new Object(-1, Context::getLang('msg_no_items') );

$oSvpromotionModel = &getModel('svpromotion');
$oTempArgs->cart = $oCart;
$oTempArgs->coupon_number = $sCouponSerial;
$oCheckoutPromotion = $oSvpromotionModel->getCheckoutPrice( $oTempArgs );
if( !$oCheckoutPromotion->toBool() )
	return $oCheckoutPromotion;

$this->add('disctype', $oCheckoutPromotion->get('disctype'));
$this->add('discpolicy', $oCheckoutPromotion->get('discpolicy'));
$this->add('promotion_title', $oCheckoutPromotion->get('promotion_title'));

v 0.7.5
17th, Jun 2017
1. svreserves 모듈 제거 대응
./svorder.view.php::dispSvorderOrderComplete()에서 아래의 코드 제거
$oSvreservesModel = &getModel('svreserves');
$mileage_config = $oSvreservesModel->getModuleConfig();
Context::set('mileage_flag', $mileage_config->use_flag);
Context::set('use_mileage', $mileage_config->use_flag);

v 0.7.6
19th, Jun 2017
1. 불필요한 tbl::svorder_order 필드 제거
./schemas/svorder_order.xml에서 아래의 코드 제거
<column name="taxation_amount" type="number" size="11" default="0" notnull="notnull" />
<column name="supply_amount" type="number" size="11" default="0" notnull="notnull" />
<column name="vat" type="number" size="11" default="0" notnull="notnull" />
<column name="taxfree_amount" type="number" size="11" default="0" notnull="notnull" />

./svorder.controller.php::_insertOrder()에서 아래의 코드를 제거
$oOrderArgs->taxation_amount = $oInArgs->cart->taxation_amount;
$oOrderArgs->supply_amount = $oInArgs->cart->supply_amount;
$oOrderArgs->taxfree_amount = $oInArgs->cart->taxfree_amount;
$oOrderArgs->vat = $oInArgs->cart->vat;

./queries/insertOrder.xml에서 아래의 코드 제거
<column name="taxation_amount" var="taxation_amount" notnull="notnull" />
<column name="supply_amount" var="supply_amount" notnull="notnull" />
<column name="taxfree_amount" var="taxfree_amount" notnull="notnull" />
<column name="vat" var="vat" notnull="notnull" />

./svorder.admin.model.php::getDefaultDataFormConfig()에서 아래의 코드 제거
'taxation_amount', 'supply_amount', 'vat', 'taxfree_amount',

./svorder.admin.model.php::getDataFormatConfig()에서 아래의 코드 제거
'taxation_amount', 'supply_amount', 'vat', 'taxfree_amount',

2. 불필요한 tbl::svorder_cart 필드 제거
./schemas/svorder_cart.xml에서 아래의 코드 제거
<column name="review_srl" type="number" size="11" default="0" notnull="notnull" index="idx_review_srl" />

3. 관리자의 에스크로 사용 여부 선택 항목 제거
./tpl/ordermanagement.html에서 아래의 코드 제거
<th scope="col" cond="$module_config->escrow_yn=='Y'">{$lang->escrow}</th>


4. 주문관리자의 에스크로 거래 처리 화면 변경
./tpl/config.html에서 아래의 코드 제거
<div class="x_control-group">
	<label class="x_control-label">{$lang->use_escrow}</label>
	<div class="x_controls">
		<select name="escrow_yn">
			<option value="N" selected="selected"|cond="$config->escrow_yn == 'N'">{$lang->notuse}</option>
			<option value="Y" selected="selected"|cond="$config->escrow_yn == 'Y'">{$lang->use}</option>
		</select>
		<a href="#escrow_yn_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="escrow_yn_help" class="x_help-block" hidden>{$lang->about_escrow}</p>
	</div>
</div>

./svorder.view.php::dispSvorderAdminEscrowDelivery()에서 아래의 코드를
$this->setTemplateFile('extra');
아래와 같이 변경
$this->setTemplateFile('content_form');

./svorder.view.php::dispSvorderAdminEscrowDenyConfirm()에서 아래의 코드를
$this->setTemplateFile('extra');
아래와 같이 변경
$this->setTemplateFile('content_form');

./tpl/content_form.html 추가

5. svcart의 배송비 관련 설정을 흡수
./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
Context::set( 'total_price', $oCart->total_price );
Context::set( 'delivery_fee', $oCart->delivery_fee );
아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$nDeliveryFee = $oSvorderModel->getDeliveryFee();
Context::set( 'total_price', $oCart->total_price + $nDeliveryFee );
Context::set( 'delivery_fee', $nDeliveryFee );

./svorder.view.php::_insertOrder()에서 아래의 코드를
if( $oConfig->shipping_fee_payment_type == 'prepaid' )
{
	$oOrderArgs->delivfee_inadvance = 'Y';
	$total_price += $oInArgs->cart->delivery_fee;
}
if( $oConfig->shipping_fee_payment_type == 'postpaid' )
{
	$oOrderArgs->delivfee_inadvance = 'N';
	$oOrderArgs->cart->total_price -= $oInArgs->cart->delivery_fee;
	$oOrderArgs->cart->delivery_fee = 0;
}
아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$nDeliveryFee = $oSvorderModel->getDeliveryFee();
if( $nDeliveryFee )
{
	$oOrderArgs->delivfee_inadvance = 'Y';
	$oInArgs->cart->total_price += $nDeliveryFee;
	$oInArgs->price += $nDeliveryFee;
	$oInArgs->cart->delivery_fee = $nDeliveryFee;
}
else
{
	$oOrderArgs->delivfee_inadvance = 'N';
	$oInArgs->cart->delivery_fee = 0;
}

./svorder.model.php::getDeliveryFee() 추가

./tpl/config.html에 아래의 코드 추가
./tpl/config.html에서 아래의 코드 제거
<div class="x_control-group">
	<label class="x_control-label" for="">{$lang->shipping_fee_payment_type}</label>
	<div class="x_controls">
		<select name="shipping_fee_payment_type">
			<option value="postpaid" selected="selected"|cond="$config->shipping_fee_payment_type == '' || $config->shipping_fee_payment_type == 'postpaid'">{$lang->shipping_cost_postpaid}</option>
			<option value="prepaid" selected="selected"|cond="$config->shipping_fee_payment_type == 'prepaid'">{$lang->shipping_cost_prepaid}</option>				
			<option value="buyer_define" selected="selected"|cond="$config->shipping_fee_payment_type == 'buyer_define'">{$lang->shipping_cost_buyer_define}</option>
		</select>
		<a href="#shipping_fee_payment_type_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="shipping_fee_payment_type_help" class="x_help-block" hidden>{$lang->about_shipping_fee_payment_type}</p>
	</div>
</div>
<div class="x_control-group">
	<label class="x_control-label" for="delivery_fee">{$lang->delivery_fee}</label>
	<div class="x_controls">
		<input type="text" name="delivery_fee" value="{$config->delivery_fee}" />
		<a href="#delivery_fee_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="delivery_fee_help" class="x_help-block" hidden>{$lang->about_delivery_fee}</p>
	</div>
</div>
<div class="x_control-group">
	<label class="x_control-label" for="freedeliv_amount">{$lang->amount_for_free_delivery}</label>
	<div class="x_controls">
		<input type="text" name="freedeliv_amount" value="{$config->freedeliv_amount}" />
		<a href="#freedeliv_amount" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="freedeliv_amount" class="x_help-block" hidden>{$lang->about_free_delivery}</p>
	</div>
</div>
<div class="x_control-group">
	<label class="x_control-label" for="guest_buy">{$lang->guest_buy}</label>
	<div class="x_controls">
		<select name="guest_buy">
			<option value="N" selected="selected"|cond="$config->guest_buy == 'N'">{$lang->notuse}</option>
			<option value="Y" selected="selected"|cond="$config->guest_buy == 'Y'">{$lang->use}</option>
	    </select>
		<a href="#guest_buy_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="guest_buy_help" class="x_help-block" hidden>{$lang->about_guest_buy}</p>
	</div>
</div>

6. svcart의 비회원구매 허용 설정을 흡수
./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
$oSvcartModel = &getModel('svcart');
$oSvcartConfig = $oSvcartModel->getModuleConfig();
Context::set('config', $oSvcartConfig );

$logged_info = Context::get('logged_info');
if( $oSvcartConfig->guest_buy != 'Y' && !$logged_info )
	return new Object(-1, 'msg_no_guest_buy');
아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$oSvorderConfig = $oSvorderModel->getModuleConfig();
$logged_info = Context::get('logged_info');
if( $oSvorderConfig->guest_buy != 'Y' && !$logged_info )
	return new Object(-1, 'msg_no_guest_buy');

Context::set('config', $oSvorderConfig );

./svorder.view.php::dispSvorderOrderList()에서 아래의 코드를
$oSvorderModel = &getModel('svorder');
$config = $oSvorderModel->getModuleConfig();
Context::set('config',$config);

$logged_info = Context::get('logged_info');
if(!$logged_info && $config->guest_buy=='N')
	return new Object(-1, 'msg_login_required');

아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$config = $oSvorderModel->getModuleConfig();
Context::set('config',$config);

$logged_info = Context::get('logged_info');
if(!$logged_info && $config->guest_buy=='N')
	return new Object(-1, 'msg_login_required');

v 0.7.7
20th, Jun 2017
1. 외부 물류 서버 주문 번호 수동으로 받기
./svorder.controller.php::procSvorderAdminTransmitTransaction() 추가
./tpl/orderdetail.html에서 아래의 코드 추가
function transmitSettlement( nOrderSrl )
{
	if( typeof nOrderSrl == 'undefined' )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	if( nOrderSrl.length == 0 )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	var sManualTransmitReason = prompt("수기로 주문전송하는 사유를 입력해 주세요.", "예)PG사 통신 오류");
	if( sManualTransmitReason == null )
		return;
	else if( sManualTransmitReason == "예)PG사 통신 오류" || sManualTransmitReason == '' || sManualTransmitReason == null )
	{
		alert( '수기 주문 전송 사유를 입력해 주세요.' );
		return;
	}

	var params = new Array();
	params['order_srl'] = nOrderSrl;
	params['manual_transmit_reason'] = sManualTransmitReason;
	exec_xml('svorder', 'procSvorderAdminTransmitTransaction', params, function(ret_obj){
		alert(ret_obj['message']);
		jQuery('#btnTransmitExtl').attr('disabled','disabled');
	});
}

v 0.7.8
21st, Jun 2017
1. 관리자 주문서 화면에서 배송비 지불 방식 표시 오류 수정

./svorder.controller.php::_insertOrder()에서 아래의 코드를
$nDeliveryFee = $oSvorderModel->getDeliveryFee($oInArgs->price);
if( $nDeliveryFee )
{
	$oOrderArgs->delivfee_inadvance = 'Y';
	$oInArgs->cart->total_price += $nDeliveryFee;
	$oInArgs->price += $nDeliveryFee;
	$oInArgs->cart->delivery_fee = $nDeliveryFee;
}
else
{
	$oOrderArgs->delivfee_inadvance = 'N';
	$oInArgs->cart->delivery_fee = 0;
}
아래와 같이 변경
$oDeliveryFeeRst = $oSvorderModel->getDeliveryFee($oInArgs->price);
if( $oDeliveryFeeRst->delivery_fee_pay_mode == 'free' || $oDeliveryFeeRst->delivery_fee_pay_mode == 'pre' )
{
	$oOrderArgs->delivfee_inadvance = 'Y';
	$oInArgs->cart->total_price += $oDeliveryFeeRst->delivery_fee;//$nDeliveryFee;
	$oInArgs->price += $oDeliveryFeeRst->delivery_fee;//$nDeliveryFee;
	$oInArgs->cart->delivery_fee = $oDeliveryFeeRst->delivery_fee;//$nDeliveryFee;
}
else
{
	$oOrderArgs->delivfee_inadvance = 'N';
	$oInArgs->cart->delivery_fee = 0;
}

./svorder.model.php::getDeliveryFee()에서 아래의 코드를
if( $nTotalPayment >= $oConfig->freedeliv_amount )
	return 0;
if( $oConfig->shipping_fee_payment_type == 'prepaid' )
	return (int)$oConfig->delivery_fee;
else if( $oConfig->shipping_fee_payment_type == 'postpaid' )
	return 0;

아래와 같이 변경
if( $nTotalPayment >= $oConfig->freedeliv_amount )
{
	$oRst->delivery_fee_pay_mode = 'free';
	$oRst->delivery_fee = 0;
}
else if( $oConfig->shipping_fee_payment_type == 'prepaid' )
{
	$oRst->delivery_fee_pay_mode = 'pre';
	$oRst->delivery_fee = (int)$oConfig->delivery_fee;
}
	
else if( $oConfig->shipping_fee_payment_type == 'postpaid' )
{
	$oRst->delivery_fee_pay_mode = 'post';
	$oRst->delivery_fee = 0;
}
return $oRst;

./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
$nDeliveryFee = $oSvorderModel->getDeliveryFee($oCart->total_price);
Context::set( 'total_price', $oCart->total_price + $nDeliveryFee );
Context::set( 'delivery_fee', $nDeliveryFee );
아래와 같이 변경
$oDeliveryFeeRst = $oSvorderModel->getDeliveryFee($oCart->total_price);
Context::set( 'total_price', $oCart->total_price + $oDeliveryFeeRst->delivery_fee );
Context::set( 'delivery_fee', $oDeliveryFeeRst->delivery_fee );

v 0.7.9
22nd, Jun 2017
1. svpromotino의 쿠폰 사용내역 추적 기능 추가에 대응
./svorder.controller.php::completePgProcess()에서 아래의 코드를
$oSvPromotionController->procSvprmotionMarkUsedCoupon( $nCouponSrl );
아래와 같이 변경
$oSvPromotionController->procSvprmotionMarkUsedCoupon( $oOrder );

v 0.8.0
24th, Jun 2017
1. 결제 쿠폰 입력되면 개별 상품 프로모션 내용 무시
./svorder.model.php::dispSvorderOrderDetail()에 아래의 코드 추가
foreach( $oOrderInfo->item_list as $key=>$val)
{
	if( $oOrderInfo->checkout_promotion_info ) // 결제 할인 적용되면, 상품별 할인은 표시하지 않음
	{
		$val->discount_amount = 0;
		$val->discount_info = '';
		$val->discounted_price = $val->price;
	}
}

2. 사용자 주문 상세 페이지에서 주문 비번 정보 확인
./svorder.model.php::dispSvorderNonOrderList()에 아래의 코드 추가
setCookie('svorder_guest_buy_pw', $non_password);

./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
if( $oOrderInfo->member_srl == 0 ) // guest buy
{
	if(!$_COOKIE['svorder_guest_buy_pw'])
		return new Object(-1, 'msg_login_required');
	else
	{
		$non_password = $_COOKIE['svorder_guest_buy_pw'];
		$compare_password = $oOrderInfo->non_password;
		if($non_password != $compare_password)
			return new Object(-1,'msg_invalid_password');
	}
}
else // member buy
{
	$logged_info = Context::get('logged_info');
	if($logged_info->member_srl != $oOrderInfo->member_srl )
		return new Object(-1, 'msg_login_required');
}

3. 비회원 주문시 비번 상실 문제 개선
./svorder.controller.php::_validatePurchaserReceipientInfo()에서 아래의 코드를
$args->non_password = $non_password;
아래와 같이 변경
$in_args->non_password = $non_password;

v 0.8.1
15th, Jul 2017
1. 사용자 결제 취소 시 취소 요청자 정보 확인
./svorder.controller.php::procSvorderCancelSettlement()에 아래의 코드 추가
$nOrderSrl = (int)Context::get( 'order_srl' );
$oSvorderModel = &getModel('svorder');
$oOrderInfo = $oSvorderModel->getOrderInfo($nOrderSrl);
if( !$oOrderInfo )
	return new Object(-1,'msg_invalid_order_srl');

if( $oOrderInfo->member_srl == 0 ) // guest buy
{
	if(!$_COOKIE['svorder_guest_buy_pw'])
		return new Object(-1, 'msg_login_required');
	else
	{
		$non_password = $_COOKIE['svorder_guest_buy_pw'];
		$compare_password = $oOrderInfo->non_password;
		if($non_password != $compare_password)
			return new Object(-1,'msg_invalid_password');
	}
}
else // member buy
{
	$logged_info = Context::get('logged_info');
	if($logged_info->member_srl != $oOrderInfo->member_srl )
		return new Object(-1, 'msg_login_required');
}

v 0.8.2
2nd, Aug 2017
1. 주문관리 화면에서 전환 source, medium, capaign, term 표시 추가
./tpl/orderdetail.html()에 아래의 코드 추가
<section class="section">
	<h1>{$lang->title_conversion_media_info}</h1>
	<table class="x_table">
		<tbody>
			<tr>
				<th>utm_source</th>
				<td>{$order_info->utm_source}</td>
				<th>utm_medium</th>
				<td>{$order_info->utm_medium}</td>
				<th>utm_campaign</th>
				<td>{$order_info->utm_campaign}</td>
				<th>utm_term</th>
				<td>{$order_info->utm_term}</td>
				<th>mobile</th>
				<td>{$order_info->is_mobile_access}</td>
			</tr>
		</tbody>
	</table>
</section>

2. 주문관리 화면의 결제 내역 표시 오류 수정
./tpl/orderdetail.html()에서 아래의 코드를
<tbody>
	<tr loop="$order_info->item_list=>$key,$val">
		<td>{$val->formatMoney($order_info->sum_price)}</td>
		<td>{$val->formatMoney($order_info->total_discount_amount)}
			<block loop="$order_info->checkout_promotion_info=>$checkoupromotionkey,$checkoutpromotionval">
			<BR>{$checkoutpromotionval->title}<BR>
			</block>
		</td>
<block cond="$order_info->consumed_reserves_amount">
		<td>{svitemItem::formatMoney($order_info->consumed_reserves_amount)}</td>
</block>
		<td>{$val->formatMoney($order_info->total_discounted_price)}</td>
	</tr>
</tbody>
아래와 같이 변경
<tbody>
	<tr >
		<td>{svitemItem::formatMoney($order_info->sum_price)}</td>
		<td>{svitemItem::formatMoney($order_info->total_discount_amount)}
			<block loop="$order_info->checkout_promotion_info=>$checkoupromotionkey,$checkoutpromotionval">
			<BR>{$checkoutpromotionval->title}<BR>
			</block>
		</td>
<block cond="$order_info->consumed_reserves_amount">
		<td>{svitemItem::formatMoney($order_info->consumed_reserves_amount)}</td>
</block>
		<td>{svitemItem::formatMoney($order_info->total_discounted_price)}</td>
	</tr>
</tbody>

v 0.8.3
5th, Aug 2017
1. 주문관리 화면에서 외부 물류 서버 주문코드 받지 못하면
상세주문관리 화면에서 강제로 주문코드 요청하라고 메세지 변경
./svorder.controller.php::dispSvorderAdminOrderManagement()에 아래의 코드를
$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', '','act','dispSvorderAdminOrderDetail','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."' target='_new'>".$config->external_server."주문번호받기</a>";
아래와 같이 변경
$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', 'svshopmaster','act','dispSvorderAdminOrderDetail','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."'>".$config->external_server."주문번호받기</a>";

v 0.8.4
16th, Aug 2017
1. 관리자 거래원장 다운로드 화면에서 불필요 코드 블럭 제거
./tpl/download_order_raw.html에서 아래의 코드 제거
<a href="#modifyDataFormat" class="modalAnchor modifyDataFormat">{$lang->data_format_setting}</a><a> | </A>

<td><a href="#viewOrderInfo" class="modalAnchor viewOrderInfo" data-order-srl="{$order->order_srl}">주문정보</a></td>
				<td>
					<a cond="$status!='0'" href="#" onclick="window.open('{getUrl('act','dispSvorderAdminOrderSheet','order_srl',$order->order_srl)}', 'addressbook_popup', 'left=50, top=20, width=700, scrollbars=yes, height=700, toolbars=no'); return false;"><span>{$lang->cmd_print_ordersheet}</span></a>
				</td>

<form action="./" class="x_modal" method="post" id="viewOrderInfo">
	<div class="x_modal-header">
		<h1>주문정보</h1>
	</div>
	<div id="orderInfo" class="x_modal-body" style="max-height:600px">
	</div>
</form>

<div class="x_modal" id="deleteOrders">
	<form action="./" class="fg form" method="post">
		<input type="hidden" name="module" value="{$module}" />
		<input type="hidden" name="act" value="procSvorderAdminDeleteOrders" />
		<input type="hidden" name="module_srl" value="{$module_srl}" />
		<input type="hidden" name="status" value="{$status}" />
		<input type="hidden" name="success_return_url" value="{getUrl('act', $act)}" />
		<div id="deleteForm">
		</div>
	</form>
</div>

<span style="display:none;"><a href="#deleteOrders" class="modalAnchor deleteOrders">Hidden Button For Delete</a></span>

<div class="x_modal" id="modifyDataFormat">
	<form action="./" class="fg form" method="post">
		<div id="CsvFormatForm">
		</div>
	</form>
</div>
<div class="x_modal" id="registerShippingSerial">
	<form action="./" class="fg form" method="post">
		<div id="ShippingSerialForm">
		</div>
	</form>
</div>

<script>
function update_status() 
{
	var order_status = jQuery('select[name=order_status]').val();
	if( order_status == 'Z' ) 
		jQuery('a.modalAnchor.deleteOrders').trigger('open.mw');
	else
	{
		var $fo = jQuery('#fo_orderlist');
		$fo.submit();
	}
}

(function($){
	$('.escrow').escrow();
})(jQuery);

function cancelSettlement( nOrderSrl )
{
	if( typeof nOrderSrl == 'undefined' )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	if( nOrderSrl.length == 0 )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	var params = new Array();
	params['order_srl'] = nOrderSrl;
	exec_xml('svorder', 'procSvorderAdminCancelSettlement', params, function(ret_obj) { alert(ret_obj['message']); });
}
</script>

v 0.8.5
2nd, Sep 2017
1. 회원 팝업 메뉴에서 "주문관리" 메뉴 제거하고 회원 관점의 주문관리는 svcrm으로 통합
./svorder.class.php::moduleInstall()에서 아래의 코드 제거
if(!$oModuleModel->getTrigger('member.getMemberMenu', 'svorder', 'model', 'triggerMemberMenu', 'before'))
	$oModuleController->insertTrigger('member.getMemberMenu', 'svorder', 'model', 'triggerMemberMenu', 'before');

./svorder.class.php::checkUpdate()에서 아래의 코드 제거
/if(!$oModuleModel->getTrigger('member.getMemberMenu', 'svorder', 'model', 'triggerMemberMenu', 'before')) return true;

./svorder.model.php::triggerMemberMenu() 제거

2. 미사용 코드 제거
./svorder.model.php::checkSvitemExtraName() 제거

v 0.8.6
11th, Oct 2017
1. 주문 정보 입력창에 사용자정의 변수 기능 추가
./svorderextravar.class.php 추가
./svorder.admin.view.php::dispSvorderAdminExtraVars() 추가
./svorder.model.php::getExtraVarsHTML() 추가
./svorder.model.php::getExtraKeys() 추가
./svorder.admin.controller.php::procSvorderAdminInsertExtraVar() 추가
./svorder.admin.controller.php::procSvorderAdminDeleteExtraVar() 추가
./svorder.admin.controller.php::procSvorderAdminMoveExtraVar() 추가
./svorder.controller.php::insertSvorderExtraKey() 추가
./svorder.controller.php::deleteSvorderExtraKeys() 추가
./svorder.controller.php::_insertExtraVar() 추가
./svorder.controller.php::_updateExtraVar() 추가

./tpl/extra_vars.html 추가
./tpl/extra_keys.html 추가

./schemas/svorder_extra_vars.xml 추가
./queries/insertExtraVar.xml 추가
./queries/updateExtraVar.xml 추가

./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드 제거
$aFieldsetList = $oSvcartModel->getFieldSetList($this->module_info->module_srl);
Context::set('fieldset_list', $aFieldsetList);

./svorder.controller.php::_getExtraFields() 코드 변경

./svorder.controller.php::_insertOrder()에서 아래의 코드를
$oOrderArgs->extra_vars = NULL;
if( $oInArgs->extra_order_form_info )
	$oOrderArgs->extra_vars = serialize( $oInArgs->extra_order_form_info );
아래와 같이 변경
if(count($oInArgs->extra_order_form_info))
{
	foreach($oInArgs->extra_order_form_info as $key => $extra_item)
	{
		$value = NULL;
		$tmp = $extra_item->value;
		if(is_array($tmp))
			$value = implode('|@|', $tmp);
		else
			$value = trim($tmp);
		
		if( $extra_item->type == 'text' || $extra_item->type == 'textarea' )
			$value = strip_tags($value);

		if($value == NULL) 
			continue;

		$this->_insertExtraVar($oInArgs->module_srl, $oInArgs->order_srl, $extra_item->idx, $value, $extra_item->eid);
	}
}

./svorder.controller.php::_getExtraFields()를 _getExtraVars()로 변경

./svorder.model.php::getExtraVars() 추가
./queries/getSvorderExtraVars.xml 추가

./svorder.view.php::dispSvorderOrderComplete()에서 아래의 코드를
$oSvcartModel = &getModel('svcart');
$fieldset_list = $oSvcartModel->getFieldSetList($this->module_info->module_srl);
foreach($fieldset_list as $key=>&$val)
{
	foreach($val->fields as $key2=>&$field)
	{
		if(isset($extra_vars->{$field->column_name}))
			$field->value = $extra_vars->{$field->column_name};
	}
}
Context::set('fieldset_list', $fieldset_list);
아래와 같이 변경
$oExtraVars = $oSvorderModel->getExtraVars($this->module_srl, $nOrderSrl);
Context::set('extra_vars', $oExtraVars);

2. 관리자 화면에서 [module_name 페이지 관리] 링크 수정
./tpl/_header.html에서 아래의 코드를
<li cond="$module_srl" class="x_active"><a href="{getUrl('act','dispSvorderAdminItemList')}">{$module_info->mid} {$lang->page_management}</a></li>
아래와 같이 변경
<li cond="$module_srl" class="x_active"><a href="{getUrl('act','dispSvorderAdminInsertModInst','module_srl',$module_srl)}">{$module_info->mid} {$lang->page_management}</a></li>

3. 미사용 코드 제거
./svorder.view.php::dispSvorderReplyComment() 제거

./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드 제거
$script = "<script>(function($) { jQuery(function($) { var appValidator = xe.getApp('validator')[0];";
foreach($aFieldsetList as $fieldset)
{
	foreach($fieldset->fields as $field)
	{
		$column_name = $field->column_name;
		// if column types are tel or kr_zip, add [] in suffix
		if(in_array($field->column_type, array('tel','kr_zip'))) 
			$column_name = $field->column_name . '[]';
		$script .= sprintf("appValidator.cast('ADD_MESSAGE',['%s','%s']);", $column_name, $field->column_title);
	}
}
$script .= "}); }) (jQuery);</script>";
Context::addHtmlHeader($script);

4. 주문완료 화면에서 회원 주문이면 접근권한 관리
./svorder.view.php::dispSvorderOrderComplete()에 아래의 코드 추가
if( $oOrderInfo->member_srl )
{
	$logged_info = Context::get('logged_info');
	if( $logged_info->member_srl != $oOrderInfo->member_srl )
		return new Object(-1,'msg_invalid_order_srl');
}

5. ext server로 전송되는 배송메모 변수 기능 추가
./svorder.controller.php::_insertOrder()에 아래의 코드 추가
$oOrderArgs->extra_vars = NULL;
if( $oInArgs->delivery_memo )
{
	$aDefaultExtraVars['delivery_memo'] = strip_tags(trim($oInArgs->delivery_memo));
	$oOrderArgs->extra_vars = serialize( $aDefaultExtraVars);
}

./svorder.controller.php::transmitOrderInfoExt()에 아래의 코드 추가
$aDefaultExtraVars = unserialize( $oOrdersInfo->extra_vars );
foreach($aDefaultExtraVars as $key=>$val)
	$oOrdersInfo->{$key} = $val;

./ecaso_query.class.php::_sendNewOrderInfo()에서 아래의 코드를
'b_memo' => iconv('UTF-8', 'EUC-KR', $oArgs->purchaser_memo),
아래와 같이 변경
'b_memo' => iconv('UTF-8', 'EUC-KR', $oArgs->delivery_memo),

v 0.8.7
12th, Nov 2017
1. svpromotion 0.4.0에 대응
할인 쿠폰의 정책에 수량과 품목 추가
./svorder.model.php::getSvorderCouponValidation()에서 아래의 코드 제거
$this->add('disctype', $oCheckoutPromotion->get('disctype'));
$this->add('discpolicy', $oCheckoutPromotion->get('discpolicy'));

./svorder.model.php::getSvorderCouponValidation()에 아래의 코드 추가
$this->add('total_discount_amount', $oCheckoutPromotion->get('total_discount_amount'));

./tpl/skin.js/orderitems.js에서 아래의 코드를
var respons = ['discpolicy', 'disctype', 'promotion_title'];
exec_xml('svcart', 'getSvorderCouponValidation', params, function(ret_obj) {
	var nTotalAmnt = jQuery("#total_amount").text();
	nTotalAmnt = parseInt( nTotalAmnt.replace(/,/g, '') );
	
	var sDisctype = ret_obj['disctype'];
	var sDiscPolicy = ret_obj['discpolicy'];

	if( sDisctype == 'amount' )
		var nTotalDiscount = sDiscPolicy;
	if( sDisctype == 'rate' )
		var nTotalDiscount = nTotalAmnt * sDiscPolicy;

아래와 같이 변경
var respons = ['promotion_title', 'total_discount_amount'];
exec_xml('svorder', 'getSvorderCouponValidation', params, function(ret_obj) {
	var nTotalAmnt = jQuery("#total_amount").text();
	nTotalAmnt = parseInt( nTotalAmnt.replace(/,/g, '') );
	
	var nTotalDiscount = parseInt( ret_obj['total_discount_amount'] );

2. 미사용 코드 제거
./skins/Trendshop/orderitems.html에서 아래의 코드 제거
var my_mileage = {$my_mileage};

./m.skins/trendshop/orderitems.html에서 아래의 코드 제거
var my_mileage = {$my_mileage};

v 0.8.8
1st, Feb 2018
1. 주문화면에서 품목별 기본 할인이 설정된 상태에서 쿠폰 할인이 적용되면 품목별 할인 내역 표시를 제거
./skins/Trendshop/orderitems.html에서 아래의 코드를 
{svitemItem::printPrice($val->sum_discount_amount)}<br />{$val->discount_info}
아래와 같이 변경
<span id="discount_amnt">{number_format($val->sum_discount_amount)}<br /><span id="discount_desc">{$val->discount_info}</span>

./m.skins/trendshop/orderitems.html에서 아래의 코드를 
{svitemItem::printPrice($val->sum_discount_amount)}<br />{$val->discount_info}
아래와 같이 변경
<span id="discount_amnt">{number_format($val->sum_discount_amount)}<br /><span id="discount_desc">{$val->discount_info}</span>

./tpl/skin.js/orderitems.js에 아래의 코드 추가
jQuery('*[id*=discount_amnt]:visible').each(function() {
	jQuery(this).text(0);
});
jQuery('*[id*=discount_desc]:visible').each(function() {
	jQuery(this).empty();
});

v 0.8.9
8th, Feb 2018
1. thirdparty_order_id == 'err:general_transmit_failure' 인 경우에도 주문번호 받기 표시
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
if( is_null( $val->thirdparty_order_id ) )
아래와 같이 변경
if( is_null( $val->thirdparty_order_id ) || $val->thirdparty_order_id == 'err:general_transmit_failure' )

./tpl/orderdetail.html에서 아래의 코드를
<button ID='btnTransmitExt' NAME='btnTransmitExt' type="button" class="x_btn x_btn-primary" onClick="javascript:transmitSettlement( '{$order_info->order_srl}' ); return false;" cond="$order_info->thirdparty_order_id==''&&$order_info->order_status==2">외부서버에 주문 전송</button>&nbsp;&nbsp
아래와 같이 변경
<button ID='btnTransmitExt' NAME='btnTransmitExt' type="button" class="x_btn x_btn-primary" onClick="javascript:transmitSettlement( '{$order_info->order_srl}' ); return false;" cond="($order_info->thirdparty_order_id==''||$order_info->thirdparty_order_id=='err:general_transmit_failure')&&$order_info->order_status==2">외부서버에 주문 전송</button>&nbsp;&nbsp

v 0.8.10
19th, Feb 2018
1. 모바일 사이트에서 비회원 주문확인 오류 해결
./m.skins/trendshop/orderlistlogin.html에서 아래의 코드를
<input type="hidden" name="act" value="procSvorderGuestLogin" />
<input type="hidden" name="mid" value="{$mid}" />
<input type="hidden" name="module" value="{$module}"/>
<div class="signin-idpw"><input type="text" name="order_srl" id="uid" value="" placeholder="{$lang->order_number}" /></div>
<div class="signin-idpw"><input type="password" name="non_password" id="upw" value="" placeholder="{$lang->password}" /> </div>
아래와 같이 변경
<input type="hidden" name="act" value="dispSvorderNonOrderList" />
<div class="signin-idpw"><input type="text" name="non_order_srl" id="uid" value="" placeholder="{$lang->order_number}" /></div>
<div class="signin-idpw"><input type="password" name="non_password" id="upw" value="" placeholder="{$lang->password}" /> </div>

./m.skins/trendshop/orderlist.html에서 아래의 코드 제거
<load target="../../../nproduct/tpl/skin.js/script.js" />

./tpl/skin.js/escrow.js에서 아래의 코드를
'nstore',
'getNstoreEscrowInfo',
아래와 같이 변경
'svorder',
'getSvorderEscrowInfo',

v 0.8.11
19th, Mar 2018
1. svpromotion v 0.4.3에 대응하여 주문 조회 화면에 쿠폰 리스트 표시
./svorder.view.php::dispSvorderOrderList()에 아래의 코드 추가
$oSvpromotionModel = &getModel('svpromotion');
$oPersonalizedPromotionInfo = $oSvpromotionModel->getPromotionInfoByMemberSrl( $logged_info->member_srl);
Context::set('coupon_list', $oPersonalizedPromotionInfo->coupon_list);

./skins/Trendshop/orderlist.html에 아래의 코드 추가
<div id="orderlist" class="newclearfix" cond="count($coupon_list)">
	<h2 class="order-list-title">{$lang->cmd_coupon_view}</h2>
	<table class="item-table">
		<thead>
			<tr>
				<th>{$lang->coupon_title}</th>
				<th>{$lang->coupon_serial}</th>
				<th>{$lang->coupon_usage_count}</th>
				<th>{$lang->regdate}</th>
				<th>{$lang->coupon_expired_date}</th>
			</tr>
		</thead>
		<tbody>
			<tr loop="$coupon_list=>$coupon_key,$coupon_val">
				<td>
					<span class="block">{$coupon_val->promotion_title}<BR>
<block loop="$coupon_val->target_items=>$item_title">
					{$item_title}<BR>
</block>
					에 한해 {$coupon_val->discount_info}
					</span>
				</td>
				<td>
					<span class="block">{$coupon_val->coupon_serial}</span>
				</td>
				<td>
					<span class="block">{$coupon_val->used_count}/{$coupon_val->max_use_count}</span>
				</td>
				<td>
					<span class="block">{$coupon_val->regdate}</span>
				</td>
				<td>
					<span class="block">{$coupon_val->expiration}</span>
				</td>
			</tr>
		</tbody>
	</table>
</div>

./m.skins/trendshop/orderlist.html에 아래의 코드 추가
<div id="orderlist" class="newclearfix" cond="count($coupon_list)">
	<h2 class="order-list-title">{$lang->cmd_coupon_view}</h2>
	<table class="item-table">
		<thead>
			<tr>
				<th>{$lang->coupon_serial}</th>
				<th>{$lang->coupon_usage_count}</th>
				<th>{$lang->coupon_expired_date}</th>
			</tr>
		</thead>
		<tbody>
			<tr loop="$coupon_list=>$coupon_key,$coupon_val">
				<td>
					<span class="block">{$coupon_val->coupon_serial}</span>
				</td>
				<td>
					<span class="block">{$coupon_val->used_count}/{$coupon_val->max_use_count}</span>
				</td>
				<td>
					<span class="block">{$coupon_val->expiration}</span>
				</td>
			</tr>
		</tbody>
	</table>
</div>

v 0.8.12
24th, Mar 2018
1. 다중 운송장 번호 처리 코드 블록 개선
./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에 아래의 코드 추가
$invoice_nos = str_replace( '.', ',', $invoice_nos );

./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 아래의 코드를
if( $pos !== false ) 
{
	$temp_invoice_no = substr( $invoice_no, 0, $pos );
	$temp_extra_invoice_nos = substr( $invoice_no, $pos+1 );
	$temp_extra_invoice_nos = str_replace( ',', '|@|', $temp_extra_invoice_nos );
	$args->extra_invoice_no = $temp_extra_invoice_nos ;
	$invoice_no = $temp_invoice_no;
}

아래와 같이 변경
if( $pos !== false )
{
	$aInvoice = array();
	$aInvoice = explode( ',', $invoice_no );
	$aInvoice = array_unique($aInvoice);
	$nCnt = count( $aInvoice );
	$invoice_no = $aInvoice[0];
	if( $nCnt > 1 )
	{
		array_shift($aInvoice);
		$args->extra_invoice_no = serialize($aInvoice);
	}
}

./ecaso_listen.class.php::_setInvoiceByOrder()에 아래의 코드 추가
$sShippingInvoice = str_replace( '.', ',', $sShippingInvoice );

./ecaso_listen.class.php::_setInvoiceByOrder()에서 아래의 코드를
if( $pos !== false ) 
{
	$temp_invoice_no = substr( $sShippingInvoice, 0, $pos );
	$temp_extra_invoice_nos = substr( $sShippingInvoice, $pos+1 );
	$temp_extra_invoice_nos = str_replace( ',', '|@|', $temp_extra_invoice_nos );
	$args->extra_invoice_no = $temp_extra_invoice_nos ;
	$sShippingInvoice = $temp_invoice_no;
}

아래와 같이 변경
if( $pos !== false )
{
	$aInvoice = array();
	$aInvoice = explode( ',', $sShippingInvoice );
	$aInvoice = array_unique($aInvoice);
	$nCnt = count( $aInvoice );
	$sShippingInvoice = $aInvoice[0];
	if( $nCnt > 1 )
	{
		array_shift($aInvoice);
		$args->extra_invoice_no = serialize($aInvoice);
	}
}

v 0.8.13
5th, Apr 2018
1. 미사용 코드 제거
./skins/Trendshop/orderitems.html에서 아래의 코드를
<block cond="$module_info->display_delivfee=='Y' || $delivery_fee">
<td class="calculation"><img src="img/price_plus.png" style="width:31px; height:31px" /></td>
<td>
	<span class="price-title">{$lang->delivery_fee}</span>
	<span id="delivery_fee" class="price-section"><!--@if($delivery_fee)-->{number_format($delivery_fee)}<!--@else-->0<!--@endif--></span>
</td>
</block>
아래와 같이 변경
<td class="calculation"><img src="img/price_plus.png" style="width:31px; height:31px" /></td>
<td>
	<span class="price-title">{$lang->delivery_fee}</span>
	<span id="delivery_fee" class="price-section"><!--@if($delivery_fee)-->{number_format($delivery_fee)}<!--@else-->0<!--@endif--></span>
</td>

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
svitemItem::printPrice()
아래와 같이 변경
number_format()

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
<tr cond="$module_info->display_delivfee=='Y' || $order_info->delivery_fee">
아래와 같이 변경
<tr>

./m.skins/trendshop/orderitems.html에서 아래의 코드를
<tr cond="$module_info->display_delivfee=='Y' || $delivery_fee">
아래와 같이 변경
<tr>

./m.skins/trendshop/orderitems.html에서 아래의 코드를
svitemItem::printPrice()
아래와 같이 변경
number_format()

./m.skins/trendshop/ordercomplete.html에서 아래의 코드를
svitemItem::printPrice()
아래와 같이 변경
number_format()

2. 할인된 최종금액이 무료 배송 금액보다 작으면 배송비 표시하는 UI 추가
./svorder.model.php::getSvorderCouponValidation()에 아래의 코드 추가
$oModuleModel = &getModel('module');
$config = $oModuleModel->getModuleConfig('svorder');

$nFinalDeliveryFee = 0;
if( (int)$config->freedeliv_amount > ( (int)$oCart->total_discounted_price - (int)$oCheckoutPromotion->get('total_discount_amount') ) )
	$nFinalDeliveryFee = (int)$config->delivery_fee;

$this->add('final_delivery_fee', $nFinalDeliveryFee);

./tpl/skin.js/orderitems.js에서 아래의 코드를 
var respons = ['promotion_title', 'total_discount_amount'];
exec_xml('svorder', 'getSvorderCouponValidation', params, function(ret_obj) {
	var nTotalAmnt = jQuery("#total_amount").text();
	nTotalAmnt = parseInt( nTotalAmnt.replace(/,/g, '') );
	var nTotalDiscount = parseInt( ret_obj['total_discount_amount'] );
	var nDeliveryFee = jQuery("#delivery_fee").text();
	if( nDeliveryFee.length == 0 )
		nDeliveryFee = 0;
	else
		nDeliveryFee = parseInt( nDeliveryFee.replace(',', '') );

	var nMileageAmnt = jQuery("#reserves_amount").text();
	if( nMileageAmnt.length == 0 )
		nMileageAmnt = 0;
	else
		nMileageAmnt = parseInt( nMileageAmnt.replace(',', '') );

	nPaymentAmnt = parseInt( nTotalAmnt )- parseInt( nTotalDiscount )+ parseInt( nDeliveryFee ) - parseInt( nMileageAmnt );

	jQuery("#promotion_title").html(ret_obj['promotion_title']);
	jQuery("#total_discount").html( formatCurrencyInt( nTotalDiscount ) );
	jQuery("#payment_amount").html( formatCurrencyInt( nPaymentAmnt ) );
	jQuery('*[id*=discount_amnt]:visible').each(function() {
		jQuery(this).text(0);
	});
	jQuery('*[id*=discount_desc]:visible').each(function() {
		jQuery(this).empty();
	});
},respons);
아래와 같이 변경
var respons = ['promotion_title', 'total_discount_amount', 'final_delivery_fee'];
exec_xml('svorder', 'getSvorderCouponValidation', params, function(ret_obj) {
	var nTotalAmnt = jQuery("#total_amount").text();
	nTotalAmnt = parseInt( nTotalAmnt.replace(/,/g, '') );
	var nTotalDiscount = parseInt( ret_obj['total_discount_amount'] );
	var nDeliveryFee = jQuery("#delivery_fee").text();
	if( nDeliveryFee.length == 0 )
		nDeliveryFee = 0;
	else
		nDeliveryFee = parseInt( nDeliveryFee.replace(',', '') );

	var nFinalDeliveryFee = parseInt( ret_obj['final_delivery_fee'] );
	if( nFinalDeliveryFee )
		nDeliveryFee = nFinalDeliveryFee;

	var nMileageAmnt = jQuery("#reserves_amount").text();
	if( nMileageAmnt.length == 0 )
		nMileageAmnt = 0;
	else
		nMileageAmnt = parseInt( nMileageAmnt.replace(',', '') );

	nPaymentAmnt = parseInt( nTotalAmnt )- parseInt( nTotalDiscount )+ parseInt( nDeliveryFee ) - parseInt( nMileageAmnt );

	jQuery("#promotion_title").html(ret_obj['promotion_title']);
	jQuery("#total_discount").html( formatCurrencyInt( nTotalDiscount ) );
	jQuery("#payment_amount").html( formatCurrencyInt( nPaymentAmnt ) );
	if( nFinalDeliveryFee )
		jQuery("#delivery_fee").html( formatCurrencyInt( nFinalDeliveryFee ) );
	
	jQuery('*[id*=discount_amnt]:visible').each(function() {
		jQuery(this).text(0);
	});
	jQuery('*[id*=discount_desc]:visible').each(function() {
		jQuery(this).empty();
	});
},respons);

3. svcart v 0.5.5에 대응하여 그룹별 장바구니 수량 정책 기능 추가
./svorder.controller.php::_validateOrderAuthority() 추가
./svorder.controller.php::precheckOrder()에 아래의 코드 추가
$output = $this->_validateOrderAuthority($oSvcartModel, $oArgs->cart);
if( !$output->toBool() )
	return $output;

4. 미사용 코드 제거
./svorder.admin.model.php::getModuleMidList() 제거
./queries/getModuleMidList.xml 제거

5. 관리자에서 모듈 목록 가져오기 추가
./svorder.admin.model.php::getModInstList() 추가

6. 결제 모듈이 프로모션몰로 설정되어 있을 경우에만 0 가격 PG 호출 허용하는 기능 추가
./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를 
$oSvpgView = &getView('svpg');
$output = $oSvpgView->getPaymentForm($args);
if (!$output->toBool()) 
	return $output;
$sSvpgForm = $output->data;

아래와 같이 변경
$sSvpgForm = null;
$oSvpromotionConfig = $oSvpromotionModel->getModuleConfig();
if( $oSvpromotionConfig->aPromotionMallOrderModuleSrl[$this->module_info->module_srl] == 'Y' )
{
	if( $args->price == 0 ) // PG 표시
		$args->price = true;
}
else
{
	if( $args->price == 0 ) // PG 중단
		$sSvpgForm = Context::getLang('msg_error_free_item_not_allowed');
}
if( !$sSvpgForm )
{
	$oSvpgView = &getView('svpg');
	$output = $oSvpgView->getPaymentForm($args);
	if (!$output->toBool()) 
		return $output;
	$sSvpgForm = $output->data;
}

v 0.8.14
29th, Apr 2018
1. svpg가 order_srl을 결정하는 것을 svorder로 이동시킴
./schemas/svorder_sequence.xml 추가

./svorder.controller.php::_getOrderSrl() 추가

./svorder.controller.php::precheckOrder()에 아래의 코드 추가
$nOrderSrl = $this->_getOrderSrl();
$oOrderArgs->order_srl = $nOrderSrl;
$output->add( 'order_srl', $nOrderSrl ); 

v 0.8.15
6th, May 2018
1. 쿠폰 사용한 결제를 취소할 때 쿠폰 사용 횟수 roll back
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
$args->order_srl = $nOrderSrl;
$output = executeQuery('svorder.getOrderByOrderSrl', $args);
if(!$output->toBool())
	return $output;
//debugPrint( $output );		
if( $output->data->order_status != '2' && $output->data->order_status != '5' && 
	$output->data->order_status != '6' && 
	$output->data->order_status != 'A' && $output->data->order_status != 'B' && 
	$output->data->order_status != 'C' && $output->data->order_status != 'D' )
	return new Object( -1, 'msg_cancel_not_available_order_status' );

$args->order_status = 'E'; // 취소 요청 상태
$sTransmitCancelInfoExtType = 'cancel_request_without_pg_cancellation';
$sCancelReason = Context::get( 'cancel_reason' );
$sThirdPartyOrderId = $output->data->thirdparty_order_id;

// 배송 전이고 신용카드 결제이면 PG 취소 실행
//if( $output->data->payment_method == 'CC' && ( $output->data->order_status == '2' || $output->data->order_status == '3' ) )
if( $output->data->payment_method == 'CC' && $output->data->order_status == '2' )
{
debugPrint( 'before procSvpgAdminCancelSettlement' );
	if( strlen( $sCancelReason ) == 0 )
		return new Object( -1, 'msg_invalid_pg_tr_id_cancel_reason' );

	$oSvpgAdminController = &getAdminController('svpg');
	$oRst = $oSvpgAdminController->procSvpgAdminCancelSettlement($nOrderSrl,$sCancelReason);
debugPrint( $oRst );
	// 취소 성공하면 취소일자 표시하고 주문 상태 변경
	if( $oRst->toBool())
	{
		$sTimeStamp = $oRst->get('regdate' ) == '' ? date('YmdHis') : $oRst->get('regdate' );
		$args->pg_tid_canceldate = $sTimeStamp;
		$output = executeQuery('svorder.updatePgTrIdCancelLogByOrderSrl',$args);
debugPrint( $output );
		if (!$output->toBool()) 
			return $output;

		unset($args->pg_tid_canceldate);
		$args->order_status = 'A'; // PG 신용카드 결제 취소 후 취소 상태로 분류
		$sTransmitCancelInfoExtType = 'cancel_request_with_pg_cancellation';
	}
debugPrint( 'after procSvpgAdminCancelSettlement' );		
}
$oSvorderController = &getController('svorder');
$output = $oSvorderController->updateOrderStatus( $nOrderSrl, $args );
if( !$output->toBool() )
	return $output;

아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$oOrder = $oSvorderModel->getOrderInfo($nOrderSrl);

//debugPrint( $oOrder );		
if( $oOrder->order_status != '2' && $oOrder->order_status != '5' && 
	$oOrder->order_status != '6' && $oOrder->order_status != 'A' && 
	$oOrder->order_status != 'B' && $oOrder->order_status != 'C' && $oOrder->order_status != 'D' )
	return new Object( -1, 'msg_cancel_not_available_order_status' );

$args->order_status = 'E'; // 취소 요청 상태
$sTransmitCancelInfoExtType = 'cancel_request_without_pg_cancellation';
$sCancelReason = Context::get( 'cancel_reason' );
$sThirdPartyOrderId = $oOrder->thirdparty_order_id;


// 배송 전이고 신용카드 결제이면 PG 취소 실행
if( $oOrder->payment_method == 'CC' && $oOrder->order_status == '2' )
{
debugPrint( 'before procSvpgAdminCancelSettlement' );
	if( strlen( $sCancelReason ) == 0 )
		return new Object( -1, 'msg_invalid_pg_tr_id_cancel_reason' );

	$oSvpgAdminController = &getAdminController('svpg');
	$oRst = $oSvpgAdminController->procSvpgAdminCancelSettlement($nOrderSrl,$sCancelReason);
debugPrint( $oRst );
	// 취소 성공하면 취소일자 표시하고 주문 상태 변경
	if( $oRst->toBool())
	{
		$sTimeStamp = $oRst->get('regdate' ) == '' ? date('YmdHis') : $oRst->get('regdate' );
		$args->pg_tid_canceldate = $sTimeStamp;
		$output = executeQuery('svorder.updatePgTrIdCancelLogByOrderSrl',$args);
debugPrint( $output );
		if (!$output->toBool()) 
			return $output;

		unset($args->pg_tid_canceldate);
		$args->order_status = 'A'; // PG 신용카드 결제 취소 후 취소 상태로 분류
		$sTransmitCancelInfoExtType = 'cancel_request_with_pg_cancellation';
	}
debugPrint( 'after procSvpgAdminCancelSettlement' );		
}
$oSvorderController = &getController('svorder');
$output = $oSvorderController->updateOrderStatus( $nOrderSrl, $args );
if( !$output->toBool() )
	return $output;

if( count( $oOrder->checkout_promotion_info ) )
{
debugPrint( 'rollbackCouponUsedCount' );
	$oSvPromotionController = &getController('svpromotion');
	$output = $oSvPromotionController->procSvprmotionRollbackUsedCoupon( $oOrder );
	if( !$output->toBool() )
		return $output;
}

v 0.8.16
6th, Jun 2018
1. 회원 주문이면 관리자의 주문 상세 화면에서 아이디 표시
./tpl/orderdetail.html에서 아래의 코드를
<tr cond="$order_info->recipient_name">
	<th>{$lang->recipient}</th>
	<td colspan="3">{$order_info->recipient_name}</td>
</tr>

아래와 같이 변경
<tr cond="$order_info->recipient_name">
	<th>{$lang->recipient}</th>
	<td>{$order_info->recipient_name} &nbsp; (<a href="#popup_menu_area" class="member_{$order_info->member_srl}">{$order_info->item_list[0]->nick_name}</a>)</td>
	<th>{$lang->mileage}</th>
	<td>{$order_info->mileage}<div cond="$order_info->mileage_save=='Y'">({$lang->mileage_saved})</div></td>
</tr>

2. 관리자의 주문 상세 화면에서 외부 서버 주문 번호 표시
./tpl/orderdetail.html에서 아래의 코드를
<tr>
	<th>{$lang->order_number}</th>
	<td>{$order_info->order_srl}</td>
	<th>{$lang->order_date}</th>
	<td>{zdate($order_info->regdate)}</td>
</tr>

아래와 같이 변경
<tr>
	<th>{$lang->order_date}</th>
	<td colspan="3">{zdate($order_info->regdate)}</td>
</tr>
<tr>
	<th>{$lang->order_number}</th>
	<td>{$order_info->order_srl}</td>
	<th><div cond="$config->external_server!=''">{$config->external_server} 주문번호</div></th>
	<td><div cond="$config->external_server!=''">{$order->thirdparty_order_id}</div></td>
</tr>

3. PG 결제 방법을 PG사 반환값으로 재확인하는 코드 추가
./svorder.controller.php::completePgProcess()에 아래의 코드 추가
if( $oPgParam->payment_method )
	$args->payment_method = $oPgParam->payment_method;

./svorder.controller.php::updateOrderStatus()에 아래의 코드 추가
if( $in_args->payment_method )
	$args->payment_method = $in_args->payment_method;

./queries/updateOrderStatusSvorder.xml에 아래의 코드 추가
<column name="payment_method" var="payment_method" />

4. 주문 테이블 기록 완료 후 외부 서버 전송하는 것으로 변경
./svorder.controller.php::completePgProcess()에서 아래의 코드를
if($oPgParam->state == '2') // 결제 완료되면 재고 수정
{
	$oSvitemModel = &getModel('svitem');
	$oSvitemController = &getController('svitem');
	foreach($oOrder->item_list as $key=>$val)
	{
		$stock = $oSvitemModel->getItemStock($val->item_srl);
		if($stock != null)
		{
			$stock = $stock - $val->quantity;
			$output = $oSvitemController->setItemStock($val->item_srl, $stock);
		}
	}
	$this->transmitOrderInfoExt( $oPgParam->order_srl, $oPgParam->state );
	$this->sendAlarmMail( $oPgParam->order_srl );
}
if( !$oOrder->pg_tid ) // pg process를 최초 완료했으면 실행: 신용카드, 무통장입금, 법인계좌이체
{
	$oSvPromotionController = &getController('svpromotion');
	if($oOrder->reserves_consume_srl) // updateorderstatus의 거래완료시 적립금 지급 코드 명심
		$oSvPromotionController->activateReservesLog( $oOrder->reserves_consume_srl );
	$nCouponSrl = (int)$oOrder->checkout_promotion_info[0]->coupon_srl;
	if( $nCouponSrl > 0 )
		$oSvPromotionController->procSvprmotionMarkUsedCoupon( $oOrder );
}
// update order info for success
unset( $args );
if($oPgParam->state == 1 || $oPgParam->state == 3 )   // 1:not completed, 3:failure
	$args->order_status = 1;
else if($oPgParam->state == 2) // completed
	$args->order_status = 2;

if( isset( $oPgParam->extra_vars[vact_inputname] ) ) // 사업자 통장 입금 시 입금자명
	$args->remitter_name = $oPgParam->extra_vars[vact_inputname]; 

$args->pg_tid = $oPgParam->pg_tid;
if( $oPgParam->use_escrow ) // svcart.controller.php::_updateTransaction()에서 호출되면 $args->use_escrow == null
	$args->use_escrow = $oPgParam->use_escrow;

if( $oPgParam->payment_method )
	$args->payment_method = $oPgParam->payment_method;

$output = $this->updateOrderStatus( $oPgParam->order_srl, $args );
if( !$output->toBool() )
	return $output;

아래와 같이 변경
if($oPgParam->state == '2') // 결제 완료되면 재고 수정
{
	$oSvitemModel = &getModel('svitem');
	$oSvitemController = &getController('svitem');
	foreach($oOrder->item_list as $key=>$val)
	{
		$stock = $oSvitemModel->getItemStock($val->item_srl);
		if($stock != null)
		{
			$stock = $stock - $val->quantity;
			$output = $oSvitemController->setItemStock($val->item_srl, $stock);
		}
	}
	//$this->transmitOrderInfoExt( $oPgParam->order_srl, $oPgParam->state );
	//$this->sendAlarmMail( $oPgParam->order_srl );
}
if( !$oOrder->pg_tid ) // pg process를 최초 완료했으면 실행: 신용카드, 무통장입금, 법인계좌이체
{
	$oSvPromotionController = &getController('svpromotion');
	if($oOrder->reserves_consume_srl) // updateorderstatus의 거래완료시 적립금 지급 코드 명심
		$oSvPromotionController->activateReservesLog( $oOrder->reserves_consume_srl );
	$nCouponSrl = (int)$oOrder->checkout_promotion_info[0]->coupon_srl;
	if( $nCouponSrl > 0 )
		$oSvPromotionController->procSvprmotionMarkUsedCoupon( $oOrder );
}
// update order info for success
unset( $args );
if($oPgParam->state == 1 || $oPgParam->state == 3 )   // 1:not completed, 3:failure
	$args->order_status = 1;
else if($oPgParam->state == 2) // completed
	$args->order_status = 2;

if( isset( $oPgParam->extra_vars[vact_inputname] ) ) // 사업자 통장 입금 시 입금자명
	$args->remitter_name = $oPgParam->extra_vars[vact_inputname]; 

$args->pg_tid = $oPgParam->pg_tid;
if( $oPgParam->use_escrow ) // svcart.controller.php::_updateTransaction()에서 호출되면 $args->use_escrow == null
	$args->use_escrow = $oPgParam->use_escrow;

if( $oPgParam->payment_method )
	$args->payment_method = $oPgParam->payment_method;

$output = $this->updateOrderStatus( $oPgParam->order_srl, $args );
if( !$output->toBool() )
	return $output;

if($oPgParam->state == '2') // 결제 완료되면 외부 서버에 주문 전송
{
	$this->transmitOrderInfoExt( $oPgParam->order_srl, $oPgParam->state );
	$this->sendAlarmMail( $oPgParam->order_srl );
}

v 0.8.17
17th, Jun 2018
1. 외부 업체 스크립트용 변수 기능 추가
./tpl/insertmodinst.html에 아래의 코드 추가
<section class="section">
	<h1>{$lang->etc}</h1>
	<div class="x_control-group">
		<div class="x_control-label" for="">3rd party script with skin vars </div>
		<div class="x_controls">
			<textarea name="ext_script">{$ext_script}</textarea>
		</div>
	</div>
</section>

./svorder.admin.model.php::getExtScript() 추가

./svorder.admin.controller.php::_registerExtScript() 추가

./svorder.admin.controller.php::procSvorderAdminInsertModInst()에 아래의 코드 추가
$this->_registerExtScript();

./svorder.view.php::dispSvorderOrderComplete()에 아래의 코드 추가
$sExtScriptArchivePath = _XE_PATH_.'files/svorder/';
$oTemplate = &TemplateHandler::getInstance();
$sExtScript = $oTemplate->compile($sExtScriptArchivePath, 'ext_script_ordercomplete_'.$this->module_info->module_srl);
Context::set('ext_script', $sExtScript );

./skins/Trendshop/ordercomplete.html에 아래의 코드 추가
<block cond="$ext_script">
{$ext_script}
</block>

./m.skins/trendshop/ordercomplete.html에 아래의 코드 추가
<block cond="$ext_script">
{$ext_script}
</block>

v 0.8.18
16th, Aug 2018
1. 모바일 결제 정보 입력 화면에서 쿠폰이 빈칸일 때 검증 버튼 누르면 상품금액이 0으로 표시되는 오류 수정

./tpl/skin.js/orderitems.js::validateCouponSerial()에 아래의 코드를 추가
if( sCouponNumber.length )
{
}
else
	alert('쿠폰 번호를 입력해 주세요.');

v 0.8.19
22nd, Aug 2018
1. 미사용 코드 제거
./svorder.view.php::dispSvorderOrderList()에서 아래의 코드 제거
$oSvorderModel = &getModel('svpg');

2. 비회원 주문을 회원 주문으로 이관 기능 추가
./svorder.admin.controller.php::procSvorderAdminTransferToMember() 추가

./tpl/_header.html에 아래의 코드 추가
<div cond="$XE_VALIDATOR_MESSAGE && $XE_VALIDATOR_ID == ''" class="message {$XE_VALIDATOR_MESSAGE_TYPE}">
	<p>{$XE_VALIDATOR_MESSAGE}</p>
</div>

./tpl/orderdetail.html에 아래의 코드 추가
<div class="x_modal" id="transferToMember">
	<form action="./" class="fg form" method="post">
		<input type="hidden" name="act" value="procSvorderAdminTransferToMember" />
		<input type="hidden" name="module" value="svshopmaster" />
		<input type="hidden" name="order_srl" value="{$order_srl}" />

		<div id="transferForm">
			<div class="x_modal-header">
				<h1>{$lang->cmd_move_to_member}</h1>
			</div>
			<div class="x_modal-content">
				<table>
					<tbody>
						<tr>
							<td>이 주문을</td>
							<td><input type="text" name="member_srl" value="" />번 회원에게 이관</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="x_modal-footer">
				<button type="submit" class="x_btn x_btn-inverse">{$lang->cmd_submit}</button>
			</div>
		</div>
	</form>
</div>

./queries/updateCartMemberSrlByOrderSrl.xml 추가
./queries/updateOrderMemberSrlByOrderSrl.xml 추가

3. 코드 오류 수정
./tpl/ordetail.html에서 아래의 코드를
<script type='text/javascript' src='http://singleview.co.kr/gatk.js'></script>

아래와 같이 변경
<script type='text/javascript' src='https://svapi.co.kr:5018/gatk.js'></script>

v 0.8.20
23rd, Aug 2018
1. svshopmaster v 0.1.3의 레이아웃 표시 방법 변경에 대응
./svorder.admin.view.php::init()에 아래의 코드 추가
if(Context::get('module') == 'svshopmaster')
{
	$sClassPath = _XE_PATH_ . 'modules/svshopmaster/svshopmaster.class.php';
	if(file_exists($sClassPath))
	{
		require_once($sClassPath);
		svshopmaster::init($this);
	}
}

v 0.8.21
24th, Aug 2018
1. 일별 매출액 추출 기능 추가
./svorder.admin.model.php::getTodaySalesInfo() 제거
./svorder.admin.model.php::getSalesInfo() 제거
./svorder.admin.model.php::getTotalSalesInfo() 제거
./queries/getSalesInfo.xml 제거
./queries/getTotalSalesInfo.xml 제거

./svorder.admin.model.php::getSalesInfoDaily() 추가
./queries/getSalesInfoDaily.xml 추가

v 0.8.22
26th, Aug 2018
1. svestudio의 분석 자료 추출 효율 개선
./schemas/svorder_order.xml에서 아래의 코드를
<column name="regdate" type="date" notnull="notnull"/>
아래와 같이 변경
<column name="regdate" type="date" notnull="notnull"  index="idx_regdate"/>

./queries/getSalesInfoDaily.xml에서 아래의 코드를
<condition operation="equal" column="member_srl" var="member_srl" />
<condition operation="in" column="order_status" default="'2','3','4','5','6'" pipe="and" />
<condition operation="like_prefix" column="regdate" var="regdate" pipe="and" />

아래와 같이 변경
<condition operation="like_prefix" column="regdate" var="regdate" />
<condition operation="in" column="order_status" default="'2','3','4','5','6'" pipe="and" />


v 0.8.22
26th, Aug 2018
1. 주문 상태에서 무의미한 [반품], [교환], [환불] 제거
./svorder.class.php에서 아래의 코드를
var $order_status = array('0'=>'cart_keep', '1'=>'wait_deposit', '2'=>'deposit_done', '3'=>'prepare_delivery', '4'=>'on_delivery', '5'=>'delivery_done', '6'=>'transaction_done', 'E'=>'on_cancelling', 'A'=>'cancelled','B'=>'returns','C'=>'exchanges','D'=>'refund');
아래와 같이 변경
var $order_status = array('0'=>'cart_keep', '1'=>'wait_deposit', '2'=>'deposit_done', '3'=>'prepare_delivery', '4'=>'on_delivery', '5'=>'delivery_done', '6'=>'transaction_done', 'E'=>'on_cancelling', 'A'=>'cancelled' );

./tpl/ordermanagement_header.html에서 아래의 코드 제거
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','B')}" class="active"|cond="$status=='B'">{$lang->returns}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','C')}" class="active"|cond="$status=='C'">{$lang->exchanges}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','D')}" class="active"|cond="$status=='D'">{$lang->refund}</a> <i>|</i>

2. SKU별 일별 매출액 집계 기능 추가
./queries/getOrderSrlByDate.xml 추가

v 0.8.23
3rd, Jan 2019
1. 쿠폰을 사용한 주문 상세 화면에서 증정품 정보가 보이지 않는 문제 해결
./svorder.model.php::_constructItemInfoByOrder()에 아래의 코드 추가
$aDiscountInfo[$nPromotionIdx]->type = $val2->type;

./svorder.model.php::getOrderInfo()에서 아래의 코드를
if( $oOrderInfo->checkout_promotion_info )
아래와 같이 변경
if( $oOrderInfo->checkout_promotion_info && $val->discount_info[0]->type != 'giveaway')

2. 0 적립금 기록이 축적되는 현상 제거
./svorder.model.php::updateOrderStatus()에서 아래의 코드를
$oSvpromotionController = &getController( 'svpromotion' );
$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price, $order_info->member_srl );
$nReservesSrl = (int)$output->get('reserves_srl');
if( $nReservesSrl )
	$args->reserves_receive_srl = $nReservesSrl;

아래와 같이 변경
if( (int)$oSvpromotionConfig->reserves_ratio > 0 )
{
	$oSvpromotionController = &getController( 'svpromotion' );
	$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price, $order_info->member_srl );
	$nReservesSrl = (int)$output->get('reserves_srl');
	if( $nReservesSrl )
		$args->reserves_receive_srl = $nReservesSrl;
}

v 0.8.24
6th, Jan 2019
1. 주문서 화면에서 증정품 정보가 보이지 않는 문제 해결
./skins/.../orderitems.html에서 아래의 코드를
<td><!--@if($val->sum_discount_amount)--><span id="discount_amnt">{number_format($val->sum_discount_amount)}</span><br /><span id="discount_desc">{$val->discount_info}</span><!--@else-->0<!--@endif--></td>
아래와 같이 변경
<td><span id="discount_amnt">{number_format($val->sum_discount_amount)}</span><span id="discount_desc">{$val->discount_info}</span></td>

./skins/.../ordercomplete.html에서 아래의 코드를
<!--@if($val->discount_amount)-->{number_format($val->discount_amount*$val->quantity)}<br />
<block loop="$val->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block><!--@else-->0<!--@endif-->

아래와 같이 변경
{number_format($val->discount_amount*$val->quantity)}<br />
<block loop="$val->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>

./svorder.view.php::dispSvorderOrderComplete()에서 아래의 코드 제거
$oDiscountInfo = unserialize( $val->discount_info );

$oConditionalDiscountInfo = unserialize( $val->conditional_promotion );
foreach( $oConditionalDiscountInfo->promotion as $key2 => $val2 )
{
	$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
	$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->resultant_disc_amnt;
}

./svorder.view.php::dispSvorderOrderComplete()에서 아래의 코드를
foreach( $oDiscountInfo as $key2 => $val2 )

아래와 같이 변경
foreach( $val->discount_info as $key2 => $val2 )

v 0.8.25
8th, Jan 2019
1. 주문서 화면에서 쿠폰 입력하면 증정품 정보가 사라지는 문제 해결
./skins/.../orderitems.html에서 아래의 코드를
<td><span id="discount_amnt">{number_format($val->sum_discount_amount)}</span><span id="discount_desc">{$val->discount_info}</span></td>

아래와 같이 변경
<td><span id="discount_amnt">{number_format($val->sum_discount_amount)}</span>{$val->discount_info}</td>

./m.skins/.../orderitems.html에서 아래의 코드를
<div cond="$val->sum_discount_amount" class="item-price">{$lang->total_discount} : <span id="discount_amnt" class="number-font">{number_format($val->sum_discount_amount)}</span> <block cond="$val->discount_info"><span id="discount_desc">({$val->discount_info})</span></block></div>
아래와 같이 변경
<div cond="$val->sum_discount_amount" class="item-price">{$lang->total_discount} : <span id="discount_amnt" class="number-font">{number_format($val->sum_discount_amount)}</span></div>
<div cond="$val->discount_info" class="item-price"><block cond="$val->discount_info">{$val->discount_info}</block></div>

./m.skins/.../ordercomplete.html에서 아래의 코드를
<div cond="$val->discount_amount" class="item-price">{$lang->total_discount} : <span class="number-font">{number_format($val->discount_amount)}</span></dov<block cond="$val->discount_info">({$val->discount_info})</block></div>

아래와 같이 변경
<div cond="$val->discount_amount" class="item-price">{$lang->total_discount} : <span class="number-font">{number_format($val->discount_amount)}</span></div>
<div cond="$val->discount_info" class="item-price">
<block loop="$val->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>						
</div>

./tpl/skin.js/orderitems.js에서 아래의 코드를
jQuery("#promotion_title").html(ret_obj['promotion_title']);
jQuery("#total_discount").html( formatCurrencyInt( nTotalDiscount ) );
jQuery("#payment_amount").html( formatCurrencyInt( nPaymentAmnt ) );
if( nFinalDeliveryFee )
	jQuery("#delivery_fee").html( formatCurrencyInt( nFinalDeliveryFee ) );

jQuery('*[id*=discount_amnt]:visible').each(function() {
	jQuery(this).text(0);
});
jQuery('*[id*=discount_desc]:visible').each(function() {
	jQuery(this).empty();
});

아래와 같이 변경
if( nTotalDiscount )
{
	jQuery("#promotion_title").html(ret_obj['promotion_title']);
	jQuery("#total_discount").html( formatCurrencyInt( nTotalDiscount ) );
	jQuery("#payment_amount").html( formatCurrencyInt( nPaymentAmnt ) );
	if( nFinalDeliveryFee )
		jQuery("#delivery_fee").html( formatCurrencyInt( nFinalDeliveryFee ) );
	
	jQuery('*[id*=discount_amnt]:visible').each(function() {
		jQuery(this).text(0);
	});
	jQuery('*[id*=discount_info]:visible').each(function() {
		jQuery(this).empty();
	});
}

v 0.8.26
30th, Jan 2019
1. 비회원 장바구니 기능 활성화
./skins/*/login_form.html에서 아래의 코드를
<a href="{getUrl('act','dispMemberSignUpForm')}">{$lang->cmd_signup}</a> | <a href="{getUrl('act','dispMemberFindAccount')}">{$lang->cmd_find_member_account}</a> | <a href="{getUrl('act','dispSvcartOrderItems','cartnos',Context::get('cartnos'))}" cond="$config->guest_buy != 'N'">{$lang->cmd_non_buy}</a>

아래와 같이 변경
<a href="{getUrl('act','dispMemberSignUpForm')}">{$lang->cmd_signup}</a> | <a href="{getUrl('act','dispMemberFindAccount')}">{$lang->cmd_find_member_account}</a> | <a href="{getUrl('act','dispSvorderOrderForm','cartnos',Context::get('cartnos'))}" cond="$config->guest_buy != 'N'">{$lang->cmd_non_buy}</a>

./m.skins/*/login_form.html에서 아래의 코드를
<a href="{getUrl('act','dispMemberFindAccount')}">{$lang->cmd_find_member_account}</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="{getUrl('act','dispMemberSignUpForm')}">{$lang->cmd_signup}</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="{getUrl('act','dispSvcartOrderItems','cartnos',Context::get('cartnos'))}" cond="$config->guest_buy != 'N'">{$lang->cmd_non_buy}</a>

아래와 같이 변경
<a href="{getUrl('act','dispMemberFindAccount')}">{$lang->cmd_find_member_account}</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="{getUrl('act','dispMemberSignUpForm')}">{$lang->cmd_signup}</a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a href="{getUrl('act','dispSvorderOrderForm','cartnos',Context::get('cartnos'))}" cond="$config->guest_buy != 'N'">{$lang->cmd_non_buy}</a>

v 0.8.27
2nd, Feb 2019
1. 관리자 화면의 모든 svitemItem::formatMoney을 number_format으로 변경

2. 관리자 화면의 주문 확인서에서 공급가, 부가세, 면세액 표시 섹션 제거
./tpl/ordersheet.html에서 아래의 코드 제거
<div class="table">
	<table>
		<thead>
			<tr>
				<th>{$lang->tax_products}</th>
				<th>{$lang->vat}</th>
				<th>{$lang->taxfree_products}</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{number_format($order_info->supply_amount)}</td>
				<td>{number_format($order_info->vat)}</td>
				<td>{number_format($order_info->taxfree_amount)}</td>
			</tr>
		</tbody>
	</table>
</div>

v 1.0.0
23rd, Feb 2019
1. 적립금 기능 보완
./skins/Trendshop/orderitems.html에서 아래의 코드를
<td>({$lang->remaning_reserves} : <span id="remaning_reserves">{number_format($reserves_info[my_reserves])}</span></td>

아래와 같이 변경
<td>({$lang->remaning_reserves} : <span id="remaning_reserves">{number_format($reserves_info[my_reserves])})</span></td>

./tpl/orderdetail.html에 아래의 코드 제거
<th>{$lang->mileage}</th>
<td>{$order_info->mileage}<div cond="$order_info->mileage_save=='Y'">({$lang->mileage_saved})</div></td>

<th>{$lang->use_mileage}</th>
<td>{$order_info->use_mileage}</td>

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
if( $oOrderInfo->reserves_receive_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLogByReservesSrl( $oOrderInfo->reserves_receive_srl  );
	if( $output->get('mode') == '+' )
		$oOrderInfo->received_reserves_amount = $output->get('amount');
}

./tpl/orderdetail.html에 아래의 코드 추가
<th>{$lang->delivery_fee}</th>
<td>+{number_format($order_info->delivery_fee)}</td>

./svorder.model.php::getSvorderCouponValidation() 제거
./svorder.model.php::getSvorderReservesValidation() 제거

./svorder.model.php::getSvorderConfirmInvoice() 추가

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
<tr>
	<!--@if($logged_info && $use_mileage=='Y')-->
	<th>{$lang->mileage} -</th>
	<td id="mileage_amount">{number_format($order_info->use_mileage)}</td>
	<!--@else-->
	<th>&nbsp;</th>
	<td>&nbsp;</td>
	<!--@endif-->
</tr>

아래와 같이 변경
<tr>
	<!--@if($logged_info && $order_info->consumed_reserves_amount)-->
	<th>{$lang->reserves} -</th>
	<td id="mileage_amount">{number_format($order_info->consumed_reserves_amount)}</td>
	<!--@else-->
	<th>&nbsp;</th>
	<td>&nbsp;</td>
	<!--@endif-->
</tr>

./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price, $order_info->member_srl );

아래와 같이 변경
$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price - $order_info->delivery_fee, $order_info->member_srl );

./svorder.view.php::dispSvorderOrderDetail()에 아래의 코드 추가
$oSvpromotionModel = &getModel('svpromotion'); 
if( $oOrderInfo->order_status < 6 )
	$oOrderInfo->received_reserves_amount = $oSvpromotionModel->getExpectedReserves( $oOrderInfo->total_price - $oOrderInfo->delivery_fee);

./svorder.view.php::dispSvorderOrderList()에 아래의 코드 추가
$oSvpromotionModel = &getModel('svpromotion');
foreach( $aOrderList as $key => $val )
{
	if( $val->order_status < 6 )
		$val->received_reserves = $oSvpromotionModel->getExpectedReserves( $val->total_price - $val->delivery_fee);
}

2. 일반 고객의 주문 관리 화면 보안 강화
./svorder.view.php::dispSvorderOrderDetail()에서 아래의 코드를
return new Object(-1, 'msg_login_required');

아래와 같이 변경
return new Object(-1, 'msg_invalid_order_srl');

./svorder.view.php::dispSvorderEscrowConfirm()에 아래의 코드 추가
if( $oOrderInfo->member_srl )
{
	$logged_info = Context::get('logged_info');
	if( $logged_info->member_srl != $oOrderInfo->member_srl )
		return new Object(-1,'msg_invalid_order_srl');
}

3. 일반 고객의 주문 관리 화면 코드 정리
./queries/getOrderListByMemberSrl.xml 추가
./queries/getOrderCartByOrderSrl.xml 추가

./svorder.view.php::dispSvorderOrderList() 수정

4. svitem.item.php 제거 준비
./skins/svorder/orderdetail.html에서 아래의 코드를
svitemItem::printPrice 
아래와 같이 변경
number_format

./skins/svorder/orderitems.html에서 아래의 코드를
svitemItem::printPrice 
아래와 같이 변경
number_format

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
$val->getThumbnail($module_info->thumbnail_width,$module_info->thumbnail_height,$module_info->thumbnail_type)
아래와 같이 변경
svitemView::getThumbnailUrl($val->thumb_file_srl, $module_info->thumbnail_width, $module_info->thumbnail_height, $module_info->thumbnail_type)

./skins/Trendshop/orderlist.html에서 아래의 코드를
$val->getThumbnail($module_info->thumbnail_width,$module_info->thumbnail_height,$module_info->thumbnail_type)
아래와 같이 변경
svitemView::getThumbnailUrl($val->thumb_file_srl, $module_info->thumbnail_width, $module_info->thumbnail_height, $module_info->thumbnail_type)

./skins/Trendshop/orderdetail.html에서 아래의 코드를
$val->getThumbnail($module_info->thumbnail_width,$module_info->thumbnail_height,$module_info->thumbnail_type)
아래와 같이 변경
svitemView::getThumbnailUrl($val->thumb_file_srl, $module_info->thumbnail_width, $module_info->thumbnail_height, $module_info->thumbnail_type)

./m.skins/trendshop/orderdetail.html에서 아래의 코드를
svitemItem::printPrice 
아래와 같이 변경
number_format

./m.skins/trendshop/orderitems.html에서 아래의 코드를
svitemItem::printPrice 
아래와 같이 변경
number_format

./m.skins/trendshop/ordercomplete.html에서 아래의 코드를
$val->getThumbnail($module_info->thumbnail_width,$module_info->thumbnail_height,$module_info->thumbnail_type)
아래와 같이 변경
svitemView::getThumbnailUrl($val->thumb_file_srl, $module_info->thumbnail_width, $module_info->thumbnail_height, $module_info->thumbnail_type)

./m.skins/trendshop/orderdetail.html에서 아래의 코드를
$val->getThumbnail($module_info->thumbnail_width,$module_info->thumbnail_height,$module_info->thumbnail_type)
아래와 같이 변경
svitemView::getThumbnailUrl($val->thumb_file_srl, $module_info->thumbnail_width, $module_info->thumbnail_height, $module_info->thumbnail_type)

./tpl/orderdetail.html에서 아래의 코드를
$item->getThumbnail(40)
아래와 같이 변경
svitemView::getThumbnailUrl($item->thumb_file_srl,40)

./tpl/ordersheet.html에서 아래의 코드를
$val->formatMoney
아래와 같이 변경
number_format

./svorder.model.php::_constructItemInfoByOrder()에서 아래의 코드를 
$item = new svitemItem( $val );
아래와 같이 변경
$item = $val;

5. svitem.item.php 제거
./svorder.class.php에서 아래의 코드를 제거
require_once(_XE_PATH_.'modules/svitem/svitem.item.php');


6. 쿼리 xml 이름 변경
./queries/getSvorderExtraVars.xml을 getExtraVars.xml로 변경

7. 관리자 화면 거래 원장 다운로드에 개선된 적립금 필드 추가
./svorder.admin.model.php::getDefaultDataFormConfig()에서 아래의 코드를
$virtual_vars = array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 'recipient_telnum', 'recipient_postcode', 'recipient_address', 'is_mobile_access', 'payment_method', 'remitter_name', 'mileage', 'mileage_save', 'use_mileage', 'title','option_price', 'option_title', 'item_count', 'total_price', 'sum_price', 'delivery_fee', 'total_discounted_price', 'total_discount_amount', 'invoice_no', 'express_id', 'delivfee_inadvance', 'regdate' );

아래와 같이 변경
$virtual_vars = array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 'recipient_telnum', 'recipient_postcode', 'recipient_address', 'is_mobile_access', 'payment_method', 'remitter_name', 'reserves-', 'reserves+', 'title','option_price', 'option_title', 'item_count', 'total_price', 'sum_price', 'delivery_fee', 'total_discounted_price', 'total_discount_amount', 'invoice_no', 'express_id', 'delivfee_inadvance', 'regdate' );

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에 아래의 코드 추가
$oSvPromotionModel = &getModel('svpromotion');

$nReservesConsumed = 0; 
$nReservesReceived = 0;
if( $rec->reserves_consume_srl || $rec->reserves_receive_srl )
{
	$oRst = $oSvPromotionModel->getReservesLogByOrderSrl( $rec->order_srl );
	foreach( $oRst->data as $key=>$val )
	{
		if( $val->is_deleted == 'N' && $val->is_active == 'Y' )
		{
			if( $val->mode == '-' )
				$nReservesConsumed += $val->amount;
			else if( $val->mode == '+' )
				$nReservesReceived += $val->amount;
		}
	}
}

else if( $key == 'reserves-' )
{
	if( $i == 0 )
		echo '"'.$nReservesConsumed.'"';
	else
		echo '""';
}
else if( $key == 'reserves+' )
{
	if( $i == 0 )
		echo '"'.$nReservesReceived.'"';
	else
		echo '""';
}

8. 결제 취소 시 프로모션 혜택 롤백 기능 추가
./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
if( count( $oOrder->checkout_promotion_info ) )
{
	$oSvPromotionController = &getController('svpromotion');
	$output = $oSvPromotionController->procSvprmotionRollbackUsedCoupon( $oOrder );
	if( !$output->toBool() )
		return $output;
}

아래와 같이 변경
$oSvPromotionController = &getController('svpromotion');
$output = $oSvPromotionController->procSvprmotionRollbackBenefit( $oOrder );
if( !$output->toBool() )
	return $output;

9. 주문 상태에 [반품] 추가
./svorder.class.php::svorder()에서 아래의 코드를
var $order_status = array('0'=>'cart_keep', '1'=>'wait_deposit', '2'=>'deposit_done', '3'=>'prepare_delivery', '4'=>'on_delivery', '5'=>'delivery_done', '6'=>'transaction_done', 'E'=>'on_cancelling', 'A'=>'cancelled' );

아래와 같이 변경
var $order_status = array('0'=>'cart_keep', '1'=>'wait_deposit', '2'=>'deposit_done', '3'=>'prepare_delivery', '4'=>'on_delivery', '5'=>'delivery_done', '6'=>'transaction_done', 'E'=>'on_cancelling', 'A'=>'cancelled','B'=>'returns' );

./tpl/ordermanagement_header.html에 아래의 코드 추가
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','B')}" class="active"|cond="$status=='B'">{$lang->returns}</a> <i>|</i>

./tpl/ordermanagement.html에서 아래의 코드를
<option value="B" selected="selected"|cond="$status=='A'">{$lang->returns}</option>
<option value="C" selected="selected"|cond="$status=='B'">{$lang->exchanges}</option>
<option value="D" selected="selected"|cond="$status=='C'">{$lang->refund}</option>

아래와 같이 변경
<option value="B" selected="selected"|cond="$status=='B'">{$lang->returns}</option>

10. 비회원 주문 조회 코드 블록 개선
./queries/getNonOrderItems.xml 제거

./svorder.view.php::dispSvorderNonOrderList()에서 아래의 코드를
$output = executeQueryArray('svorder.getNonOrderItems', $args);
$item_list = $output->data;
$order_list = array();
if( $item_list )
{
	$oSvitemModel = &getModel('svitem');
	foreach ($item_list as $key=>$val) 
	{
		//$item = new svitemItem($val, $config->currency, $config->as_sign, $config->decimals);
		$item = $oSvitemModel->getItemInfoByItemSrl( $val->item_srl );
		if ($item->option_srl)
			$item->price += ($item->option_price);

		$item_list[$key] = $item;

		if (!isset($order_list[$val->order_srl]))
			$order_list[$val->order_srl] = array();

		$order_list[$val->order_srl][] = $item;
	}
}

아래와 같이 변경
$aOrderList = $oSvorderModel->getOrderedList( $oOrderArgs );

11. svitem V 3.0.0에 대응
./svorder.controller.php::createCartObj() 에서 아래의 코드를
$item_info = $oSvitemModel->getItemInfo($val->item_srl);

아래와 같이 변경
$item_info = $oSvitemModel->getItemInfoByItemSrl($val->item_srl);

./svorder.controller.php::_insertCartItem() 에서 아래의 코드를
$item_info = $oSvitemModel->getItemInfo($val->item_srl);

아래와 같이 변경
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl($val->item_srl);

./svorder.view.php::dispSvorderOrderComplete() 에서 아래의 코드를
$oItemInfo = $oSvitemModel->getItemInfo( $val->item_srl );

아래와 같이 변경
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl( $val->item_srl );

./svorder.controller.php::transmitOrderInfoExt() 에서 아래의 코드를
$oItemInfo = $oSvitemModel->getItemInfo($val1->giveaway_item_srl);

아래와 같이 변경
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl($val1->giveaway_item_srl);

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder() 에서 아래의 코드를
$oItemInfo = $oSvitemModel->getItemInfo( $val2->bundle_item_srl );
$oItemInfo = $oSvitemModel->getItemInfo( $val2->giveaway_item_srl );
아래와 같이 변경
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl( $val2->bundle_item_srl );
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl( $val2->giveaway_item_srl );

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll() 에서 아래의 코드를
$oItemInfo = $oSvitemModel->getItemInfo( $val->bundle_item_srl );

아래와 같이 변경
$oItemInfo = $oSvitemModel->getItemInfoByItemSrl( $val->bundle_item_srl );

v 1.0.1
4th, Mar 2019
1. 외부 매체 전환 추적 스크립트 시행 코드 블럭 개선
./svorder.view.php::dispSvorderOrderComplete() 에서 아래의 코드를
$sExtScriptArchivePath = _XE_PATH_.'files/svorder/';
$oTemplate = &TemplateHandler::getInstance();
$sExtScript = $oTemplate->compile($sExtScriptArchivePath, 'ext_script_ordercomplete_'.$this->module_info->module_srl);
Context::set('ext_script', $sExtScript );

아래와 같이 변경
$sExtScriptArchivePath = _XE_PATH_.'files/svorder/';
$sExtScriptFilename = 'ext_script_ordercomplete_'.$this->module_info->module_srl;
$bRst = FileHandler::exists( $sExtScriptArchivePath.$sExtScriptFilename.'.html');
if( $bRst )
{
	$oTemplate = &TemplateHandler::getInstance();
	$sExtScript = $oTemplate->compile($sExtScriptArchivePath, 'ext_script_ordercomplete_'.$this->module_info->module_srl);
	Context::set('ext_script', $sExtScript );
}

v 1.0.2
5th, Mar 2019
1. 코드 오류 수정
./svorder.model.php::getOrderedList()에서 아래의 코드를 
$oReservesRst = $oSvpromotionModel->getReservesStatusByMemberSrl($nMemberSrl);

아래와 같이 변경
$oReservesRst = $oSvpromotionModel->getReservesStatusByMemberSrl($oOrderArgs->member_srl);

v 1.0.3
6th, Mar 2019
1. svitem v 3.0.1에 대응
./queries/getOrderItemsForPg.xml에서 아래의 코드 제거
<column name="items.file_srl" alias="file_srl" />

./queries/getOrderItemsByStatus.xml에서 아래의 코드 제거
<column name="items.file_srl" alias="file_srl" />

./queries/getOrderItems.xml에서 아래의 코드 제거
<column name="items.file_srl" alias="file_srl" />

./queries/getOrderedItemsByOrderSrl.xml에서 아래의 코드 제거
<column name="item.file_srl" alias="file_srl" />

2. mileage 관련 미사용 코드 제거
./ecaso_query.class.php::ecasoQuery()에서 아래의 코드 제거
'MI'=>'mileage'

./svorder.class.php::svorder()에서 아래의 코드를
var $payment_method = array(
	'CC'=>'credit_card','BT'=>'bank_transfer','IB'=>'internet_banking','VA'=>'virtual_account','MP'=>'mobile_phone','MI'=>'mileage'
);
아래와 같이 변경
var $payment_method = array(
	'CC'=>'credit_card','BT'=>'bank_transfer','IB'=>'internet_banking','VA'=>'virtual_account','MP'=>'mobile_phone'
);

./svorder.admin.model.php::getDataFormatConfig()에서 아래의 코드를
$aBuff = Array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 'recipient_telnum', 'recipient_postcode', 'recipient_address', 'is_mobile_access', 'payment_method', 'remitter_name', 'mileage', 'mileage_save', 'use_mileage', 'title', 'option_price', 'option_title', 'item_count', 'total_price', 'sum_price', 'delivery_fee', 'total_discounted_price', 'total_discount_amount', 'invoice_no', 'express_id', 'delivfee_inadvance', 'regdate' );

아래와 같이 변경
$aBuff = Array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 'recipient_telnum', 'recipient_postcode', 'recipient_address', 'is_mobile_access', 'payment_method', 'remitter_name', 'consumed_reserves', 'received_reserves', 'title', 'option_price', 'option_title', 'item_count', 'total_price', 'sum_price', 'delivery_fee', 'total_discounted_price', 'total_discount_amount', 'invoice_no', 'express_id', 'delivfee_inadvance', 'regdate' );

./svorder.admin.model.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드를
$oDataConfig = $oSvorderAdminModel->getDefaultDataFormConfig( $this->module_info->module_srl );

아래와 같이 변경
$oDataConfig = $oSvorderAdminModel->getDataFormatConfig( $this->module_info->module_srl );

./svorder.admin.model.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
$oSvPromotionModel = &getModel('svpromotion');

$nReservesConsumed = 0;
$nReservesReceived = 0;
if( $rec->reserves_consume_srl || $rec->reserves_receive_srl )
{
	$oRst = $oSvPromotionModel->getReservesLogByOrderSrl( $rec->order_srl );
	foreach( $oRst->data as $key=>$val )
	{
		if( $val->is_deleted == 'N' && $val->is_active == 'Y' )
		{
			if( $val->mode == '-' )
				$nReservesConsumed += $val->amount;
			else if( $val->mode == '+' )
				$nReservesReceived += $val->amount;
		}
	}
}

else if( $key == 'consumed_reserves' )
{
	if( $i == 0 )
		echo '"'.$nReservesConsumed.'"';
	else
		echo '""';
}
else if( $key == 'received_reserves' )
{
	if( $i == 0 )
		echo '"'.$nReservesReceived.'"';
	else
		echo '""';
}

v 1.0.4
7th, Mar 2019
1. 한 주문에 다중 송장 처리 기능 개선
./svorder.admin.controller.php::parseInvoiceSerials() 추가

./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 아래의 코드를
$oSvorderController = &getController('svorder');
$order_srls = Context::get('order_srls');
$express_ids = Context::get('express_id');
$invoice_nos = Context::get('invoice_no');
// 송장번호에 -가 포함되어 있으면 제거
$invoice_nos = str_replace( '-', '', $invoice_nos );
// 다중 송장을 .로 구분하면 ,으로 변경
$invoice_nos = str_replace( '.', ',', $invoice_nos );
$extra_invoice_nos = Context::get( 'extra_invoice_no' );
$nUpdatedItems = 0;

foreach( $order_srls as $key=>$order_srl )
{
	$express_id = $express_ids[$key];
	$invoice_no = $invoice_nos[$key];
	
	// 주문관리 화면에서 수기로 ,구분된 복수 송장 입력하는 경우
	$pos = strpos( $invoice_no, ',' );
	if( $pos !== false )
	{
		$aInvoice = array();
		$aInvoice = explode( ',', $invoice_no );
		$aInvoice = array_unique($aInvoice);
		$nCnt = count( $aInvoice );
		$invoice_no = $aInvoice[0];
		if( $nCnt > 1 )
		{
			array_shift($aInvoice);
			$args->extra_invoice_no = serialize($aInvoice);
		}
	}

	if( $extra_invoice_nos[$key] !== NULL )
		$args->extra_invoice_no = $extra_invoice_nos[$key];

	$args->order_srl = $order_srl;
	$args->order_status = 4; // 송장번호가 입력되면 배송중 상태로 변경
	$args->express_id = $express_id;
	$args->invoice_no = $invoice_no;

	// 상태값변경, 배송회사, 운송장번호 데이터가 없으면 업데이트 필요치 않는다.
	if( !$args->express_id || strlen( $args->invoice_no )==0)
		continue;

	// express_id값은 항상 넘어 오므로 이 루틴을 타게된다.
	$output = $oSvorderController->updateOrderStatus( $order_srl, $args );
	if( !$output->toBool() )
		return $output;
	
	unset( $args );
	$nUpdatedItems++;
}

아래와 같이 변경
$order_srls = Context::get('order_srls');
$express_ids = Context::get('express_id');
$invoice_nos = Context::get('invoice_no');
$nUpdatedItems = 0;

foreach( $order_srls as $key=>$order_srl )
{
	$express_id = $express_ids[$key];
	$invoice_no = $invoice_nos[$key];
	$aInvoiceInfo = $this->parseInvoiceSerials( $invoice_no );
	$args->invoice_no = $aInvoiceInfo['default'];
	$args->extra_invoice_no = $aInvoiceInfo['extra'];
	$args->order_srl = $order_srl;
	$args->order_status = 4; // 송장번호가 입력되면 배송중 상태로 변경
	$args->express_id = $express_id;
	// 상태값변경, 배송회사, 운송장번호 데이터가 없으면 업데이트 필요치 않는다.
	if( !$args->express_id || strlen( $args->invoice_no )==0)
		continue;
	
	// express_id값은 항상 넘어 오므로 이 루틴을 타게된다.
	$oSvorderController = &getController('svorder');
	$output = $oSvorderController->updateOrderStatus( $order_srl, $args );
	if( !$output->toBool() )
		return $output;
	
	unset( $args );
	$nUpdatedItems++;
}

./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
$args->extra_invoice_no = $in_args->extra_invoice_no;

아래와 같이 변경
$args->extra_invoice_no = serialize( $in_args->extra_invoice_no );

./ecaso_listen.class.php::_setInvoiceByOrder()에서 아래의 코드를
// 송장번호에 -가 포함되어 있으면 제거
$sShippingInvoice = str_replace( '-', '', $aShippingInvoice[$key] );
// 다중 송장을 .로 구분하면 ,으로 변경
$sShippingInvoice = str_replace( '.', ',', $sShippingInvoice );
// ,구분된 복수 송장 입력하는 경우
$pos = strpos( $sShippingInvoice, ',' );
if( $pos !== false ) 
{
	$aInvoice = array();
	$aInvoice = explode( ',', $sShippingInvoice );
	$aInvoice = array_unique($aInvoice);
	$nCnt = count( $aInvoice );
	$sShippingInvoice = $aInvoice[0];
	if( $nCnt > 1 )
	{
		array_shift($aInvoice);
		$args->extra_invoice_no = serialize($aInvoice);
	}
	/*$temp_invoice_no = substr( $sShippingInvoice, 0, $pos );
	$temp_extra_invoice_nos = substr( $sShippingInvoice, $pos+1 );
	$temp_extra_invoice_nos = str_replace( ',', '|@|', $temp_extra_invoice_nos );
	$args->extra_invoice_no = $temp_extra_invoice_nos ;
	$sShippingInvoice = $temp_invoice_no;*/
} 

if( $extra_invoice_nos !== NULL )
	$args->extra_invoice_no = $extra_invoice_nos;

$args->order_srl = $sSvOrderSrl;
$args->order_status = 4; // 송장번호가 입력되면 배송중 상태로 변경
$args->express_id = $sExpressId;
$args->invoice_no = $sShippingInvoice;

아래와 같이 변경
$oSvorderAdminController = getAdminController('svorder');
$aInvoiceInfo = $oSvorderAdminController->parseInvoiceSerials( $aShippingInvoice[$key] );
$args->invoice_no = $aInvoiceInfo['default'];
$args->extra_invoice_no = $aInvoiceInfo['extra'];

2. 주문자 결제 화면 편의성 개선
./svorder.class.php::svorder()에 아래의 코드 추가
const COOKIE_PURCHASER_NAME = 'sv_purchaser_name';
const COOKIE_PURCHASER_EMAIL = 'sv_purchaser_email';

./svorder.view.php::dispSvorderOrderForm()에 아래의 코드 추가
if($logged_info)
{
	$oPurchaserInfo->user_name = $logged_info->user_name;
	$oPurchaserInfo->email_address = $logged_info->email_address;
}
else
{
	$oPurchaserInfo->user_name = $_COOKIE[COOKIE_PURCHASER_NAME];
	$oPurchaserInfo->email_address = $_COOKIE[COOKIE_PURCHASER_EMAIL];
}

./svorder.controller.php::_validatePurchaserReceipientInfo()에 아래의 코드 추가
$nExpirationTimestamp = time() + 86400 * 30; // 30 days
setcookie(COOKIE_PURCHASER_NAME, $in_args->purchaser_name, $nExpirationTimestamp);
setcookie(COOKIE_PURCHASER_EMAIL, $in_args->purchaser_email, $nExpirationTimestamp);

./skin/Trendshop/orderitems.html에서 아래의 코드를
<td class="text"><input type="text" name="purchaser_name" id="purchaser_name" value="" /></td>
<td class="email_address"><input type="text" name="purchaser_email" id="purchaser_email" value="" /></td>

아래와 같이 변경
<td class="text"><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}" /></td>
<td class="email_address"><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}" /></td>

./m.skin/trendshop/orderitems.html에서 아래의 코드를
<td><input type="text" name="purchaser_name" id="purchaser_name" value="" /></td>
<td><input type="text" name="purchaser_email" value="" /></td>

아래와 같이 변경
<td><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}" /></td>
<td><input type="text" name="purchaser_email" value="{$purchaser_info->email_address}" /></td>

3. 주문 상태 판별하는 코드 개선
./svorder.class.php::svorder()에서 아래의 코드를
const ORDER_STATE_COMPLETE = 6;
var $order_status = array('0'=>'cart_keep', '1'=>'wait_deposit', '2'=>'deposit_done', '3'=>'prepare_delivery', '4'=>'on_delivery', '5'=>'delivery_done', '6'=>'transaction_done', 'E'=>'on_cancelling', 'A'=>'cancelled','B'=>'returns' );

아래와 같이 변경
const ORDER_STATE_ON_CART = '0';
const ORDER_STATE_ON_DEPOSIT = '1';
const ORDER_STATE_PAID = '2';
const ORDER_STATE_PREPARE_DELIVERY = '3';
const ORDER_STATE_ON_DELIVERY = '4';
const ORDER_STATE_DELIVERED = '5';
const ORDER_STATE_COMPLETED = '6';
const ORDER_STATE_ON_CANCELLING = 'E';
const ORDER_STATE_CANCELLED = 'A';
const ORDER_STATE_RETURNED = 'B';
// 취소요청 후에 취소가 배치되도록 코드값 재배열 필요함
protected $_g_aOrderStatus = array(
	svorder::ORDER_STATE_ON_CART=>'cart_keep', 
	svorder::ORDER_STATE_ON_DEPOSIT=>'wait_deposit', 
	svorder::ORDER_STATE_PAID=>'deposit_done', 
	svorder::ORDER_STATE_PREPARE_DELIVERY=>'prepare_delivery', 
	svorder::ORDER_STATE_ON_DELIVERY=>'on_delivery', 
	svorder::ORDER_STATE_DELIVERED=>'delivery_done', 
	svorder::ORDER_STATE_COMPLETED=>'transaction_done', 
	svorder::ORDER_STATE_ON_CANCELLING=>'on_cancelling', 
	svorder::ORDER_STATE_CANCELLED=>'cancelled',
	svorder::ORDER_STATE_RETURNED=>'returns' ); 

./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
if( $in_args->order_status == svorder::ORDER_STATE_COMPLETE )

아래와 같이 변경
if( $in_args->order_status == svorder::ORDER_STATE_COMPLETED )

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
Context::set( 'status', '1' );

아래와 같이 변경
Context::set( 'status', svorder::ORDER_STATE_ON_DEPOSIT );

./svorder.admin.view.php::dispSvorderAdminRecoverTransaction()에서 아래의 코드를
$args->order_status = 0;

아래와 같이 변경
$args->order_status = svorder::ORDER_STATE_ON_CART

./svorder.admin.model.php::getOrderListByStatus() 추가

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
$output = executeQueryArray( 'svorder.getOrderListByStatus', $args );
if( !$output->toBool() )
	return $output;

if( $args->order_status == svorder::ORDER_STATE_PAID ) // 외부 서버 전송 상태일 때, PG 통신 실패한 경우, 외부서버에 수기 전송을 위해
{
	$oModuleModel = &getModel('module');
	foreach( $output->data as $key=>$val ) 
	{
		if( is_null( $val->thirdparty_order_id ) || $val->thirdparty_order_id == 'err:general_transmit_failure' )
		{
			$oRst = $oModuleModel->getModuleInfoByModuleSrl($val->module_srl);
			if( $oRst->module == 'svorder' )
				$output->data[$key]->thirdparty_order_id = "<a href='".getUrl('module', 'svshopmaster','act','dispSvorderAdminOrderDetail','order_srl',$val->order_srl, 'mid', $oRst->mid, 'status', '')."'>".$config->external_server."주문번호받기</a>";
			else
				$output->data[$key]->thirdparty_order_id = '연결된 장바구니 모듈 에러';
		}
	}
}
$order_list = $output->data;
if( !is_array( $order_list ) ) 
	$order_list = array();

아래와 같이 변경
$oSvorderAdminModel = &getAdminModel('svorder');
$oOrderList = $oSvorderAdminModel->getOrderListByStatus( $args );

./svorder.class.php::getOrderStatus() 제거
./svorder.model.php::getOrderStatusLabel() 추가하고 이와 관련된 모든 코드 변경

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
$oOrderInfo->extra_invoice_no = unserialize( $oOrderInfo->extra_invoice_no );
$oOrderInfo->extra_vars = unserialize( $oOrderInfo->extra_vars );
if( $oOrderInfo->invoice_no )
{
	$oOrderInfo->carrier_title = $this->delivery_companies[$oOrderInfo->express_id];
	$oOrderInfo->invoice_count = count( $oOrderInfo->invoice_no ) + count( $oOrderInfo->extra_invoice_no );
}

./tpl/orderdetail.html에서 아래의 코드 제거
<br />
<a cond="in_array($item->order_status,array('3','4'))" href="{$delivery_inquiry_urls[$item->express_id]}{$item->invoice_no}" class="kso_btn" target="_blank"><span>배송추적</span></a>

./tpl/orderdetail.html에서 아래의 코드 추가
<tr loop="$order_info->extra_invoice_no=>$extra_invoice_idx,$extra_invoice_no">
	<td><select name="primary_express_id"><option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$order_info->express_id==$key">{$val}</option></select></td>					
	<td><input type="text" name="primary_invoice_no" value="{$extra_invoice_no}" /> <a cond="in_array($item->order_status,array('3','4'))" href="{$delivery_inquiry_urls[$item->express_id]}{$extra_invoice_no}" class="kso_btn" target="_blank"><span>배송추적</span></a></td>
</tr>

./skins/Trendshop/orderdetail.html에 아래의 코드 추가
<block cond="$order_info->invoice_no">
	<div class="float-none newclearfix"></div>
	<div class="newclearfix">
		<h3 class="order-section-title" style="margin-bottom:0">{$lang->title_delivery_info}</h3>
		<div class="item-count newclearfix">{$lang->invoice_count} : {$order_info->invoice_count}</div>
		<table class="item-table">
			<thead>
				<tr>
					<th>{$lang->delivery_company}</th>
					<th>{$lang->status}</th>
					<th>{$lang->invoice_no}</th>
					<th>실시간 현황</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>{$order_info->carrier_title}</td>
					<td>{$order_status[$order_info->order_status]}</td>
					<td>{$order_info->invoice_no}</td>
					<td>
						<block cond="$val->express_id != '00'">
						<a href="{$delivery_inquiry_urls[$val->express_id]}{$order_info->invoice_no}" target="_blank">{$lang->cmd_trace_delivery}</a>
						</block>
					</td>
				</tr>
				<tr loop="$order_info->extra_invoice_no=>$extIdx,$ext_invoice">
					<td>{$order_info->carrier_title}</td>
					<td>{$order_status[$order_info->order_status]}</td>
					<td>{$ext_invoice}</td>
					<td>
						<block cond="$val->express_id != '00'">
						<a href="{$delivery_inquiry_urls[$val->express_id]}{$ext_invoice}" target="_blank">{$lang->cmd_trace_delivery}</a>
						</block>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</block>

4. 미사용 코드 제거
./tpl/ordermangement.html에서 아래의 코드 제거
{@unset($order_status['0'])}

./svorder.class.php에서 아래의 코드 제거
define('WAIT_FOR_DEPOSIT', '1');
define('PREPARE_DELIVERY', '2');

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
if($module_info && !in_array($module_info->module, array('svorder','svorder_digital','elearning')))

아래와 같이 변경
if($module_info && $module_info->module != 'svorder')

5. module MECE 개선
./svorder.class.php::$payment_method 제거
./svorder.class.php::getPaymentMethods() 제거

./svorder.view.php::dispSvorderOrderDetail()에서 아래의 코드를
Context::set( 'payment_method', $this->getPaymentMethods() );

아래와 같이 변경
Context::set( 'payment_method', $oSvpgModel->getPaymentMethodLabel() );

./svorder.admin.view.php::dispSvorderAdminOrderDetail()에서 아래의 코드를
Context::set('payment_method', $this->getPaymentMethods());

아래와 같이 변경
Context::set( 'payment_method', $oSvpgModel->getPaymentMethodLabel() );

5. 주문 취소 기능 정리
./skins/Trendshop/orderdetail.html에서 아래의 코드 제거
<script>
function cancelSettlement( nOrderSrl )
{
	if( typeof nOrderSrl == 'undefined' )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	if( nOrderSrl.length == 0 )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	var sCancelReason = prompt("결제 취소 사유를 입력해 주세요.", "예)주문 취소");
	if( sCancelReason == null )
		return;
	else if( sCancelReason == "예)주문 취소" || sCancelReason == '' || sCancelReason == null )
	{
		alert( '취소사유를 입력해 주세요.' );
		return;
	}

	var params = new Array();
	params['order_srl'] = nOrderSrl;
	params['cancel_reason'] = sCancelReason;
	exec_xml('svorder', 'procSvorderCancelSettlement', params, function(ret_obj){
		alert(ret_obj['message']);
// Google Analytics Code Begin (3/4/2016 9:48 AM) singleview.co.kr --->
		gatkMypage.refund( nOrderSrl );
		gatkHeader.close();
// Google Analytics Code End (3/4/2016 9:48 AM) singleview.co.kr --->
		location.reload();
	});
}
</script>

./m.skins/trendshop/orderdetail.html에서 아래의 코드 제거
<script>
jQuery(function($){
	$('.escrow').escrow();

	$('.receipt').click(function() {
		var order_srl = $(this).attr('data-order-srl');
		var $_parent = $(this).parent();
		exec_xml(
			'epay',
			'getEpayReceipt',
			{order_srl:order_srl},
			function(ret){
				var tpl = ret.tpl.replace(/<enter>/g, '\n');
				$_parent.html(tpl);
			},
			['error','message','tpl']
		);
	});
});
</script>

<script>
function cancelSettlement( nOrderSrl )
{
	if( typeof nOrderSrl == 'undefined' )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	if( nOrderSrl.length == 0 )
	{
		alert( '잘못된 주문번호입니다.' );
		return;
	}

	var sCancelReason = prompt("결제 취소 사유를 입력해 주세요.", "예)주문 취소");
	if( sCancelReason == null )
		return;
	else if( sCancelReason == "예)주문 취소" || sCancelReason == '' || sCancelReason == null )
	{
		alert( '취소사유를 입력해 주세요.' );
		return;
	}

	var params = new Array();
	params['order_srl'] = nOrderSrl;
	params['cancel_reason'] = sCancelReason;
	exec_xml('svorder', 'procSvorderCancelSettlement', params, function(ret_obj){
		alert(ret_obj['message']);
// Google Analytics Code Begin (3/4/2016 9:48 AM) singleview.co.kr --->
		gatkMypage.refund( nOrderSrl );
		gatkHeader.close();
// Google Analytics Code End (3/4/2016 9:48 AM) singleview.co.kr --->
		location.reload();
	});
}
</script>

6. 결제 완료 화면에서 예상 적립금 표시 추가
./svorder.view.php::dispSvorderOrderComplete()에 아래의 코드 추가
$oSvpromotionModel = &getModel('svpromotion');
$nExpectedReserves = $oSvpromotionModel->getExpectedReserves( $oOrderInfo->total_price - $oOrderInfo->delivery_fee );
$oOrderInfo->tobe_received_reserves = $nExpectedReserves;

7. 결제 완료 화면에서 배송 정보 표시 추가
./svorder.model.php::getOrderInfo()에 아래의 코드 추가
$oOrderInfo->recipient_address = unserialize( $oOrderInfo->recipient_address );

./m.skins/trendshop/ordercomplete.html에서 아래의 코드를
$address = unserialize($order_info->recipient_address);

아래와 같이 변경
$address = $order_info->recipient_address;

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
$address = unserialize($order_info->recipient_address);

아래와 같이 변경
$address = $order_info->recipient_address;

./tpl/orderdetail.html에서 아래의 코드를
$address = unserialize($order_info->recipient_address);

아래와 같이 변경
$address = $order_info->recipient_address;

./m.skins/trendshop/ordercomplete.html에 아래의 코드 추가
{@
$address = $order_info->recipient_address;
$address1 = $address[0];
$address2 = $address[1];
$address3 = $address[2];
$address4 = $address[3];
}
<div id="orderer-info">
	<table class="info-table">
		<thead>
			<tr>
				<th>{$lang->delivery_info}</th>
				<td></td>
			</tr>
		</thead>
		<tbody>
			<tr cond="$order_info->recipient_name">
				<th>{$lang->recipient}</th>
				<td>{$order_info->recipient_name}</td>
			</tr>
			<tr cond="$order_info->recipient_cellphone">
				<th>{$lang->cellphone}</th>
				<td class="number-font">{$order_info->recipient_cellphone}</td>
			</tr>
			<tr cond="$order_info->recipient_telnum">
				<th>{$lang->telnum}</th>
				<td class="number-font">{$order_info->recipient_telnum}</td>
			</tr>
			<tr cond="$address1">
				<th>{$lang->address}</th>
				<td><span cond="$order_info->recipient_postcode">({$order_info->recipient_postcode})</span>{$address1} {$address2} {$address3} {$address4}</td>
			</tr>
			<tr cond="$order_info->extra_vars['delivery_memo']">
				<th>{$lang->delivery_memo}</th>
				<td>{$order_info->extra_vars['delivery_memo']}</td>
			</tr>
		</tbody>
	</table>
</div>

./skins/Trendshop/ordercomplete.html에 아래의 코드 추가
{@
$address = $order_info->recipient_address;
$address1 = $address[0];
$address2 = $address[1];
$address3 = $address[2];
$address4 = $address[3];
}
<div id="orderer-info" class="newclearfix">
	<div  class="fieldset newclearfix">
		<h3 class="fieldset-title">{$lang->delivery_info}</h3>
		<table class="fieldset-table">
			<tbody>
				<tr cond="$order_info->recipient_name">
					<th>{$lang->recipient}</th>
					<td>{$order_info->recipient_name}</td>
				</tr>
				<tr cond="$order_info->recipient_cellphone">
					<th>{$lang->cellphone}</th>
					<td class="number-font">{$order_info->recipient_cellphone}</td>
				</tr>
				<tr cond="$order_info->recipient_telnum">
					<th>{$lang->telnum}</th>
					<td class="number-font">{$order_info->recipient_telnum}</td>
				</tr>
				<tr cond="$address1">
					<th>{$lang->address}</th>
					<td><span cond="$order_info->recipient_postcode">({$order_info->recipient_postcode})</span>{$address1} {$address2} {$address3} {$address4}</td>
				</tr>
				<tr cond="$order_info->extra_vars['delivery_memo']">
					<th>{$lang->delivery_memo}</th>
					<td>{$order_info->extra_vars['delivery_memo']}</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

8. svpg v0.3.9에 대응함
./tpl/insertmodinst.html에서 아래의 코드를
<option loop="$svpg_modules=>$key,$val" value="{$val->module_srl}" selected="selected"|cond="$module_info->svpg_module_srl==$val->module_srl" >{$val->browser_title}</option>

아래와 같이 변경
<option loop="$svpg_modules=>$key,$val" value="{$val->module_srl}" selected="selected"|cond="$module_info->svpg_module_srl==$val->module_srl" >{$val->mid}</option>

9. 싱글뷰 몰 최초 설치 시 svorder mid가 미등록 상태인 경우 ext_script에 오류 메세지 출력 방지
./svorder.admin.model.php::getExtScript()에서 아래의 코드를
if( !(int)$nModuleSrl )
	return 'invalid_module_srl';

아래와 같이 변경
if( !(int)$nModuleSrl )
{
	$oModuleModel = &getModel('module');
	$aInstalledMidList = $oModuleModel->getMidList();
	foreach( $aInstalledMidList as $nIdx => $oMid )
	{
		if( $oMid->module == 'svorder' )
			return 'invalid_module_srl';
	}
	return '';
}

./tpl/insertmodinst.html에서 아래의 코드를
<section class="section"">

아래와 같이 변경
<section class="section" cond="$module_srl">

10. 취소 완료된 주문은 상태 변경 금지
./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
$oSvorderModel = &getModel('svorder');
// svshopmaster에서 거래완료로 분류되는 거래만 처리함
if( $in_args->order_status == svorder::ORDER_STATE_COMPLETED )
{
	$order_info = $oSvorderModel->getOrderInfo( $order_srl );
	if( $order_info->member_srl )
	{
		$oSvpromotionModel = &getModel('svpromotion');
		$oSvpromotionConfig = $oSvpromotionModel->getModuleConfig();
		if( (int)$oSvpromotionConfig->reserves_ratio > 0 )
		{
			$oSvpromotionController = &getController( 'svpromotion' );
			$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price - $order_info->delivery_fee, $order_info->member_srl );
			$nReservesSrl = (int)$output->get('reserves_srl');
			if( $nReservesSrl )
				$args->reserves_receive_srl = $nReservesSrl;
		}
	}
	if( $order_info->item_list )
	{
		foreach( $order_info->item_list as $key=>$item )
		{
			$item_srl = $item->item_srl;
			$quantity = $item->quantity;
			$this->_updateSalesCount( $item_srl, $quantity );
		}
	}
}
$args->order_srl = $order_srl;
// 원본 주문 상태와 비교를 위해서 값 추출
$output = executeQuery( 'svorder.getOrderInfo', $args );
if( !$output->toBool() )
	return $output;
$sPurchaserName = $output->data->purchaser_name;
$sPurchaserCellPhone = $output->data->purchaser_cellphone;
$nOriginalOrderStatus = (int)$output->data->order_status;

아래와 같이 변경
$oOriginalOrderArgs->order_srl = $order_srl;
// 원본 주문 상태와 비교를 위해서 값 추출
$output = executeQuery( 'svorder.getOrderInfo', $oOriginalOrderArgs );
if( !$output->toBool() )
	return $output;
$sPurchaserName = $output->data->purchaser_name;
$sPurchaserCellPhone = $output->data->purchaser_cellphone;
$nOriginalOrderStatus = $output->data->order_status;
if( $nOriginalOrderStatus == svorder::ORDER_STATE_CANCELLED )
	return new Object(-1, 'msg_already_cancelled_order');

// svshopmaster에서 거래완료로 분류되는 거래만 처리함
if( $in_args->order_status == svorder::ORDER_STATE_COMPLETED )
{
	$oSvorderModel = &getModel('svorder');
	$order_info = $oSvorderModel->getOrderInfo( $order_srl );
	if( $order_info->member_srl )
	{
		$oSvpromotionModel = &getModel('svpromotion');
		$oSvpromotionConfig = $oSvpromotionModel->getModuleConfig();
		if( (int)$oSvpromotionConfig->reserves_ratio > 0 )
		{
			$oSvpromotionController = &getController( 'svpromotion' );
			$output = $oSvpromotionController->issueReserves( $order_srl, $order_info->total_price - $order_info->delivery_fee, $order_info->member_srl );
			$nReservesSrl = (int)$output->get('reserves_srl');
			if( $nReservesSrl )
				$args->reserves_receive_srl = $nReservesSrl;
		}
	}
	if( $order_info->item_list )
	{
		foreach( $order_info->item_list as $key=>$item )
		{
			$item_srl = $item->item_srl;
			$quantity = $item->quantity;
			$this->_updateSalesCount( $item_srl, $quantity );
		}
	}
}

11. 회원 구매 시 주문자명과 이메일 주소 입력 UI 개선
./svorder.view.php::dispSvorderOrderForm()에서 아래의 코드를
if($logged_info)
{
	$oPurchaserInfo->user_name = $logged_info->user_name;
	$oPurchaserInfo->email_address = $logged_info->email_address;
}
else
{
	$oPurchaserInfo->user_name = $_COOKIE[COOKIE_PURCHASER_NAME];
	$oPurchaserInfo->email_address = $_COOKIE[COOKIE_PURCHASER_EMAIL];
}

아래와 같이 변경
$oPurchaserInfo->is_readonly_name = false;
$oPurchaserInfo->is_readonly_email = false;
if($logged_info)
{
	$oPurchaserInfo->user_name = $logged_info->user_name;
	$oPurchaserInfo->email_address = $logged_info->email_address;
	$oPurchaserInfo->is_readonly_name = true;
	$oPurchaserInfo->is_readonly_email = true;
}
else
{
	$oPurchaserInfo->user_name = $_COOKIE[COOKIE_PURCHASER_NAME];
	$oPurchaserInfo->email_address = $_COOKIE[COOKIE_PURCHASER_EMAIL];
}

./skins/Trendshop/orderitems.html에서 아래의 코드를
<td class="text"><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}"/></td>
<td class="email_address"><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}"/></td>

아래와 같이 변경
<td class="text"><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}" READONLY|cond="$purchaser_info->is_readonly_name"/></td>
<td class="email_address"><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}" READONLY|cond="$purchaser_info->is_readonly_email"/></td>

./m.skins/trendshop/orderitems.html에서 아래의 코드를
<td><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}"/></td>
<td><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}"/></td>

아래와 같이 변경
<td><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}" READONLY|cond="$purchaser_info->is_readonly_name"/></td>
<td><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}" READONLY|cond="$purchaser_info->is_readonly_email"/></td>

v 1.0.5
15th, Mar 2019
1. 관리자 주문상세 보기 페이지에서 1주문 다송장 체게로 수정
./tpl/orderdetail.html에서 아래의 코드 제거
<th>{$lang->individual_delivery_company}</th>
<th>{$lang->individual_invoice_no}</th>

{@$total_price=0}

<td><select name="express_id[]"><option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$item->express_id==$key">{$val}</option></select></td>
<td><input type="text" name="invoice_no[]" value="{$item->invoice_no}" /></td>
{@$total_price+=$item->price}

v 1.0.6
18th, Mar 2019
1. 주문 화면에서 보유 적립금보다 초과해서 청구하면 invalid query 오류 발생 해결

./svorder.controller.php::precheckOrder()에서 아래의 코드를
$oRst = $oSvorderModel->confirmOffer( $oParam );
if(!$oRst->toBool())
	return $output;

아래와 같이 변경
$oRst = $oSvorderModel->confirmOffer( $oParam );
if(!$oRst->toBool())
	return $oRst;

v 1.0.7
21st, Mar 2019
1. 주문 관리 화면에서 pagination 표시 안되는 문제 해결
./svorder.admin.model.php::getOrderListByStatus()에서 아래의 코드를
return $output->data;

아래와 같이 변경
return $output;

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드를
Context::set('list', $oOrderList);
Context::set('total_count', $output->total_count);
Context::set('total_page', $output->total_page);
Context::set('page', $output->page);
Context::set('page_navigation', $output->page_navigation);

아래와 같이 변경
Context::set('list', $oOrderList->data);
Context::set('total_count', $oOrderList->total_count);
Context::set('total_page', $oOrderList->total_page);
Context::set('page', $oOrderList->page);
Context::set('page_navigation', $oOrderList->page_navigation);

v 1.0.8
22nd, Mar 2019
1. 설정 저장 기능 개선
./svorder.admin.controller.php::_saveModuleConfig() 추가

./svorder.admin.model.php::getModuleConfig() 추가

./svorder.admin.controller.php::procSvorderAdminConfig()에서 아래의 코드를
$oModuleControll = getController('module');
$output = $oModuleControll->insertModuleConfig('svorder', $args);
$this->setMessage('success_updated');

아래와 같이 변경
$aParams = array( 'external_server', 'delivery_fee', 'freedeliv_amount', 'default_shipping_serial_column_name', 'alarm_mail_sender_name', 'ga_tracking_id' );	
foreach( $aParams as $nIdx => $sParamName )
{
	if( !$oArgs->{$sParamName} )
		$oArgs->{$sParamName} = '';
}

$oRst = $this->_saveModuleConfig($oArgs);
if(!$oRst->toBool())
	$this->setMessage( 'error_occured' );
else
	$this->setMessage( 'success_updated' );

./svorder.admin.controller.php::procSvorderAdminInsertModInst()에 아래의 코드 추가
foreach( $args as $key=>$val)
	$module_info->{$key} = $val;

v 1.0.9
30th, Mar 2019
1. 모든 주문 내역 CSV 다운로드에서 아이템의 카테고리 정보 추가
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에 아래의 코드 추가
$oSvitemAdminModel = &getAdminModel('svitem');
$aCategoryInfoByItem = $oSvitemAdminModel->getAllItemCategoryInfo();

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에 아래의 코드를
if( $key == 'title' )
	echo '"'.$output->data->item_name.'"';

아래와 같이 변경
if( $key == 'title' )
{
	echo '"'.$output->data->item_name.'"';
	for( $nCat=0; $nCat<$aCategoryInfoByItem['$_max_depth_$'];$nCat++)
		echo ','.$aCategoryInfoByItem[$output->data->item_srl]->category_info[$nCat];
}

./queries/getCartItems.xml에 아래의 코드 추가
<column name="items.item_srl" alias="item_srl" />

2. 모든 주문 내역 CSV 다운로드에서 모든 아이템에 주문 일시 정보 추가
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에 아래의 코드를
else if( $key == 'regdate' )
{
	if( $i == 0 )
		echo zdate( $rec->$key,'Y-m-d H:m:s' );
	else
		echo '""';
}

아래와 같이 변경
else if( $key == 'regdate' )
{
	echo zdate( $rec->$key,'Y-m-d H:m:s' );
}

v 1.0.10
5th, Apr 2019
1. 네이버 프리미엄 로그 호출 구문을 http(s) 중립적으로 수정
./skins/.../ordercomplete.html에서 아래의 코드를
<script type="text/javascript" src="http://wcs.naver.net/wcslog.js"> </script> 

아래와 같이 변경
<script type="text/javascript" src="//wcs.naver.net/wcslog.js"> </script> 

./m.skins/.../ordercomplete.html에서 아래의 코드를
<script type="text/javascript" src="http://wcs.naver.net/wcslog.js"> </script> 

아래와 같이 변경
<script type="text/javascript" src="//wcs.naver.net/wcslog.js"> </script> 

v 1.0.11
22nd, Apr 2019
1. 구매자의 주문 주소 이력 기능 추가
./svorder.controller.php::_insertRecipientAddress() 추가
./svorder.controller.php::_insertPurchaserAddress() 제거

./svorder.controller.php::precheckOrder()에서 아래의 코드 제거
$output = $this->_insertPurchaserAddress($oArgs);
if( !$output->toBool() )
	return $output;

./queries/insertOrder.xml에 아래의 코드 추가
<column name="addr_srl" var="addr_srl" />

./svorder.controller.php::_insertOrder()에서 아래의 코드를
$oOrderArgs->recipient_address = $oInArgs->recipient_address;
$oOrderArgs->recipient_postcode = $oInArgs->recipient_postcode;

아래와 같이 변경
$oOrderArgs->addr_srl = $oInArgs->addr_srl;

./schemas/svorder_address.xml에서 아래의 코드를
<column name="opt" type="char" size="1" default="1" notnull="notnull" />
<column name="title" type="varchar" size="120" notnull="notnull" index="idx_title" />
<column name="address" type="text" notnull="notnull" />
<column name="default" type="char" size="1" default="N" notnull="notnull" />

아래와 같이 변경
<column name="addr_type" type="varchar" size="20" notnull="notnull" />
<column name="postcode" type="varchar" size="10" notnull="notnull" />
<column name="address" type="text" />

./schemas/svorder_order.xml에 아래의 코드 추가
<column name="addr_srl" type="number" size="11" notnull="notnull" />

./svorder.model.php::_getAddrInfo() 추가

./svorder.model.php::getOrderInfo()에서 아래의 코드를
$oOrderInfo->recipient_address = unserialize( $oOrderInfo->recipient_address );
		
아래와 같이 변경
$oAddrInfo = $this->_getAddrInfo($oOrderInfo->addr_srl);
$oOrderInfo->recipient_address = $oAddrInfo->aAddrInfo;
$oOrderInfo->recipient_postcode = $oAddrInfo->postcode;

./svorder.model.php::getOrderInfoForPayment()에 아래의 코드 추가
$oAddrInfo = $this->_getAddrInfo($order_info->addr_srl);
$order_info->recipient_address = $oAddrInfo->aAddrInfo;
$order_info->recipient_postcode = $oAddrInfo->postcode;

./ecaso_query.class.php::_sendNewOrderInfo()에서 아래의 코드를
$aReceipientAddr = unserialize($oArgs->recipient_address);

아래와 같이 변경
$aReceipientAddr = $oArgs->recipient_address;

./schemas/svorder_addr_seq.xml 추가

./svorder.controller.php::_getAddrSrl() 추가

2. 미사용 코드 제거
./svorder.controller.php::_validatePurchaserReceipientInfo()에서 아래의 코드 제거
if( $in_args->manorder_pid ) 
{
	$in_args->user_id = $in_args->manorder_pid;
	// member module method로 변경 해야 함
	$output = executeQuery('member.getMemberInfo', $in_args);
	$in_args->member_srl = $output->data->member_srl;
	$in_args->purchaser_name = $output->data->nick_name;
	$in_args->purchaser_email = $output->data->email_address;
}

3. ./ext_class 폴더 생성
./ecaso_listen.class.php 이동
./ecaso_query.class.php 이동

./svorder.controller.php::procSvorderExtCommand()에서 아래의 코드를
require_once(_XE_PATH_.'modules/svorder/ecaso_listen.class.php');

아래와 같이 변경
require_once(_XE_PATH_.'modules/svorder/ext_class/ecaso_listen.class.php');

./svorder.controller.php::transmitOrderInfoExt()에서 아래의 코드를
require_once(_XE_PATH_.'modules/svorder/ecaso_query.class.php');

아래와 같이 변경
require_once(_XE_PATH_.'modules/svorder/ext_class/ecaso_query.class.php');

./svorder.controller.php::transmitCancelInfoExt()에서 아래의 코드를
require_once(_XE_PATH_.'modules/svorder/ecaso_query.class.php');

아래와 같이 변경
require_once(_XE_PATH_.'modules/svorder/ext_class/ecaso_query.class.php');

4. 주문 상세 페이지 표시 내용 개선
./tpl/orderdetail.html에서 아래의 코드를 
	<tr cond="$order_info->recipient_name">
		<th>{$lang->recipient}</th>
		<td>{$order_info->recipient_name} &nbsp; 
<block cond="$order_info->member_srl">
		( <a href="#popup_menu_area" class="member_{$order_info->member_srl}">{$order_info->item_list[0]->nick_name}</a> )
</block>
<block cond="$order_info->member_srl==0">
		<span class="btn small" data-item-srl="{$item_srl}"><a href="#transferToMember" class="modalAnchor transferToMember">{$lang->cmd_move_to_member}</a></span>
</block>
		</td>
	</tr>

아래와 같이 변경
	<tr>
		<th>{$lang->purchaser_name}</th>
		<td>{$order_info->purchaser_name} &nbsp; 
<block cond="$order_info->member_srl">
		( <a href="#popup_menu_area" class="member_{$order_info->member_srl}">{$order_info->item_list[0]->nick_name}</a> )
</block>
<block cond="$order_info->member_srl==0">
		<span class="btn small" data-item-srl="{$item_srl}"><a href="#transferToMember" class="modalAnchor transferToMember">{$lang->cmd_move_to_member}</a></span>
</block>
		</td>
<block cond="$order_info->recipient_name">
		<th>{$lang->recipient}</th>
		<td>{$order_info->recipient_name} &nbsp;</td>
</block>
	</tr>

./tpl/orderdetail.html에서 아래의 코드를 
<th>{$lang->contract_number}</th>
<th>{$lang->product}</th>
<th>{$lang->product_name}</th>
<th>{$lang->quantity}</th>
<th>{$lang->price}</th>
<th>{$lang->discount}</th>
<th>{$lang->order_amount}</th>
<th>{$lang->order_status}</th>

아래와 같이 변경
<th>{$lang->contract_number}</th>
<th>{$lang->product}</th>
<th>{$lang->product_name}</th>
<th>{$lang->quantity}</th>
<th>{$lang->price}</th>
<th>{$lang->discount}</th>
<th>{$lang->order_amount}</th>

./tpl/orderdetail.html에서 아래의 코드를 
<td><input type="hidden" name="cart_srls[]" value="{$item->cart_srl}" />{$item->cart_srl}</td>
<td><a href="{getUrl('','module',$module,'act','dispSvitemAdminUpdateItem','module_srl',$item->module_srl,'item_srl',$item->item_srl)}"><img src="{svitemView::_dispThumbnailUrl($item->thumb_file_srl,40)}" /></a></td>
<td>
	<div>{$item->item_name}</div>
	<div cond="$item->option_srl">{$item->option_title} ({$item->printPrice($item->option_price)})</div>
</td>
<td>{$item->quantity}</td>
<td>{number_format($item->price)}</td>
<td>{number_format($item->discount_amount)}<br />
<block loop="$item->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>
</td>
<td>{number_format($item->discounted_price)}</td>
<td><span class="ko_text red">{$order_status[$order_info->order_status]}</span></td>

아래와 같이 변경
<td><input type="hidden" name="cart_srls[]" value="{$item->cart_srl}" />{$item->cart_srl}</td>
<td><a href="{getUrl('','module',$module,'act','dispSvitemAdminUpdateItem','module_srl',$item->module_srl,'item_srl',$item->item_srl)}"><img src="{svitemView::_dispThumbnailUrl($item->thumb_file_srl,40)}" /></a></td>
<td>
	<div>{$item->item_name}</div>
	<div cond="$item->option_srl">{$item->option_title} ({$item->printPrice($item->option_price)})</div>
</td>
<td>{$item->quantity}</td>
<td>{number_format($item->price)}</td>
<td>{number_format($item->discount_amount)}<br />
<block loop="$item->discount_info=>$promotionkey,$promotionval">
{$promotionval->title}<BR>
</block>
</td>
<td>{number_format($item->discounted_price)}</td>

./tpl/orderdetail.html에서 아래의 코드를 
<thead>
	<tr>
		<th>{$lang->paymethod}</th>
		<block cond="$payment_info->payment_method=='VA' || $payment_info->payment_method=='BT'">
		<th>{$lang->account_number}</th>
		<th>{$lang->bank_code}</th>
		<th>{$lang->account_holder}</th>
		<th>{$lang->sender_name}</th>
		<th cond="$payment_info->vact_date">{$lang->send_date}</th>
		</block>
	</tr>
</thead>
<tbody>
	<tr>
		<td>{$payment_method[$order_info->payment_method]}</td>
		<block cond="$payment_info->payment_method=='VA' || $payment_info->payment_method=='BT'">
		<td>{$payment_info->vact_num}</td>
		<td>{$payment_info->vact_bankname}({$payment_info->vact_bankcode})</td>
		<td>{$payment_info->vact_name}</td>
		<td>{$payment_info->vact_inputname}</td>
		<td cond="$payment_info->vact_date">{zdate($payment_info->vact_date,'Y-m-d')}</td>
		</block>
	</tr>
</tbody>

아래와 같이 변경
<thead>
	<tr>
		<th>{$lang->paymethod}</th>
		<th>{$lang->order_status}</th>
		<block cond="$payment_info->payment_method=='VA' || $payment_info->payment_method=='BT'">
		<th>{$lang->account_number}</th>
		<th>{$lang->bank_code}</th>
		<th>{$lang->account_holder}</th>
		<th>{$lang->sender_name}</th>
		<th cond="$payment_info->vact_date">{$lang->send_date}</th>
		</block>
	</tr>
</thead>
<tbody>
	<tr>
		<td>{$payment_method[$order_info->payment_method]}</td>
		<td><span class="ko_text red">{$order_status[$order_info->order_status]}</span></td>
		<block cond="$payment_info->payment_method=='VA' || $payment_info->payment_method=='BT'">
		<td>{$payment_info->vact_num}</td>
		<td>{$payment_info->vact_bankname}({$payment_info->vact_bankcode})</td>
		<td>{$payment_info->vact_name}</td>
		<td>{$payment_info->vact_inputname}</td>
		<td cond="$payment_info->vact_date">{zdate($payment_info->vact_date,'Y-m-d')}</td>
		</block>
	</tr>
</tbody>

v 1.0.12
15th, May 2019
1. 주문을 논리 삭제하는 기능 추가
./svorder.admin.controller.php::procSvorderAdminDeleteOrders()를 procSvorderAdminPermanentDeleteOrders()로 변경

./svorder.admin.controller.php::procSvorderAdminDeleteOrders() 추가

./svorder.class.php::svorder()에 아래의 코드 추가
const ORDER_STATE_DELETED = 'Z';
svorder::ORDER_STATE_DELETED=>'deleted'

2. 주문 생성 출처 구분 기능 추가
./schemas/svorder_order.xml에 아래의 코드 추가
<column name="order_referral" type="char" size="1" default="0" />

./queries/insertOrder.xml에 아래의 코드 추가
<column name="order_referral" var="order_referral" notnull="notnull" />

./svorder.controller.php::_insertOrder()에 아래의 코드 추가
$oOrderArgs->order_referral = svorder::ORDER_REFERRAL_LOCALHOST;

2. 코드 오류 수정
./svorder.admin.controller.php::procSvorderAdminUpdateOrderDetail()에서 아래의 코드를
$output = executeQuery('svorder.updateOrderStatus', $args);

아래와 같이 변경
$output = executeQuery('svorder.updateOrderStatusSvorder', $args);

./queries/updateCartOrderStatus.xml에서 아래의 코드 제거
<column name="purdate" default="curdate()" />

./svorder.controller.php::updateOrderStatus()에서 아래의 코드 제거
$args->purdate = "YmdHiS";

3. 개별 주문에 관리자 메모 기능 추가
./schemas/svorder_cs_memo.xml 추가

./queries/insertOrderCsMemo.xml 추가

./svorder.admin.controller.php::procSvorderAdminUpdateOrderDetail()에 아래의 코드 추가
$sAdminMemo = strip_tags(trim(Context::get('admin_memo')));
if($sAdminMemo)
{
	$oArgs->order_srl = $order_srl;

	$oLoggedInfo = Context::get('logged_info');
	if( !$oLoggedInfo )
		$oLoggedInfo->member_srl = 0;

	$oArgs->member_srl = $oLoggedInfo->member_srl;
	$oArgs->memo = $sAdminMemo;
	$oRst = executeQuery('svorder.insertOrderAdminMemo', $oArgs);
	if(!$oRst->toBool())
		return $oRst;
}

./svorder.admin.model.php::getSvorderCsMemo() 추가

./tpl/orderdetail.html에 아래의 코드 추가
<section class="section">
	<h1>{$lang->title_extra_info}</h1>
	<div class="x_control-group">
		<label class="x_control-label" for="mid">{$lang->cs_memo}</label>
		<div class="x_controls">
			<textarea name="cs_memo" id="cs_memo">{$order_info->cs_memo}</textarea>
			<a href="#cs_memo_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
			<p id="cs_memo_help" class="x_help-block" hidden>{$lang->about_cs_memo}</p>
		</div>
	</div>
	<table class="x_table">
		<tr>
			<th>{$lang->writer}</th>
			<th>{$lang->cs_memo}</th>
		</tr>
		<tr loop="$cs_memos=>$memo_key,$memo_val">
			<td>{$memo_val->cs_memo_srl}</td>
			<td>{$memo_val->memo}</td>
		</tr>
	</table>
</section>

4. 상황에 따른 주문 상태 변경 기능 추가
./schemas/svorder_order.xml에 아래의 코드 추가
<column name="delivdate" type="date" notnull="notnull" />
<column name="receiptdate" type="date" notnull="notnull" />

./queries/updateOrderStatusSvorder.xml에 아래의 코드 추가
<column name="delivdate" var="delivdate" />
<column name="receiptdate" var="receiptdate" />

./svorder.controller.php::updateOrderStatus()에 아래의 코드 추가
if( $in_args->order_status == svorder::ORDER_STATE_ON_DELIVERY )
	$oOrderArgs->delivdate = date('Ymdhis', time());
elseif( $in_args->order_status == svorder::ORDER_STATE_DELIVERED )
	$oOrderArgs->receiptdate =  date('Ymdhis', time());

./svorder.admin.controller.php::arrangeOrderStatus() 추가
./svorder.admin.controller.php::_deleteOrders() 추가
./svorder.admin.controller.php::_deleteOrder() 추가

./queries/getOrdersByStatus.xml 추가

5. 코드 효율화
/svorder.admin.controller.php::arrangeOrderStatus()에서 아래의 코드를
foreach ($aOrderSrl as $nOrderSrl)
{
	if(!$nOrderSrl)
		continue;
	// delete cart items.
	$oArgs->order_srl = $nOrderSrl;
	$oArgs->order_status = svorder::ORDER_STATE_DELETED;
	$oRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oArgs);
	if(!$oRst->toBool())
		return $oRst;

	// delete order info.
	$oArgs->order_srl = $nOrderSrl;
	$oArgs->order_status = svorder::ORDER_STATE_DELETED;
	$oRst = executeQuery('svorder.updateOrderStatusSvorder', $oArgs);
	if(!$oRst->toBool())
		return $oRst;
}

아래와 같이 변경
foreach ($aOrderSrl as $nOrderSrl)
{
	if(!$nOrderSrl)
		continue;
	$oRst = $this->_deleteOrder( $nOrderSrl );
	if(!$oRst->toBool())
		return $oRst;
}

v 1.0.13
29th, May 2019
1. 주문서 엑셀 다운로드 기능 개선
./svorder.admin.model.php::getDataFormatConfig()에 아래의 코드를 추가
'item_code',

./svorder.admin.model.php::_getDefaultDataFormConfig()에 아래의 코드를 추가
'item_code',

./svorder.admin.model.php::getAddrInfo() 추가

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드를 추가
$oAddrInfo = $oSvorderAdminModel->getAddrInfo($rec->addr_srl );

else if( $key == 'item_code' )
	echo '"'.$output->data->item_code.'"';

else if( $key == 'recipient_postcode' )
{
	if( $i == 0 )
	{
		//$oTemp = unserialize( $rec->$key );
		echo '"'.$oAddrInfo->postcode.'"';
	}
	else
		echo '""';
}

else if( $key1 == 'item_code' )
	echo '"'.$oItemInfo->item_code.'"';

2. 코드 가독성 개선
$args->order_status_min = 2;
$args->order_status_max = 7;

아래와 같이 변경
$args->order_status_min = svorder::ORDER_STATE_PAID;
$args->order_status_max = svorder::ORDER_STATE_COMPLETE;

v 1.0.14
1st, Jun 2019
1. svshopmaster v 1.0.13에 대응
./svorder.admin.view.php::init()에서 아래의 코드 제거
if(Context::get('module')=='svshopmaster')
{
	$this->setLayoutPath('');
	$this->setLayoutFile('common_layout');
}

v 1.0.15
2nd, Jun 2019
1. [입금완료] 상태의 주문 정보를 엑셀 다운하면 [배송준비중] 으로 변경하는 기능 추가
./svorder.admin.controller.php::updateOrderStatusPhp() 추가

v 1.0.16
3rd, Jun 2019
1. 배송메모 필드를 정규화
./schemas/svorder_order.xml에 아래의 코드 추가
<column name="delivery_memo" type="varchar" size="255" />

./queries/insertOrder.xml에 아래의 코드 추가
<column name="delivery_memo" var="delivery_memo" />

./svorder.controller.php::_insertOrder()에서 아래의 코드를 
if( $oInArgs->delivery_memo )
{
	$aDefaultExtraVars['delivery_memo'] = strip_tags(trim($oInArgs->delivery_memo));
	$oOrderArgs->extra_vars = serialize( $aDefaultExtraVars);
}

아래와 같이 변경
if( $oInArgs->delivery_memo )
	$oInArgs->delivery_memo = strip_tags(trim($oInArgs->delivery_memo));

./skins/Trendshop/ordercomplete.html에서 아래의 코드를
<td class="text"><input type="text" name="purchaser_name" id="purchaser_name" value="{$purchaser_info->user_name}"/></td>
<td class="email_address"><input type="text" name="purchaser_email" id="purchaser_email" value="{$purchaser_info->email_address}"/></td>

아래와 같이 변경
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./skins/Trendshop/orderdetail.html에서 아래의 코드를
<tr cond="$order_info->extra_vars['delivery_memo']">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->extra_vars['delivery_memo']}</td>
</tr>

아래와 같이 변경
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./m.skins/trendshop/ordercomplete.html에서 아래의 코드를
<tr cond="$order_info->extra_vars['delivery_memo']">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->extra_vars['delivery_memo']}</td>
</tr>

아래와 같이 변경
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./m.skins/trendshop/orderdetail.html에서 아래의 코드를
<tr cond="$order_info->extra_vars['delivery_memo']">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->extra_vars['delivery_memo']}</td>
</tr>

아래와 같이 변경
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./tpl/orderdetail.html에 아래의 코드 추가
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td colspan="3">{$order_info->delivery_memo}</td>
</tr>

2. 운송장정보 엑셀 등록 기능 개선
./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial() 개선

./tpl/form_register_shipping_serial.html에서 아래의 코드를
<input type="hidden" name="success_return_url" value="{getCurrentPageUrl()}?module=svshopmaster&act=dispSvorderAdminOrderManagement" />

아래와 같이 변경
<input type="hidden" name="success_return_url" value="{getCurrentPageUrl()}?module=svshopmaster&act=dispSvorderAdminOrderManagement&status=4" />

3. svestudio에 필요한 메소드 추가
./svorder.model.php::getDeliveryInquiryUrls() 추가

v 1.0.17
5th, Jun 2019
1. 관리자 화면의 [거래원장 다운로드] 기능과 [주문상태별 다운로드] 기능의 출력 데이터 설정을 분리함
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드를
$oDataConfig = $oSvorderAdminModel->getDataFormatConfig( $this->module_info->module_srl );

아래와 같이 변경
$bDumpMode = true;
$oDataConfig = $oSvorderAdminModel->getDataFormatConfig( $this->module_info->module_srl, $bDumpMode );

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드를
$oDataConfig = $oSvorderAdminModel->getDataFormatConfig( $this->module_info->module_srl );

아래와 같이 변경
$bDumpMode = false;
$oDataConfig = $oSvorderAdminModel->getDataFormatConfig( $this->module_info->module_srl, $bDumpMode );

./svorder.admin.model.php::getDataFormatConfig()에 아래의 코드 추가
if( $bDumpMode )
	$list_config = $aBuff;

v 1.0.18
20th, Jun 2019
1. 코드 효율성 개선
./svorder.admin.model.php::getModInstList()에서 아래의 코드를
$args->list_count = 1000;
$output = executeQueryArray('svorder.getModInstList', $args);
return $output->data;

아래와 같이 변경
$args->sort_index = 'module_srl';
$args->page = $nPage;
$args->list_count = 20;
$args->page_count = 10;

$output = executeQueryArray('svorder.getModInstList', $args);
return $output->data;

./svorder.admin.view.php::dispSvorderAdminModInstList()에서 아래의 코드를
$args->sort_index = "module_srl";
$args->page = Context::get('page');
$args->list_count = 20;
$args->page_count = 10;
$args->s_module_category_srl = Context::get('module_category_srl');
$output = executeQueryArray('svorder.getModInstList', $args);
$list = $output->data;
Context::set('list', $list);

아래와 같이 변경
$oSvorderAdminModel = &getAdminModel('svorder');
$aList = $oSvorderAdminModel->getModInstList(Context::get('page'));
Context::set('list', $aList);

./queries/getModInstList.xml에서 아래의 코드 제거
<group pipe="and">
	<condition operation="equal" column="module_category_srl" var="s_module_category_srl" pipe="or" />
</group>

v 1.0.19
26th, Jun 2019
1. 핸드폰 번호로 주문 검색 기능 추가
./tpl/ordermanagement.html에 아래의 코드 추가
<option value="purchaser_cellphone" selected="selected"|cond="$search_key=='purchaser_cellphone'">{$lang->cellphone}</option>

./queries/getOrderListByStatus.html에 아래의 코드 추가
<condition operation="equal" column="order.purchaser_cellphone" var="purchaser_cellphone" pipe="or" />

2. 코드 최적화
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드 제거
if( $search_key == 'nick_name' && $search_value == '비회원' )
{
	$search_key = 'member_srl';
	$search_value = 0;
}

v 1.0.20
30th, Jun 2019
1. 주문 주소 정보에 member_srl 기록 추가
./svorder.controller.php::_validatePurchaserReceipientInfo()에서 아래의 코드를
$oAddrArgs->member_srl = $logged_info->member_srl;

아래와 같이 변경
if( $logged_info )
	$oAddrArgs->member_srl = $logged_info->member_srl;
else
	$oAddrArgs->member_srl = 0;

./svorder.controller.php::_insertRecipientAddress()에서 아래의 코드를
$oTmpArgs->member_srl = 0;

아래와 같이 변경
$oTmpArgs->member_srl = $oAddrArgs->member_srl;

2. 미사용 코드 제거
./svorder.controller.php::_validatePurchaserReceipientInfo()에서 아래의 코드 제거
$oAddrArgs->addr_srl = $logged_info->addr_srl = null; 

3. svorder_address 필드 구조 최적화
./schemas/svorder_address.xml에서 아래의 코드를
<column name="addr_type" type="varchar" size="20" notnull="notnull" />

아래와 같이 변경
<column name="addr_type" type="char" size="1" notnull="notnull" />

./svorder.class.php에 아래의 코드 추가
protected $_g_aAddrType = array( 'postcodify' => 0, 'npay' => 1);

./svorder.controller.php::_insertRecipientAddress()에서 아래의 코드를
$oTmpArgs->addr_type = 'postcodify';

아래와 같이 변경
$oTmpArgs->addr_type = $this->_g_aAddrType['postcodify'];

./svorder.model.php::_getAddrInfo()에서 아래의 코드를
case 'postcodify':

아래와 같이 변경
case $this->_g_aAddrType['postcodify']:

./svorder.admin.model.php::_getAddrInfo()에서 아래의 코드를
case 'postcodify':

아래와 같이 변경
case $this->_g_aAddrType['postcodify']:

v 1.0.21
6th, Jul 2019
1. 주문상태별 CSV 다운로드할 때 모든 행에 각 정보 입력
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder() 수정

2. svpromotion v0.4.24에 대응
./svorder.model.php::confirmOffer()에 아래의 코드 추가
$oCart->discount_duplicated = $oPromotionInfo->promotion[0]->discount_duplicated; // for ajax UI

./svorder.model.php::getSvorderConfirmInvoice()에 아래의 코드 추가
$this->add('discount_duplicated', $oOrderFormRst->promotion_info->promotion[0]->discount_duplicated );

./tpl/skin.js/orderitems.js에서 아래의 코드를 
var respons = ['promotion_title', 'total_price','total_discount_amount', 'delivery_fee','claiming_reserves','tobe_reserved_reserves', 'reserves_msg'];
exec_xml('svorder', 'getSvorderConfirmInvoice', params, function(ret_obj) {
	jQuery('*[id*=discount_amnt]:visible').each(function() {
		jQuery(this).text(0);
	});
	jQuery('*[id*=discount_info]:visible').each(function() {
		jQuery(this).empty();
	});
	_printInvoice( ret_obj );
},respons);

아래와 같이 변경
var respons = ['promotion_title', 'total_price','total_discount_amount', 'delivery_fee','claiming_reserves','tobe_reserved_reserves', 'reserves_msg','discount_duplicated'];
exec_xml('svorder', 'getSvorderConfirmInvoice', params, function(ret_obj) {
	if( ret_obj['discount_duplicated'] == '1' )
		;
	else
	{
		jQuery('*[id*=discount_amnt]:visible').each(function() {
			jQuery(this).text(0);
		});
		jQuery('*[id*=discount_info]:visible').each(function() {
			jQuery(this).empty();
		});
	}
	_printInvoice( ret_obj );
},respons);

./svorder.model.php::getOrderInfo()에서 아래의 코드를 
if( $oOrderInfo->checkout_promotion_info && $val->discount_info[0]->type != 'giveaway')
{
	$val->discount_amount = 0;
	$val->discount_info = '';
	$val->discounted_price = $val->price;
}

아래와 같이 변경
if( $oOrderInfo->checkout_promotion_info )
{
	if( $val->discount_info[0]->type != 'giveaway' && $val->discount_info[0]->type != 'item_policy')
	{
		$val->discount_amount = 0;
		$val->discount_info = '';
		$val->discounted_price = $val->price;
	}
}

v 1.0.22
16th, Jul 2019
1. 미사용 코드 제거
./svorder.controller.php::insertCartItem()에서 아래의 코드를 
$aGroupList = NULL;
if( $oArgs->member_srl )
	$aGroupList = $oMemberModel->getMemberGroups($oArgs->member_srl);
$output = $oSvpromotionModel->getItemPriceDetail($oItemInfo, $aGroupList);

아래와 같이 변경
$output = $oSvpromotionModel->getItemPriceDetail($oItemInfo );

2. 코드 효율성 개선
./svorder.admin.controller.php::procSvorderAdminConfig()에서 아래의 코드를
$returnUrl = Context::get('success_return_url') ? Context::get('success_return_url') : getNotEncodedUrl('', 'module', Context::get('module'), 'act', 'dispSvorderAdminConfig'),'module_srl',Context::get('module_srl'));

아래와 같이 변경
$returnUrl = Context::get('success_return_url') ? Context::get('success_return_url') : getNotEncodedUrl('', 'module', Context::get('module'), 'act', 'dispSvorderAdminConfig');

v 2.0.0
17th, Jul 2019
1. 네이버페이 API 주문 수집 기능 추가
./svorder.admin.view.php::dispSvorderAdminNpayOrderSync() 추가

./svorder.admin.view.php::dispSvorderAdminNpayApiConfig() 추가
./tpl/config_npay_api.html 추가

./tpl/_header.html에 아래의 코드 추가
<li class="x_active"|cond="$act=='dispSvorderAdminNpayApiConfig'"><a href="{getUrl('','module',$module,'act','dispSvorderAdminNpayApiConfig')}">{$lang->npay_api_setting}</a></li>

./svorder.admin.controller.php::procSvorderAdminNpayApiConfig() 추가

./schemas/svorder_npay.xml 추가

./queries/insertNpayOrderInfo.xml 추가

./svorder.controller.php::_validatePurchaserReceipientInfo()를 validatePurchaserReceipientInfo()로 변경

./svorder.controller.php::_getOrderSrl()를 getOrderSrl()로 변경

./svorder.controller.php::_insertCartItem()를 insertCartItem()로 변경

./svorder.controller.php::_insertOrder()를 insertOrder()로 변경

./svorder.class.php에 아래의 코드 추가
const ORDER_STATE_EXCHANGED = 'C'; 
const ORDER_STATE_CANCEL_REQUESTED = 'D';
const ORDER_STATE_RETURN_REQUESTED = 'E';
const ORDER_STATE_EXCHANGE_REQUESTED = 'F';
const ORDER_STATE_EXCHANGE_REDELIVERY_READY = 'G';
const ORDER_STATE_HOLDBACK_REQUESTED = 'H';

protected $_g_aNpayOrderStatus = array(
	'PAY_WAITING'=>svorder::ORDER_STATE_ON_DEPOSIT,
	'PAYED'=>svorder::ORDER_STATE_PAID,
	'DISPATCHED'=>svorder::ORDER_STATE_ON_DELIVERY,
	'CANCEL_REQUESTED'=>svorder::ORDER_STATE_CANCEL_REQUESTED,
	'RETURN_REQUESTED'=>svorder::ORDER_STATE_RETURN_REQUESTED,
	'EXCHANGE_REQUESTED'=>svorder::ORDER_STATE_EXCHANGE_REQUESTED,
	'EXCHANGE_REDELIVERY_READY'=>svorder::ORDER_STATE_EXCHANGE_REDELIVERY_READY,
	'HOLDBACK_REQUESTED'=>svorder::ORDER_STATE_HOLDBACK_REQUESTED,
	'CANCELED'=>svorder::ORDER_STATE_CANCELLED,
	'RETURNED'=>svorder::ORDER_STATE_RETURNED,
	'EXCHANGED'=>svorder::ORDER_STATE_EXCHANGED,
	'PURCHASE_DECIDED'=>svorder::ORDER_STATE_COMPLETED );

protected $_g_aOrderReferralType = array( 
	svorder::ORDER_REFERRAL_LOCALHOST=>'myshop', 
	svorder::ORDER_REFERRAL_NPAY=>'npay' );

2. 주문관리자 화면 UI 정리
./tpl/ordermanagement.html에서 아래의 코드를 제거
<th scope="col">{$lang->cmd_print_ordersheet}</th>

./tpl/ordermanagement.html에서 아래의 코드를
<td><a href="{getUrl('act','dispSvorderAdminOrderDetail','order_srl',$order->order_srl)}">{$lang->order_management}</a></td>
<td><a cond="$status!='0'" href="#" onclick="window.open('{getUrl('act','dispSvorderAdminOrderSheet','order_srl',$order->order_srl)}', 'addressbook_popup', 'left=50, top=20, width=700, scrollbars=yes, height=700, toolbars=no'); return false;"><span>{$lang->cmd_print_ordersheet}</span></a></td>

아래와 같이 변경
<td>
	<a href="{getUrl('act','dispSvorderAdminOrderDetail','order_srl',$order->order_srl)}">{$lang->order_management}</a><BR>
	<a cond="$status!='0'" href="#" onclick="window.open('{getUrl('act','dispSvorderAdminOrderSheet','order_srl',$order->order_srl)}', 'addressbook_popup', 'left=50, top=20, width=700, scrollbars=yes, height=700, toolbars=no'); return false;"><span>{$lang->cmd_print_ordersheet}</span></a>
</td>

./tpl/ordermanagement.html에서 아래의 코드를 제거
<th loop="$usedIdentifiers=>$key,$val" scope="col">{Context::getLang($key)}</th>

./tpl/ordermanagement.html에서 아래의 코드를
<td loop="$usedIdentifiers=>$key,$val"><a href="#popup_menu_area" class="member_{$order->member_srl}" title="{$order_arr[$key]}">{cut_str($order_arr[$key],6)}</a></td>
<td>
	{$order->purchaser_name}
</td>

아래와 같이 변경
<td>
	<block cond="!$order->member_srl">{cut_str($order->purchaser_name,6)}</block>
	<block cond="$order->member_srl"><a href="#popup_menu_area" class="member_{$order->member_srl}" title="{$order_arr[$key]}">{cut_str($order->purchaser_name,6)}</a></block>
</td>

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드 제거
$member_config = $oMemberModel->getMemberConfig();
$memberIdentifiers = array( 'user_id'=>'user_id' );
$usedIdentifiers = array();	
if( is_array( $member_config->signupForm ) )
{
	foreach( $member_config->signupForm as $signupItem )
	{
		if( !count( $memberIdentifiers ) )
			break;
		if( in_array( $signupItem->name, $memberIdentifiers ) && ( $signupItem->required || $signupItem->isUse ) )
		{
			unset( $memberIdentifiers[$signupItem->name]) ;
			$usedIdentifiers[$signupItem->name] = $lang->{$signupItem->name};
		}
	}
}

./svorder.admin.view.php::dispSvorderAdminOrderManagement()에 아래의 코드 추가
Context::set('order_referral', $this->_g_aOrderReferralType);

./tpl/ordermanagement.html에 아래의 코드 추가
<th scope="col">{$lang->order_referral}</th>
<td><span title="">{$order_referral[$order->order_referral]}</span></td>

./tpl/ordermanagement.html에서 아래의 코드를 제거
<th scope="col">{$lang->items}</th>

./tpl/ordermanagement.html에서 아래의 코드를
<td><span title="{$order->title}">{cut_str($order->title, 34)}</span></td>
<td>{number_format($order->item_count)}</td>

아래와 같이 변경
<td>
	<div><span title="{$order->title}">{cut_str($order->title, 34)}</span></div>
	<div>({number_format($order->item_count)}개 품목)</div>
</td>

v 2.0.1
24th, Jul 2019
1. 주문서의 우편번호 체계를 ./modules/krzip의 설정을 따르도록 개선
./svorder.view.php::dispSvorderOrderForm()에 아래의 코드 추가
$oKrzip = &getClass('krzip');
$oKrzipConfig = $oKrzip->getKrzipConfig();
Context::set('krzip_config', $oKrzipConfig);

./skins/.../orderitems.html에서 아래의 코드를
<div id="postcodify_1" class="postcodify_address_area" data-server-url="https://api.poesis.kr/post/search.php" data-map-provider="naver" data-address-format="newkrzip"
data-postcode-format="6" data-server-request-format="CORS" data-require-exact-query="N"	data-use-full-jibeon="N">

아래와 같이 변경
<div id="postcodify_1" class="postcodify_address_area" data-server-url="{$krzip_config->krzip_server_url}" data-map-provider="{$krzip_config->krzip_map_provider}" data-address-format="{$krzip_config->krzip_address_format}"
data-postcode-format="{$krzip_config->krzip_postcode_format}" data-server-request-format="{$krzip_config->krzip_server_request_format}" data-require-exact-query="{$krzip_config->krzip_require_exact_query}" data-use-full-jibeon="{$krzip_config->krzip_use_full_jibeon}">

./m.skins/.../orderitems.html에서 아래의 코드를
<div id="postcodify_1" class="postcodify_address_area" data-server-url="https://api.poesis.kr/post/search.php" data-map-provider="naver" data-address-format="newkrzip"
data-postcode-format="6" data-server-request-format="CORS" data-require-exact-query="N"	data-use-full-jibeon="N">

아래와 같이 변경
<div id="postcodify_1" class="postcodify_address_area" data-server-url="{$krzip_config->krzip_server_url}" data-map-provider="{$krzip_config->krzip_map_provider}" data-address-format="{$krzip_config->krzip_address_format}"
data-postcode-format="{$krzip_config->krzip_postcode_format}" data-server-request-format="{$krzip_config->krzip_server_request_format}" data-require-exact-query="{$krzip_config->krzip_require_exact_query}" data-use-full-jibeon="{$krzip_config->krzip_use_full_jibeon}">

v 2.0.2
9th, Aug 2019
1. 주문 관리자 화면에서 주문고유번호로 검색 기능 추가
./queries/getOrderListByStatus.xml에서 아래의 코드를
<query id="getOrderListByStatus" action="select">
	<tables>
		<table name="svorder_order" alias="order" />
		<table name="member" alias="member" type="left join">
			<conditions>
				<condition operation="equal" column="member.member_srl" default="order.member_srl" />
			</conditions>
		</table>
	</tables>
	<columns>
		<column name="order.*" />
		<column name="member.member_srl" alias="member_srl" />
		<column name="member.user_id" alias="user_id" />
	</columns>
	<conditions>
		<condition operation="equal" column="order.member_srl" var="member_srl" />
		<condition operation="equal" column="order.order_status" var="order_status" pipe="and" />
		<condition operation="like_prefix" column="order.regdate" var="regdate" pipe="and" />
		<group pipe="and">
			<condition operation="equal" column="member.user_id" var="user_id" pipe="or" />
			<condition operation="equal" column="order.purchaser_email" var="email_address" pipe="or" />
			<condition operation="equal" column="order.purchaser_name" var="purchaser_name" pipe="or" />
			<condition operation="equal" column="order.purchaser_cellphone" var="purchaser_cellphone" pipe="or" />
			<condition operation="equal" column="order.member_srl" var="member_srl" pipe="or" />
			<condition operation="like" column="order.extra_vars" var="extra_vars" pipe="or" />
		</group>
	</conditions>
	<navigation>
		<index var="sort_index" default="order.regdate" order="desc" />
		<list_count var="list_count" default="20" />
		<page_count var="page_count" default="10" />
		<page var="page" default="1" />
	</navigation>
</query>

아래와 같이 변경
<query id="getOrderListByStatus" action="select">
	<tables>
		<table name="svorder_order" />
	</tables>
	<columns>
		<column name="*" />
	</columns>
	<conditions>
		<condition operation="equal" column="member_srl" var="member_srl" />
		<condition operation="equal" column="order_status" var="order_status" pipe="and" />
		<condition operation="like_prefix" column="regdate" var="regdate" pipe="and" />
		<condition operation="equal" column="purchaser_email" var="email_address" pipe="or" />
		<condition operation="equal" column="purchaser_name" var="purchaser_name" pipe="or" />
		<condition operation="equal" column="purchaser_cellphone" var="purchaser_cellphone" pipe="or" />
		<condition operation="equal" column="member_srl" var="member_srl" pipe="or" />
	</conditions>
	<navigation>
		<index var="sort_index" default="regdate" order="desc" />
		<list_count var="list_count" default="20" />
		<page_count var="page_count" default="10" />
		<page var="page" default="1" />
	</navigation>
</query>

2. 미사용 코드 제거
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에서 아래의 코드 제거
$member_config = $oMemberModel->getMemberConfig();
$memberIdentifiers = array( 'user_id'=>'user_id' );
$usedIdentifiers = array();	
if( is_array( $member_config->signupForm ) )
{
	foreach( $member_config->signupForm as $signupItem )
	{
		if( !count( $memberIdentifiers ) )
			break;
		if( in_array( $signupItem->name, $memberIdentifiers ) && ( $signupItem->required || $signupItem->isUse ) )
		{
			unset( $memberIdentifiers[$signupItem->name]) ;
			$usedIdentifiers[$signupItem->name] = $lang->{$signupItem->name};
		}
	}
}
Context::set('usedIdentifiers', $usedIdentifiers);

./svorder.admin.view.php::dispSvorderAdminRecoverTransaction()에서 아래의 코드 제거
$member_config = $oMemberModel->getMemberConfig();
$memberIdentifiers = array( 'user_id'=>'user_id' );
$usedIdentifiers = array();	

if( is_array( $member_config->signupForm ) )
{
	foreach( $member_config->signupForm as $signupItem )
	{
		if( !count( $memberIdentifiers ) )
			break;
		if( in_array( $signupItem->name, $memberIdentifiers ) && ( $signupItem->required || $signupItem->isUse ) )
		{
			unset( $memberIdentifiers[$signupItem->name]) ;
			$usedIdentifiers[$signupItem->name] = $lang->{$signupItem->name};
		}
	}
}
Context::set('usedIdentifiers', $usedIdentifiers);

./svorder.admin.view.php::dispSvorderAdminOrderRawDataDownload()에서 아래의 코드 제거
$member_config = $oMemberModel->getMemberConfig();
$memberIdentifiers = array( 'user_id'=>'user_id' );
$usedIdentifiers = array();	
if( is_array( $member_config->signupForm ) )
{
	foreach( $member_config->signupForm as $signupItem )
	{
		if( !count( $memberIdentifiers ) )
			break;
		if( in_array( $signupItem->name, $memberIdentifiers ) && ( $signupItem->required || $signupItem->isUse ) )
		{
			unset( $memberIdentifiers[$signupItem->name]) ;
			$usedIdentifiers[$signupItem->name] = $lang->{$signupItem->name};
		}
	}
}
Context::set('usedIdentifiers', $usedIdentifiers);

v 2.1.0
23rd, Aug 2019
1. 외부 물류 서버와 연동하지 않을 때 svorder_order::thirdparty_order_id에 unset_ext_order_no이 표시되는 현상 개선
./svorder.controller.php::transmitOrderInfoExt()에서 아래의 코드를
if( $nOrderState != '2' )
	return new Object();

$oSvitemModel = &getModel( 'svitem' );
$oSvorderModel = &getModel('svorder');
$oOrdersInfo = $oSvorderModel->getOrderInfoForPayment( $nOrderSrl );
$aGiveawayItem = array();
foreach($oOrdersInfo->item_list as $key=>$val)
{
	if( strlen( $val->conditional_promotion ) > 0 )
	{
		$oConditionalPromotion = unserialize( $val->conditional_promotion );
		if( $oConditionalPromotion->version == '1.0' )
		{
			foreach( $oConditionalPromotion->promotion as $key1=>$val1)
			{
				if( $val1->type == 'giveaway' )
				{
					$oItemInfo = $oSvitemModel->getItemInfoByItemSrl($val1->giveaway_item_srl);
					$aGiveawayItem[$key]->item_code = $oItemInfo->item_code;
					$aGiveawayItem[$key]->price = 0;
					$aGiveawayItem[$key]->quantity = $val1->resultant_giveaway_qty;
				}
			}
		}
	}
}
if( count( $aGiveawayItem ) > 0 )
	$oOrdersInfo->giveaway_item_list = $aGiveawayItem;

$aDefaultExtraVars = unserialize( $oOrdersInfo->extra_vars );
foreach($aDefaultExtraVars as $key=>$val)
	$oOrdersInfo->{$key} = $val;

$config = $oSvorderModel->getModuleConfig();
$sExtOrderSrl = 'unset_ext_order_no';

아래와 같이 변경
if( $nOrderState != '2' )
	return new Object();

$oSvorderModel = &getModel('svorder');
$config = $oSvorderModel->getModuleConfig();
if( !$config->external_server )
	return new Object();

$oSvitemModel = &getModel( 'svitem' );
$oOrdersInfo = $oSvorderModel->getOrderInfoForPayment( $nOrderSrl );
$aGiveawayItem = array();
foreach($oOrdersInfo->item_list as $key=>$val)
{
	if( strlen( $val->conditional_promotion ) > 0 )
	{
		$oConditionalPromotion = unserialize( $val->conditional_promotion );
		if( $oConditionalPromotion->version == '1.0' )
		{
			foreach( $oConditionalPromotion->promotion as $key1=>$val1)
			{
				if( $val1->type == 'giveaway' )
				{
					$oItemInfo = $oSvitemModel->getItemInfoByItemSrl($val1->giveaway_item_srl);
					$aGiveawayItem[$key]->item_code = $oItemInfo->item_code;
					$aGiveawayItem[$key]->price = 0;
					$aGiveawayItem[$key]->quantity = $val1->resultant_giveaway_qty;
				}
			}
		}
	}
}
if( count( $aGiveawayItem ) > 0 )
	$oOrdersInfo->giveaway_item_list = $aGiveawayItem;

$aDefaultExtraVars = unserialize( $oOrdersInfo->extra_vars );
foreach($aDefaultExtraVars as $key=>$val)
	$oOrdersInfo->{$key} = $val;

$sExtOrderSrl = 'unset_ext_order_no';

2. 외부 물류 서버와 연동하지 않을 때 상점 관리자에서 주문 취소 가능하도록 개선
./svorder.admin.controller.php::procSvorderAdminCancelSettlement() 제거

./svorder.admin.controller.php::_cancelSettlement() 추가

./svorder.admin.controller.php::procSvorderCancelSettlement()에서 아래의 코드를
return $oSvorderAdminController->procSvorderAdminCancelSettlement();

아래와 같이 변경
return $oSvorderAdminController->_cancelSettlement();

./svorder.class.php에서 아래의 코드를
const ORDER_STATE_RETURN_REQUESTED = 'A'; // 반품 요청 - npay
const ORDER_STATE_RETURNED = 'D';
const ORDER_STATE_EXCHANGE_REQUESTED = 'G'; // 교환 요청 - npay
const ORDER_STATE_EXCHANGE_REDELIVERY_READY = 'J'; // 교환 재배송 준비 - npay
const ORDER_STATE_EXCHANGED = 'M'; 
const ORDER_STATE_CANCEL_REQUESTED = 'P'; // 취소 요청 - npay
const ORDER_STATE_ON_CANCELLING = 'S'; <- 제거해야 함
const ORDER_STATE_CANCELLED = 'V';
const ORDER_STATE_HOLDBACK_REQUESTED = 'Y';

아래와 같이 변경
const ORDER_STATE_RETURN_REQUESTED = 'A'; // 반품 요청 - npay
const ORDER_STATE_RETURNED = 'D';
const ORDER_STATE_EXCHANGE_REQUESTED = 'G'; // 교환 요청 - npay
const ORDER_STATE_EXCHANGE_REDELIVERY_READY = 'J'; // 교환 재배송 준비 - npay
const ORDER_STATE_EXCHANGED = 'M'; 
const ORDER_STATE_CANCEL_REQUESTED = 'P'; // 취소 요청 - npay
const ORDER_STATE_CANCELLED = 'S';
const ORDER_STATE_HOLDBACK_REQUESTED = 'V'; // 구매 확정 보류 요청 - npay

./svorder.class.php에서 아래의 코드를
protected $_g_aOrderStatus = array(
	svorder::ORDER_STATE_ON_CART=>'cart_keep', 
	svorder::ORDER_STATE_ON_DEPOSIT=>'wait_deposit', 
	svorder::ORDER_STATE_PAID=>'deposit_done', 
	svorder::ORDER_STATE_PREPARE_DELIVERY=>'prepare_delivery', 
	svorder::ORDER_STATE_ON_DELIVERY=>'on_delivery', 
	svorder::ORDER_STATE_DELIVERED=>'delivery_done', 
	svorder::ORDER_STATE_COMPLETED=>'transaction_done', 
	svorder::ORDER_STATE_ON_CANCELLING=>'on_cancelling',  // <- 제거해야 함
	svorder::ORDER_STATE_CANCELLED=>'cancelled',
	svorder::ORDER_STATE_RETURNED=>'returns',
	svorder::ORDER_STATE_DELETED=>'deleted' );

아래와 같이 변경
protected $_g_aOrderStatus = array(
	svorder::ORDER_STATE_ON_CART=>'cart_keep', 
	svorder::ORDER_STATE_ON_DEPOSIT=>'wait_deposit', 
	svorder::ORDER_STATE_PAID=>'deposit_done', 
	svorder::ORDER_STATE_PREPARE_DELIVERY=>'prepare_delivery', 
	svorder::ORDER_STATE_ON_DELIVERY=>'on_delivery', 
	svorder::ORDER_STATE_DELIVERED=>'delivery_done', 
	svorder::ORDER_STATE_COMPLETED=>'transaction_done', 
	svorder::ORDER_STATE_CANCEL_REQUESTED=>'on_cancelling',
	svorder::ORDER_STATE_CANCELLED=>'cancelled',
	svorder::ORDER_STATE_RETURNED=>'returns',
	svorder::ORDER_STATE_DELETED=>'deleted' );

./tpl/ordermanagement.html에서 아래의 코드를
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','0')}" class="active"|cond="$status=='0'" cond="0">{$lang->cmd_cart}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','1')}" class="active"|cond="$status=='1'">{$lang->wait_deposit}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','2')}" class="active"|cond="$status=='2'">{$lang->deposit_done}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','3')}" class="active"|cond="$status=='3'">{$lang->prepare_delivery}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','4')}" class="active"|cond="$status=='4'">{$lang->on_delivery}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','5')}" class="active"|cond="$status=='5'">{$lang->delivery_done}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','6')}" class="active"|cond="$status=='6'">{$lang->transaction_done}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','B')}" class="active"|cond="$status=='B'">{$lang->returns}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','E')}" class="active"|cond="$status=='E'">{$lang->on_cancelling}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status','A')}" class="active"|cond="$status=='A'">{$lang->cancelled}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderRawDataDownload','status','')}" class="active"|cond="$act=='dispSvorderAdminOrderRawDataDownload'">{$lang->order_rawdata_download}</a> <i>|</i>

아래와 같이 변경
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_ON_DEPOSIT)}" class="active"|cond="$status==svorder::ORDER_STATE_ON_DEPOSIT">{$lang->wait_deposit}</a> 
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_PAID)}" class="active"|cond="$status==svorder::ORDER_STATE_PAID">{$lang->deposit_done}</a> 
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_PREPARE_DELIVERY)}" class="active"|cond="$status==svorder::ORDER_STATE_PREPARE_DELIVERY">{$lang->prepare_delivery}</a> 
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_ON_DELIVERY)}" class="active"|cond="$status==svorder::ORDER_STATE_ON_DELIVERY">{$lang->on_delivery}</a> 
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_DELIVERED)}" class="active"|cond="$status==svorder::ORDER_STATE_DELIVERED">{$lang->delivery_done}</a> 
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_COMPLETED)}" class="active"|cond="$status==svorder::ORDER_STATE_COMPLETED">{$lang->transaction_done}</a> 
<i>&nbsp;||&nbsp;</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_RETURN_REQUESTED)}" class="active"|cond="$status==svorder::ORDER_STATE_RETURN_REQUESTED">{$lang->return_requested}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_RETURNED)}" class="active"|cond="$status==svorder::ORDER_STATE_RETURNED">{$lang->returns}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_EXCHANGE_REQUESTED)}" class="active"|cond="$status==svorder::ORDER_STATE_EXCHANGE_REQUESTED">{$lang->exchange_requested}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_EXCHANGE_REDELIVERY_READY)}" class="active"|cond="$status==svorder::ORDER_STATE_EXCHANGE_REDELIVERY_READY">{$lang->exchange_redelivery_ready}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_EXCHANGED)}" class="active"|cond="$status==svorder::ORDER_STATE_EXCHANGED">{$lang->exchanged}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_CANCEL_REQUESTED)}" class="active"|cond="$status==svorder::ORDER_STATE_CANCEL_REQUESTED">{$lang->on_cancelling}</a> <i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_CANCELLED)}" class="active"|cond="$status==svorder::ORDER_STATE_CANCELLED">{$lang->cancelled}</a>
<i>&nbsp;||&nbsp;</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderManagement','status',svorder::ORDER_STATE_DELETED)}" class="active"|cond="$status==svorder::ORDER_STATE_DELETED">{$lang->deleted}</a>
<i>|</i>
<a href="{getUrl('','module',$module,'act','dispSvorderAdminOrderRawDataDownload','status','')}" class="active"|cond="$act=='dispSvorderAdminOrderRawDataDownload'">{$lang->order_rawdata_download}</a> <i>|</i>

./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
$args->order_status = 'E'; // 취소 요청 상태
$args->order_status = 'A'; // PG 신용카드 결제 취소 후 취소 상태로 분류

아래와 같이 변경
$args->order_status = svorder::ORDER_STATE_CANCEL_REQUESTED;
$args->order_status = svorder::ORDER_STATE_CANCELLED;

./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 아래의 코드를
$args->order_status = 4; 

아래와 같이 변경
$args->order_status = svorder::ORDER_STATE_ON_DELIVERY; 

./svorder.admin.controller.php::arrangeOrderStatus()에서 아래의 코드를
$oArgs->order_status = '1';

아래와 같이 변경
$oArgs->order_status = svorder::ORDER_STATE_ON_DEPOSIT;

./svorder.admin.controller.php::_updateStock()에서 아래의 코드를
if( $val->order_status != '1' )

아래와 같이 변경
if( $val->order_status != svorder::ORDER_STATE_ON_DEPOSIT )

./svorder.admin.controller.php::completePgProcess()에서 아래의 코드를
if($oPgParam->state == 1 || $oPgParam->state == 3 )   // 1:not completed, 3:failure
	$args->order_status = 1;
else if($oPgParam->state == 2) // completed
	$args->order_status = 2;

아래와 같이 변경
if($oPgParam->state == 1 || $oPgParam->state == 3 )   // 1:not completed, 3:failure
	$args->order_status = svorder::ORDER_STATE_ON_DEPOSIT;
else if($oPgParam->state == 2) // completed
	$args->order_status = svorder::ORDER_STATE_PAID;

./svorder.admin.view.php::dispSvorderAdminOrderRawDataDownload()에서 아래의 코드를
$args->order_status_min = 2;
$args->order_status_max = 7;

아래와 같이 변경
$args->order_status_min = svorder::ORDER_STATE_PAID;
$args->order_status_max = svorder::ORDER_STATE_COMPLETED;

./svorder.admin.model.php::getOrdersByMemberSrl()에서 아래의 코드를
$args->order_status = '2';

아래와 같이 변경
$args->order_status = svorder::ORDER_STATE_PAID;

./tpl/orderdetail.html에서 
order_status 관련 코드를 global defined로 변경

./skins/.../orderlist.html에서 
order_status 관련 코드를 global defined로 변경

./skins/.../orderdetail.html에서 
order_status 관련 코드를 global defined로 변경

./m.skins/.../orderlist.html에서 
order_status 관련 코드를 global defined로 변경

./m.skins/.../orderdetail.html에서 
order_status 관련 코드를 global defined로 변경

./m.skins/.../ordercomplete.html에서
order_status 관련 코드를 global defined로 변경

./ext_class/ecaso_listen.class.php에서
order_status 관련 코드를 global defined로 변경

./tpl/orderdetail.html에서 아래의 코드를
<button ID='btnTransmitExt' NAME='btnTransmitExt' type="button" class="x_btn x_btn-primary" onClick="javascript:transmitSettlement( '{$order_info->order_srl}' ); return false;" cond="($order_info->thirdparty_order_id==''||$order_info->thirdparty_order_id=='err:general_transmit_failure')&&$order_info->order_status==svorder::ORDER_STATE_PAID">외부서버에 주문 전송</button>&nbsp;&nbsp

아래와 같이 변경
<block cond="$config->external_server">
	<button ID='btnTransmitExt' NAME='btnTransmitExt' type="button" class="x_btn x_btn-primary" onClick="javascript:transmitSettlement( '{$order_info->order_srl}' ); return false;" cond="($order_info->thirdparty_order_id==''||$order_info->thirdparty_order_id=='err:general_transmit_failure')&&$order_info->order_status==svorder::ORDER_STATE_PAID">외부서버에 주문 전송</button>&nbsp;&nbsp
</block>

./svorder.admin.controller.php::procSvorderAdminCancelSettlement()에서 아래의 코드를
if( $oOrder->payment_method == 'CC' && $oOrder->order_status == '2' )
{
	if( strlen( $sCancelReason ) == 0 )
		return new Object( -1, 'msg_invalid_pg_tr_id_cancel_reason' );

	$oSvpgAdminController = &getAdminController('svpg');
	$oRst = $oSvpgAdminController->procSvpgAdminCancelSettlement($nOrderSrl,$sCancelReason);
	// 취소 성공하면 취소일자 표시하고 주문 상태 변경
	if( $oRst->toBool())
	{
		$sTimeStamp = $oRst->get('regdate' ) == '' ? date('YmdHis') : $oRst->get('regdate' );
		$args->pg_tid_canceldate = $sTimeStamp;
		$output = executeQuery('svorder.updatePgTrIdCancelLogByOrderSrl',$args);
		if (!$output->toBool()) 
			return $output;

		unset($args->pg_tid_canceldate);
		$args->order_status = svorder::ORDER_STATE_CANCELLED; // PG 신용카드 결제 취소 후 취소 상태로 분류
		$sTransmitCancelInfoExtType = 'cancel_request_with_pg_cancellation';
	}
}

아래와 같이 변경
$args->order_status = svorder::ORDER_STATE_CANCEL_REQUESTED; // 기본은 취소 요청
// 배송 전이고 신용카드 결제이면 PG 취소 실행
if( $oOrder->payment_method == 'CC' )
{
	if( $oOrder->order_status == svorder::ORDER_STATE_PAID || 
		$oOrder->order_status == svorder::ORDER_STATE_RETURNED )
	{
		if( strlen( $sCancelReason ) == 0 )
			return new Object( -1, 'msg_invalid_pg_tr_id_cancel_reason' );

		$oSvpgAdminController = &getAdminController('svpg');
		$oRst = $oSvpgAdminController->procSvpgAdminCancelSettlement($nOrderSrl,$sCancelReason);
		// 취소 성공하면 취소일자 표시하고 주문 상태 변경
		if( $oRst->toBool())
		{
			$sTimeStamp = $oRst->get('regdate' ) == '' ? date('YmdHis') : $oRst->get('regdate' );
			$args->order_srl = $nOrderSrl;
			$args->pg_tid_canceldate = $sTimeStamp;
			$output = executeQuery('svorder.updatePgTrIdCancelLogByOrderSrl',$args);
			if (!$output->toBool()) 
				return $output;

			unset($args->pg_tid_canceldate);
			$args->order_status = svorder::ORDER_STATE_CANCELLED; // PG 신용카드 결제 취소 후 취소 상태로 분류
			$sTransmitCancelInfoExtType = 'cancel_request_with_pg_cancellation';
		}
	}
}

./svorder.admin.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
$aChangeableOrderStatus = $oSvorderAdminModel->getChangeableOrderStatusByStatus( $oOrderInfo );
foreach( $aChangeableOrderStatus as $nOrderStatus => $nDummy)
	$aChangeableOrderStatus[$nOrderStatus] = Context::getLang($this->_g_aOrderStatus[$nOrderStatus]);

./svorder.admin.model.php::getChangeableOrderStatusByStatus() 추가
./svorder.admin.model.php::_getChangeableOrderStatusByPaymethod() 추가

./tpl/orderdetail.html에 관련 코드 변경

./svorder.admin.controller.php::updateSingleOrderStatus() 추가

./svorder.admin.controller.php::procSvorderAdminUpdateOrderDetail()에 아래의 코드 추가
$sTargetOrderStatus = Context::get('target_order_status');
if( $sTargetOrderStatus )
{
	$oInArgs->order_status = $sTargetOrderStatus;
	// 상태 변경 사유 수집 시작
	$sCsMemo = strip_tags(trim(Context::get('cs_memo'))); 
	$oInArgs->cs_memo = $sCsMemo;
	// 상태 변경 사유 수집 끝
	// 환불 계좌 정보 수집 시작
	$aDeductionInfo = array();
	$aDeductionTitle = Context::get('deduction_title');
	$aDeductionAmnt = Context::get('deduction_amnt');
	$sRefundBankAcct = Context::get('refund_bank_account');
	
	$aDeductionInfo['bank_acct'] = Context::get('refund_bank_account');
	foreach( $aDeductionTitle as $nIdx => $sTitle )
		$aDeductionInfo[$sTitle] = $aDeductionAmnt[$nIdx];
	
	$bPgManualCancel = Context::get('pg_manual_cancel');
	if( $bPgManualCancel == 'y' )
		$aDeductionInfo['pg_manual_cancel'] = true;

	$oInArgs->deduct_info_for_cancel = $aDeductionInfo;
	// 환불 정보 수집 끝
	$oUpdateStatusRst = $this->updateSingleOrderStatus( $nOrderSrl, $oInArgs );
	if(!$oUpdateStatusRst->toBool())
		return $oUpdateStatusRst;
}

./schemas/svorder_cs_log.xml 추가

./schemas/svorder_order.xml에서 아래의 코드 제거
<column name="delivdate" type="date" notnull="notnull" />
<column name="receiptdate" type="date" notnull="notnull" />

./queries/getOrdersByStatus.xml에서 아래의 코드 제거
<column name="delivdate" />
<column name="receiptdate" />

./queries/updateOrderStatusSvorder.xml에서 아래의 코드 제거
<column name="delivdate" var="delivdate" />
<column name="receiptdate" var="receiptdate" />

./svorder.controller.php::procSvorderAdminUpdateOrderDetail()에서 아래의 코드 제거
$sCsMemo = $oTgtArgs->cs_memo;
if($sCsMemo)
{
	$oArgs->order_srl = $nOrderSrl;
	$oLoggedInfo = Context::get('logged_info');
	$oArgs->member_srl = $oLoggedInfo->member_srl;
	$oArgs->memo = $sCsMemo;
	$oRst = executeQuery('svorder.insertOrderCsMemo', $oArgs);
	if(!$oRst->toBool())
		return $oRst;
}

./schemas/svorder_order.xml에 아래의 코드 추가
<column name="deduction_info" type="text" />
<column name="is_redelivery" type="char" size="1" default="0"  notnull="notnull" />

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
$oOrderInfo->deduction_info = unserialize( $oOrderInfo->deduction_info );

./queries/updateOrderDeductInfoByOrderSrl.xml 추가

./queries/updateOrderRedeliveryByOrderSrl.xml 추가

./svorder.admin.controller.php::_toggleRedelivery() 추가

./svorder.admin.model.php::getSvorderCsMemo()에서 아래의 코드를
$output = executeQueryArray('svorder.getOrderCsMemo', $args);

아래와 같이 변경
$output = executeQueryArray('svorder.getOrderCsLog', $args);

./svorder.model.php::getChangeableOrderStatusByStatus() 추가
./svorder.model.php::_getChangeableOrderStatusByPaymethod() 추가

./svorder.controller.php::procSvorderCancelSettlement()에서 아래의 코드를
$oSvorderAdminController = &getAdminController('svorder');
return $oSvorderAdminController->procSvorderAdminCancelSettlement();

아래와 같이 변경
if( $oOrderInfo->payment_method == 'CC' )
	$oTgtArgs->order_status = svorder::ORDER_STATE_CANCELLED:
else
	$oTgtArgs->order_status = svorder::ORDER_STATE_CANCEL_REQUESTED:

$oSvorderAdminController = &getAdminController('svorder');
return $oSvorderAdminController->updateSingleOrderStatus( $nOrderSrl, $oTgtArgs );

./svorder.admin.controller.php::_updateSalesCount() 추가

./svorder.admin.controller.php::_notifyViaMail() 추가

./svorder.admin.controller.php::_updatePgTrIdCancelLogByOrderSrl() 추가

./svorder.admin.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
if( $oOrderInfo->deduction_info )
{
	if( $oOrderInfo->payment_method == 'CC' )
		Context::set('deduction_bank_info', '신용카드 환불' );
	elseif( $oOrderInfo->deduction_info['bank_acct'] )
		Context::set('deduction_bank_info', $oOrderInfo->deduction_info['bank_acct'] );
}

$aChangeableOrderStatus = $oSvorderAdminModel->getChangeableOrderStatusByStatus( $oOrderInfo );
foreach( $aChangeableOrderStatus as $nOrderStatus => $nDummy)
	$aChangeableOrderStatus[$nOrderStatus] = Context::getLang($this->_g_aOrderStatus[$nOrderStatus]);

if( $oOrderInfo->order_status != svorder::ORDER_STATE_COMPLETED &&
	$oOrderInfo->order_status != svorder::ORDER_STATE_CANCELLED )
	Context::set('allow_modification', true);

./skins/~/orderdetail.html에서 아래의 코드 제거
<th>{$lang->delivery_info}</th>

./skins/~/orderdetail.html에서 아래의 코드 제거
<td>{$order_status[$order_info->order_status]}</td>

./skins/~/orderdetail.html에서 아래의 코드를
<td class="price-td">
	<a cond="$order_info->order_status == svorder::ORDER_STATE_PAID && $payment_info->payment_method=='CC'" href='#' onClick="javascript:cancelSettlement( '{$order_info->order_srl}' ); return false;"><button>{$lang->cmd_cancel_transaction}</button></a>
</td>

아래와 같이 변경
<td class="price-td">
	<select name="target_order_status" id="target_order_status">
	<option loop="$status_button_arr=>$nOrderStatus,$sOrderTitle" value="{$nOrderStatus}">{$sOrderTitle}</option>
	</select>
	<a cond="$order_info->order_status != svorder::ORDER_STATE_COMPLETED && $order_info->order_status != svorder::ORDER_STATE_CANCELLED" href='#' onClick="javascript:cancelSettlement( '{$order_info->order_srl}' ); return false;"><button>{$lang->cmd_update_order_status}</button></a>
</td>

./m.skins/~/orderdetail.html에서 아래의 코드를
{$order_status[$order_info->order_status]}

아래와 같이 변경
<select name="target_order_status" id="target_order_status">
<option loop="$status_button_arr=>$nOrderStatus,$sOrderTitle" value="{$nOrderStatus}">{$sOrderTitle}</option>
</select>
<a cond="$order_info->order_status != svorder::ORDER_STATE_COMPLETED && $order_info->order_status != svorder::ORDER_STATE_CANCELLED" href='#' onClick="javascript:updateOrderStatus( '{$order_info->order_srl}' ); return false;"><button>{$lang->cmd_update_order_status}</button></a>

./tpl/skins.js/script.js::cancelSettlement() 제거

./tpl/skins.js/script.js::updateOrderStatus() 추가

./svorder.controller.php::procSvorderCancelSettlement() 제거

./svorder.controller.php::procSvorderUpdateOrderStatus() 추가

./svorder.admin.controller.php::procSvorderAdminUpdateStatus() 제거
./svorder.admin.controller.php::procSvorderAdminUpdateStatusMultiple() 추가

./svorder.admin.controller.php::completePgProcess()에서 아래의 코드를
$output = $this->updateOrderStatus( $oPgParam->order_srl, $args );

아래와 같이 변경
if( $args->order_status )
	$args->cs_memo = 'completePgProcess 일괄처리'; 

$oSvorderAdminController = &getAdminController('svorder');
$output = $oSvorderAdminController->updateSingleOrderStatus( $oPgParam->order_srl, $args );

./svorder.controller.php::updateOrderStatus() 제거

/ecaso_listen.class.php에서 아래의 코드를
$oSvorderController = getController('svorder');
$output = $oSvorderController->updateOrderStatus( $sSvOrderSrl, $args );

아래와 같이 변경
$oSvorderAdminController = getAdminController('svorder');
$output = $oSvorderAdminController->updateSingleOrderStatus( $sSvOrderSrl, $args );

3. 주문 알람 메일 작동 방식 변경
./svorder.controller.php::sendAlarmMail()에서 아래의 코드를
$oSvorderModel = &getModel('svorder');
$oConfig = $oSvorderModel->getModuleConfig();
if( strlen( $oConfig->alarm_mail_sender_name ) == 0 )
	return;

$oOrdersInfo = $oSvorderModel->getOrderInfo( $nOrderSrl );
$sMailTo = $oOrdersInfo->purchaser_email;
$nOrderSrl = $oOrdersInfo->order_srl;
if( strlen( $sMailTo ) == 0 || strlen( $nOrderSrl ) == 0 )
	return;
// 관리자 그룹(group_srl = 1)만 추출 시작
$adminMemberArgs = new stdClass;
$adminMemberArgs->group_srl = 1;
$output = executeQueryArray('svorder.getAdminMembersByGroupSrl', $adminMemberArgs);

if( count( $output->data ) )
{
	$aAdminMail = array();
	$sAdminMembersSrl = '';
	$i = 0;
	foreach( $output->data as $key => $val ) 
	{
		$arg->member_srl = $val->member_srl;
		$output = executeQuery('member.getMemberInfoByMemberSrl', $arg);
		$sAdminMembersSrl .= $val->member_srl.'|';
		$aAdminMail[$i++] = $output->data->email_address;
	}
}
// 관리자 그룹(group_srl = 1)만 추출 끝
$aPurchaserMail[0] = $sMailTo;

// send an email to admin user
if($output->toBool() && count( $aAdminMail ) && count( $aPurchaserMail ) )
{
	$oMail = new Mail();
	$sServerName = str_replace('www.', '', $_SERVER['HTTP_HOST']);
	$sSenderAddr = 'no-reply@'.$sServerName;
	$oMail->setSender($oConfig->alarm_mail_sender_name, $sSenderAddr);
	// 상점 관리자에게 알람 메일 전송
	$sTitle = '주문번호('.$nOrderSrl.')가 접수되었습니다.';
	$sTitle = $this->_encode2047($sTitle);
	for( $i = 0; $i < count( $aAdminMail ); $i++ )
	{
		$sConsumerContent = '새로운 주문 번호는 '.$nOrderSrl.'입니다.'."<br/><br/>\r\n\r\n<a href='".getFullUrl('')."/index.php?module=admin&act=dispSvshopmasterAdminIndex'>주문내역 확인하기</a>";
		$oMail->setContent( $sConsumerContent );
		$oMail->setTitle($sTitle);
		$email_address = trim( $aAdminMail[$i] );
		if( !$email_address ) 
			continue;
		$oMail->setReceiptor($email_address, $email_address);
		$oMail->send();
	}
	// 고객에게 안내 메일 전송
	$sTitle = $oSettlementInfo->delivdest_info['주문자 성명'].'님의 주문이 접수되었습니다.';
	$sTitle = $this->_encode2047($sTitle);
	$oModuleModel = &getModel('module');
	$oModules = $oModuleModel->getMidList();
	foreach($oModules as $key=>$val)
	{
		if( $val->module == 'svorder' )
		{
			$sSvorderMid = $val->mid;
			break;
		}
	}
	for($i=0;$i<count($aPurchaserMail);$i++)
	{
		$sConsumerContent = '고객님의 주문 번호는 '.$nOrderSrl.'입니다.'."<br/><br/>\r\n\r\n<a href='".getFullUrl('').'/'.$sSvorderMid.'?order_srl='.$nOrderSrl."'>주문내역 확인하러 가기</a>";
		$oMail->setContent( $sConsumerContent );
		$oMail->setTitle($sTitle);
		$email_address = trim($aPurchaserMail[$i]);
		if(!$email_address) continue;
		$oMail->setReceiptor($email_address, $email_address);
		$oMail->send();
	}
}

아래와 같이 변경
$oSvorderModel = &getModel('svorder');
$oConfig = $oSvorderModel->getModuleConfig();
if( strlen( $oConfig->use_purchaser_alarm_mail ) == 'Y' )
	return;

$oOrdersInfo = $oSvorderModel->getOrderInfo( $nOrderSrl );
$sPurchaserName = $oOrdersInfo->purchaser_name;
$sMailTo = $oOrdersInfo->purchaser_email;
$nOrderSrl = $oOrdersInfo->order_srl;
if( strlen( $sMailTo ) == 0 || strlen( $nOrderSrl ) == 0 )
	return;

if(preg_match("/^[_\.0-9a-zA-Z-]+@([0-9a-zA-Z][0-9a-zA-Z-]+\.)+[a-zA-Z]{2,6}$/i", $sMailTo) == false)
	return;// array(false, "올바른 이메일 주소를 입력해주세요.");

$oGmailParam->aReceiverInfo = array();

$aTemp = array( 'receiver_addr'=>$sMailTo, 'receiver_title'=>$sPurchaserName );
array_push($oGmailParam->aReceiverInfo, $aTemp );
if( count( $oGmailParam->aReceiverInfo ) )
{
	$oModuleModel = &getModel('module');
	$oModules = $oModuleModel->getMidList();
	foreach($oModules as $key=>$val)
	{
		if( $val->module == 'svorder' )
		{
			$sSvorderMid = $val->mid;
			break;
		}
	}

	$oModuleModel = getModel('module');
	$oSiteConfig = $oModuleModel->getModuleConfig('module');

	$oGmailParam->bHTML = true;
	$oGmailParam->sSubject = '['.$oSiteConfig->siteTitle.'] '.$sPurchaserName.'님의 주문이 접수되었습니다.';
	$oGmailParam->sBody = '고객님의 주문 번호는 '.$nOrderSrl.'입니다.'."<br/><br/>\r\n\r\n<a href='".getFullUrl('').'/'.$sSvorderMid.'?order_srl='.$nOrderSrl."'>주문내역 확인하러 가기</a>";
	$oSvcrmAdminController = &getAdminController('svcrm');
	$oSvcrmAdminController->sendGmail( $oGmailParam );
}

./tpl/config.html에서 아래의 코드를
<div class="x_control-group">
	<label class="x_control-label" for="alarm_mail_sender_name">{$lang->alarm_mail_sender_name}</label>
	<div class="x_controls">
		<input type="text" name="alarm_mail_sender_name" id="alarm_mail_sender_name" value="{$config->alarm_mail_sender_name}" />
		<a href="#alarm_mail_sender_name_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="alarm_mail_sender_name_help" class="x_help-block" hidden>{$lang->about_alarm_mail_sender_name}</p>
	</div>
</div>

아래와 같이 변경
<div class="x_control-group">
	<label class="x_control-label" for="use_purchaser_alarm_mail">{$lang->use_purchaser_alarm_mail}</label>
	<div class="x_controls">
		<select name="use_purchaser_alarm_mail">
			<option value="N" selected="selected"|cond="$config->use_purchaser_alarm_mail == 'N' || $config->use_purchaser_alarm_mail == ''">{$lang->notuse}</option>
			<option value="Y" selected="selected"|cond="$config->use_purchaser_alarm_mail == 'Y'">{$lang->use}</option>
		</select>
		<a href="#guest_buy_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="use_purchaser_alarm_mail_help" class="x_help-block" hidden>{$lang->about_use_purchaser_alarm_mail}</p>
	</div>
</div>

4. 미사용 코드 제거
./schemas/svorder_order.xml에서 아래의 코드 제거
<column name="purchaser_postcode" type="varchar" size="10" notnull="notnull" />
<column name="purchaser_address" type="varchar" size="250" notnull="notnull" />
<column name="recipient_postcode" type="varchar" size="10" notnull="notnull" />
<column name="recipient_address" type="varchar" size="250" notnull="notnull" />
<column name="extra_vars" type="text" />

./svorder.model.php::getOrderInfo()에서 아래의 코드 제거
$oOrderInfo->extra_vars = unserialize( $oOrderInfo->extra_vars );

./schemas/svorder_cs_memo.xml 제거
./queries/getOrderCsMemo.xml 제거
./queries/insertOrderCsMemo.xml 제거
./queries/updateOrderStatusSvorder.xml 제거

./svorder.controller.php::_encode2047() 제거

./queries/getOrderCsMemo.xml에서 아래의 코드 제거
<column name="purchaser_address" var="purchaser_address" />
<column name="purchaser_postcode" var="purchaser_postcode" default="" />
<column name="recipient_address" var="recipient_address" default="" />
<column name="recipient_postcode" var="recipient_postcode" default="" />

5. 비효율 코드 수정
./queries/updateOrderStatusByOrderSrl.xml에서 아래의 코드를
<tables>
	<table name="svorder_cart" />
</tables>
<columns>
	<column name="order_status" var="order_status" />
	<column name="express_id" var="express_id" />
	<column name="invoice_no" var="invoice_no" />
</columns>
<conditions>
	<condition operation="in" column="order_srl" var="order_srl" notnull="notnull" />
</conditions>

아래와 같이 변경
<tables>
	<table name="svorder_order" />
</tables>
<columns>
	<column name="order_status" var="order_status" />
	<column name="express_id" var="express_id" />
	<column name="invoice_no" var="invoice_no" />
	<column name="reserves_receive_srl" var="reserves_receive_srl" />
	<column name="extra_invoice_no" var="extra_invoice_no" />
	<column name="remitter_name" var="remitter_name" />
	<column name="pg_tid" var="pg_tid" />
	<column name="payment_method" var="payment_method" />
	<column name="use_escrow" var="use_escrow" />
</columns>
<conditions>
	<condition operation="equal" column="order_srl" var="order_srl" notnull="notnull" />
</conditions>

./svorder.admin.controller.php::_deleteOrder()에서 아래의 코드를
$oArgs->order_srl = $nOrderSrl;
$oArgs->order_status = svorder::ORDER_STATE_DELETED;
$oRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oArgs);
if(!$oRst->toBool())
	return $oRst;

// delete order info.
$oArgs->order_srl = $nOrderSrl;
$oArgs->order_status = svorder::ORDER_STATE_DELETED;
$oRst = executeQuery('svorder.updateOrderStatusSvorder', $oArgs);

아래와 같이 변경
$oArgs->order_srl = $nOrderSrl;
$oArgs->order_status = svorder::ORDER_STATE_DELETED;
$oRst = executeQuery('svorder.updateOrderStatusByCartSrl', $oArgs);
if(!$oRst->toBool())
	return $oRst;

// delete order info.
$oArgs->order_srl = $nOrderSrl;
$oArgs->order_status = svorder::ORDER_STATE_DELETED;
$oRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oArgs);

./svorder.admin.controller.php::procSvorderAdminUpdateOrderDetail()에서 아래의 코드를
$oOrderRst = executeQuery('svorder.updateOrderStatusSvorder', $oOrderArgs);

아래와 같이 변경
$oOrderRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oOrderArgs);

./svorder.controller.php::updateOrderStatus()에서 아래의 코드를
$output = executeQuery( 'svorder.updateOrderStatusSvorder', $oOrderArgs );

아래와 같이 변경
$output = executeQuery( 'svorder.updateOrderStatusByOrderSrl', $oOrderArgs );

6. 코드 오류 수정
./tpl/skin.js/script.js에서 아래의 코드를 
jQuery('#receipt').click(function() {

아래와 같이 변경
jQuery('.receipt').click(function() {

./skins/~/orderlist.html에서 아래의 코드를
<div cond="$val->order_status >= svorder::ORDER_STATE_PAID && $val->order_status <= svorder::ORDER_STATE_COMPLETED" class="receipt-btn">
	<a href="#" id="receipt" data-order-srl="{$val->order_srl}" onclick="return false;">{$lang->receipt}</a>
</div>

아래와 같이 변경
<div cond="$val->order_status >= svorder::ORDER_STATE_PAID && $val->order_status <= svorder::ORDER_STATE_COMPLETED" class="receipt-btn">
	<a href="#" class="receipt" data-order-srl="{$val->order_srl}" onclick="return false;">{$lang->receipt}</a>
</div>

./m.skins/~/orderlist.html에서 아래의 코드를
<span><a cond="$val->order_status >= svorder::ORDER_STATE_PAID && $val->order_status <= svorder::ORDER_STATE_COMPLETED" href="#" id="receipt item-button button-receipt" data-order-srl="{$val->order_srl}" class="receipt" onclick="return false;">{$lang->receipt}</a></span>

아래와 같이 변경
<span><a cond="$val->order_status >= svorder::ORDER_STATE_PAID && $val->order_status <= svorder::ORDER_STATE_COMPLETED" href="#" class="receipt item-button button-receipt" data-order-srl="{$val->order_srl}" class="receipt" onclick="return false;">{$lang->receipt}</a></span>

./tpl/skin.js/script.js 제거

./tpl/skin.js/orderlist.js 추가

./tpl/skin.js/orderdetail.js 추가

7. 상태별 주문 조회가 사용자 의도대로 작동하지 않는 상황 수정
./queries/getOrderListByStatus.xml에서 아래의 코드를
<condition operation="equal" column="member_srl" var="member_srl" />
<condition operation="equal" column="order_status" var="order_status" pipe="and" />
<condition operation="equal" column="order_srl" var="order_srl" pipe="and" />
<condition operation="like_prefix" column="regdate" var="regdate" pipe="and" />
<condition operation="equal" column="purchaser_email" var="email_address" pipe="or" />
<condition operation="equal" column="purchaser_name" var="purchaser_name" pipe="or" />
<condition operation="equal" column="purchaser_cellphone" var="purchaser_cellphone" pipe="or" />
<condition operation="equal" column="member_srl" var="member_srl" pipe="or" />

아래와 같이 변경
<condition operation="equal" column="order_status" var="order_status" />
<condition operation="equal" column="member_srl" var="member_srl" pipe="and"/>
<condition operation="equal" column="order_srl" var="order_srl" pipe="and" />
<condition operation="equal" column="purchaser_email" var="email_address" pipe="and" />
<condition operation="equal" column="purchaser_name" var="purchaser_name" pipe="and" />
<condition operation="equal" column="purchaser_cellphone" var="purchaser_cellphone" pipe="and" />
<condition operation="equal" column="member_srl" var="member_srl" pipe="and" />
<condition operation="like_prefix" column="regdate" var="regdate" pipe="and" />

8. 배송 주소 변경 기능 추가
./svorder.model.php::getSvorderUpdateAddrAllowable() 추가
./svorder.controller.php::procSvorderUpdateAddress() 추가

./tpl/skin.js/orderdetail.js::_checkAddrChangeable() 추가
./tpl/skin.js/orderdetail.js::_requestUpdateAddr() 추가

./tpl/skin.js/orderdetail.js::jQuery(function($)에 아래의 코드 추가
jQuery('#btn_show_addr').click(function () {
	if(jQuery('#tbl_postcodify_addr').css('display') == 'none')
	{   
		var nOrderSrl =jQuery(this).attr('data-order-srl');
		_checkAddrChangeable( nOrderSrl );
	}
	else
	{
		jQuery('#btn_show_addr').html('변경');
		jQuery('#tbl_postcodify_addr').hide();  
	}
});

jQuery('#btn_update_req_addr').click(function () {
	//console.log( jQuery('#tbl_postcodify_addr').css('display') )
	if(jQuery('#tbl_postcodify_addr').css('display') == 'table')
	{   
		var nOrderSrl =jQuery(this).attr('data-order-srl');
		_requestUpdateAddr( nOrderSrl );
	}
	else
		console.log('invalid approach');
}); 

./skins/~/orderdetail.html에 관련 코드 추가
./m.skins/~/orderdetail.html에 관련 코드 추가

9. 관리자 화면의 주문 검색 화면에서 주문상태를 고려한 검색과 무시한 검색으로 기능 구분
./svorder.admin.view.php::dispSvorderAdminOrderManagement()에 아래의 코드 추가
$sStatusSearchMode = trim(Context::get( 's_status_search' ));
if( $sStatusSearchMode == 'wo_status' )
	unset( $args->order_status );

./tpl/ordermanagement.html에 아래의 코드 추가
<select name="s_status_search" style="width:140px;">
	<option value="" selected="selected"|cond="!$s_status_search">{$lang->wt_status}</option>
	<option value="wo_status" selected="selected"|cond="$s_status_search=='wo_status'">{$lang->wo_status}</option>
</select>

10. 코드 오류 수정
./svorder.model.php::getExtraVars()에서 아래의 코드를 
$output = executeQueryArray('svorder.getSvorderExtraVars', $args);

아래와 같이 변경
$output = executeQueryArray('svorder.getExtraVars', $args);

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
$oOrderInfo->extra_vars = $this->getExtraVars($oOrderInfo->module_srl, $order_srl);

./skins/~/orderdetail.html에서 아래의 코드를 
<tr loop="$extra_vars=>$key,$val">
	<th>{$key}</th>
	<td><span cond="is_array($val)">{implode(' ', $val)}</span><span cond="!is_array($val)">{$val}</span></td>
</tr>

아래와 같이 변경
<tr loop="$extra_vars=>$key,$val">
	<th>{$val->name}</th>
	<td><span>{$val->value}</span></td>
</tr>

./m.skins/~/orderdetail.html에서 아래의 코드를 
<th>{$key}</th>
<td class="number-font"><span cond="is_array($val)">{implode(' ', $val)}</span><span cond="!is_array($val)">{$val}</span></td>

아래와 같이 변경
<th>{$val->name}</th>
<td><span>{$val->value}</span></td>

11. 주문 관리자의 주문 상세 보기에서 사용자 변수 표시 기능 추가
./svorder.admin.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
Context::set('extra_vars', $oOrderInfo->extra_vars);

./tpl/orderdetail.html에서 아래의 코드를
<th>{$key}</th>
<td colspan="3"><span cond="is_array($val)">{implode(' ', $val)}</span><span cond="!is_array($val)">{$val}</span></td>

아래와 같이 변경
<th>{$val->name}</th>
<td colspan="3"><span>{$val->value}</span></td>

v 2.1.1
16th, Sep 2019
1. 관리자에서 주문 삭제 오류 해결
./svorder.admin.controller.php::_deleteOrder()에서 아래의 코드를
$oArgs->order_srl = $nOrderSrl;

아래와 같이 변경
$oArgs->cart_srl = $nOrderSrl;

v 2.1.2
17th, Sep 2019
1. 출고 직전 결제 취소를 위해 배송준비 상태에서 입금완료로 롤백할 수 있는 기능 추가 
./svorder.admin.model.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_PREPARE_DELIVERY )
	$aChangeableOrderStatus[svorder::ORDER_STATE_ON_DELIVERY] = 1; //'배송중';

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_PREPARE_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PAID] = 1; //'입금완료로 롤백';
	$aChangeableOrderStatus[svorder::ORDER_STATE_ON_DELIVERY] = 1; //'배송중';
}

./svorder.admin.view.php::dispSvorderAdminOrderDetail()에서 아래의 코드를
unset( $aChangeableOrderStatus[svorder::ORDER_STATE_PAID] ); // 입금완료는 PG 프로세스만으로 이동할 수 있음

아래와 같이 변경
if( $oOrderInfo->order_status != svorder::ORDER_STATE_PREPARE_DELIVERY )
	unset( $aChangeableOrderStatus[svorder::ORDER_STATE_PAID] ); // 입금완료는 PG 프로세스만으로 이동할 수 있음

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
if( $nOriginalOrderStatus !== $oTgtArgs->order_status )
{
	$oCrmArgs->order_srl = $nOrderSrl;
	$oCrmArgs->purchaser_name = $oOrderInfo->purchaser_name;
	$oCrmArgs->purchaser_cellphone = $oOrderInfo->purchaser_cellphone;
	$oCrmArgs->order_status = $oTgtArgs->order_status;
	$oSvcrmController = &getController('svcrm');
	if( !is_null( $oSvcrmController ) )
		$oSvcrmController->notifyOrderStatusUpdate($oCrmArgs);
}

아래와 같이 변경
if( $nOriginalOrderStatus != svorder::ORDER_STATE_PREPARE_DELIVERY || 
	$oTgtArgs->order_status != svorder::ORDER_STATE_PAID ) // 배송 전 취소를 위한 롤백은 통지하지 않음
{
	if( $nOriginalOrderStatus !== $oTgtArgs->order_status )
	{
		$oCrmArgs->order_srl = $nOrderSrl;
		$oCrmArgs->purchaser_name = $oOrderInfo->purchaser_name;
		$oCrmArgs->purchaser_cellphone = $oOrderInfo->purchaser_cellphone;
		$oCrmArgs->order_status = $oTgtArgs->order_status;
		$oSvcrmController = &getController('svcrm');
		if( !is_null( $oSvcrmController ) )
			$oSvcrmController->notifyOrderStatusUpdate($oCrmArgs);
	}
}

2. CS 로그에 user_id 대신 nick_name이 표시되도록 변경
./svorder.admin.model.php::getSvorderCsMemo()에서 아래의 코드를
$oVal->admin_user_id = $oMemberInfo->user_id;

아래와 같이 변경
$oVal->nick_name = $oMemberInfo->nick_name;

3. 배송 전 신용카드 취소인 경우에도 차감 항목 표시하도록 변경
./tpl/orderdetail.html에서 아래의 코드를
if( jQuery( this ).val() == '{svorder::ORDER_STATE_CANCEL_REQUESTED}' )

아래와 같이 변경
if( jQuery( this ).val() == '{svorder::ORDER_STATE_CANCEL_REQUESTED}' || jQuery( this ).val() == '{svorder::ORDER_STATE_CANCELLED}' )

v 2.1.3
18th, Sep 2019
1. 코드 오류 수정
./svorder.admin.controller.php::_cancelSettlement()에서 아래의 코드를
$sTimeStamp = $oRst->get('regdate' ) == '' ? date('YmdHis') : $oRst->get('regdate' );

아래와 같이 변경
$sTimeStamp = $oCancelPgRst->get('regdate' ) == '' ? date('YmdHis') : $oCancelPgRst->get('regdate' );

v 2.1.4
23rd, Sep 2019
1. 상태 변경 없이 메모 추가 기능
./svorder.admin.controller.php::updateSingleOrderStatus()에 아래의 코드 추가
elseif( $sTargetOrderStatus == 'memo_only' ) // 상태 변경없이 단순 메모
{
	$oTgtArgs->order_status = $oOrderInfo->order_status;
	$bChangeOrderStatus = true;
}

./tpl/orderdetail.html에 아래의 코드 추가
<option value="memo_only">단순메모</option>

v 2.1.5
25th, Sep 2019
1. 지메일 통지 받는 관리자 회원을 다수 지정할 수 있도록 개선
./svorder.admin.controller.php::_notifyViaMail()에서 아래의 코드를
$nOrderAdminSrl = (int)$oConfig->order_admin_member_srl;
$oMemberModel = getModel('member');
$oOrderAdminMemberInfo = $oMemberModel->getMemberInfoByMemberSrl($nOrderAdminSrl);
if($oOrderAdminMemberInfo->member_srl != $nOrderAdminSrl)
	return new Object(-1, 'msg_not_exists_member');

// send an e-mail
$oGmailParam->aReceiverInfo = array();
$aTemp = array( 'receiver_addr'=>$oOrderAdminMemberInfo->email_address, 'receiver_title'=>$oOrderAdminMemberInfo->user_name );
array_push($oGmailParam->aReceiverInfo, $aTemp );

아래와 같이 변경
$sOrderAdminSrls = $oConfig->order_admin_member_srl;
// Check if there is a member to receive a message
$aAdminInfo = explode( "\n", $oConfig->order_admin_mail_info );
foreach( $aAdminInfo as $nIdx => $sAdminMailInfo )
{
	$aAdminMailInfo = explode( ';', $sAdminMailInfo );
	$aTemp = array( 'receiver_addr'=>trim($aAdminMailInfo[1]), 'receiver_title'=>trim($aAdminMailInfo[0]) );
	array_push($oGmailParam->aReceiverInfo, $aTemp );
}

./svorder.admin.controller.php::procSvorderAdminConfig()에서 아래의 코드를
$aParams = array( 'external_server', 'delivery_fee', 'freedeliv_amount', 'default_shipping_serial_column_name', 
		 'alarm_mail_sender_name', 'ga_tracking_id' );	

아래와 같이 변경
$aParams = array( 'external_server', 'delivery_fee', 'freedeliv_amount', 'default_shipping_serial_column_name', 
			'order_admin_mail_info', 'alarm_mail_sender_name', 'ga_tracking_id' );	

v 2.1.6
1st, Oct 2019
1. 가상계좌 취소 시 차감액이 없어도 환불계좌 정보 표시하도록 개선
./tpl/orderdetail.html에서 아래의 코드를
{@
if( $order_info->deduction_info['pg_manual_cancel'] == 'y' )
	$bPgManualCancelChecked = 'CHECKED';
unset( $order_info->deduction_info['bank_acct'] );
unset( $order_info->deduction_info['pg_manual_cancel'] );
$nGrossDeductionAmnt = 0;
}
<block cond="$order_info->deduction_info">
	<thead>
		<tr>
			<th>차감 항목명</th>
			<th>금액</th>
		</tr>
	</thead>
	<tbody id="deduction_detail">
		<tr loop="$order_info->deduction_info=>$sTitle,$nDeductAmnt">
			<td><input type='text' name='deduction_title[]' id='deduction_title[]' class='deduction_title' value='{$sTitle}' /></td>
			<td><input type='text' name='deduction_amnt[]' id='deduction_amnt[]' class='deduction_amnt' value='{number_format($nDeductAmnt)}' /></td>
{@
$nGrossDeductionAmnt += $nDeductAmnt;
}
		</tr>
	</tbody>
</block>
	<tfoot align="center" cond="$nGrossDeductionAmnt">


아래와 같이 변경
{@
if( $order_info->deduction_info['pg_manual_cancel'] == 'y' )
	$bPgManualCancelChecked = 'CHECKED';
unset( $order_info->deduction_info['pg_manual_cancel'] );
$nGrossDeductionAmnt = 0;
}
<block cond="$order_info->deduction_info">
	<thead>
		<tr>
			<th>차감 항목명</th>
			<th>금액</th>
		</tr>
	</thead>
	<tbody id="deduction_detail">
		<tr loop="$order_info->deduction_info=>$sTitle,$nDeductAmnt" cond="$sTitle!='bank_acct'">
			<td><input type='text' name='deduction_title[]' id='deduction_title[]' class='deduction_title' value='{$sTitle}' /></td>
			<td><input type='text' name='deduction_amnt[]' id='deduction_amnt[]' class='deduction_amnt' value='{number_format($nDeductAmnt)}' /></td>
{@
$nGrossDeductionAmnt += $nDeductAmnt;
}
		</tr>
	</tbody>
</block>
	<tfoot align="center" cond="$order_info->deduction_info['bank_acct']">

v 2.1.7
7th, Oct 2019
1. 출고 직전 결제 취소를 위해 배송 중 상태에서 배송준비 상태로 롤백할 수 있는 기능 추가 
./svorder.admin.model.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_ON_DELIVERY )
	$aChangeableOrderStatus[svorder::ORDER_STATE_DELIVERED] = 1; //'배송완료';

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_ON_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = 1; //'배송준비로 롤백';
	$aChangeableOrderStatus[svorder::ORDER_STATE_DELIVERED] = 1; //'배송완료';
}

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
if( $nOriginalOrderStatus != svorder::ORDER_STATE_PREPARE_DELIVERY || 
	$oTgtArgs->order_status != svorder::ORDER_STATE_PAID ) // 배송 전 취소를 위한 롤백은 통지하지 않음

아래와 같이 변경
if( $nOriginalOrderStatus == svorder::ORDER_STATE_PREPARE_DELIVERY && 
	$oTgtArgs->order_status == svorder::ORDER_STATE_PAID ) // 배송 전 취소를 위한 롤백은 통지하지 않음
	;
elseif( $nOriginalOrderStatus == svorder::ORDER_STATE_ON_DELIVERY && 
	$oTgtArgs->order_status == svorder::ORDER_STATE_PREPARE_DELIVERY ) // 배송 전 취소를 위한 롤백은 통지하지 않음
	;
else

v 2.1.8
8th, Oct 2019
1. 반품 완료 상태로 전환되는 것도 관리자에게 통지하도록 개선
./svorder.admin.controller.php::updateSingleOrderStatus()에 아래의 코드 추가
case svorder::ORDER_STATE_RETURNED:
	$bChangeOrderStatus = true;
	$sSubject = $nOrderSrl.' 주문의 반품이 접수되었습니다.';
	$sBody = '환불 과정을 시작해야 할 주문 번호는 '.$nOrderSrl.'입니다.'."<br/><br/>\r\n\r\n<a href='".getFullUrl('').'index.php?module=svshopmaster&act=dispSvorderAdminOrderDetail&status=2&order_srl='.$nOrderSrl."'>환불 진행해야 할 주문내역 확인하러 가기</a>";
	break;

v 2.1.9
16th, Nov 2019
1. 결제 취소 완결 기능 오류 수정
./svorder.admin.model.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_CANCEL_REQUESTED )
{
	$oSvorderModel = &getModel('svorder');
	$oConfig = $oSvorderModel->getModuleConfig();
	if( $oConfig->order_admin_member_srl )
	{
		$nOrderAdminSrl = (int)$oConfig->order_admin_member_srl;
		$oLoggedInfo = Context::get('logged_info');
		if( $oLoggedInfo->member_srl == $nOrderAdminSrl ) // 만약 현재 로그인 세션이 결제 관리자라면
			$aChangeableOrderStatus[svorder::ORDER_STATE_CANCELLED] = 1; //'취소 확정';
	}
}

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_CANCEL_REQUESTED )
{
	$oSvorderModel = &getModel('svorder');
	$oConfig = $oSvorderModel->getModuleConfig();
	$oLoggedInfo = Context::get('logged_info');
	if( $oConfig->aParsedOrderAdminInfo[$oLoggedInfo->member_srl] ) // 만약 현재 로그인 세션이 결제 관리자라면
		$aChangeableOrderStatus[svorder::ORDER_STATE_CANCELLED] = 1; //'취소 확정';
}

./svorder.admin.controller.php::procSvorderAdminConfig()에서 아래의 코드를
$aParams = array( 'external_server', 'delivery_fee', 'freedeliv_amount', 'default_shipping_serial_column_name', 
		'order_admin_mail_info', 'alarm_mail_sender_name', 'ga_tracking_id' );

foreach( $aParams as $nIdx => $sParamName )
{
	if( !$oArgs->{$sParamName} )
		$oArgs->{$sParamName} = '';
}

아래와 같이 변경
$aParams = array( 'external_server', 'delivery_fee', 'freedeliv_amount', 'default_shipping_serial_column_name', 
		'order_admin_info', 'alarm_mail_sender_name', 'ga_tracking_id' );

foreach( $aParams as $nIdx => $sParamName )
{
	if( !$oArgs->{$sParamName} )
		$oArgs->{$sParamName} = '';
}

if( $oArgs->order_admin_info )
{
	$aAdminInfo = explode( "\n", $oArgs->order_admin_info );
	foreach( $aAdminInfo as $nIdx => $sAdminMailInfo )
	{
		$aAdminMailInfo = explode( ';', $sAdminMailInfo );
		if( count( $aAdminMailInfo ) != 3 )
			return new Object(-1, 'msg_invalid_order_admin_info');
	}
}

./svorder.admin.controller.php::_notifyViaMail()에서 아래의 코드를
if( !$oConfig->order_admin_info )
	return new Object(-1, 'msg_not_configured');

// send an e-mail
$oGmailParam->aReceiverInfo = array();
//$sOrderAdminSrls = $oConfig->order_admin_member_srl;

// Check if there is a member to receive a message
$aAdminInfo = explode( "\n", $oConfig->order_admin_info );

foreach( $aAdminInfo as $nIdx => $sAdminMailInfo )
{
	$aAdminMailInfo = explode( ';', $sAdminMailInfo );
	
	if( count( $aAdminMailInfo ) != 2 )
		return new Object(-1, 'msg_invalid_admin_mail_info');

	$aTemp = array( 'receiver_addr'=>trim($aAdminMailInfo[1]), 'receiver_title'=>trim($aAdminMailInfo[0]) );
	array_push($oGmailParam->aReceiverInfo, $aTemp );
}

아래와 같이 변경
if( !$oConfig->aParsedOrderAdminInfo )
	return new Object(-1, 'msg_not_configured');
// send an e-mail
$oGmailParam->aReceiverInfo = array();
foreach( $oConfig->aParsedOrderAdminInfo as $nAdminMemberSrl => $aAdminInfo )
{
	$aTemp = array( 'receiver_addr'=>$aAdminMailInfo[order_admin_email], 'receiver_title'=>$aAdminMailInfo[order_admin_name] );
	array_push($oGmailParam->aReceiverInfo, $aTemp );
}

./svorder.model.php::getModuleConfig()에 아래의 코드 추가
if( $oConfig->order_admin_info )
{
	$oConfig->aParsedOrderAdminInfo = Array();
	$aAdminInfo = explode( "\n", $oConfig->order_admin_info );
	foreach( $aAdminInfo as $nIdx => $sAdminMailInfo )
	{
		$aAdminMailInfo = explode( ';', $sAdminMailInfo );
		if( count( $aAdminMailInfo ) != 3 )
			continue;
		$aTemp = array( 'order_admin_name'=>trim($aAdminMailInfo[1]), 'order_admin_email'=>trim($aAdminMailInfo[2]) );
		$oConfig->aParsedOrderAdminInfo[(int)$aAdminMailInfo[0]] = $aTemp;
	}
}

./tpl/config.html에서 아래의 코드를 
<div class="x_control-group">
	<label class="x_control-label" for="order_admin_mail_info">{$lang->order_admin_mail_info}</label>
	<div class="x_controls" >
		<textarea name="order_admin_mail_info">{$config->order_admin_mail_info}</textarea>
		<a href="#order_admin_mail_info_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="order_admin_mail_info_help" class="x_help-block" hidden>{$lang->about_order_admin_mail_info}</p>
	</div>
</div>

아래와 같이 변경
<div class="x_control-group">
	<label class="x_control-label" for="order_admin_info">{$lang->order_admin_info}</label>
	<div class="x_controls" >
		<textarea name="order_admin_info">{$config->order_admin_info}</textarea>
		<a href="#order_admin_info_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="order_admin_info_help" class="x_help-block" hidden>{$lang->about_order_admin_info}</p>
	</div>
</div>

v 2.1.10
9th, Dec 2019
1. 반품 요청했지만 거부 혹은 철회되는 경우를 위해 배송준비로 변경 허용
./svorder.admin.model.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_RETURN_REQUESTED )
	$aChangeableOrderStatus[svorder::ORDER_STATE_RETURNED] = 1; //'반품완료';

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_RETURN_REQUESTED )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_RETURNED] = 1; //'반품완료';
	$aChangeableOrderStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = 1; //'배송완료' 반품 거부 혹은 철회되는 경우를 위해 배송준비로 변경 허용
}

v 2.1.11
10th, Dec 2019
1. npay 주문 수집 API 개발 재개
./queries/updateExtOrderIdByOrderSrl.xml 추가

./tpl/config_npay_api.html에 아래 코드 추가
<div class="x_control-group">
	<label class="x_control-label" for="npay_shop_debug_mode">{$lang->npay_shop_debug_mode}</label>
	<div class="x_controls">
		<input type="radio" name="npay_shop_debug_mode" id="npay_shop_debug_mode" value="debug" checked="checked"|cond="$config->npay_shop_debug_mode == '' || $config->npay_shop_debug_mode == 'debug'" /> Debug
		<input type="radio" name="npay_shop_debug_mode" id="npay_shop_debug_mode" value="release" checked="checked"|cond="$config->npay_shop_debug_mode == 'release'" /> Release
		<a href="#npay_shop_debug_mode_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="npay_shop_debug_mode_help" class="x_help-block" hidden>{$lang->about_npay_shop_debug_mode}</p>
	</div>
</div>

./svorder.admin.controller.php::procSvorderAdminNpayApiConfig()에서 아래의 코드를 
$aParams = array( 'npay_api_use', 'npay_api_accesslicense', 'npay_api_secretkey', 'npay_shop_id', 'npay_connected_svorder_mid' );

아래와 같이 변경
$aParams = array( 'npay_api_use', 'npay_api_accesslicense', 'npay_api_secretkey', 'npay_shop_id', 'npay_shop_debug_mode', 'npay_connected_svorder_mid' );

./svorder.admin.view.php::dispSvorderAdminNpayOrderSync()에서 아래의 코드를 
$oNpayConfigParam->npay_service_type = 'Alpha2MallService41';

아래와 같이 변경
$oNpayConfigParam->npay_shop_debug_mode = $oConfig->npay_shop_debug_mode;

./queries/getNpayOrderInfoByOrderSrl.xml 추가

./svorder.admin.model.php::getNpayOrderInfo() 추가

./svorder.admin.model.php::getOrderListByStatus()에 아래의 코드 추가
if( $oRec->order_referral == svorder::ORDER_REFERRAL_NPAY )
{
	$oNpayInfoRst = $this->getNpayOrderInfo($oRec->order_srl);
	$oSvorderRecs->data[$nIdx]->npay_order_id = $oNpayInfoRst->npay_order_id;
}

./tpl/ordermanagement.html에서 아래 코드를
<td><span title="">{$order_referral[$order->order_referral]}</span></td>

아래와 같이 변경
<td><span title="">{$order_referral[$order->order_referral]}</span><BR><span cond='$order->ext_pg_order_id' title="">{$order->ext_pg_order_id}</span></td>

./svorder.model.php::getOrderInfo()에 아래의 코드 추가
if( $oOrderInfo->order_referral == svorder::ORDER_REFERRAL_NPAY )
{
	$oSvorderAdminModel = &getAdminModel('svorder');
	$oNpayInfoRst = $oSvorderAdminModel->getNpayOrderInfo($oOrderInfo->order_srl);
	$oOrderInfo->ext_pg_order_id = $oNpayInfoRst->npay_order_id;
}

./svorder.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
Context::set('order_referral', $this->_g_aOrderReferralType);

./tpl/orderdetail.html에 아래 코드 추가
<tr>
	<th>{$lang->order_referral}</th>
	<td>{$order_referral[$order_info->order_referral]}
<block cond="$order_info->ext_pg_order_id">
	- {$order_info->ext_pg_order_id}
</block>
	</td>
	<th></th>
	<td></td>
</tr>

2. 장바구니 품목별 송장과 배송메모 기능 추가
./svorder.admin.model.php::getDataFormatConfig()에서 아래의 코드를
$aBuff = Array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 

아래와 같이 변경
$aBuff = Array( 'order_srl', 'cart_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 

./svorder.admin.model.php::_getDefaultDataFormConfig()에서 아래의 코드를
$aBuff = Array( 'order_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 

아래와 같이 변경
$aBuff = Array( 'order_srl', 'cart_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 'recipient_cellphone', 

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
else if( $key == 'cart_srl' )
	echo '"'.$aCartSrl[$i].'"';

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에 아래의 코드 추가
if( $key1 == 'cart_srl' )
	echo '"'.$aCartSrl[$i].'"';

./schemas/svorder_cart.xml에 아래의 코드 추가
<column name="delivery_memo" type="varchar" size="255" />

./queries/insertCartItem.xml에 아래의 코드 추가
<column name="delivery_memo" var="delivery_memo" />

./svorder.controller.php::insertCartItem()에 아래의 코드 추가
$bDeliveryMemoParticularInput = false;
if( !$oArgs->delivery_memo )
	$bDeliveryMemoParticularInput = true;

./svorder.controller.php::insertCartItem()에 아래의 코드 추가
if( !$bDeliveryMemoParticularInput )
	$cartitem_args->delivery_memo = $oArgs->delivery_memo;
else
	$cartitem_args->delivery_memo = $val->delivery_memo;

./schemas/getOrderItems.xml에 아래의 코드 추가
<column name="cart.delivery_memo" alias="delivery_memo" />

./tpl/orderdetail.html에서 아래의 코드 제거
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td colspan="3">{$order_info->delivery_memo}</td>
</tr>

./tpl/orderdetail.html에 아래의 코드 추가
<th>{$lang->delivery_memo}</th>
<td>{$item->delivery_memo}</td>

./skins/~/ordercomplete.html에서 아래의 코드 제거
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./skins/~/ordercomplete.html에 아래의 코드 추가
<th>{$lang->delivery_memo}</th>
<td>{$val->delivery_memo}</td>

./skins/~/orderdetail.html에서 아래의 코드 제거
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./skins/~/orderdetail.html에 아래의 코드 추가
<th>{$lang->delivery_memo}</th>
<td>{$val->delivery_memo}</td>

./m.skins/~/ordercomplete.html에서 아래의 코드 제거
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./m.skins/~/ordercomplete.html에 아래의 코드 추가
<div class="item-sum-price">{$lang->delivery_memo} : {$val->delivery_memo}</div>

./m.skins/~/orderdetail.html에서 아래의 코드 제거
<tr cond="$order_info->delivery_memo">
	<th>{$lang->delivery_memo}</th>
	<td>{$order_info->delivery_memo}</td>
</tr>

./m.skins/~/orderdetail.html에 아래의 코드 추가
<div class="item-quantity">{$lang->delivery_memo} : <span class="number-font">{$val->delivery_memo}</span></div>

./queries/getCartItems.xml에 아래의 코드 추가
<column name="cart.delivery_memo" alias="delivery_memo" />

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
else if( $key == 'delivery_memo' )
	echo '"'.$output->data->delivery_memo.'"';

3. 주문 정보 CSV에 주문 출처 표시 기능 추가
./svorder.admin.model.php에서 아래의 코드를
var $_g_aRawDataFormat = Array( 'order_srl', 'cart_srl', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 

아래와 같이 변경
var $_g_aRawDataFormat = Array( 'order_srl', 'cart_srl', 'order_referral', 'order_status', 'purchaser_name', 'purchaser_cellphone', 'purchaser_telnum', 'purchaser_email', 'recipient_name', 

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
else if( $key == 'order_referral' )
	echo '"'.$this->_g_aOrderReferralType[$rec->order_referral].'"';

else if( $key1 == 'order_referral' )
	echo '"'.$this->_g_aOrderReferralType[$rec->order_referral].'"';

4. 등록된 주문의 배송메모 변경 기능 추가
./tpl/skin.js/orderdetail.js::jQuery(function($)에 아래의 코드 추가
jQuery('.btn_toggle_delivery_memo').click(function () {
	var nOrderSrl = jQuery(this).attr('data-order-srl');
	var nCartSrl = jQuery(this).attr('data-cart-srl');
	var $oTdDelivMemo = jQuery('[data-cart-srl='+nCartSrl+']').parent();
	if($oTdDelivMemo.children('#txt_update_deliv_memo').css('display') == 'none')
		_checkDelivMemoChangeable( nOrderSrl, nCartSrl );
	else
	{
		$oTdDelivMemo.children('#txt_update_deliv_memo').hide();
		$oTdDelivMemo.children('#btn_update_delivery_memo').hide();
	}
});

./svorder.controller.php::procSvorderUpdateDelivMemo() 추가
./svorder.controller.php::_updateDeliveryMemo() 추가
./queries/updateDeliveryMemoByCartSrl.xml 추가

./tpl/skin.js/orderdetail.js::_checkDelivMemoChangeable() 추가
./tpl/skin.js/orderdetail.js::_requestUpdateDelivMemo() 추가

./skins/~/orderdetail.html에서 아래의 코드를
<td>{$val->delivery_memo}</td>

아래와 같이 변경
<td>{$val->delivery_memo}<BR><button type="button" class='btn_toggle_delivery_memo' data-order-srl='{$order_info->order_srl}' data-cart-srl='{$val->cart_srl}'>{$lang->btn_update}</button>
<input type="text" style='display: none;' id="txt_update_deliv_memo" name="txt_update_deliv_memo" value="" data-cart-srl='{$val->cart_srl}' />
<button type="button" style='display: none;' class='btn_update_delivery_memo' data-cart-srl='{$val->cart_srl}'>{$lang->btn_update}</button>
</td>

./m.skins/~/orderdetail.html에서 아래의 코드를
<div class="item-quantity">{$lang->delivery_memo} : <span class="number-font">{$val->delivery_memo}</span></div>

아래와 같이 변경
<div class="item-quantity">{$lang->delivery_memo} : <span class="number-font">{$val->delivery_memo}</span>
	<BR><button type="button" class='btn_toggle_delivery_memo' data-order-srl='{$order_info->order_srl}' data-cart-srl='{$val->cart_srl}'>{$lang->btn_update}</button>
	<input type="text" style='display: none;' id="txt_update_deliv_memo" name="txt_update_deliv_memo" value="" data-cart-srl='{$val->cart_srl}' />
	<button type="button" style='display: none;' class='btn_update_delivery_memo' data-cart-srl='{$val->cart_srl}'>{$lang->btn_update}</button>
</div>

5.
운송장 번호 CSV 일괄 등록 시 장바구니번호 컬럼 유무에 따라 품목별 송장 등록 기능
./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에 아래의 코드 추가
$nCartSrlIdx = -1;
$bCartLevelShippingSerialMode = true;

./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서 아래의 코드를
foreach( $oHeader[0] as $nKey => $sVal )
{
	if( $sVal == Context::getLang('order_srl') )//'주문번호' )
		$nOrderSrlIdx = $nKey;
	if( $sVal == $sShippingSerialColumn )
		$nShippingSrlIdx = $nKey;
}

아래와 같이 변경
foreach( $oHeader[0] as $nKey => $sVal )
{
	if( $sVal == Context::getLang('order_srl') )//'주문번호' )
		$nOrderSrlIdx = $nKey;
	if( $sVal == Context::getLang('cart_srl') )//'장바구니번호' )
		$nCartSrlIdx = $nKey;
	if( $sVal == $sShippingSerialColumn )
		$nShippingSrlIdx = $nKey;
}

./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에 아래의 코드 추가
if( $nCartSrlIdx == -1 )
{
	$bCartLevelShippingSerialMode = false;
	$aCartSrl = array();
	$aShippingSrl = array();
}

./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서 아래의 코드를
if( !$bChildOrder )
{
	$aOrderSrl[$nRow] = $oRowData[0][$nOrderSrlIdx];
	$aShippingSrl[$nRow] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
} 
else 
{
	if( $aExtraShippingSrl[$nPrevRow] === NULL )
		$aExtraShippingSrl[$nPrevRow] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
	else
		$aExtraShippingSrl[$nPrevRow] .= '|@|'.str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
}

아래와 같이 변경
if( $bCartLevelShippingSerialMode ) // 장바구니 품목별 운송장 번호 등록
{
	if( $oRowData[0][$nCartSrlIdx] != 'giveaway' )
	{
		$aOrderSrl[$nRow] = $oRowData[0][$nOrderSrlIdx];
		$aCartSrl[$nRow] = $oRowData[0][$nCartSrlIdx];
		$aShippingSrl[$nRow] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
	}
}
else
{
	if( !$bChildOrder )
	{
		$aOrderSrl[$nRow] = $oRowData[0][$nOrderSrlIdx];
		$aShippingSrl[$nRow] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
	} 
	else 
	{
		if( $aExtraShippingSrl[$nPrevRow] === NULL )
			$aExtraShippingSrl[$nPrevRow] = str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
		else
			$aExtraShippingSrl[$nPrevRow] .= '|@|'.str_replace( '-', '', $oRowData[0][$nShippingSrlIdx] );
	}
	// 단일 주문 다품목이 여러행으로 구분된 상황 처리
	$aTmpShippingInvoiceInfo[$order_info->order_srl][] = $oRowData[0][$nShippingSrlIdx];
}

./svorder.admin.controller.php::procSvorderAdminRegisterShippingSerial()에서 아래의 코드를
$aShippingSrl = array();
$aCarrierId = array();
$aOrderSrl = array_unique($aOrderSrl);
foreach( $aOrderSrl as $nRowIdx => $nOrderSrl )
{
	$aTmpShippingInvoiceInfo[$nOrderSrl] = array_unique($aTmpShippingInvoiceInfo[$nOrderSrl]);
	$nIdx = 0;
	$sAllShippinInvoices = null;
	foreach( $aTmpShippingInvoiceInfo[$nOrderSrl] as $nShipSrlIdx => $sShipInvoiceSerial )
	{
		if( $nIdx > 0 )
			$sAllShippinInvoices .= ',';
		$sAllShippinInvoices .= $sShipInvoiceSerial;
		$nIdx++;
	}
	$aCarrierId[$nRowIdx] = $sCarrierIdx;
	$aShippingSrl[$nRowIdx] = $sAllShippinInvoices;
}

아래와 같이 변경
$aCarrierId = array();
if( $bCartLevelShippingSerialMode ) // 장바구니 품목별 운송장 번호 등록
{
	$aCartSrl = array_unique($aCartSrl);
	foreach( $aCartSrl as $nRowIdx => $nCartSrl )
		$aCarrierId[$nRowIdx] = $sCarrierIdx;

	Context::set( 'cart_srls', $aCartSrl );
}
else
{
	$aOrderSrl = array_unique($aOrderSrl);
	$aShippingSrl = array();
	foreach( $aOrderSrl as $nRowIdx => $nOrderSrl )
	{
		$aTmpShippingInvoiceInfo[$nOrderSrl] = array_unique($aTmpShippingInvoiceInfo[$nOrderSrl]);
		$nIdx = 0;
		$sAllShippinInvoices = null;
		foreach( $aTmpShippingInvoiceInfo[$nOrderSrl] as $nShipSrlIdx => $sShipInvoiceSerial )
		{
			if( $nIdx > 0 )
				$sAllShippinInvoices .= ',';
			$sAllShippinInvoices .= $sShipInvoiceSerial;
			$nIdx++;
		}
		$aCarrierId[$nRowIdx] = $sCarrierIdx;
		$aShippingSrl[$nRowIdx] = $sAllShippinInvoices;
	}
}

./svorder.admin.controller.php::procSvorderAdminUpdateDeliveryInfo()에서 아래의 코드를
$aOrderSrl = Context::get('order_srls');
$aExpressId = Context::get('express_id');
$aInvoiceNo = Context::get('invoice_no');
$nUpdatedItems = 0;
$sErrMsg = null;
foreach( $aOrderSrl as $nIdx => $nOrderSrl )
{
	$sExpressId = $aExpressId[$nIdx];
	$sInvoiceNo = $aInvoiceNo[$nIdx];
	$aInvoiceInfo = $this->parseInvoiceSerials( $sInvoiceNo );
	$oArgs->invoice_no = $aInvoiceInfo['default'];
	$oArgs->extra_invoice_no = $aInvoiceInfo['extra'];
	$oArgs->order_srl = $nOrderSrl;
	$oArgs->order_status = svorder::ORDER_STATE_ON_DELIVERY;//4; // 송장번호가 입력되면 배송중 상태로 변경
	$oArgs->express_id = $sExpressId;
	$oArgs->cs_memo = 'procSvorderAdminUpdateDeliveryInfo 일괄처리';
	if( !$oArgs->express_id || strlen( $oArgs->invoice_no )==0)
		continue;
	
	//$oSvorderController = &getController('svorder');
	//$output = $oSvorderController->updateOrderStatus( $order_srl, $args );
	$oUpdateRst = $this->updateSingleOrderStatus( $nOrderSrl, $oArgs );
	if( !$oUpdateRst->toBool() )
		$sErrMsg .= $oUpdateRst->getMessage().'<BR>'; //return $output;
	else
	{
		unset( $args );
		$nUpdatedItems++;
	}
}

아래와 같이 변경
$aOrderSrl = Context::get('order_srls');
$aCartSrl = Context::get('cart_srls');
$aExpressId = Context::get('express_id');
$aInvoiceNo = Context::get('invoice_no');
$nUpdatedItems = 0;
$sErrMsg = null;
if( !$aCartSrl ) // 주문별 운송장 번호 등록
{
	foreach( $aOrderSrl as $nIdx => $nOrderSrl )
	{
		$sExpressId = $aExpressId[$nIdx];
		$sInvoiceNo = $aInvoiceNo[$nIdx];
		$aInvoiceInfo = $this->parseInvoiceSerials( $sInvoiceNo );
		$oArgs->invoice_no = $aInvoiceInfo['default'];
		$oArgs->extra_invoice_no = $aInvoiceInfo['extra'];
		$oArgs->order_srl = $nOrderSrl;
		$oArgs->order_status = svorder::ORDER_STATE_ON_DELIVERY;//4; // 송장번호가 입력되면 배송중 상태로 변경
		$oArgs->express_id = $sExpressId;
		$oArgs->cs_memo = 'procSvorderAdminUpdateDeliveryInfo 일괄처리';
		if( !$oArgs->express_id || strlen( $oArgs->invoice_no )==0)
			continue;
		
		$oUpdateRst = $this->updateSingleOrderStatus( $nOrderSrl, $oArgs );
		if( !$oUpdateRst->toBool() )
			$sErrMsg .= $oUpdateRst->getMessage().'<BR>'; //return $output;
		else
		{
			unset( $args );
			$nUpdatedItems++;
		}
	}
}
else // 장바구니 품목별 운송장 번호 등록
{
	foreach( $aCartSrl as $nIdx => $nCartSrl )
	{
		$nOrderSrl = $aOrderSrl[$nIdx];
		$sExpressId = $aExpressId[$nIdx];
		$sInvoiceNo = $aInvoiceNo[$nIdx];
		$oArgs->order_srl = $nOrderSrl;
		$oArgs->cart_srl = $nCartSrl;
		$oArgs->order_status = svorder::ORDER_STATE_ON_DELIVERY;
		$oArgs->invoice_no = $sInvoiceNo;
		$oArgs->express_id = $sExpressId;
		$oArgs->cs_memo = 'procSvorderAdminUpdateDeliveryInfo 일괄처리';
		if( !$oArgs->express_id || strlen( $oArgs->invoice_no )==0)
			continue;
		$oUpdateRst = $this->updateSingleOrderStatus( $nOrderSrl, $oArgs );
		if( !$oUpdateRst->toBool() )
			$sErrMsg .= $oUpdateRst->getMessage().'<BR>';
		else
		{
			unset( $args );
			$nUpdatedItems++;
		}
	}
}

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
switch( $sTargetOrderStatus )
{
	case svorder::ORDER_STATE_ON_DEPOSIT:
	case svorder::ORDER_STATE_PAID:
	case svorder::ORDER_STATE_COMPLETED:
	case svorder::ORDER_STATE_RETURNED:
	case svorder::ORDER_STATE_PREPARE_DELIVERY:
	case svorder::ORDER_STATE_ON_DELIVERY:
		break;

아래와 같이 변경
switch( $sTargetOrderStatus )
{
	case svorder::ORDER_STATE_ON_DEPOSIT:
	case svorder::ORDER_STATE_PAID:
	case svorder::ORDER_STATE_COMPLETED:
	case svorder::ORDER_STATE_RETURNED:
	case svorder::ORDER_STATE_PREPARE_DELIVERY:
		break;
	case svorder::ORDER_STATE_ON_DELIVERY:
		if( $oTgtArgs->cart_srl ) // 장바구니 품목별 운송장 번호 등록
		{
			if( $oOrderInfo->item_list )
			{
				foreach( $oOrderInfo->item_list as $nIdx=>$oItem )
				{
					if( $oItem->cart_srl == $oTgtArgs->cart_srl )
					{
						if( strlen( $oItem->invoice_no ) )
							$bChangeOrderStatus = false;
						break;
					}
				}
			}
		}
		break;

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
elseif( $sTargetOrderStatus == 'memo_only' ) // 상태 변경없이 단순 메모
{
	$oTgtArgs->order_status = $oOrderInfo->order_status;
	$bChangeOrderStatus = true;
}
else
{
	$aOrderLabel = $oSvorderModel->getOrderStatusLabel();
	$sMsg = '주문번호 '.$nOrderSrl.' '.Context::getLang( $aOrderLabel[$oOrderInfo->order_status] ).
		' -> '.Context::getLang( $aOrderLabel[$oTgtArgs->order_status] ).' 이동 불가능';
	return new Object(-1, $sMsg);
}

아래와 같이 변경
elseif( $sTargetOrderStatus == 'memo_only' ) // 상태 변경없이 단순 메모
{
	$oTgtArgs->order_status = $oOrderInfo->order_status;
	$bChangeOrderStatus = true;
}

if( !$bChangeOrderStatus )
{
	$aOrderLabel = $oSvorderModel->getOrderStatusLabel();
	$sMsg = '주문번호 '.$nOrderSrl.' '.Context::getLang( $aOrderLabel[$oOrderInfo->order_status] ).
		' -> '.Context::getLang( $aOrderLabel[$oTgtArgs->order_status] ).' 이동 불가능';
	return new Object(-1, $sMsg);
}

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
// for order table 
$oOrderArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oOrderArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oOrderArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->invoice_no )
	$oOrderArgs->invoice_no = $oTgtArgs->invoice_no;
if( $oTgtArgs->extra_invoice_no )
	$oOrderArgs->extra_invoice_no = serialize( $oTgtArgs->extra_invoice_no );
$oOrderRst = executeQuery( 'svorder.updateOrderStatusByOrderSrl', $oOrderArgs );
if( !$oOrderRst->toBool() )
	return $oOrderRst;

$oCartArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oCartArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oCartArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->invoice_no )
	$oCartArgs->invoice_no = $oTgtArgs->invoice_no;
$oCartRst = executeQuery( 'svorder.updateCartOrderStatus', $oCartArgs );
if( !$oCartRst->toBool() )
	return $oCartRst;

아래와 같이 변경
// for order table 
$oOrderArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oOrderArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oOrderArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->order_status == svorder::ORDER_STATE_ON_DELIVERY && !$oTgtArgs->cart_srl )
{
	if( $oTgtArgs->invoice_no )
		$oOrderArgs->invoice_no = $oTgtArgs->invoice_no;
	if( $oTgtArgs->extra_invoice_no )
		$oOrderArgs->extra_invoice_no = serialize( $oTgtArgs->extra_invoice_no );
}
$oOrderRst = executeQuery( 'svorder.updateOrderStatusByOrderSrl', $oOrderArgs );
if( !$oOrderRst->toBool() )
	return $oOrderRst;

$oCartArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->cart_srl )
	$oCartArgs->cart_srl = $oTgtArgs->cart_srl;
if( $oTgtArgs->order_status )
	$oCartArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oCartArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->invoice_no )
	$oCartArgs->invoice_no = $oTgtArgs->invoice_no;
$oCartRst = executeQuery( 'svorder.updateCartOrderStatus', $oCartArgs );
if( !$oCartRst->toBool() )
	return $oCartRst;

./svorder.admin.controller.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_ON_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = 1; //'배송준비로 롤백';
	$aChangeableOrderStatus[svorder::ORDER_STATE_DELIVERED] = 1; //'배송완료';
}

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_ON_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = 1; //'배송준비로 롤백';
	$aChangeableOrderStatus[svorder::ORDER_STATE_ON_DELIVERY] = 1; // 동일 주문번호의 장바구니 품목별 운송장 번호 등록
	$aChangeableOrderStatus[svorder::ORDER_STATE_DELIVERED] = 1; //'배송완료';
}

6. 코드 패턴 개선
./svorder.admin.view.php::dispSvorderAdminRecoverTransaction()에서 아래의 코드를
$output = executeQueryArray( 'svorder.getOrderListByStatus', $args );
if( !$output->toBool() )
	return $output;

$order_list = $output->data;
if( !is_array( $order_list ) ) 
	$order_list = array();
		
Context::set('list', $order_list);

아래와 같이 변경
$oSvorderAdminModel = &getAdminModel('svorder');
$oOrderList = $oSvorderAdminModel->getOrderListByStatus( $args );
Context::set('list', $oOrderList->data);

7.
장바구니 픔묵별 운송장 번호 등록 시 관리자 화면의 정보 표시 UI 변경
./svorder.admin.model.php::getOrderListByStatus()에 아래의 코드 추가
if( strlen( $oRec->invoice_no ) == 0 ) // 장바구니별 운송장 정보 등록 상황 처리
{
	$oCartArgs->order_srl = (int)$oRec->order_srl;
	$oCartInfoRst = executeQueryArray('svorder.getCartItems', $oCartArgs);
	$oRec->invoice_no = $oCartInfoRst->data[0]->invoice_no;
}

./svorder.admin.model.php::getOrderListByStatus()에서 아래의 코드를
$sPrimaryExpressId = Context::get('primary_express_id');
$sPrimaryInvoiceNo = Context::get('primary_invoice_no');
if($sPrimaryExpressId || $sPrimaryInvoiceNo)
{
	// order info
	$oOrderArgs->order_srl = $nOrderSrl;
	$oOrderArgs->express_id = $sPrimaryExpressId;
	$oOrderArgs->invoice_no = $sPrimaryInvoiceNo;
	//$oOrderRst = executeQuery('svorder.updateOrderStatusSvorder', $oOrderArgs);
	$oOrderRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oOrderArgs);
	if(!$oOrderRst->toBool())
		return $oOrderRst;
}

$aCartSrl = Context::get('cart_srls');
$aExpressId = Context::get('express_id');
$aInvoiceNo = Context::get('invoice_no');
foreach($aCartSrl as $key=>$nCartSrl) // cart info
{
	$sExpressId = $aExpressId[$key];
	$sInvoiceNo = $aInvoiceNo[$key];
	$oCartArgs->cart_srl = $nCartSrl;
	$oCartArgs->express_id = $sExpressId;
	$oCartArgs->invoice_no = $sInvoiceNo;
	if(!$oCartArgs->express_id&&!$oCartArgs->invoice_no)
		continue;
	$oCartRst = executeQuery('svorder.updateCartOrderStatus', $oCartArgs);
	if(!$oCartRst->toBool())
		return $oCartRst;
}

아래와 같이 변경
$sPrimaryExpressId = Context::get('primary_express_id');
if( $sPrimaryExpressId ) // order delivery invoice number mode
{
	$sPrimaryInvoiceNo = Context::get('primary_invoice_no');
	if($sPrimaryExpressId || $sPrimaryInvoiceNo)
	{
		// order info
		$oOrderArgs->order_srl = $nOrderSrl;
		$oOrderArgs->express_id = $sPrimaryExpressId;
		$oOrderArgs->invoice_no = $sPrimaryInvoiceNo;
		$oOrderRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oOrderArgs);
		if(!$oOrderRst->toBool())
			return $oOrderRst;
	}
}
$aCartInvoiceNo = Context::get('cart_invoice_nos');
$aCartExpressId = Context::get('cart_express_id');
$aCartSrl = Context::get('cart_srls');
foreach($aCartSrl as $key=>$nCartSrl) // cart info
{
	$sExpressId = $aCartExpressId[$key];
	$sInvoiceNo = $aCartInvoiceNo[$key];
	$oCartArgs->order_srl = $nOrderSrl;
	$oCartArgs->cart_srl = $nCartSrl;
	$oCartArgs->express_id = $sExpressId;
	$oCartArgs->invoice_no = $sInvoiceNo;
	if(!$oCartArgs->express_id&&!$oCartArgs->invoice_no)
		continue;
	$oCartRst = executeQuery('svorder.updateCartOrderStatus', $oCartArgs);
	if(!$oCartRst->toBool())
		return $oCartRst;
}

./svorder.admin.view.php::dispSvorderAdminOrderDetail()에 아래의 코드 추가
$bCartInvoiceMode = true;
if( $oOrderInfo->invoice_no )
	$bCartInvoiceMode = false;
Context::set('cart_deliv_invoice_mode', $bCartInvoiceMode);

./tpl/orderdetail.html에 관련 코드 추가

./svorder.view.php::dispSvorderOrderDetail()에 아래의 코드 추가
$bCartInvoiceMode = true;
if( $oOrderInfo->invoice_no )
	$bCartInvoiceMode = false;
Context::set('cart_deliv_invoice_mode', $bCartInvoiceMode);

./skins/~/orderdetail.html에 관련 코드 추가
./m.skins/~/orderdetail.html에 관련 코드 추가

8.
운송장 갯수를 과대평가하는 코드 오류 수정
./svorder.model.php::getOrderInfo()에 아래의 코드 추가
if( !$oOrderInfo->invoice_no )
	$oOrderInfo->invoice_no = null;
if( !$oOrderInfo->extra_invoice_no )
	$oOrderInfo->extra_invoice_no = null;

9.
네이버페이 신규 주문 수집할 때 npay ProductOrderId를 개별 장바구니 품목에 입력하도록 변경
./schemas/svorder_cart.xml에 아래의 코드 추가
<column name="npay_product_order_id" type="number" size="11" index="idx_npay_product_order_id" />

./queries/insertCartItem.xml에 아래의 코드 추가
<column name="npay_product_order_id" var="npay_product_order_id" filter="number" />

./svorder.controller.php::insertCartItem()에 아래의 코드 추가
if( $val->ProductOrderID ) // npay product order info일 경우
	$cartitem_args->npay_product_order_id = $val->ProductOrderID;

./queries/getOrderItems.xml에 아래의 코드 추가
<column name="cart.npay_product_order_id" alias="npay_product_order_id" />

./queries/getNpayCartInfoByNpayProdOrderId.xml 추가

10.
모호한 코드 개선
./queries/getCartItems.xml을 getCartItemsAdmin.xml로 변경

./svorder.admin.model.php::getCartItem() 추가

./svorder.admin.model.php::getOrderListByStatus()에서 아래의 코드를
$oCartArgs->order_srl = (int)$oRec->order_srl;
$oCartInfoRst = executeQueryArray('svorder.getCartItemsAdmin', $oCartArgs);
$oRec->invoice_no = $oCartInfoRst->data[0]->invoice_no;

아래와 같이 변경
$oArgs->order_srl = (int)$oRec->order_srl;
$oCartInfoRst = $this->getCartItem($oArgs);
$oRec->invoice_no = $oCartInfoRst[0]->invoice_no;

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에서 아래의 코드를
$output = executeQuery('svorder.getCartItemsAdmin', $oCartArgs);

아래와 같이 변경
$aCartRst = $oSvorderAdminModel->getCartItem( $oCartArgs );

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()에서 아래의 코드를
$output = executeQuery('svorder.getCartItemsAdmin', $oCartArgs);

아래와 같이 변경
$aCartRst = $oSvorderAdminModel->getCartItem( $oCartArgs );

11.
비효율 코드 개선
./queries/getOrderItems.xml에서 아래의 코드 제거
<table name="member" alias="member" type="left join">
	<conditions>
		<condition operation="equal" column="member.member_srl" default="cart.member_srl" />
	</conditions>
</table>

./queries/getOrderItems.xml에서 아래의 코드 제거
<column name="member.member_srl" alias="member_srl" />
<column name="member.user_id" alias="user_id" />
<column name="member.nick_name" alias="nick_name" />
<column name="member.user_name" alias="user_name" />

./queries/getOrderItems.xml에서 아래의 코드 제거
<condition operation="equal" column="cart.member_srl" var="member_srl" />
<condition operation="more" column="cart.order_status" var="order_status" default="1" pipe="and" />
<group pipe="and">
	<condition operation="more" column="cart.purdate" var="startdate" pipe="and" />
	<condition operation="less" column="cart.purdate" var="enddate" pipe="and" />
</group>

12.
택배업체 리스트 최신화
./svorder.class.php에서 아래의 코드를
protected $delivery_companies = array(
	'00'=>'직배송', 
	'16'=>'경동택배',
	'18'=>'대신택배',
	'20'=>'대한통운',
	'22'=>'동부택배',
	'24'=>'로젠택배',
	'26'=>'우체국택배',
	'28'=>'이노지스택배',
	'30'=>'일양로지스택배',
	'32'=>'한덱스',
	'34'=>'한의사랑택배',
	'36'=>'한진택배',
	'38'=>'현대택배',
	'40'=>'호남택배',
	'42'=>'CJ GLS',
	'44'=>'CVSnet 편의점택배',
	'46'=>'DHL',
	'48'=>'EMS',
	'50'=>'FedEx',
	'52'=>'GTX',
	'54'=>'KG옐로우캡택배',
	'56'=>'TNT Express',
	'58'=>'UPS',
	'60'=>'KGB택배'
);

아래와 같이 변경
protected $delivery_companies = array(
	'00'=>'직배송',
	'01'=>'일반우편',
	'02'=>'우편등기',
	'03'=>'우체국택배',
	'04'=>'천일택배',
	'05'=>'합동택배',
	'06'=>'GSMNTON',
	'07'=>'WarpEx',
	'08'=>'WIZWA',
	'09'=>'ACI',
	'10'=>'EZUSA',
	'11'=>'범한판토스',
	'12'=>'롯데택배(국제택배)',
	'13'=>'성원글로벌',
	'14'=>'대운글로벌',
	'15'=>'i-parcel',
	'16'=>'건영택배',
	'17'=>'SLX택배',
	'18'=>'대신택배',
	'19'=>'경동택배',
	'20'=>'CJ대한통운',
	'21'=>'CJ대한통운(국제택배)',
	'22'=>'로젠택배',
	'23'=>'일양로지스',
	'24'=>'한의사랑택배',
	'25'=>'한진택배',
	'26'=>'현대택배',
	'27'=>'호남택배',
	'28'=>'편의점택배',
	'29'=>'DHL',
	'30'=>'DHL(독일)',
	'31'=>'EMS',
	'32'=>'FedEx',
	'33'=>'TNT Express',
	'34'=>'UPS',
	'35'=>'GSI익스프레스',
	'36'=>'세방택배',
	'37'=>'농협택배',
	'38'=>'CU편의점택배',
	'39'=>'AIRWAY익스프레스',
	'40'=>'홈픽택배',
	'41'=>'APEX',
	'42'=>'CwayExpress',
	'43'=>'용마로지스',
	'44'=>'EuroParcel',
	'45'=>'로젝스',
	'46'=>'GOS당일택배',
	'47'=>'GS Postbox퀵',
	'48'=>'ADC항운택배',
	'49'=>'동강물류',
	'50'=>'경인택배',
	'51'=>'한우리물류',
	'52'=>'LG전자물류',
	'53'=>'GSPostbox택배',
	'54'=>'한달음택배',
	'55'=>'하우저택배',
	'56'=>'퀵배송',
	'57'=>'USPS',
	'58'=>'KGB택배',
	'59'=>'기타 택배',
	'60'=>'KG옐로우캡택배'
);

./svorder.class.php에서 아래의 코드를
var $delivery_inquiry_urls = array(
	'16'=>'http://www.kdexp.com/sub4_1.asp?stype=1&p_item='
	,'18'=>'http://home.daesinlogistics.co.kr/daesin/jsp/d_freight_chase/d_general_process2.jsp?billno1='
	,'20'=>'https://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no='
	,'22'=>'http://www.dongbups.com/newHtml/delivery/dvsearch_View.jsp?item_no='
	,'24'=>'http://www.ilogen.com/iLOGEN.Web.New/TRACE/TraceView.aspx?gubun=slipno&slipno='
	,'26'=>'http://service.epost.go.kr/trace.RetrieveRegiPrclDeliv.postal?sid1='
	,'28'=>'http://www.innogis.net/trace02.asp?invoice='
	,'30'=>'http://www.ilyanglogis.com/functionality/tracking_result.asp?hawb_no='
	,'32'=>'http://btob.sedex.co.kr/work/app/tm/tmtr01/tmtr01_s4.jsp?IC_INV_NO='
	,'34'=>'http://www.hanips.com/html/sub03_03_1.html?logicnum='
	,'36'=>'http://www.hanjin.co.kr/Delivery_html/inquiry/result_waybill.jsp?wbl_num='
	,'38'=>'http://www.hlc.co.kr/personalService/tracking/06/tracking_goods_result.jsp?InvNo='
	,'40'=>'http://honam.enfrom.com/YYSearch/YYSearch.jsp?&Slip01='
	,'42'=>'http://nexs.cjgls.com/web/service02_01.jsp?slipno='
	,'44'=>'http://was.cvsnet.co.kr/_ver2/board/ctod_status.jsp?invoice_no='
	,'46'=>'http://www.dhl.co.kr/ko/express/tracking.shtml?pageToInclude=RESULTS&type=fasttrack&AWB='
	,'48'=>'http://service.epost.go.kr/trace.RetrieveEmsTrace.postal?ems_gubun=E&POST_CODE='
	,'50'=>'http://www.fedex.com/Tracking?ascend_header=1&clienttype=dotcomreg&cntry_code=kr&language=korean&tracknumbers='
	,'52'=>'http://www.gtx2010.co.kr/del_inquiry_result.html?s_gbn=1&awblno='
	,'54'=>'http://www.yellowcap.co.kr/custom/inquiry_result.asp?invoice_no='
	,'56'=>'http://www.tnt.com/webtracker/tracking.do?respCountry=kr&respLang=ko&searchType=CON&cons='
	,'58'=>'http://www.ups.com/WebTracking/track?loc=ko_KR&InquiryNumber1='
	,'60'=>'http://www.kgbls.co.kr/sub5/trace.asp?f_slipno='
);

아래와 같이 변경
var $delivery_inquiry_urls = array(
	'20'=>'https://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no='
	/*'16'=>'http://www.kdexp.com/sub4_1.asp?stype=1&p_item='
	,'18'=>'http://home.daesinlogistics.co.kr/daesin/jsp/d_freight_chase/d_general_process2.jsp?billno1='
	,'22'=>'http://www.dongbups.com/newHtml/delivery/dvsearch_View.jsp?item_no='
	,'24'=>'http://www.ilogen.com/iLOGEN.Web.New/TRACE/TraceView.aspx?gubun=slipno&slipno='
	,'26'=>'http://service.epost.go.kr/trace.RetrieveRegiPrclDeliv.postal?sid1='
	,'28'=>'http://www.innogis.net/trace02.asp?invoice='
	,'30'=>'http://www.ilyanglogis.com/functionality/tracking_result.asp?hawb_no='
	,'32'=>'http://btob.sedex.co.kr/work/app/tm/tmtr01/tmtr01_s4.jsp?IC_INV_NO='
	,'34'=>'http://www.hanips.com/html/sub03_03_1.html?logicnum='
	,'36'=>'http://www.hanjin.co.kr/Delivery_html/inquiry/result_waybill.jsp?wbl_num='
	,'38'=>'http://www.hlc.co.kr/personalService/tracking/06/tracking_goods_result.jsp?InvNo='
	,'40'=>'http://honam.enfrom.com/YYSearch/YYSearch.jsp?&Slip01='
	,'42'=>'http://nexs.cjgls.com/web/service02_01.jsp?slipno='
	,'44'=>'http://was.cvsnet.co.kr/_ver2/board/ctod_status.jsp?invoice_no='
	,'46'=>'http://www.dhl.co.kr/ko/express/tracking.shtml?pageToInclude=RESULTS&type=fasttrack&AWB='
	,'48'=>'http://service.epost.go.kr/trace.RetrieveEmsTrace.postal?ems_gubun=E&POST_CODE='
	,'50'=>'http://www.fedex.com/Tracking?ascend_header=1&clienttype=dotcomreg&cntry_code=kr&language=korean&tracknumbers='
	,'52'=>'http://www.gtx2010.co.kr/del_inquiry_result.html?s_gbn=1&awblno='
	,'54'=>'http://www.yellowcap.co.kr/custom/inquiry_result.asp?invoice_no='
	,'56'=>'http://www.tnt.com/webtracker/tracking.do?respCountry=kr&respLang=ko&searchType=CON&cons='
	,'58'=>'http://www.ups.com/WebTracking/track?loc=ko_KR&InquiryNumber1='
	,'60'=>'http://www.kgbls.co.kr/sub5/trace.asp?f_slipno='*/
);

13.
npay 주문은 관리자 화면에서 주문단위 송장 입력 금지시킴
./tpl/ordermanagement.html에서 아래의 코드를
<select name="express_id[]" style="width:156px; display:block; margin-bottom:4px;">
	<option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$key == $order->express_id || (!$order->express_id && $key == $config->default_delivery_company)">{$val}</option>
</select>
<input type="text" name="invoice_no[]" style="width:140px;" value="{$order->merged_invoice_no}" placeholder="{$lang->input_invoice_no}" />

아래와 같이 변경
<block cond="$order->order_referral==svorder::ORDER_REFERRAL_LOCALHOST">
	<select name="express_id[]" style="width:156px; display:block; margin-bottom:4px;">
		<option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$key == $order->express_id || (!$order->express_id && $key == $config->default_delivery_company)">{$val}</option>
	</select>
	<input type="text" name="invoice_no[]" style="width:140px;" value="{$order->merged_invoice_no}" placeholder="{$lang->input_invoice_no}" />
</block>

v 2.1.11
6th, Jan 2020
1. 총 누적 지표 표시 기능 추가
./svorder.admin.model.php::getGrossSalesInfo() 추가
./queries/getGrossSalesInfo.xml 추가
./queries/getTodaySalesInfo.xml 추가

v 2.2.0
20th, Dec 2019
1. 
운송장 번호 등록 메소드 일원화하고 npay 운송장 등록 기능 추가
./svorder.admin.controller.php::procSvorderAdminUpdateOrderDetail()에서 아래의 코드 제거
$sPrimaryExpressId = Context::get('primary_express_id');
if( $sPrimaryExpressId ) // order delivery invoice number mode
{
	$sPrimaryInvoiceNo = Context::get('primary_invoice_no');
	if($sPrimaryExpressId || $sPrimaryInvoiceNo)
	{
		$oOrderArgs->order_srl = $nOrderSrl;
		$oOrderArgs->express_id = $sPrimaryExpressId;
		$oOrderArgs->invoice_no = $sPrimaryInvoiceNo;
		$oOrderRst = executeQuery('svorder.updateOrderStatusByOrderSrl', $oOrderArgs);
		if(!$oOrderRst->toBool())
			return $oOrderRst;
	}
}

./svorder.admin.controller.php::_registerShippingInvoice() 추가
./svorder.admin.controller.php::_insertCsLog() 추가

./queries/updateCartShippingInvoice.xml 추가

./queries/updateCartOrderStatus.xml 에서 아래의 코드 제거
<column name="express_id" var="express_id" />
<column name="invoice_no" var="invoice_no" />

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
$oCsArgs->order_srl = $nOrderSrl;
$oLoggedInfo = Context::get('logged_info');
if( $oLoggedInfo )
	$oCsArgs->admin_member_srl = $oLoggedInfo->member_srl;
else
	$oCsArgs->admin_member_srl = 0;

$oCsArgs->buyer_member_srl = $oOrderInfo->member_srl;
$oCsArgs->order_status_source = $oOrderInfo->order_status;
$oCsArgs->order_status_dest = $oTgtArgs->order_status;
$oCsArgs->memo = $oTgtArgs->cs_memo;
$oRst = executeQuery('svorder.insertOrderCsLog', $oCsArgs);
if(!$oRst->toBool())
	return $oRst;

아래와 같이 변경
$oCsLogRst = $this->_insertCsLog($nOrderSrl, $oOrderInfo->member_srl, $oOrderInfo->order_status, $oTgtArgs->order_status, $oTgtArgs->cs_memo);
if(!$oCsLogRst->toBool())
	return $oCsLogRst;

./svorder.admin.model.php::getChangeableOrderStatusByStatus()에서 아래의 코드를
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_PREPARE_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PAID] = 1; // 입금완료로 롤백
	$aChangeableOrderStatus[svorder::ORDER_STATE_ON_DELIVERY] = 1; // 배송중
}

아래와 같이 변경
elseif( $oOrderInfo->order_status == svorder::ORDER_STATE_PREPARE_DELIVERY )
{
	$aChangeableOrderStatus[svorder::ORDER_STATE_PAID] = 1; // 입금완료로 롤백
	$aChangeableOrderStatus[svorder::ORDER_STATE_ON_DELIVERY] = 1; // 배송중
	if( $oOrderInfo->order_referral == svorder::ORDER_REFERRAL_NPAY )
		$aChangeableOrderStatus[svorder::ORDER_STATE_CANCELLED] = 1; // npay는 배송준비중 상태에서도 결제취소 가능
}

./svorder.admin.controller.php::updateSingleOrderStatus()에서 아래의 코드를
// for order table 
$oOrderArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oOrderArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oOrderArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->order_status == svorder::ORDER_STATE_ON_DELIVERY && !$oTgtArgs->cart_srl )
{
	if( $oTgtArgs->invoice_no )
		$oOrderArgs->invoice_no = $oTgtArgs->invoice_no;
	if( $oTgtArgs->extra_invoice_no )
		$oOrderArgs->extra_invoice_no = serialize( $oTgtArgs->extra_invoice_no );
}
$oOrderRst = executeQuery( 'svorder.updateOrderStatusByOrderSrl', $oOrderArgs );
if( !$oOrderRst->toBool() )
	return $oOrderRst;

// for cart table
$oCartArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status == svorder::ORDER_STATE_ON_DELIVERY && $oTgtArgs->cart_srl )
	$oCartArgs->cart_srl = $oTgtArgs->cart_srl;
if( $oTgtArgs->order_status )
	$oCartArgs->order_status = $oTgtArgs->order_status;
if( $oTgtArgs->express_id )
	$oCartArgs->express_id = $oTgtArgs->express_id;
if( $oTgtArgs->invoice_no )
	$oCartArgs->invoice_no = $oTgtArgs->invoice_no;
$oCartRst = executeQuery( 'svorder.updateCartOrderStatus', $oCartArgs );
if( !$oCartRst->toBool() )
	return $oCartRst;

아래와 같이 변경
// for order table 
$oOrderArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oOrderArgs->order_status = $oTgtArgs->order_status;
$oOrderRst = executeQuery( 'svorder.updateOrderStatusByOrderSrl', $oOrderArgs );
if( !$oOrderRst->toBool() )
	return $oOrderRst;

// for cart table
$oCartArgs->order_srl = $nOrderSrl;
if( $oTgtArgs->order_status )
	$oCartArgs->order_status = $oTgtArgs->order_status;
$oCartRst = executeQuery( 'svorder.updateCartOrderStatus', $oCartArgs );
if( !$oCartRst->toBool() )
	return $oCartRst;

./queries/updateOrderStatusByOrderSrl.xml에서 아래의 코드 제거
<column name="express_id" var="express_id" />
<column name="invoice_no" var="invoice_no" />
<column name="extra_invoice_no" var="extra_invoice_no" />

2.
비효율 코드 수정
./queries/getCartItems.xml 추가
./queries/getOrderItems.xml 제거

./svorder.model.php::getOrderInfo()에서 아래의 코드를
$args->order_srl = $nOrderSrl;
$output = executeQuery('svorder.getOrderInfo', $args);
$oOrderInfo = $output->data;

if( $oOrderInfo->order_referral == svorder::ORDER_REFERRAL_NPAY )
{
	$oSvorderAdminModel = &getAdminModel('svorder');
	$oNpayInfoRst = $oSvorderAdminModel->getNpayOrderInfo($oOrderInfo->order_srl);
	$oOrderInfo->ext_pg_order_id = $oNpayInfoRst->npay_order_id;
}

if( $oOrderInfo->reserves_consume_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLogByReservesSrl( $oOrderInfo->reserves_consume_srl  );
	if( $output->get('mode') == '-' )
		$oOrderInfo->consumed_reserves_amount = $output->get('amount');
}
if( $oOrderInfo->reserves_receive_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLogByReservesSrl( $oOrderInfo->reserves_receive_srl  );
	if( $output->get('mode') == '+' )
		$oOrderInfo->received_reserves_amount = $output->get('amount');
}

$oCheckoutPromotionInfo = unserialize( $oOrderInfo->checkout_promotion_info );
$nCheckoutPromoIdx = 0;
foreach( $oCheckoutPromotionInfo->promotion as $ccpromokey => $ccpromoval )
{
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->coupon_srl = $ccpromoval->coupon_srl;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->title = $ccpromoval->title;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx++]->total_disc_amnt = $ccpromoval->total_disc_amnt;
}
$oOrderInfo->checkout_promotion_info = $aCheckoutPromotionInfo;

// ordered items
$args->order_srl = $nOrderSrl;
$output = executeQueryArray( 'svorder.getCartItems', $args );
$aCartItemList = $output->data;
$this->_constructItemInfoByOrder( $aCartItemList);

$oOrderInfo->item_list = $aCartItemList;

// 결제 할인 적용되면, 상품별 할인은 표시하지 않음
foreach( $oOrderInfo->item_list as $key=>$val)
{
	if( $oOrderInfo->checkout_promotion_info )
	{
		if( $val->discount_info[0]->type != 'giveaway' && $val->discount_info[0]->type != 'item_policy')
		{
			$val->discount_amount = 0;
			$val->discount_info = '';
			$val->discounted_price = $val->price;
		}
	}
}
$oAddrInfo = $this->_getAddrInfo($oOrderInfo->addr_srl);
$oOrderInfo->recipient_address = $oAddrInfo->aAddrInfo;
$oOrderInfo->recipient_postcode = $oAddrInfo->postcode;
$oOrderInfo->extra_vars = $this->getExtraVars($oOrderInfo->module_srl, $nOrderSrl);
$oOrderInfo->deduction_info = unserialize( $oOrderInfo->deduction_info );
$oOrderInfo->extra_invoice_no = unserialize( $oOrderInfo->extra_invoice_no );
if( !$oOrderInfo->invoice_no )
	$oOrderInfo->invoice_no = null;
if( !$oOrderInfo->extra_invoice_no )
	$oOrderInfo->extra_invoice_no = null;
if( $oOrderInfo->invoice_no )
{
	$oOrderInfo->carrier_title = $this->delivery_companies[$oOrderInfo->express_id];
	$oOrderInfo->invoice_count = count( $oOrderInfo->invoice_no ) + count( $oOrderInfo->extra_invoice_no );
}
return $oOrderInfo;

아래와 같이 변경
$args->order_srl = $nOrderSrl;
$output = executeQuery('svorder.getOrderInfo', $args);
$oOrderInfo = $output->data;
if( $oOrderInfo->order_referral == svorder::ORDER_REFERRAL_NPAY )
{
	$oSvorderAdminModel = &getAdminModel('svorder');
	$oNpayInfoRst = $oSvorderAdminModel->getNpayOrderInfo($oOrderInfo->order_srl);
	$oOrderInfo->ext_pg_order_id = $oNpayInfoRst->npay_order_id;
}

if( $oOrderInfo->reserves_consume_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLogByReservesSrl( $oOrderInfo->reserves_consume_srl  );
	if( $output->get('mode') == '-' )
		$oOrderInfo->consumed_reserves_amount = $output->get('amount');
}
if( $oOrderInfo->reserves_receive_srl )
{
	$oSvpromotionModel = &getModel('svpromotion');
	$output = $oSvpromotionModel->getReservesLogByReservesSrl( $oOrderInfo->reserves_receive_srl  );
	if( $output->get('mode') == '+' )
		$oOrderInfo->received_reserves_amount = $output->get('amount');
}

$oAddrInfo = $this->_getAddrInfo($oOrderInfo->addr_srl);
$oOrderInfo->recipient_address = $oAddrInfo->aAddrInfo;
$oOrderInfo->recipient_postcode = $oAddrInfo->postcode;

$oCheckoutPromotionInfo = unserialize( $oOrderInfo->checkout_promotion_info );
$nCheckoutPromoIdx = 0;
foreach( $oCheckoutPromotionInfo->promotion as $ccpromokey => $ccpromoval )
{
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->coupon_srl = $ccpromoval->coupon_srl;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->title = $ccpromoval->title;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx++]->total_disc_amnt = $ccpromoval->total_disc_amnt;
}
$oOrderInfo->checkout_promotion_info = $aCheckoutPromotionInfo;

// ordered items
$args->order_srl = $nOrderSrl;
$output = executeQueryArray( 'svorder.getCartItems', $args );
$aCartItems = $output->data;

$oSvitemModel = &getModel('svitem');
// 결제 할인 적용되면, 상품별 할인은 표시하지 않음
foreach( $aCartItems as $nCartIdx => $oCartItem )
{
	if( $oOrderInfo->checkout_promotion_info )
	{
		if( $oCartItem->discount_info[0]->type != 'giveaway' && 
			$oCartItem->discount_info[0]->type != 'item_policy' )
		{
			$oCartItem->discount_amount = 0;
			$oCartItem->discount_info = ''; // 결제 할인 적용되면, 상품별 할인은 표시하지 않음
			$oCartItem->discounted_price = $oCartItem->price;
		}
	}
	$aBundlingInfo = Array();
	$oItem = $oCartItem;
	$oBundlingInfo = unserialize( $oItem->bundling_order_info );
	$nBundlingIdx = 0;
	foreach( $oBundlingInfo as $key2 => $val2 )
	{
		$oItemInfo = $oSvitemModel->getItemInfoByItemSrl( $val2->bundle_item_srl );
		$aBundlingInfo[$nBundlingIdx]->bundling_item_name = $oItemInfo->item_name;
		$aBundlingInfo[$nBundlingIdx++]->bundle_quantity = $val2->bundle_quantity;
	}
	$oItem->bundling_infos = $aBundlingInfo;
	
	$aDiscountInfo = Array();
	$oDiscountInfo = unserialize( $oItem->discount_info );
	$nPromotionIdx = 0;
	foreach( $oDiscountInfo->promotion as $key2 => $val2 )
	{
		$aDiscountInfo[$nPromotionIdx]->type = $val2->type; 
		$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
		$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->unit_disc_amnt;
	}
	$oConditionalDiscountInfo = unserialize( $oItem->conditional_promotion );
	foreach( $oConditionalDiscountInfo->promotion as $key2 => $val2 )
	{
		$aDiscountInfo[$nPromotionIdx]->type = $val2->type;
		$aDiscountInfo[$nPromotionIdx]->title = $val2->title;
		$aDiscountInfo[$nPromotionIdx++]->unit_disc_amnt = $val2->resultant_disc_amnt;
	}
	$oItem->discount_info = $aDiscountInfo;
	$aCartItems[$nCartIdx] = $oItem;
}
$oOrderInfo->item_list = $aCartItems;
$oOrderInfo->extra_vars = $this->getExtraVars($oOrderInfo->module_srl, $nOrderSrl);
$oOrderInfo->deduction_info = unserialize( $oOrderInfo->deduction_info );
$oOrderInfo->extra_invoice_no = unserialize( $oOrderInfo->extra_invoice_no );
if( !$oOrderInfo->invoice_no )
	$oOrderInfo->invoice_no = null;
if( !$oOrderInfo->extra_invoice_no )
	$oOrderInfo->extra_invoice_no = null;
if( $oOrderInfo->invoice_no )
{
	$oOrderInfo->carrier_title = $this->delivery_companies[$oOrderInfo->express_id];
	$oOrderInfo->invoice_count = count( $oOrderInfo->invoice_no ) + count( $oOrderInfo->extra_invoice_no );
}
return $oOrderInfo;


./svorder.model.php::getOrderInfoForPayment()에서 아래의 코드를
$args->order_srl = $order_srl;
$output = executeQuery('svorder.getOrderInfo', $args);
$order_info = $output->data;

$oAddrInfo = $this->_getAddrInfo($order_info->addr_srl);
$order_info->recipient_address = $oAddrInfo->aAddrInfo;
$order_info->recipient_postcode = $oAddrInfo->postcode;

$oCheckoutPromotionInfo = unserialize( $order_info->checkout_promotion_info );
$nCheckoutPromoIdx = 0;
foreach( $oCheckoutPromotionInfo->promotion as $ccpromokey => $ccpromoval )
{
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->coupon_srl = $ccpromoval->coupon_srl;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx]->title = $ccpromoval->title;
	$aCheckoutPromotionInfo[$nCheckoutPromoIdx++]->total_disc_amnt = $ccpromoval->total_disc_amnt;
}
$order_info->checkout_promotion_info = $aCheckoutPromotionInfo;

// ordered items
$args->order_srl = $order_srl;
$output = executeQueryArray( 'svorder.getOrderItemsForPg', $args );
$item_list = $output->data;
$this->_constructItemInfoByOrder( $item_list);
$order_info->item_list = $item_list;
return $order_info;

아래와 같이 변경
return $this->getOrderInfo($nOrderSrl);

./svorder.model.php::_constructItemInfoByOrder() 제거
./queries/getOrderItems.xml 제거
./queries/getOrderItemsForPg.xml 제거
./queries/getCartItemsAdmin.xml 제거
./queries/getOrderedItemsByOrderSrl.xml 제거

./queries/getCartItems.xml 추가

./svorder.admin.model.php::getCartItem()을 getCartItemByCartSrl()로 변경

./svorder.admin.model.php::getOrderListByStatus()애서 아래의 코드를
$oCartInfoRst = $this->getCartItem($oArgs);

아래와 같이 변경
$oCartInfoRst = $this->getCartItemByCartSrl($oArgs);

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrderAll()애서 아래의 코드를
$aCartRst = $oSvorderAdminModel->getCartItem( $oCartArgs );

아래와 같이 변경
$aCartRst = $oSvorderAdminModel->getCartItemByCartSrl( $oCartArgs );

./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()애서 아래의 코드를
$aCartRst = $oSvorderAdminModel->getCartItem( $oCartArgs );

아래와 같이 변경
$aCartRst = $oSvorderAdminModel->getCartItemByCartSrl( $oCartArgs );

./queries/getOrderCartByOrderSrl.xml 제거

./svorder.model.php::getOrderedList()애서 아래의 코드를
$oCartRst = executeQueryArray('svorder.getOrderCartByOrderSrl', $oCartArgs);

아래와 같이 변경
$oCartRst = executeQueryArray('svorder.getCartItems', $oCartArgs);

./queries/getOrderItemsByStatus.xml을 getCartItemsByOrderStatus 변경

./svorder.admin.controller.php::procSvorderAdminOrderExcelDownload()애서 아래의 코드를
$output = executeQueryArray('svorder.getOrderItemsByStatus', $args);

아래와 같이 변경
$output = executeQueryArray('svorder.getCartItemsByOrderStatus', $args);

3.
하나의 결제에서 품목별 부분 취소 기능 추가
./svorder.admin.controller.php::procSvorderAdminCancelRequestByCartItem() 추가

./svorder.controller.php::reevaluateOrder() 추가

./svorder.controller.php::updateCartItemStatus() 추가

./schemas/updateOrder.xml 추가

./svorder.model.php::confirmOffer()에 replace mode 추가

./tpl/orderdeatail.html에서 아래의 코드를
<tr>
	<th>{$lang->cart_number}</th>
	<th>{$lang->product}</th>
	<th>{$lang->product_name}</th>
	<th>{$lang->quantity}</th>
	<th>{$lang->price}</th>
	<th>{$lang->discount}</th>
	<th>{$lang->order_amount}</th>
	<th>{$lang->delivery_memo}</th>
	<th cond="$cart_deliv_invoice_mode">{$lang->invoice_no}</th>
</tr>

아래와 같이 변경
<tr>
	<th>{$lang->cart_number}</th>
	<th>{$lang->order_status}</th>
	<th>{$lang->product}</th>
	<th>{$lang->product_name}</th>
	<th>{$lang->quantity}</th>
	<th>{$lang->price}</th>
	<th>{$lang->discount}</th>
	<th>{$lang->order_amount}</th>
	<th>{$lang->delivery_memo}</th>
	<th cond="$cart_deliv_invoice_mode">{$lang->invoice_no}</th>
</tr>

./tpl/orderdeatail.html에서 아래의 코드를
<tr loop="$order_info->item_list=>$no,$item">
<!-- Google Analytics Code Begin (3/4/2016 9:48 AM) singleview.co.kr -->
<script>
gatkMypage.queueItemInfo( '{$item->item_srl}', '{$item->item_name}', '', '', '{$item->option_title}', '{$item->price+$item->option_price}', '{$item->quantity}', '' );
</script>
<!-- Google Analytics Code End (3/4/2016 9:48 AM) singleview.co.kr -->
	<td><input type="hidden" name="cart_srls[]" value="{$item->cart_srl}" />{$item->cart_srl}</td>
	<td>{$order_status[$item->order_status]}</td>
	<td><a href="{getUrl('','module',$module,'act','dispSvitemAdminUpdateItem','module_srl',$item->module_srl,'item_srl',$item->item_srl)}"><img src="{svitemView::_dispThumbnailUrl($item->thumb_file_srl,40)}" /></a></td>
	<td>
		<div>{$item->item_name}</div>
		<div cond="$item->option_srl">{$item->option_title} ({$item->printPrice($item->option_price)})</div>
	</td>
	<td>{$item->quantity}</td>
	<td>{number_format($item->price)}</td>
	<td>{number_format($item->discount_amount)}<br />
	<block loop="$item->discount_info=>$promotionkey,$promotionval">
	{$promotionval->title}<BR>
	</block>
	</td>
	<td>{number_format($item->discounted_price)}</td>
	<td>{$item->delivery_memo}</td>
	<td cond="$cart_deliv_invoice_mode">
		<select name="cart_express_id[]">
		<option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$key == $item->express_id || (!$item->express_id && $key == $config->default_delivery_company)">{$val}</option>
		</select>
		<BR>
		<input type="text" name="cart_invoice_nos[]" value="{$item->invoice_no}" />
		<BR>
		<a cond="$item->order_status == svorder::ORDER_STATE_ON_DELIVERY" href="{$delivery_inquiry_urls[$item->express_id]}{$item->invoice_no}" class="kso_btn" target="_blank"><span>배송추적</span></a>
		<input type="button" value="부분취소" data-order-srl="{$item->order_srl}" data-cart-srl="{$item->cart_srl}" class="cancel_partially"/>
	</td>
</tr>

아래와 같이 변경
<tr loop="$order_info->item_list=>$no,$item">
<!-- Google Analytics Code Begin (3/4/2016 9:48 AM) singleview.co.kr -->
<script>
gatkMypage.queueItemInfo( '{$item->item_srl}', '{$item->item_name}', '', '', '{$item->option_title}', '{$item->price+$item->option_price}', '{$item->quantity}', '' );
</script>
<!-- Google Analytics Code End (3/4/2016 9:48 AM) singleview.co.kr -->
	<td><input type="hidden" name="cart_srls[]" value="{$item->cart_srl}" />{$item->cart_srl}</td>
	<td>{$order_status[$item->order_status]}</td>
	<td><a href="{getUrl('','module',$module,'act','dispSvitemAdminUpdateItem','module_srl',$item->module_srl,'item_srl',$item->item_srl)}"><img src="{svitemView::_dispThumbnailUrl($item->thumb_file_srl,40)}" /></a></td>
	<td>
		<div>{$item->item_name}</div>
		<div cond="$item->option_srl">{$item->option_title} ({$item->printPrice($item->option_price)})</div>
	</td>
	<td><strike cond="$item->order_status == svorder::ORDER_STATE_CANCELLED">{$item->quantity}</strike></td>
	<td><strike cond="$item->order_status == svorder::ORDER_STATE_CANCELLED">{number_format($item->price)}</strike></td>
	<td><strike cond="$item->order_status == svorder::ORDER_STATE_CANCELLED">{number_format($item->discount_amount)}<br />
	<block loop="$item->discount_info=>$promotionkey,$promotionval">
	{$promotionval->title}<BR>
	</block></strike>
	</td>
	<td><strike cond="$item->order_status == svorder::ORDER_STATE_CANCELLED">{number_format($item->discounted_price)}</strike></td>
	<td>{$item->delivery_memo}</td>
	<td cond="$cart_deliv_invoice_mode">
		<select name="cart_express_id[]">
		<option loop="$delivery_companies=>$key,$val" value="{$key}" selected="selected"|cond="$key == $item->express_id || (!$item->express_id && $key == $config->default_delivery_company)">{$val}</option>
		</select>
		<BR>
		<input type="text" name="cart_invoice_nos[]" value="{$item->invoice_no}" />
		<BR>
		<a cond="$item->order_status == svorder::ORDER_STATE_ON_DELIVERY" href="{$delivery_inquiry_urls[$item->express_id]}{$item->invoice_no}" class="kso_btn" target="_blank"><span>배송추적</span></a>
		<input type="button" value="부분취소" data-order-srl="{$item->order_srl}" data-cart-srl="{$item->cart_srl}" class="cancel_partially"/>
	</td>
</tr>

4. svpromotion v0.4.32에 대응
./svorder.controller.php::completePgProcess()에서 아래의 코드를
$oSvPromotionController->activateReservesLog( $oOrder->reserves_consume_srl );

아래와 같이 변경
$oSvPromotionController->toggleReservesLog( $oOrder->reserves_consume_srl, 'active' );

v 3.0.0
15th, Jan 2020
1. ./svorder.order.php 추가하고 주문 객체 class wrapping
2. ./ext_class/npya/npay_order.class.php 추가하고 주문 객체 class wrapping

v 3.0.1
6th, Feb 2020
1. npay 주문 연동 시 입금완료부터 수집하는 모드와 발송 처리된 주문부터 수집하는 모드로 구분함; 엔페이주문 API로 운송장 대량 할당이 불안정할 경우에 대비함
./svorder.admin.controller.php::procSvorderAdminNpayApiConfig()에서 아래의 코드를
$aParams = array( 'npay_api_use', 'npay_api_accesslicense_release', 'npay_api_secretkey_release', 'npay_api_accesslicense_debug', 'npay_api_secretkey_debug', 'npay_shop_id', 'npay_shop_debug_mode', 'npay_connected_svitem_mid', 'npay_connected_svorder_mid' );

아래와 같이 변경
$aParams = array( 'npay_api_use', 'npay_api_accesslicense_release', 'npay_api_secretkey_release', 'npay_shop_order_collect_from', 'npay_api_accesslicense_debug', 'npay_api_secretkey_debug', 'npay_shop_id', 'npay_shop_debug_mode', 'npay_connected_svitem_mid', 'npay_connected_svorder_mid' );

./tpl/config_npay_api.html에 아래의 코드 추가
<div class="x_control-group">
	<label class="x_control-label" for="npay_shop_order_collect_from">{$lang->npay_shop_order_collect_from}</label>
	<div class="x_controls">
		<input type="radio" name="npay_shop_order_collect_from" id="npay_shop_order_collect_from" value="payed" checked="checked"|cond="$config->npay_shop_order_collect_from == '' || $config->npay_shop_order_collect_from == 'payed'" /> {$lang->npay_shop_collect_from_payed}
		<input type="radio" name="npay_shop_order_collect_from" id="npay_shop_order_collect_from" value="dispatched" checked="checked"|cond="$config->npay_shop_order_collect_from == 'dispatched'" /> {$lang->npay_shop_collect_from_dispatched}
		<a href="#npay_shop_order_collect_from_help" class="x_icon-question-sign" data-toggle>{$lang->help}</a>
		<p id="npay_shop_order_collect_from_help" class="x_help-block" hidden>{$lang->about_npay_shop_order_collect_from}</p>
	</div>
</div>

./ext_class/npay/npay_order.class.php::commmit()에서 아래의 코드를
switch( $this->_g_aNpayOrderStatus[$this->_g_oOrderHeader->LastChangedStatus] )
{
	case svorder::ORDER_STATE_ON_DEPOSIT: // 입금 대기 신규 주문은 무시
		break;
	default: // 신규 PAYED 주문만 수집하는 것이 아니고 오래된 PURCHASE_DECIDED 등도 수집될 수 있음
		$oProcRst = $this->_insertNpayOrder();
		break;
}

아래와 같이 변경
$aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true;
if( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'payed' )
	; // do nothing
elseif( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'dispatched' )
{
	$aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true;
	$aIgnoreStatus[svorder::ORDER_STATE_PAID] = true;
	$aIgnoreStatus[svorder::ORDER_STATE_DELIVERY_DELAYED] = true;
	$aIgnoreStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = true;
}
if( is_null( $aIgnoreStatus[$sCurOrderStatus] ) )
	$oProcRst = $this->_insertNpayOrder();

./ext_class/npay/response_body/GetProductOrderInfoList.php에 아래의 코드 추가
$xmlDelivery = $oProductOrder->getElementsByTagName('Delivery')->item(0);
if( count( $xmlDelivery ) > 0 )
{
	foreach ($xmlDelivery->childNodes as $oNode)
	{
		$aNodeName = explode( ':', $oNode->nodeName );
		if( $aNodeName[1] == 'DeliveryCompany' )
		{
			$nExpressId = array_search($oNode->nodeValue, $this->_g_aDeliveryCompanyCodeNpay);
			if(!$nExpressId)
				$oNode->nodeValue = '100'; // refer to the svorder.class.php::delivery_companies
			else
				$oNode->nodeValue = $nExpressId;
		}
	}
}

./ext_class/npay/npay_order.class.php::_setSingleChangedProdcutOrder()에 아래의 코드 추가
if( $oSingleChangedProductOrder->oProductOrderDetail->Delivery )
{
	$oTmpInfo->DeliveryCompany = $oSingleChangedProductOrder->oProductOrderDetail->Delivery->DeliveryCompany;
	$oTmpInfo->DeliveryMethod = $oSingleChangedProductOrder->oProductOrderDetail->Delivery->DeliveryMethod;
	$oTmpInfo->DeliveryStatus = $oSingleChangedProductOrder->oProductOrderDetail->Delivery->DeliveryStatus;
	$oTmpInfo->SendDate = $oSingleChangedProductOrder->oProductOrderDetail->Delivery->SendDate;
	$oTmpInfo->TrackingNumber = $oSingleChangedProductOrder->oProductOrderDetail->Delivery->TrackingNumber;
}

./ext_class/npay/npay_order.class.php::_decideSingleChangedProdOrderMode()에서 아래의 코드를
if( $nRecCnt == 0 )
	$sMode = 'add';
elseif( $nRecCnt > 0 )
{
	$oFirstRec = array_values($oRst->data)[0];
	$oRst->add( 'nSvOrderSrl', $oFirstRec->order_srl );
	if( $oParam->sLastChangedDate && $oParam->sLastChangedStatus ) 
	{
		// Order level proc mode 판단에서는 검사하지 않음
		foreach( $oRst->data as $nIdx => $oRec )
		{
			if( $oRec->npay_last_changed_date == $oParam->sLastChangedDate &&
				$oRec->npay_order_status == $this->_g_aNpayOrderStatus[$oParam->sLastChangedStatus] )
			{
				$sMode = 'ignore';
				break;
			}
			elseif( $oRec->npay_last_changed_date > $oParam->sLastChangedDate )
			{
// 1주문 다품목 상황에서 시차를 두고 구매확정하면, weird가 아닌데 weird로 분류되는 문제 발생
				//$sMode = 'weird';
				break;
			}
		}
	}
}

아래와 같이 변경
if( $nRecCnt == 0 )
	$sMode = 'add';
elseif( $nRecCnt > 0 )
{
	if( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'dispatched' ) // 이 설정에서는 입금완료 주문이 npay_log에만 존재하고 svorder tbl에는 존재하지 않음
		$sMode = 'add';
	else
	{
		$oFirstRec = array_values($oRst->data)[0];
		$oRst->add( 'nSvOrderSrl', $oFirstRec->order_srl );
		if( $oParam->sLastChangedDate && $oParam->sLastChangedStatus ) 
		{
			// Order level proc mode 판단에서는 검사하지 않음
			foreach( $oRst->data as $nIdx => $oRec )
			{
				if( $oRec->npay_last_changed_date == $oParam->sLastChangedDate &&
					$oRec->npay_order_status == $this->_g_aNpayOrderStatus[$oParam->sLastChangedStatus] )
				{
					$sMode = 'ignore';
					break;
				}
				elseif( $oRec->npay_last_changed_date > $oParam->sLastChangedDate )
				{
// 1주문 다품목 상황에서 시차를 두고 구매확정하면, weird가 아닌데 weird로 분류되는 문제 발생
					//$sMode = 'weird';
					break;
				}
			}
		}
	}
}

./ext_class/npay/npay_order.class.php::_insertNpayOrder()에 아래의 코드 추가
if( $oProductOrderInfo->DeliveryCompany && $oProductOrderInfo->TrackingNumber && $oProductOrderInfo->SendDate ) // collect dispatched order
{
	$oTmpProdOrderInfo->DeliveryCompany = $oProductOrderInfo->DeliveryCompany;
	$oTmpProdOrderInfo->DeliveryMethod = $oProductOrderInfo->DeliveryMethod;
	$oTmpProdOrderInfo->DeliveryStatus = $oProductOrderInfo->DeliveryStatus;
	$oTmpProdOrderInfo->SendDate = $this->_convertIsoDtStr2DtStr($oProductOrderInfo->SendDate);
	$oTmpProdOrderInfo->TrackingNumber = $oProductOrderInfo->TrackingNumber;
}

./svorder.order_create.class.php::_registerShippingInvoiceBySvCartSrl() 추가

./svorder.order_create.class.php::_setSvCartList()에 아래의 코드 추가
if( $oCartVal->ship)
	$this->_g_aCartItem[$nSvCartSrl]->ship = $oCartVal->ship;

if( $oCartVal->ship) // npay api에서 발송된 주문 수집
{
	$oShippingRst = $this->_registerShippingInvoiceBySvCartSrl($nSvCartSrl);
	if( !$oShippingRst->toBool() )
		return $oShippingRst;
}

./svorder.order_create.class.php::createSvOrder()에 아래의 코드 추가
if( $oCartVal->DeliveryCompany && $oCartVal->SendDate && $oCartVal->TrackingNumber ) // npay api에서 발송된 주문 수집
{
	$oCartVal->ship->express_id = $oCartVal->DeliveryCompany;
	$oCartVal->ship->regdate = $oCartVal->SendDate;
	$oCartVal->ship->invoice_no = $oCartVal->TrackingNumber;
	unset( $oCartVal->DeliveryCompany);
	unset( $oCartVal->SendDate);
	unset( $oCartVal->TrackingNumber);
}

2. npay api crontab 수집 모드 준비
./svorder.admin.view.php::dispSvorderAdminNpayOrderSync() 제거
./svorder.admin.view.php::dispSvorderAdminNpayReviewListCollect() 제거
./svorder.admin.view.php::dispSvorderAdminNpayInquiryCollect() 제거

./svorder.view.php::dispSvorderNpayOrderSync() 추가
./svorder.view.php::dispSvorderNpayReviewListCollect() 추가
./svorder.view.php::dispSvorderNpayInquiryCollect() 추가

3. npay 취소 반품 사유 코드 개선
./svorder.admin.model.php::getOrderStatusUpdateForm()에서 아래의 코드를
$aNpayCancelReason = Context::getLang('arr_cancel_reason');
foreach( $this->g_aNpayCancelReason as $sReasonCode => $sSymbol)
$aNpayReturnReqReason = Context::getLang('arr_npay_claim_return_reason');
foreach( $this->g_aNpayReturnReason as $sReasonCode => $sSymbol)

아래와 같이 변경
$aNpayCancelReason = Context::getLang('arr_npay_claim_cancel_return_reason');
foreach( $this->g_aNpayCancelReturnReason as $sReasonCode => $sSymbol)
$aNpayReturnReqReason = Context::getLang('arr_npay_claim_cancel_return_reason');
foreach( $this->g_aNpayCancelReturnReason as $sReasonCode => $sSymbol)

./svorder.model.php::getOrderStatusUpdateForm()에서 아래의 코드를
$aNpayCancelReason = Context::getLang('arr_cancel_reason');
foreach( $this->g_aNpayCancelReason as $sReasonCode => $sSymbol)

아래와 같이 변경
$aNpayCancelReason = Context::getLang('arr_npay_claim_cancel_return_reason');
foreach( $this->g_aNpayCancelReturnReason as $sReasonCode => $sSymbol)

./svorder.order_update.php::_updateCartItemStatusBySvCartSrl()에서 아래의 코드를
$sNpayExchangeReasonCode = array_search($oTmpTgtParams->sExchangeReqReasonCode, $this->g_aNpayReturnReason);
$sNpayCancelReasonCode = array_search($oTmpTgtParams->sCancelReqReasonCode, $this->g_aNpayCancelReason);

아래와 같이 변경
$sNpayExchangeReasonCode = array_search($oTmpTgtParams->sExchangeReqReasonCode, $this->g_aNpayCancelReturnReason);
$sNpayCancelReasonCode = array_search($oTmpTgtParams->sCancelReqReasonCode, $this->g_aNpayCancelReturnReason);

./ext_class/npay/npay_api.class.php::_parseRequestMsg()에서 아래의 코드를
$sCancelReasonCode = array_search($oReqParam->sCancelReasonCode, $this->g_aNpayCancelReason);

아래와 같이 변경
$sCancelReasonCode = array_search($oReqParam->sCancelReasonCode, $this->g_aNpayCancelReturnReason);

v 3.0.2
20th, Feb 2020
1. 주문자별 배송주소 이력관리 기능 추가
./queries/getAddressList.xml 추가
./queries/getAddressByAddrSrl.xml 추가

./svorder.model.php::getAddressListByMemberSrl() 추가

./svorder.order_create.php::_setSkeletonSvOrderHeader()에 아래의 코드 추가
$this->_g_oOrderHeader->registered_addr = -1; 

./svorder.order_create.php::_insertRecipientAddress()에서 아래의 코드를
$oTgtParams->nOrderReferral = $this->_g_oOrderHeader->order_referral;
$oTgtParams->sAddrType = $this->_g_oOrderHeader->addr_type;
$oTgtParams->recipient_address = $this->_g_oOrderHeader->recipient_address;
$oTgtParams->recipient_postcode = $this->_g_oOrderHeader->recipient_postcode;
$oTgtParams->nMemberSrl = $this->_g_oOrderHeader->member_srl;
$oSvorderController = &getController('svorder');
$oRst = $oSvorderController->insertRecipientAddress($oTgtParams);
if( !$oRst->toBool() )
	return $oRst;
$this->_g_oOrderHeader->addr_srl = $oRst->get( 'nAddrSrl' );
return new Object();

아래와 같이 변경
if($this->_g_oOrderHeader->registered_addr && $this->_g_oOrderHeader->order_referral == svorder::ORDER_REFERRAL_LOCALHOST )
{ // 자사몰 주문이고 기존 주소를 재이용한다면
	$oArg->address_srl = $this->_g_oOrderHeader->registered_addr;
	$oArg->member_srl = $this->_g_oOrderHeader->member_srl;
	$oRst = executeQuery( 'svorder.getAddressByAddrSrl', $oArg );
	if( !$oRst->toBool() )
		return $oRst;
	unset( $oArg );
	unset( $oRst );
	$this->_g_oOrderHeader->addr_srl = $this->_g_oOrderHeader->registered_addr;
}
else
{
	$oTgtParams->nOrderReferral = $this->_g_oOrderHeader->order_referral;
	$oTgtParams->sAddrType = $this->_g_oOrderHeader->addr_type;
	$oTgtParams->recipient_address = $this->_g_oOrderHeader->recipient_address;
	$oTgtParams->recipient_postcode = $this->_g_oOrderHeader->recipient_postcode;
	$oTgtParams->nMemberSrl = $this->_g_oOrderHeader->member_srl;
	$oSvorderController = &getController('svorder');
	$oRst = $oSvorderController->insertRecipientAddress($oTgtParams);
	if( !$oRst->toBool() )
		return $oRst;
	$this->_g_oOrderHeader->addr_srl = $oRst->get( 'nAddrSrl' );
}
return new Object();

./skins/Trendshop/orderitems.html에 아래의 코드 추가
<tr id="registered_addr">
	<th>
		{$lang->select_registered_address}
	</th>
	<td class="destination">
		<select name="registered_addr" style="width:250px;height:25px;">
			<option value="-1">새 배송지로</option>
<block loop="$member_address_list=>$nIdx,$oAddrVal">
			<option value="{$oAddrVal->address_srl}">{$oAddrVal->address[0]} {$oAddrVal->address[1]} {$oAddrVal->address[2]}</option>
</block>
		</select>
	</td>	
</tr>

v 3.0.3
21st, Feb 2020
1. 미구현된 반품 완료로 상태 변경 기능 추가
./svorder.admin.model.php::getOrderStatusUpdateForm()에 아래의 코드 추가
case svorder::ORDER_STATE_RETURNED:
	$aNpayReturnReasonTranslated = array();
	$aNpayReturnReason = Context::getLang('arr_npay_claim_cancel_return_reason');
	foreach( $this->g_aNpayCancelReturnReason as $sReasonCode => $sSymbol)
	{
		$sTmpCode = $aNpayReturnReason[$sReasonCode];
		$aNpayReturnReasonTranslated[$sTmpCode] = $sSymbol;
	}
	unset( $aNpayReturnReason );
	Context::set('return_reason', $aNpayReturnReasonTranslated);
	$sTgtStatusForm = '_cart_update_returned';
	break;

./svorder.admin.controller.php::_buildOrderUpdateReasonParam()에 아래의 코드 추가
case svorder::ORDER_STATE_RETURNED: // 반품 완료
	$sReturnReasonCode = Context::get('return_reason');
	if( !$sReturnReasonCode )
		return new Object(-1, 'msg_return_reason_not_choosed');
	$oUpdateParams->sReturnReasonCode = $sReturnReasonCode;
	break;

2. 취소 요청 시 환불 계좌를 입력하지 않으면 계좌 정보가 기이하게 표시되는 오류 개선
./svorder.order_update.php::_registerDeductInfo()에 아래의 코드 추가
if( $aDeductionInfo['bank_name'] == NULL && $aDeductionInfo['bank_acct'] == NULL && $aDeductionInfo['acct_holder'] == NULL )
	return new Object();

v 3.0.4
23rd, Feb 2020
1. npay 주문 수집 시 정산 다운로드에 반영하기 위해 LastChangedDate를 기록함
./ext_class/npay/npay_order.class.php::_insertNpayOrder()에 아래의 코드 추가
$oNewOrderInfo->last_changed_date = $this->_g_oOrderHeader->LastChangedDate;

./ext_class/npay/npay_order.class.php::_insertNpayOrder()에 아래의 코드 추가
$oTmpProdOrderInfo->last_changed_date = $this->_convertIsoDtStr2DtStr($oProductOrderInfo->LastChangedDate);

./svorder.order_create.php::_setSkeletonSvOrderHeader()에 아래의 코드 추가
$this->_g_oOrderHeader->last_changed_date = -1;

./svorder.order_create.php::_getSkeletonSvCartInfo()에 아래의 코드 추가
$oSingleCart->last_changed_date = -1;
$oSingleCart->bChanged = -1;

./svorder.order_create.php::_updateCartItemStatusBySvCartSrl()에 아래의 코드 추가
$this->_g_aCartItem[$nSvCartSrl]->bChanged = 'true';

./svorder.order_create.php::_updateCartItemStatusBySvCartSrl()에서 아래의 코드를
foreach( $this->_g_aCartItem as $nSvCartSrl => $oCartVal )
{
	$oArgs->order_srl = $oCartVal->order_srl;
	$oArgs->cart_srl = $oCartVal->cart_srl;
	$oArgs->order_status = $oCartVal->order_status;
	if( $oArgs->cart_srl ) // 장바구니 품목이 없는 손상된 주문인 경우 삭제 처리라도 허용
	{
		$oRst = executeQuery( 'svorder.updateCartOrderStatus', $oArgs );
		if( !$oRst->toBool() )
			return $oRst;
	}
}

아래와 같이 변경
foreach( $this->_g_aCartItem as $nSvCartSrl => $oCartVal )
{
	if( $oCartVal->bChanged == 'true' ) // 변경된 주문 품목만 업데이트
	{
		$oArgs->order_srl = $oCartVal->order_srl;
		$oArgs->cart_srl = $oCartVal->cart_srl;
		$oArgs->order_status = $oCartVal->order_status;
		if( $oArgs->cart_srl ) // 장바구니 품목이 없는 손상된 주문인 경우 삭제 처리라도 허용
		{
			$oRst = executeQuery( 'svorder.updateCartOrderStatus', $oArgs );
			if( !$oRst->toBool() )
				return $oRst;
		}
	}
}

./svorder.order_update.php::updateOrderStatusQuick()에서 아래의 코드를
foreach( $this->_g_aCartItem as $nSvCartSrl => $oCartVal )
	$oCartVal->order_status = $sTgtOrderStatus;

아래와 같이 변경
foreach( $this->_g_aCartItem as $nSvCartSrl => $oCartVal )
{
	$oCartVal->bChanged = 'true';
	$oCartVal->order_status = $sTgtOrderStatus;
}

./svorder.order_create.php::_setSvCartList()에 아래의 코드 추가
$this->_g_aCartItem[$nSvCartSrl]->last_changed_date = $oCartVal->last_changed_date;

./schemas/svorder_cart.xml에 아래의 코드 추가
<column name="last_changed_date" type="date" index="idx_last_changed_date"/>

./queries/insertOrder.xml에 아래의 코드 추가
<column name="last_changed_date" var="last_changed_date" default="curdate()" />

./queries/updateCartOrderStatus.xml에 아래의 코드 추가
<column name="last_changed_date" var="last_changed_date" default="curdate()" />

./queries/insertCartItem.xml에 아래의 코드 추가
<column name="last_changed_date" var="last_changed_date" default="curdate()" />

2. svpg v0.4.5에 대응
./svorder.order_create.php::_insertNpayOrder()에서 아래의 코드 제거
$oPgParam->order_title = $oNewOrderRst->get('sOrderTitle');
$oPgParam->p_member_srl = 0;
$oPgParam->p_user_id = $this->_g_oOrderHeader->OrdererID;
$oPgParam->p_name = $this->_g_oOrderHeader->OrdererName;
$oPgParam->p_email_address = $this->_g_oOrderHeader->OrdererEmail;;

v 3.0.5
24th, Feb 2020
1. 주문서 수취인명에 콤마 입력하는 경우 주문원장 CSV 에러 수정
./svorder.admin.controller.php::procSvorderAdminCSVDownloadByOrder()에 아래의 코드 추가
else if( $key == 'recipient_name' )
	echo '"'.$oOrderInfo->recipient_name.'"';

v 3.0.6
26th, Feb 2020
1. npay api 비활성화 시 주문 수집 에러 처리 개선
./svorder.view.php::dispSvorderNpayOrderSync()에 아래의 코드 추가
if(!$oNpayOrderApi->toBool())
	return $oNpayOrderApi;

./svorder.admin.model.php::getNpayOrderApi()에서 아래의 코드를
$oRst = null;

아래와 같이 변경
$oRst = new Object(-1, 'msg_npay_api_not_activated');

2. 구매자가 실수로 주문 내역 삭제 방지
./svorder.order_create.php::_getChangeableStatusConsumer()에서 아래의 코드 제거
case svorder::ORDER_STATE_ON_DEPOSIT:
	$aChangeableOrderStatus[svorder::ORDER_STATE_DELETED] = 1;
	break;

v 3.0.7
27th, Feb 2020
1. npay api 주문자 질문 수집 기능 활성화
./ext_class/npay/npay_api.class.php에서 아래의 코드를
var $_g_aCustomerInquiryOperation = array( 'GetCustomerInquiryList', 'AnswerCustomerInquiry' );

아래와 같이 변경
var $_g_aCustomerInquiryReadOperation = array( 'GetCustomerInquiryList' );
var $_g_aCustomerInquiryWriteOperation = array( 'AnswerCustomerInquiry' );

./ext_class/npay/npay_api.class.php::npayApi()에 아래의 코드 추가
$this->_g_sServiceVersion = '4.1'; // 주문 API 버전

./ext_class/npay/npay_api.class.php::getLatestInquiry() 추가

./ext_class/npay/npay_api.class.php::procOperation()에서 아래의 코드를
if( in_array($oReqParam->sOperation, $this->_g_aCheckoutReadOperation ) )
	$oRst = $this->_procRead($oReqParam);
else if( in_array($oReqParam->sOperation, $this->_g_aCustomerInquiryOperation ) )
	$oRst = $this->_procRead($oReqParam);
else if( in_array($oReqParam->sOperation, $this->_g_aCheckoutWriteOperation ) )
	$oRst = $this->_procWrite($oReqParam);

아래와 같이 변경
if( in_array($oReqParam->sOperation, $this->_g_aCheckoutReadOperation ) )
	$oRst = $this->_procRead($oReqParam);
else if( in_array($oReqParam->sOperation, $this->_g_aCheckoutWriteOperation ) )
	$oRst = $this->_procWrite($oReqParam);
else if( in_array($oReqParam->sOperation, $this->_g_aCustomerInquiryReadOperation ) )
	$oRst = $this->_procRead($oReqParam);
else if( in_array($oReqParam->sOperation, $this->_g_aCustomerInquiryWriteOperation ) )
	$oRst = $this->_procWrite($oReqParam);

./ext_class/npay/npay_api.class.php::_parseRequestMsg()에서 아래의 코드를
$bAnswered = 'false';

아래와 같이 변경
$bAnswered = $oReqParam->bAnswered;//'false';

./ext_class/npay/npay_api.class.php::_parseRequestMsg()에서 아래의 코드를
$version = '4.1';

아래와 같이 변경
$version = $this->_g_sServiceVersion;

./schemas/svorder_npay_inquiry_log.xml 추가

2. npay 주문 후기 수집 시 표시 내용 개선
./ext_class/npay/response_body/GetPurchaseReviewList.php에서 아래의 코드를
$oArg->content = $oSingleReviewInfo->WriterId.'님께서 '.$oSingleReviewInfo->ProductName.'를 네이버페이로 구매하신 후<BR>아래와 같은 후기를 '.$sRegdate.'에 작성하셨습니다.<BR><BR><BR>'.$oSingleReviewInfo->Title;

아래와 같이 변경
$oArg->content = $oSingleReviewInfo->WriterId.'님께서 '.$oSingleReviewInfo->ProductName.'를 네이버페이로 구매하신 후<BR>아래와 같은 후기를 '.$sRegdate.'에 작성하셨습니다.<BR><BR><BR>'.$oSingleReviewInfo->Title.'<BR><BR><BR><A HREF=\'https://order.pay.naver.com/review/'.$oSingleReviewInfo->PurchaseReviewId.'\'>네이버페이 구매 후기 원문을 보시려면 이 링크를 클릭하세요.</A>';

v 3.0.8
28th, Feb 2020
1. npay api 주문 수집 기능 개선; npay_shop_order_collect_from 설정 관련
./ext_class/npay/npay_order.class.php에 아래의 코드 추가
private $_g_aIgnoreStatus = [];

./ext_class/npay/npay_order.class.php::npayOrder()에 아래의 코드 추가
$this->_g_aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true; 
if( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'payed' )
	; // do nothing
elseif( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'dispatched' )
{
	//$this->_g_aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_PAID] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_DELIVERY_DELAYED] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = true;
}

./ext_class/npay/npay_order.class.php::commmit()에서 아래의 코드 제거
$this->_g_aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true; 
if( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'payed' )
	; // do nothing
elseif( $this->_g_oSvOrderConfig->npay_shop_order_collect_from == 'dispatched' )
{
	//$this->_g_aIgnoreStatus[svorder::ORDER_STATE_ON_DEPOSIT] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_PAID] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_DELIVERY_DELAYED] = true;
	$this->_g_aIgnoreStatus[svorder::ORDER_STATE_PREPARE_DELIVERY] = true;
}

./ext_class/npay/npay_order.class.php::commmit()에서 아래의 코드를
if( $aIgnoreStatus[$sCurOrderStatus] )
	$this->_g_oOrderHeader->nSvOrderSrl = -1;

아래와 같이 변경
if( $this->_g_aIgnoreStatus[$sCurOrderStatus] )
	$this->_g_oOrderHeader->nSvOrderSrl = -1;

./ext_class/npay/response_body/GetChangedProductOrderList.php에서 아래의 코드를
$oArgs->sNpayProductOrderId = $oProductOrderInfo->ProductOrderID;
$oArgs->sNpayOrderId = $oNpayOrder->getNpayOrderId();
$oArgs->nSvOrderSrl = $oNpayOrder->getSvOrderId();

아래와 같이 변경
$oArgs->nSvOrderSrl = $oNpayOrder->getSvOrderId();
if( $oArgs->nSvOrderSrl == -1 ) // npay_shop_order_collect_from 설정에 의해 무시헤야 하는 주문 상태
	continue;
$oArgs->sNpayProductOrderId = $oProductOrderInfo->ProductOrderID;

2. npay api 리뷰 수집 기능 오류 수정
./ext_class/npay/npay_api.class.php::_insertReviewSyncLog() 추가

./ext_class/npay/npay_api.class.php::getLatestReview()에서 아래의 코드를
$oReqParam->sReviewClass = 'PREMIUM';

아래와 같이 변경
$oReqParam->sOperation = 'GetPurchaseReviewList';
$oReqParam->sReviewClass = 'GENERAL'; // 텍스트 리뷰(일반, 한 달 사용)
$oGeneralRst = $this->procOperation($oReqParam);
if (!$oGeneralRst->toBool())
	return $oGeneralRst;
unset( $oGeneralRst );
$oReqParam->sReviewClass = 'PREMIUM'; // 포토/동영상(일반, 한 달 사용)
$oPremiumRst = $this->procOperation($oReqParam);
return $oPremiumRst;

./ext_class/npay/request_body/GetPurchaseReviewList.php에서 아래의 코드를
<PurchaseReviewClassType>".$sReviewClass."</PurchaseReviewClassType> 

아래와 같이 변경
<mall:PurchaseReviewClassType>".$sReviewClass."</mall:PurchaseReviewClassType> 

./ext_class/npay/response_body/GetPurchaseReviewList.php에서 아래의 코드를
$oArg->content = $oSingleReviewInfo->WriterId.'님께서 '.$oSingleReviewInfo->ProductName.'를 네이버페이로 구매하신 후<BR>아래와 같은 후기를 '.$sRegdate.'에 작성하셨습니다.<BR><BR><BR>'.$oSingleReviewInfo->Title.'<BR><BR><BR><A HREF=\'https://order.pay.naver.com/review/'.$oSingleReviewInfo->PurchaseReviewId.'\'>네이버페이 구매 후기 원문을 보시려면 이 링크를 클릭하세요.</A>';


아래와 같이 변경
if( $oSingleReviewInfo->Title )
	$sContentsBody = $oSingleReviewInfo->Title;

if( $oSingleReviewInfo->Content )
	$sContentsBody = $oSingleReviewInfo->Content;

$oArg->content = $oSingleReviewInfo->WriterId.'님께서 '.$oSingleReviewInfo->ProductName.'를 네이버페이로 구매하신 후<BR>아래와 같은 후기를 '.$sRegdate.'에 작성하셨습니다.<BR><BR><BR>'.$sContentsBody.'<BR><BR><BR><A HREF=\'https://order.pay.naver.com/review/'.$oSingleReviewInfo->PurchaseReviewId.'\'>네이버페이 구매 후기 원문을 보시려면 이 링크를 클릭하세요.</A>';